<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공인검사기관 안전관리시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c8f5719a2be48f3875087006ce782934&libraries=services&autoload=false"></script>
   
    <style>
        .scroll-x-auto {
            -webkit-overflow-scrolling: touch;
        }
        .table-cell-input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        /* NO 열 클릭 가능 스타일 */
        .no-cell {
            cursor: pointer;
            user-select: none;
        }
        .no-cell:hover {
            background-color: #dbeafe !important;
        }
        /* 동기화 상태 표시 */
        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .sync-indicator.online {
            background-color: #dcfce7;
            color: #166534;
        }
        .sync-indicator.offline {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .sync-indicator.syncing {
            background-color: #fef3c7;
            color: #92400e;
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .sync-dot.online { background-color: #22c55e; }
        .sync-dot.offline { background-color: #ef4444; }
        .sync-dot.syncing { background-color: #f59e0b; animation: pulse 1s infinite; }
    </style>
</head>
<body class="bg-gradient-to-b from-sky-400 to-sky-200 min-h-screen">
    <div id="app"></div>

    <script>
        // ======================== 클라우드 설정 ========================
        const CONFIG = {
            // ⚠️ 이 URL을 실제 Google Apps Script 웹 앱 URL로 변경하세요
            API_URL: '',  // 예: 'https://script.google.com/macros/s/xxx/exec'
            USER_ID: 'user_' + Date.now(),  // 사용자 식별자
            ENABLE_CLOUD: false  // 클라우드 활성화 여부 (API_URL 설정 후 true로 변경)
        };

        // ======================== 전역 상태 ========================
        const state = {
            currentYear: new Date().getFullYear(),
            activeTab: '통합',
            selectedYear: new Date().getFullYear(),
            data: {},
            filteredData: [],
            applicationData: {},
            quarterData: {},
            cancellationData: {},
            pathwayData: {},
            resourceData: {}, 
            currentPage: 1,
            selectedRows: new Set(),
            isLoading: false,
            loadingProgress: 0,
            searchTerm: '',
            isEditing: false,
            showAdmin: false,
            adminPassword: '',
            showWelcome: true,
            lastSaved: null,
            showDownloadMenu: false,
            uploadedFileName: '',
            showDuplicateModal: false,
            duplicateInfo: { duplicates: [], selectedData: [] },
            inspectionYear: new Date().getFullYear(),
            targetYear: new Date().getFullYear(),
            applicationFilters: {
                region: [],
                inspector: '',
                receiptLocation: '',
                inspectionResult: '',
                applicationDateFrom: '',
                applicationDateTo: '',
                inspectionDateFrom: '',
                inspectionDateTo: '',
                baseMonth: '',
                fee: '',
                facilityCert: '',
                certificateStatus: '',
                insuranceStatus: ''
            },
            applicationSearchTerm: '',
            selectedApplicationRows: new Set(),
            isEditingApplication: false,
            currentApplicationPage: 1,
            selectedQuarterRows: new Set(),
            isEditingQuarter: false,
            currentQuarterPage: 1,
            isEditingCancellation: false,
            selectedCancellationRows: new Set(),
            showDeleteModal: false,
            showAppDeleteModal: false,
            showDetailModal: false,
            detailModalData: {},
            detailModalSelectedIdx: null,
            showAppDetailModal: false,
            appDetailModalData: {},
            appDetailModalSelectedIdx: null,
            filters: {
                region: [],
                month: '',
                inspectionHistory: ''
            },
            showRegionDropdown: false,
            showMonthDropdown: false,
            showInspectionDropdown: false,
            settings: {
                companyName: '공인검사기관',
                maxFileSize: 100,
                autoSave: true,
                autoSaveInterval: 30
            },
            itemsPerPage: 50,
            inspectors: ['최중수', '김택신', '김춘식', '김정만'],
            receiptLocations: ['지로', '국민', '부산', '농협', '경남', '후납', '기타'],
            inspectionResults: ['합격', '불합격', '이중납부','공란', '기타'],
            yearRange: Array.from({ length: 37 }, (_, i) => 2014 + i),
            cancelReasons: ['입금 미확인', '고객 요청', '중복 신청', '기타'],
            showMapModal: false,
            mapData: [],
            isLoadingMap: false,
            mapLoadingProgress: 0,
            // 클라우드 관련 상태
            cloudStatus: 'offline', // 'online', 'offline', 'syncing'
            lastCloudSync: null,
            showHistoryModal: false,
            historyData: [],
            isLoadingHistory: false,
            quarter: {
                selectedQuarter: 'Q1',
                selectedRecipient: '',
                quarters: ['1분기', '2분기', '3분기', '4분기'],
                recipients: {
                    '부산시청': ['부산 강서구', '부산 남구', '부산 동구', '부산 부산진구', '부산 사상구', '부산 사하구', '부산 서구', '부산 수영구', '부산 영도구', '부산 중구', '부산 해운대구', '부산 금정구', '부산 기장군', '부산 동래구', '부산 연제구', '부산 북구'],
                    '강서구청장': ['부산 강서구'],
                    '남구청장': ['부산 남구'],
                    '동구청장': ['부산 동구'],
                    '부산진구청장': ['부산 부산진구'],
                    '사상구청장': ['부산 사상구'],
                    '사하구청장': ['부산 사하구'],
                    '서구청장': ['부산 서구'],
                    '수영구청장': ['부산 수영구'],
                    '영도구청장': ['부산 영도구'],
                    '중구청장': ['부산 중구'],
                    '해운대구청장': ['부산 해운대구'],
                    '금정구청장': ['부산 금정구'],
                    '기장군수': ['부산 기장군'],
                    '동래구청장': ['부산 동래구'],
                    '연제구청장': ['부산 연제구'],
                    '북구청장': ['부산 북구'],
                    '울산광역시 북구청장': ['울산 북구'],
                    '김해시청': ['경남 김해시'],
                    '양산시청': ['경남 양산시'],
                    '사천시청': ['경남 사천시'],
                    '통영시청': ['경남 통영시'],
                    '거제시청': ['경남 거제시'],
                    '포항시청': ['경북 포항시'],
                    '경주시청': ['경북 경주시'],
                    '구미시청': ['경북 구미시'],
                    '한국가스안전공사 부산지역본부': ['부산 강서구', '부산 남구', '부산 동구', '부산 부산진구', '부산 사상구', '부산 사하구', '부산 서구', '부산 수영구', '부산 영도구', '부산 중구'],
                    '한국가스안전공사 북부지사': ['부산 해운대구', '부산 금정구', '부산 기장군', '부산 동래구', '부산 연제구', '부산 북구'],
                    '한국가스안전공사 울산지사': ['울산 북구'],
                    '한국가스안전공사 창원지사': ['경남 김해시', '경남 양산시', '경남 통영시', '경남 거제시'],
                    '한국가스안전공사 진주지사': ['경남 사천시'],
                    '한국가스안전공사 경북동부지사': ['경북 포항시', '경북 경주시'],
                    '한국가스안전공사 대구경북지역본부': ['경북 구미시']
                }
            },
            pathway: {
                searchTerm: '',
                selectedRows: new Set(),
                isEditing: false,
                currentPage: 1,
                filters: {
                    region: ''
                },
                showDownloadMenu: false
            }
        };
        
        const columns = [
            '시설번호', '시설명', '행정구역', '새주소', '구주소', '월사용예정량', 
            '전화번호', '기준일', '안전관리자명', '자격증번호', '보험사', '보험만기일', 
            '메모', '검사일', '신청일', '검사원', '검사결과', '필증번호', '수수료', 
            '접수처', '계산서발행일', '비고', '검사확인', '사업자번호', '대표자명', 
            '업태', '종목', '이메일', '면제대상', '검사이력'
        ];

        const applicationColumns = [
            '시설번호', '시설명', '행정구역', '새주소', '구주소', '사용량', 
            '전화번호', '기준일', '안전관리자명', '자격증번호', '보험사', '보험만기일', 
            '메모', '검사일', '신청일', '검사원', '검사결과', '필증번호', '수수료', 
            '접수처', '계산서발행일', '메모2', '검사확인'
        ];

        const quarterColumns = [
            '분기', '시설번호', '시설명', '행정구역', '신청일', '검사일', '검사원', '검사결과', '필증번호', '메모'
        ];

        const cancellationColumns = [
            '시설번호', '시설명', '행정구역', '새주소', '신청일', '취소사유', '취소일', '수수료', '접수처','계좌', '비고'
        ];

        const pathwayColumns = [
            '시설번호', '시설명', '행정구역', '읍면동', '새주소', '전화번호', '사용가스', '차단기', '타이머', 'CO경보기', '누설', '점검일', '점검자', '비고', '참조'
        ];

        const pathwayOptions = {
            regions: ['울주군', '북구', '남구', '중구', '동구'],
            gas: ['LPG', '도시가스', 'LPG+도시가스'],
            device: ['설치', '미설치', '불량', '해당없슴'],
            leak: ['유', '무'],
            inspectors: ['최중수', '김택신', '김춘식']
        };

        const columnWidths = {
            '시설번호': '120px', '시설명': '150px', '행정구역': '100px', '새주소': '200px',
            '구주소': '120px', '월사용예정량': '100px', '전화번호': '110px', '기준일': '100px',
            '안전관리자명': '90px', '자격증번호': '120px', '보험사': '70px', '보험만기일': '100px',
            '메모': '150px', '검사일': '100px', '신청일': '100px', '검사원': '90px',
            '검사결과': '70px', '필증번호': '140px', '수수료': '80px', '접수처': '70px',
            '계산서발행일': '110px', '메모2': '150px', '검사확인': '70px',
            '취소번호': '120px', '취소사유': '150px', '취소일': '100px', '처리자': '90px', '비고': '150px'
        };

        // ======================== 클라우드 API 함수 ========================
        async function cloudSaveData() {
            if (!CONFIG.ENABLE_CLOUD || !CONFIG.API_URL) {
                alert('⚠️ 클라우드 저장이 비활성화되어 있습니다.\n\n설정 방법:\n1. Google Sheets 생성\n2. Apps Script 배포\n3. CONFIG.API_URL 설정\n4. CONFIG.ENABLE_CLOUD = true');
                return;
            }

            state.cloudStatus = 'syncing';
            render();

            try {
                const allData = {
                    data: state.data,
                    applicationData: state.applicationData,
                    quarterData: state.quarterData,
                    cancellationData: state.cancellationData,
                    pathwayData: state.pathwayData
                };

                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'bulkSave',
                        allData: allData,
                        userId: CONFIG.USER_ID
                    })
                });

                const result = await response.json();

                if (result.success) {
                    state.cloudStatus = 'online';
                    state.lastCloudSync = new Date();
                    alert(`☁️ 클라우드 저장 완료!\n${result.message}`);
                } else {
                    throw new Error(result.error || '저장 실패');
                }
            } catch (error) {
                state.cloudStatus = 'offline';
                console.error('클라우드 저장 오류:', error);
                alert('❌ 클라우드 저장 실패: ' + error.message);
            }
            render();
        }

        async function cloudLoadData() {
            if (!CONFIG.ENABLE_CLOUD || !CONFIG.API_URL) {
                alert('⚠️ 클라우드 저장이 비활성화되어 있습니다.');
                return;
            }

            if (!confirm('☁️ 클라우드에서 데이터를 불러오시겠습니까?\n\n⚠️ 현재 로컬 데이터가 덮어씌워집니다.')) {
                return;
            }

            state.isLoading = true;
            state.loadingProgress = 30;
            state.cloudStatus = 'syncing';
            render();

            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getAllData`);
                const result = await response.json();

                state.loadingProgress = 80;
                render();

                if (result.success && result.data) {
                    if (result.data.data) state.data = result.data.data;
                    if (result.data.applicationData) state.applicationData = result.data.applicationData;
                    if (result.data.quarterData) state.quarterData = result.data.quarterData;
                    if (result.data.cancellationData) state.cancellationData = result.data.cancellationData;
                    if (result.data.pathwayData) state.pathwayData = result.data.pathwayData;

                    state.cloudStatus = 'online';
                    state.lastCloudSync = new Date();
                    state.showWelcome = false;
                    
                    saveDataToStorage();
                    
                    const totalData = Object.values(state.data).reduce((sum, arr) => sum + (arr?.length || 0), 0);
                    alert(`☁️ 클라우드 데이터 로드 완료!\n총 ${totalData}건의 데이터를 불러왔습니다.`);
                } else {
                    throw new Error(result.error || '데이터 없음');
                }
            } catch (error) {
                state.cloudStatus = 'offline';
                console.error('클라우드 로드 오류:', error);
                alert('❌ 클라우드 로드 실패: ' + error.message);
            }

            state.isLoading = false;
            state.loadingProgress = 100;
            render();
        }

        async function loadHistory() {
            if (!CONFIG.ENABLE_CLOUD || !CONFIG.API_URL) {
                alert('⚠️ 클라우드가 비활성화되어 히스토리를 볼 수 없습니다.');
                return;
            }

            state.isLoadingHistory = true;
            state.showHistoryModal = true;
            render();

            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getHistory`);
                const result = await response.json();

                if (result.success) {
                    state.historyData = result.data || [];
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('히스토리 로드 오류:', error);
                state.historyData = [];
            }

            state.isLoadingHistory = false;
            render();
        }

        // ======================== 유틸리티 함수 ========================
        function formatCurrency(value) {
            if (!value || value === '') return '';
            const num = parseInt(String(value).replace(/,/g, ''));
            if (isNaN(num)) return value;
            return num.toLocaleString();
        }

        function saveToLocalStorage(dataToSave) {
            try {
                const jsonString = JSON.stringify(dataToSave);
                const sizeInMB = (new Blob([jsonString]).size / (1024 * 1024)).toFixed(2);
                
                if (parseFloat(sizeInMB) > 15) {
                    console.warn(`⚠️ 데이터 크기가 큽니다: ${sizeInMB}MB`);
                    return false;
                }
                
                localStorage.setItem('safetySystemData', jsonString);
                console.log(`✅ 저장 완료 (${sizeInMB}MB)`);
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.error('⚠️ 저장 공간 초과. 데이터를 정리하세요.');
                    state.settings.autoSave = false;
                    return false;
                }
                console.error('저장 오류:', e);
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('safetySystemData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    if (parsed.data) state.data = parsed.data;
                    if (parsed.applicationData) state.applicationData = parsed.applicationData;
                    if (parsed.quarterData) state.quarterData = parsed.quarterData;
                    if (parsed.cancellationData) state.cancellationData = parsed.cancellationData;
                    if (parsed.pathwayData) state.pathwayData = parsed.pathwayData;
                    if (parsed.resourceData) state.resourceData = parsed.resourceData;
                    if (parsed.settings) state.settings = parsed.settings;
                    if (parsed.uploadedFileName) state.uploadedFileName = parsed.uploadedFileName;
                    if (parsed.selectedYear) state.selectedYear = parsed.selectedYear;
                    if (parsed.lastSaved) state.lastSaved = new Date(parsed.lastSaved);
                    
                    const totalData = Object.values(state.data).reduce((sum, yearData) => sum + yearData.length, 0);
                    if (totalData > 0) {
                        state.showWelcome = false;
                        const sizeInMB = (new Blob([savedData]).size / (1024 * 1024)).toFixed(2);
                        console.log(`✅ 저장된 데이터 복원: ${totalData}건 (${sizeInMB}MB)`);
                    }
                }
            } catch (e) {
                console.error('데이터 로드 실패:', e);
            }
        }

        function getStorageSize() {
            try {
                const savedData = localStorage.getItem('safetySystemData');
                if (savedData) {
                    const sizeInMB = (new Blob([savedData]).size / (1024 * 1024)).toFixed(2);
                    return sizeInMB;
                }
                return '0.00';
            } catch (e) {
                return 'N/A';
            }
        }

        function normalizeDate(dateValue) {
            if (!dateValue || dateValue === '') return '';
            
            if (typeof dateValue === 'number') {
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            const dateStr = String(dateValue).trim();
            
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            
            if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split('.');
                return `${parts[0]}-${String(parts[1]).padStart(2, '0')}-${String(parts[2]).padStart(2, '0')}`;
            }
            
            if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                return `${parts[0]}-${String(parts[1]).padStart(2, '0')}-${String(parts[2]).padStart(2, '0')}`;
            }
            
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                return `${parts[2]}-${String(parts[0]).padStart(2, '0')}-${String(parts[1]).padStart(2, '0')}`;
            }
            
            return dateStr;
        }

        function generateCertificateNumber(date, year) {
            if (!date || date === '') return '';
            
            const allAppData = Object.values(state.applicationData).flat();
            
            if (state.targetYear !== state.inspectionYear) {
                const yy = String(state.inspectionYear).slice(2);
                const prefix = `KGT${yy}0101`;
                
                const existingNumbers = allAppData
                    .filter(row => row['필증번호']?.startsWith(prefix))
                    .map(row => {
                        const match = row['필증번호']?.match(/-(\d{3})$/);
                        return match ? parseInt(match[1]) : 0;
                    })
                    .filter(num => num > 0);
                
                const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
                return `${prefix}-${String(nextNumber).padStart(3, '0')}`;
            }
            
            const targetDate = new Date(date);
            const yy = String(targetDate.getFullYear()).slice(2);
            const MM = String(targetDate.getMonth() + 1).padStart(2, '0');
            const dd = String(targetDate.getDate()).padStart(2, '0');
            
            const prefix = `KGT${yy}${MM}${dd}`;
            
            const existingNumbers = allAppData
                .filter(row => row['필증번호']?.startsWith(prefix))
                .map(row => {
                    const match = row['필증번호']?.match(/-(\d{3})$/);
                    return match ? parseInt(match[1]) : 0;
                })
                .filter(num => num > 0);
            
            const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
            return `${prefix}-${String(nextNumber).padStart(3, '0')}`;
        }

        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('파일 읽기 실패'));
                reader.onload = (e) => {
                    try {
                        state.loadingProgress = 60;
                        render();
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        state.loadingProgress = 70;
                        render();
                        
                        let targetSheet = null;
                        let maxRows = 0;

                        if (workbook.SheetNames.includes('접수')) {
                            targetSheet = workbook.Sheets['접수'];
                        } else {
                            workbook.SheetNames.forEach(sheetName => {
                                const sheet = workbook.Sheets[sheetName];
                                const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                                if (data.length > maxRows) {
                                    maxRows = data.length;
                                    targetSheet = sheet;
                                }
                            });
                        }

                        if (!targetSheet) {
                            targetSheet = workbook.Sheets[workbook.SheetNames[0]];
                        }

                        const jsonData = XLSX.utils.sheet_to_json(targetSheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('데이터가 없거나 형식이 올바르지 않습니다.'));
                            return;
                        }
                        
                        state.loadingProgress = 85;
                        render();
                        
                        const headers = jsonData[0].map(h => String(h || '').trim());
                        const dateColumns = ['기준일', '검사일', '신청일', '보험만기일', '계산서발행일'];
                        const parsedData = [];
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const hasData = jsonData[i].some(cell => cell !== undefined && cell !== null && String(cell).trim() !== '');
                            if (!hasData) continue;
                            
                            const obj = {};
                            headers.forEach((header, idx) => {
                                let value = jsonData[i][idx];
                                if (value === undefined || value === null) {
                                    obj[header] = '';
                                } else {
                                    if (dateColumns.includes(header)) {
                                        obj[header] = normalizeDate(value);
                                    } else {
                                        obj[header] = String(value).trim();
                                    }
                                }
                            });
                            parsedData.push(obj);
                        }
                        
                        state.loadingProgress = 100;
                        render();
                        resolve(parsedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('파일 읽기 실패'));
                reader.onload = (e) => {
                    try {
                        state.loadingProgress = 60;
                        render();
                        
                        const text = e.target.result;
                        
                        if (!text || text.trim() === '') {
                            reject(new Error('파일이 비어있습니다.'));
                            return;
                        }

                        const lines = text.replace(/\r\n/g, '\n').split('\n').map(line => line.trim()).filter(line => line.length > 0);

                        if (lines.length < 2) {
                            reject(new Error('데이터가 없거나 형식이 올바르지 않습니다.'));
                            return;
                        }

                        state.loadingProgress = 80;
                        render();
                        
                        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                        const dateColumns = ['기준일', '검사일', '신청일', '보험만기일', '계산서발행일'];
                        
                        const parsedData = [];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i];
                            if (!line.trim()) continue;
                            
                            const values = [];
                            let currentValue = '';
                            let insideQuotes = false;
                            
                            for (let j = 0; j < line.length; j++) {
                                const char = line[j];
                                if (char === '"') {
                                    insideQuotes = !insideQuotes;
                                } else if (char === ',' && !insideQuotes) {
                                    values.push(currentValue.trim().replace(/^"|"$/g, ''));
                                    currentValue = '';
                                } else {
                                    currentValue += char;
                                }
                            }
                            values.push(currentValue.trim().replace(/^"|"$/g, ''));
                            
                            while (values.length < headers.length) {
                                values.push('');
                            }

                            const hasData = values.some(v => v && String(v).trim() !== '');
                            if (!hasData) continue;

                            const obj = {};
                            headers.forEach((header, idx) => {
                                let value = (values[idx] || '').replace(/[\\]/g, '').trim();
                                if (dateColumns.includes(header)) {
                                    obj[header] = normalizeDate(value);
                                } else {
                                    obj[header] = value;
                                }
                            });
                            parsedData.push(obj);
                        }

                        state.loadingProgress = 100;
                        render();
                        resolve(parsedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsText(file, 'EUC-KR');
            });
        }

        async function handleFileUpload(file) {
            if (!file) return;

            const maxSize = state.settings.maxFileSize * 1024 * 1024;
            if (file.size > maxSize) {
                alert(`파일 크기가 ${state.settings.maxFileSize}MB를 초과합니다.`);
                return;
            }

            state.isLoading = true;
            state.loadingProgress = 30;
            state.uploadedFileName = file.name;
            render();

            try {
                let parsedData;
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                if (fileExt === 'xlsx' || fileExt === 'xls') {
                    parsedData = await parseExcelFile(file);
                } else if (fileExt === 'csv') {
                    parsedData = await parseCSVFile(file);
                } else {
                    throw new Error('지원하지 않는 파일 형식입니다. (.xlsx, .xls, .csv만 가능)');
                }

                if (parsedData.length === 0) {
                    alert('유효한 데이터가 없습니다.');
                    state.isLoading = false;
                    render();
                    return;
                }

                if (!state.data[state.selectedYear]) {
                    state.data[state.selectedYear] = [];
                }
                state.data[state.selectedYear] = parsedData;
                
                state.lastSaved = new Date();
                
                setTimeout(() => {
                    state.isLoading = false;
                    const storageSize = getStorageSize();
                    let message = `✅ ${parsedData.length}개의 데이터가 ${state.selectedYear}년도로 업로드되었습니다.\n파일명: ${file.name}`;
                    
                    if (parseFloat(storageSize) > 3) {
                        message += `\n\n⚠️ 저장 공간: ${storageSize}MB/5MB\n공간이 부족하면 자동 저장이 실패할 수 있습니다.`;
                    }
                    
                    alert(message);
                    saveDataToStorage();
                    render();
                }, 300);

            } catch (error) {
                console.error('파일 처리 오류:', error);
                alert('파일 처리 중 오류가 발생했습니다: ' + error.message);
                state.isLoading = false;
                render();
            }
        }

        function downloadAsExcel() {
            const dataToDownload = state.selectedRows.size > 0
                ? state.filteredData.filter((_, idx) => state.selectedRows.has(idx))
                : state.filteredData;

            if (dataToDownload.length === 0) {
                alert('다운로드할 데이터가 없습니다.');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: columns });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '안전관리');
            
            const fileName = `안전관리_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            state.showDownloadMenu = false;
            render();
        }

        function downloadAsCSV() {
            const dataToDownload = state.selectedRows.size > 0
                ? state.filteredData.filter((_, idx) => state.selectedRows.has(idx))
                : state.filteredData;

            if (dataToDownload.length === 0) {
                alert('다운로드할 데이터가 없습니다.');
                return;
            }

            const csvContent = [
                columns.join(','),
                ...dataToDownload.map(row => 
                    columns.map(col => {
                        const value = row[col] || '';
                        return value.includes(',') || value.includes('"') 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `안전관리_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            state.showDownloadMenu = false;
            render();
        }

        function createSampleData() {
            const sampleData = [
                {
                    '시설번호': '00458912-0001', '시설명': '장수마을목욕탕', '행정구역': '부산',
                    '새주소': '부산광역시 기장군 기장읍 교리 334-6번지', '구주소': '',
                    '월사용예정량': '6,334.00㎡', '전화번호': '051-724-2552', '기준일': '2025-02-03',
                    '안전관리자명': '', '자격증번호': '', '보험사': '', '보험만기일': '2028-11-22',
                    '메모': '', '검사일': '2002-01-30', '신청일': '', '검사원': '문서영',
                    '검사결과': '', '필증번호': '', '수수료': '', '접수처': '비대상',
                    '계산서발행일': '', '비고': '', '검사확인': '', '사업자번호': '',
                    '대표자명': '', '업태': '', '종목': '', '이메일': '', '면제대상': '', '검사이력': 'Y'
                },
                {
                    '시설번호': '01525996-0001', '시설명': '피플러한의원', '행정구역': '부산',
                    '새주소': '부산광역시 기장군 정관읍 용수리 12 83-3번지', '구주소': '',
                    '월사용예정량': '1,322.00㎡', '전화번호': '051-728-6999', '기준일': '2025-05-07',
                    '안전관리자명': '', '자격증번호': '', '보험사': '', '보험만기일': '',
                    '메모': '', '검사일': '2011-01-05', '신청일': '', '검사원': '',
                    '검사결과': '', '필증번호': '', '수수료': '', '접수처': '비대상',
                    '계산서발행일': '', '비고': '', '검사확인': '', '사업자번호': '',
                    '대표자명': '', '업태': '', '종목': '', '이메일': '', '면제대상': '', '검사이력': ''
                }
            ];
            if (!state.data[state.selectedYear]) {
                state.data[state.selectedYear] = [];
            }
            state.data[state.selectedYear] = sampleData;
            state.uploadedFileName = '샘플데이터.xlsx';
            state.lastSaved = new Date();
            state.showWelcome = false;
            alert('샘플 데이터 2건이 생성되었습니다.');
            saveDataToStorage();
            updateFilters();
            render();
        }

        function updateFilters() {
            let result = [...(state.data[state.selectedYear] || [])];
            
            if (state.filters.region.length > 0) {
                result = result.filter(row => {
                    const region = (row['행정구역'] || '').replace(/[\\\/]/g, '').trim();
                    return state.filters.region.includes(region);
                });
            }
            
            if (state.filters.inspectionHistory) {
                result = result.filter(row => {
                    const history = row['검사이력'];
                    if (state.filters.inspectionHistory === 'Y') return history === 'Y';
                    if (state.filters.inspectionHistory === 'N') return !history || history === '' || history === 'N';
                    return true;
                });
            }
            
            if (state.searchTerm) {
                result = result.filter(row =>
                    Object.values(row).some(val =>
                        String(val).toLowerCase().includes(state.searchTerm.toLowerCase())
                    )
                );
            }
            
            state.filteredData = result;
            state.currentPage = 1;
        }

        function copyToApplication() {
            const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
            
            if (selectedData.length === 0) {
                alert('복사할 데이터를 선택해주세요.');
                return;
            }

            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }

            const duplicates = selectedData.filter(item =>
                state.applicationData[state.targetYear].some(app => app['시설번호'] === item['시설번호'])
            );

            if (duplicates.length > 0) {
                state.duplicateInfo = { duplicates, selectedData };
                state.showDuplicateModal = true;
                render();
                return;
            }

           selectedData.forEach(row => {
    if (row['월사용예정량'] && !row['사용량']) {
        row['사용량'] = row['월사용예정량'];
    }
    if (row['신청일'] && row['신청일'] !== '') {
        row['필증번호'] = generateCertificateNumber(row['신청일'], state.targetYear);
    } else {
        row['필증번호'] = '';
    }
});

            const existingData = state.applicationData[state.targetYear] || [];
            state.applicationData[state.targetYear] = [...selectedData, ...existingData];
                
            state.activeTab = '신청접수대장';
            state.selectedRows = new Set();
            alert(`${selectedData.length}개 항목이 신청접수대장으로 복사되었습니다.`);
            saveDataToStorage();
            render();
        }

        function confirmDuplicateCopy() {
            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }

            state.applicationData[state.targetYear] = [...state.duplicateInfo.selectedData, ...state.applicationData[state.targetYear]];
                        
            state.showDuplicateModal = false;
            state.activeTab = '신청접수대장';
            state.selectedRows = new Set();
            alert(`${state.duplicateInfo.selectedData.length}개 항목이 신청접수대장으로 복사되었습니다.`);
            saveDataToStorage();
            render();
        }

        function moveToCancel() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedData = currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx));
            
            if (selectedData.length === 0) {
                alert('취소할 데이터를 선택해주세요.');
                return;
            }

            if (!state.cancellationData[state.targetYear]) {
                state.cancellationData[state.targetYear] = [];
            }

            const cancellationItems = selectedData.map((item) => ({
                '시설번호': item['시설번호'],
                '시설명': item['시설명'],
                '행정구역': item['행정구역'],
                '새주소': item['새주소'] || '',
                '필증번호': item['필증번호'],
                '신청일': item['신청일'],
                '취소사유': '',
                '취소일': '',
                '수수료': '',
                '접수처': '',
                '계좌': '',
                '비고': ''
            }));

            state.cancellationData[state.targetYear] = [...cancellationItems, ...state.cancellationData[state.targetYear]];
            
            const remainingApplicationData = currentAppData.filter((_, idx) => !state.selectedApplicationRows.has(idx));
            state.applicationData[state.targetYear] = remainingApplicationData;
            
            state.selectedApplicationRows = new Set();
            alert(`${selectedData.length}개 항목이 취소대장으로 이동되었습니다.`);
            saveDataToStorage();
            render();
        }

        function cutToInspectionYear() {
            if (state.targetYear === state.inspectionYear) {
                alert('⚠️ 해당년도와 검사예정년도가 같습니다.\n잘라내기가 필요하지 않습니다.');
                return;
            }

            if (state.selectedApplicationRows.size === 0) {
                alert('잘라낼 데이터를 선택해주세요.');
                return;
            }

            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedIndices = Array.from(state.selectedApplicationRows).sort((a, b) => b - a);
            const selectedData = selectedIndices.map(idx => ({...currentAppData[idx]}));

            const cutCount = selectedData.length;
            const targetInspectionYear = state.inspectionYear;

            if (!state.applicationData[state.inspectionYear]) {
                state.applicationData[state.inspectionYear] = [];
            }

            const yy = String(state.inspectionYear).slice(2);
            const prefix = `KGT${yy}0101`;
            
            const allAppData = Object.values(state.applicationData).flat();
            const existingNumbers = allAppData
                .filter(row => row['필증번호']?.startsWith(prefix))
                .map(row => {
                    const match = row['필증번호']?.match(/-(\d{3})$/);
                    return match ? parseInt(match[1]) : 0;
                })
                .filter(num => num > 0);
            
            let maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
            
            selectedData.forEach(row => {
                if (row['신청일'] && row['신청일'] !== '') {
                    maxNumber++;
                    row['필증번호'] = `${prefix}-${String(maxNumber).padStart(3, '0')}`;
                } else {
                    row['필증번호'] = '';
                }
            });

            state.applicationData[state.inspectionYear] = [...selectedData, ...state.applicationData[state.inspectionYear]];

            selectedIndices.forEach(idx => {
                state.applicationData[state.targetYear].splice(idx, 1);
            });

            state.targetYear = state.inspectionYear;
            state.selectedApplicationRows = new Set();

            alert(`✂️ ${cutCount}개 항목이 ${targetInspectionYear}년도로 이동되었습니다.`);
            saveDataToStorage();
            render();
        }

        function saveDataToStorage() {
            const toSave = {
                data: state.data,
                applicationData: state.applicationData,
                quarterData: state.quarterData,
                cancellationData: state.cancellationData,
                pathwayData: state.pathwayData,
                resourceData: state.resourceData,
                settings: state.settings,
                uploadedFileName: state.uploadedFileName,
                selectedYear: state.selectedYear,
                lastSaved: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            const saved = saveToLocalStorage(toSave);
            if (saved) {
                state.lastSaved = new Date();
            } else {
                console.warn('⚠️ 저장 실패. 불필요한 데이터를 삭제해주세요.');
            }
        }

        function clearAllData() {
            if (confirm('⚠️ 모든 데이터를 삭제하시겠습니까?\n(저장된 데이터도 모두 삭제됩니다)')) {
                localStorage.removeItem('safetySystemData');
                state.data = {};
                state.applicationData = {};
                state.quarterData = {};
                state.cancellationData = {};
                state.pathwayData = {};
                state.resourceData = {};
                state.uploadedFileName = '';
                state.lastSaved = null;
                state.showWelcome = true;
                state.showAdmin = false;
                alert('✅ 모든 데이터가 삭제되었습니다.');
                render();
            }
        }

        function deleteSelectedRows() {
            if (state.selectedRows.size === 0) {
                alert('삭제할 행을 선택해주세요.');
                return;
            }
            state.showDeleteModal = true;
            render();
        }

        function confirmDelete() {
            const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
            
            selectedData.forEach(selectedItem => {
                state.data[state.selectedYear] = state.data[state.selectedYear].filter(item => item !== selectedItem);
            });
            
            state.selectedRows = new Set();
            state.showDeleteModal = false;
            alert(`${selectedData.length}개 항목이 삭제되었습니다.`);
            saveDataToStorage();
            updateFilters();
            render();
        }

        function addApplicationRow() {
            const newRow = {};
            applicationColumns.forEach(col => {
                newRow[col] = '';
            });
            newRow['필증번호'] = '';
            
            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }
            state.applicationData[state.targetYear] = [newRow, ...state.applicationData[state.targetYear]];
            saveDataToStorage();
            render();
        }

        function deleteSelectedApplicationRows() {
            if (state.selectedApplicationRows.size === 0) {
                alert('삭제할 행을 선택해주세요.');
                return;
            }
            state.showAppDeleteModal = true;
            render();
        }

        function confirmAppDelete() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedIndices = Array.from(state.selectedApplicationRows);
            const newData = currentAppData.filter((_, idx) => !selectedIndices.includes(idx));
            state.applicationData[state.targetYear] = newData;
            
            state.selectedApplicationRows = new Set();
            state.showAppDeleteModal = false;
            alert('삭제되었습니다.');
            saveDataToStorage();
            render();
        }

        function generateCertificateNumbers() {
            if (state.selectedApplicationRows.size === 0) {
                alert('필증번호를 생성할 행을 선택해주세요.');
                return;
            }
            
            let generatedCount = 0;
            const sortedIndices = Array.from(state.selectedApplicationRows).sort((a, b) => b - a);
            
            sortedIndices.forEach(idx => {
                if (state.applicationData[state.targetYear] && state.applicationData[state.targetYear][idx]) {
                    const referenceDate = state.applicationData[state.targetYear][idx]['신청일'] || state.applicationData[state.targetYear][idx]['검사일'];
                    if (referenceDate) {
                        state.applicationData[state.targetYear][idx]['필증번호'] = generateCertificateNumber(referenceDate, state.targetYear);
                        generatedCount++;
                    }
                }
            });
            
            if (generatedCount > 0) {
                alert(`${generatedCount}개의 필증번호가 생성되었습니다.`);
                saveDataToStorage();
            } else {
                alert('신청일 또는 검사일이 입력된 행이 없습니다. 날짜를 먼저 입력해주세요.');
            }
            render();
        }

        // ======================== 히스토리 모달 렌더링 ========================
        function renderHistoryModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
                    <div class="bg-white rounded-lg shadow-2xl my-8 w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
                        
                        <!-- 헤더 -->
                        <div class="bg-purple-600 text-white px-6 py-4 flex items-center justify-between">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">📜</span>
                                수정 히스토리
                            </h3>
                            <button id="historyCloseBtn" class="text-white hover:text-gray-200 text-2xl">✕</button>
                        </div>

                        <!-- 컨텐츠 -->
                        <div class="flex-1 overflow-y-auto p-6">
                            ${state.isLoadingHistory ? `
                                <div class="flex items-center justify-center py-12">
                                    <div class="text-center">
                                        <div class="animate-pulse text-4xl mb-4">⏳</div>
                                        <p>히스토리 로딩 중...</p>
                                    </div>
                                </div>
                            ` : state.historyData.length === 0 ? `
                                <div class="text-center py-12 text-gray-500">
                                    <div class="text-5xl mb-4">📭</div>
                                    <p>히스토리가 없습니다.</p>
                                    <p class="text-sm mt-2">클라우드에 데이터를 저장하면 히스토리가 기록됩니다.</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${state.historyData.map((item, idx) => `
                                        <div class="bg-gray-50 border rounded-lg p-4 hover:bg-gray-100">
                                            <div class="flex items-start justify-between">
                                                <div class="flex items-center gap-3">
                                                    <span class="text-2xl">
                                                        ${item['작업'] === '데이터 저장' ? '💾' : 
                                                          item['작업'] === '행 수정' ? '✏️' : 
                                                          item['작업'] === '행 추가' ? '➕' : 
                                                          item['작업'] === '행 삭제' ? '🗑️' : '📝'}
                                                    </span>
                                                    <div>
                                                        <p class="font-semibold text-gray-800">${item['작업']}</p>
                                                        <p class="text-sm text-gray-600">${item['상세내용']}</p>
                                                        ${item['시설번호'] ? `<p class="text-xs text-gray-500">시설: ${item['시설번호']} - ${item['시설명'] || ''}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="text-right text-sm text-gray-500">
                                                    <p>${new Date(item['타임스탬프']).toLocaleDateString()}</p>
                                                    <p>${new Date(item['타임스탬프']).toLocaleTimeString()}</p>
                                                    <p class="text-xs">${item['사용자']}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>

                        <!-- 푸터 -->
                        <div class="bg-gray-50 px-6 py-4 border-t">
                            <button id="historyRefreshBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 font-semibold">
                                🔄 새로고침
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDetailModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
                    <div class="bg-white rounded-lg shadow-2xl my-8 w-full max-w-4xl mx-4 max-h-[95vh] overflow-y-auto">
                        <div class="bg-pink-600 text-white px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">👁️</span>
                                ${state.detailModalSelectedIdx !== null ? '상세보기' : '새 데이터 추가'}
                            </h3>
                            <button id="detailCloseBtn" class="text-white hover:text-gray-200 text-2xl">✕</button>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${columns.map(col => `
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">${col}</label>
                                        <input type="text" id="detail-${col}" value="${state.detailModalData[col] || ''}" 
                                               class="w-full px-3 py-2 border rounded text-sm" 
                                               ${col.includes('일') ? 'type="date"' : ''} />
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t sticky bottom-0 z-10">
                            <button id="detailCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                                취소
                            </button>
                            ${state.detailModalSelectedIdx !== null ? `
                                <button id="detailSaveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                                    💾 수정
                                </button>
                            ` : `
                                <button id="detailAddBtn" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-semibold">
                                    ➕ 추가
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAppDetailModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
                    <div class="bg-white rounded-lg shadow-2xl my-8 w-full max-w-4xl mx-4 max-h-[95vh] overflow-y-auto">
                        <div class="bg-pink-600 text-white px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">👁️</span>
                                ${state.appDetailModalSelectedIdx !== null ? '상세보기 (신청접수대장)' : '새 데이터 추가 (신청접수대장)'}
                            </h3>
                            <button id="appDetailCloseBtn" class="text-white hover:text-gray-200 text-2xl">✕</button>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${applicationColumns.map(col => `
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">${col}</label>
                                        ${col === '검사원' ? `
                                            <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                                <option value="">선택</option>
                                                ${state.inspectors.map(i => `<option value="${i}" ${i === state.appDetailModalData[col] ? 'selected' : ''}>${i}</option>`).join('')}
                                            </select>
                                        ` : col === '검사결과' ? `
                                            <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                                <option value="">선택</option>
                                                ${state.inspectionResults.map(r => `<option value="${r}" ${r === state.appDetailModalData[col] ? 'selected' : ''}>${r}</option>`).join('')}
                                            </select>
                                        ` : col === '접수처' ? `
                                            <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                                <option value="">선택</option>
                                                ${state.receiptLocations.map(l => `<option value="${l}" ${l === state.appDetailModalData[col] ? 'selected' : ''}>${l}</option>`).join('')}
                                            </select>
                                        ` : col.includes('일') ? `
                                            <input type="date" id="appDetail-${col}" value="${state.appDetailModalData[col] || ''}" class="w-full px-3 py-2 border rounded text-sm" />
                                        ` : `
                                            <input type="text" id="appDetail-${col}" value="${state.appDetailModalData[col] || ''}" class="w-full px-3 py-2 border rounded text-sm" />
                                        `}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t sticky bottom-0 z-10">
                            <button id="appDetailCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                                취소
                            </button>
                            ${state.appDetailModalSelectedIdx !== null ? `
                                <button id="appDetailSaveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                                    💾 수정
                                </button>
                            ` : `
                                <button id="appDetailAddBtn" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-semibold">
                                    ➕ 추가
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function openAppDetailModal() {
            if (state.selectedApplicationRows.size === 1) {
                const selectedIdx = Array.from(state.selectedApplicationRows)[0];
                const currentAppData = state.applicationData[state.targetYear] || [];
                const selectedData = currentAppData[selectedIdx];
                state.appDetailModalData = { ...selectedData };
                state.appDetailModalSelectedIdx = selectedIdx;
            } else {
                state.appDetailModalData = {};
                state.appDetailModalSelectedIdx = null;
                applicationColumns.forEach(col => {
                    state.appDetailModalData[col] = '';
                });
            }
            state.showAppDetailModal = true;
            render();
        }

        function closeAppDetailModal() {
            state.showAppDetailModal = false;
            render();
        }

        function saveFromAppDetailModal() {
            applicationColumns.forEach(col => {
                const input = document.getElementById(`appDetail-${col}`);
                if (input) {
                    state.appDetailModalData[col] = input.value;
                }
            });
            
            if (state.appDetailModalSelectedIdx !== null && state.appDetailModalSelectedIdx >= 0) {
                state.applicationData[state.targetYear][state.appDetailModalSelectedIdx] = { ...state.appDetailModalData };
            }
            
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showAppDetailModal = false;
            alert('💾 데이터가 저장되었습니다.');
            render();
        }

        function addFromAppDetailModal() {
            applicationColumns.forEach(col => {
                const input = document.getElementById(`appDetail-${col}`);
                if (input) {
                    state.appDetailModalData[col] = input.value;
                }
            });
            
            const newRow = { ...state.appDetailModalData };
            
            if (newRow['신청일'] && newRow['신청일'] !== '') {
                newRow['필증번호'] = generateCertificateNumber(newRow['신청일'], state.targetYear);
            } else {
                newRow['필증번호'] = '';
            }
            
            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }
            state.applicationData[state.targetYear] = [newRow, ...state.applicationData[state.targetYear]];
            
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showAppDetailModal = false;
            alert('데이터가 추가되었습니다.');
            render();
        }

        function renderMapModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto p-4">
                    <div class="bg-white rounded-lg shadow-2xl my-8" style="width: 95%; max-width: 1000px; height: 700px; display: flex; flex-direction: column; overflow: hidden;">
                        <div class="flex items-center justify-between p-6 border-b sticky top-0 bg-white z-10">
                            <h3 class="text-2xl font-bold">🗺️ 시설 위치 지도</h3>
                            <button id="mapCloseBtn" class="text-gray-600 hover:text-gray-900 text-3xl font-bold">✕</button>
                        </div>
                        <div id="mapContainer" style="width: 100%; height: 400px; background: #f0f0f0; border: 1px solid #ccc;"></div>
                        <div id="mapLoadingBar" style="padding: 1.5rem; background: #eff6ff; border-top: 1px solid #bfdbfe; ${state.isLoadingMap ? '' : 'display: none;'}">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-blue-700">지도 로딩 중...</span>
                                <span id="mapProgressText" class="text-sm font-bold text-blue-600">${state.mapLoadingProgress}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="mapProgressBar" class="bg-blue-600 h-3 rounded-full transition-all" style="width: ${state.mapLoadingProgress}%;"></div>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-50 border-t max-h-40 overflow-y-auto flex-1">
                            <h4 class="font-bold mb-4">📍 선택된 시설 주소</h4>
                            <div class="space-y-3">
                                ${state.mapData.map((item) => `
                                    <div class="bg-white p-4 rounded border-l-4 border-blue-500">
                                        <p class="font-semibold">${item['시설명']}</p>
                                        <p class="text-sm text-gray-600">시설번호: ${item['시설번호']}</p>
                                        <p class="text-sm text-gray-700">📮 ${item['새주소']}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="flex gap-3 justify-end p-6 border-t bg-white">
                            <button id="mapPrintBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                                🖨️ 인쇄
                            </button>
                            <button id="mapCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function openDetailModal() {
            if (state.selectedRows.size === 1) {
                const selectedIdx = Array.from(state.selectedRows)[0];
                const selectedData = state.filteredData[selectedIdx];
                state.detailModalData = { ...selectedData };
                state.detailModalSelectedIdx = (state.data[state.selectedYear] || []).indexOf(selectedData);
            } else {
                state.detailModalData = {};
                state.detailModalSelectedIdx = null;
                columns.forEach(col => {
                    state.detailModalData[col] = '';
                });
            }
            state.showDetailModal = true;
            render();
        }

        function closeDetailModal() {
            state.showDetailModal = false;
            render();
        }

        function saveFromDetailModal() {
            columns.forEach(col => {
                const input = document.getElementById(`detail-${col}`);
                if (input) {
                    state.detailModalData[col] = input.value;
                }
            });
            
            if (state.detailModalSelectedIdx !== null && state.detailModalSelectedIdx >= 0) {
                state.data[state.selectedYear][state.detailModalSelectedIdx] = { ...state.detailModalData };
            } else {
                if (!state.data[state.selectedYear]) {
                    state.data[state.selectedYear] = [];
                }
                state.data[state.selectedYear] = [{ ...state.detailModalData }, ...state.data[state.selectedYear]];
            }
            
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showDetailModal = false;
            alert('💾 데이터가 저장되었습니다.');
            updateFilters();
            render();
        }

        function addFromDetailModal() {
            const newRow = { ...state.detailModalData };
            if (!state.data[state.selectedYear]) {
                state.data[state.selectedYear] = [];
            }
            state.data[state.selectedYear] = [newRow, ...state.data[state.selectedYear]];
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showDetailModal = false;
            alert('데이터가 추가되었습니다.');
            updateFilters();
            render();
        }

        // ======================== 렌더링 함수 ========================
        function render() {
            try {
                updateFilters();
                const app = document.getElementById('app');
                if (!app) {
                    console.error('#app 요소를 찾을 수 없습니다.');
                    return;
                }
                app.innerHTML = renderApp();
                attachEventListeners();
            } catch (error) {
                console.error('렌더링 오류:', error);
                const app = document.getElementById('app');
                if (app) {
                    app.innerHTML = `<div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded">오류가 발생했습니다: ${error.message}</div>`;
                }
            }
        }

        function renderApp() {
            return `
                <div class="min-h-screen bg-gradient-to-b from-sky-400 to-sky-200">
                    ${renderHeader()}
                    ${renderTabs()}
                    <div class="container mx-auto px-4 py-6">
                        ${renderContent()}
                    </div>
                    ${renderFooter()}
                    ${state.isLoading ? renderLoadingModal() : ''}
                    ${state.showDuplicateModal ? renderDuplicateModal() : ''}
                    ${state.showDeleteModal ? renderDeleteModal() : ''}
                    ${state.showAppDeleteModal ? renderAppDeleteModal() : ''}
                    ${state.showDetailModal ? renderDetailModal() : ''}
                    ${state.showAppDetailModal ? renderAppDetailModal() : ''}
                    ${state.showMapModal ? renderMapModal() : ''}
                    ${state.showHistoryModal ? renderHistoryModal() : ''}
                </div>
            `;
        }

        function renderHeader() {
            const years = Array.from({ length: 10 }, (_, i) => state.currentYear - i);
            return `
                <div class="bg-gradient-to-r from-sky-400 to-sky-500 text-white">
                    <div class="container mx-auto px-4 py-6">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div>
                                <h1 class="text-3xl font-bold">공인검사기관</h1>
                                <p class="text-lg">안전관리시스템 v2.1 ☁️ (클라우드 연동)</p>
                            </div>
                            
                            <!-- 클라우드 버튼 그룹 -->
                            <div class="flex items-center gap-2">
                                <button id="cloudSaveBtn" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg font-semibold flex items-center gap-2 text-sm">
                                    ☁️ 클라우드 저장
                                </button>
                                <button id="cloudLoadBtn" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg font-semibold flex items-center gap-2 text-sm">
                                    📥 불러오기
                                </button>
                                <button id="historyBtn" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg font-semibold flex items-center gap-2 text-sm">
                                    📜 히스토리
                                </button>
                            </div>
                            
                            <div class="text-right">
                                <label class="block text-sm mb-1">당해 연도</label>
                                <select id="yearSelect" class="px-4 py-2 text-gray-900 rounded border-2 border-white">
                                    ${years.map(year => `<option value="${year}" ${year === state.selectedYear ? 'selected' : ''}>${year}년</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTabs() {
            const tabs = ['통합', '신청접수대장', '분기', '경로당', '매출분석', '취소', '자료실', '관리자'];
            return `
                <div class="bg-white border-b shadow-sm">
                    <div class="container mx-auto px-4">
                        <div class="flex gap-1 overflow-x-auto">
                            ${tabs.map(tab => `
                                <button class="tab-btn px-6 py-3 font-semibold whitespace-nowrap ${state.activeTab === tab ? 'bg-blue-600 text-white border-b-4 border-blue-800' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}" data-tab="${tab}">
                                    ${tab}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContent() {
            if (state.showWelcome && Object.keys(state.data).length === 0 && state.activeTab === '통합') {
                return renderWelcome();
            }
            
            if (state.activeTab === '관리자') {
                return renderAdmin();
            }
            
            if (state.activeTab === '신청접수대장') {
                return renderApplicationTab();
            }

            if (state.activeTab === '분기') {
                return renderQuarterTab();
            }

            if (state.activeTab === '매출분석') {
                return `<div class="bg-white rounded-lg p-6 shadow"><h2 class="text-xl font-bold">매출분석 탭</h2><p class="text-gray-600 mt-2">매출분석 기능은 원본과 동일하게 작동합니다.</p></div>`;
            }

           if (state.activeTab === '경로당') {
    return renderPathwayTab();
}

            if (state.activeTab === '자료실') {
                return `<div class="bg-white rounded-lg p-6 shadow"><h2 class="text-xl font-bold">자료실 탭</h2><p class="text-gray-600 mt-2">자료실 기능은 원본과 동일하게 작동합니다.</p></div>`;
            }

            if (state.activeTab === '취소') {
                return `<div class="bg-white rounded-lg p-6 shadow"><h2 class="text-xl font-bold">취소 탭</h2><p class="text-gray-600 mt-2">취소 기능은 원본과 동일하게 작동합니다.</p></div>`;
            }
            
            return renderMainTab();
        }

        function renderWelcome() {
            return `
                <div class="flex items-center justify-center min-h-96">
                    <div class="bg-white p-12 rounded-2xl shadow-2xl max-w-2xl text-center">
                        <h2 class="text-4xl font-bold mb-6 text-blue-600">👋 환영합니다!</h2>
                        <p class="text-xl mb-8 text-gray-700">공인검사기관 안전관리시스템</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <button id="sampleDataBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-6 rounded-xl hover:from-blue-600 hover:to-blue-700 shadow-lg transform hover:scale-105 transition-all">
                                <div class="text-4xl mb-3">🎯</div>
                                <div class="text-lg font-bold mb-2">샘플 데이터</div>
                                <div class="text-sm opacity-90">테스트용 2건 생성</div>
                            </button>

                            <label class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-6 rounded-xl hover:from-green-600 hover:to-green-700 shadow-lg transform hover:scale-105 transition-all cursor-pointer">
                                <div class="text-4xl mb-3">📁</div>
                                <div class="text-lg font-bold mb-2">파일 업로드</div>
                                <div class="text-sm opacity-90">Excel/CSV 가져오기</div>
                                <input type="file" id="welcomeFileInput" accept=".csv,.xlsx,.xls" class="hidden" />
                            </label>

                            <button id="cloudLoadWelcomeBtn" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-6 rounded-xl hover:from-purple-600 hover:to-purple-700 shadow-lg transform hover:scale-105 transition-all">
                                <div class="text-4xl mb-3">☁️</div>
                                <div class="text-lg font-bold mb-2">클라우드 불러오기</div>
                                <div class="text-sm opacity-90">저장된 데이터 가져오기</div>
                            </button>
                        </div>

                        <button id="emptyStartBtn" class="mt-6 text-gray-500 hover:text-gray-700 underline">
                            빈 화면으로 시작
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAdmin() {
            if (!state.showAdmin) {
                return `
                    <div class="flex items-center justify-center h-96">
                        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
                            <h2 class="text-xl font-bold mb-4">관리자 로그인</h2>
                            <input type="password" id="adminPassword" placeholder="비밀번호 입력" class="w-full px-4 py-2 border rounded mb-4" />
                            <button id="adminLoginBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                로그인
                            </button>
                        </div>
                    </div>
                `;
            }
            
            const totalMainData = Object.values(state.data).reduce((sum, yearData) => sum + yearData.length, 0);
            const totalAppData = Object.values(state.applicationData).reduce((sum, yearData) => sum + (yearData ? yearData.length : 0), 0);
            
            return `
                <div class="p-6 bg-white rounded-lg">
                    <h2 class="text-2xl font-bold mb-6">시스템 관리</h2>
                    <div class="space-y-6">
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold mb-4">시스템 정보</h3>
                            <div class="bg-gray-50 p-4 rounded space-y-2 text-sm">
                                <p><strong>버전:</strong> 2.1.0 (클라우드 연동)</p>
                                <p><strong>전체 데이터:</strong> ${totalMainData}건</p>
                                <p><strong>신청접수대장:</strong> ${totalAppData}건</p>
                                <p><strong>저장 공간:</strong> ${getStorageSize()} MB / ~5 MB</p>
                                <p><strong>클라우드:</strong> ${CONFIG.ENABLE_CLOUD ? '활성화' : '비활성화'}</p>
                                ${state.lastCloudSync ? `<p><strong>마지막 동기화:</strong> ${state.lastCloudSync.toLocaleString()}</p>` : ''}
                            </div>
                        </div>
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold mb-4 text-red-600">위험 구역</h3>
                            <button id="clearAllBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-semibold">
                                🗑️ 모든 데이터 초기화
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainTab() {
            const uniqueRegions = [...new Set(
                (state.data[state.selectedYear] || []).map(row => (row['행정구역'] || '').replace(/[\\\/]/g, '').trim()).filter(Boolean)
            )].sort();

            const totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);
            const paginatedData = state.filteredData.slice(
                (state.currentPage - 1) * state.itemsPerPage,
                state.currentPage * state.itemsPerPage
            );

            return `
                <div>
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <button id="uploadBtn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">📤 업로드</button>
                            <div class="relative">
                                <button id="downloadBtn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">📥 다운로드</button>
                                ${state.showDownloadMenu ? `
                                    <div class="absolute top-full mt-1 right-0 bg-white border rounded shadow-lg z-20 w-48">
                                        <button id="downloadExcelBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left">📊 Excel 다운로드</button>
                                        <button id="downloadCSVBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left border-t">📄 CSV 다운로드</button>
                                    </div>
                                ` : ''}
                            </div>
                            <button id="sampleBtn" class="flex items-center gap-2 bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">🎯 샘플 데이터</button>
                            <button id="editToggleBtn" class="flex items-center gap-2 bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">✏️ ${state.isEditing ? '완료' : '편집'}</button>
                            <button id="saveBtn" class="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">💾 저장</button>
                            <button id="copyBtn" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">📋 신청</button>
                            <button id="deleteBtn" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">🗑️ 삭제</button>
                            <button id="detailBtn" class="flex items-center gap-2 bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">👁️ 상세보기/추가</button>
                        </div>

                        ${state.uploadedFileName ? `
                            <div class="mb-4 px-3 py-2 bg-blue-50 border border-blue-200 rounded text-sm flex items-center justify-between">
                                <span>📂 <strong>${state.uploadedFileName}</strong> (${(state.data[state.selectedYear] || []).length}건)</span>
                                ${state.lastSaved ? `<span class="text-gray-600 text-xs">마지막 저장: ${state.lastSaved.toLocaleTimeString()}</span>` : ''}
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                            <div class="relative">
                                <label class="block text-xs font-semibold mb-1">행정구역</label>
                                <button id="regionDropdownBtn" class="w-full px-2 py-1 border rounded text-left text-xs bg-white hover:bg-gray-50">
                                    ${state.filters.region.length === 0 ? '선택...' : state.filters.region.join(', ')}
                                </button>
                                ${state.showRegionDropdown ? `
                                    <div class="absolute top-full left-0 right-0 border border-t-0 rounded-b bg-white z-50 max-h-32 overflow-y-auto text-xs">
                                        <div class="space-y-1 p-1">
                                            ${uniqueRegions.length === 0 ? `<div class="text-gray-400 py-2 px-1">데이터 없음</div>` : `
                                                <label class="flex items-center cursor-pointer hover:bg-blue-50 px-1 py-0.5 rounded">
                                                    <input type="checkbox" id="selectAllRegions" ${state.filters.region.length === uniqueRegions.length && uniqueRegions.length > 0 ? 'checked' : ''} class="mr-1" />
                                                    <span class="font-semibold text-blue-700">전체</span>
                                                </label>
                                                ${uniqueRegions.map(region => `
                                                    <label class="flex items-center cursor-pointer hover:bg-gray-50 px-1 py-0.5 rounded region-checkbox">
                                                        <input type="checkbox" value="${region}" ${state.filters.region.includes(region) ? 'checked' : ''} class="mr-1" />
                                                        <span>${region}</span>
                                                    </label>
                                                `).join('')}
                                            `}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div>
                                <label class="block text-xs font-semibold mb-1">검색</label>
                                <div class="flex gap-1">
                                    <input type="text" id="searchInput" value="${state.searchTerm}" placeholder="검색..." class="flex-1 px-2 py-1 border rounded text-xs" />
                                    <button id="searchBtn" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">🔍</button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold mb-1">필터 초기화</label>
                                <button id="mainFilterResetBtn" class="w-full px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-xs">🔄 초기화</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse" style="table-layout: fixed; min-width: 4500px;">
                                <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2 sticky left-0 bg-blue-600 z-20" style="width: 50px;">
    <input type="checkbox" id="selectAllRows" ${state.selectedRows.size === state.filteredData.length && state.filteredData.length > 0 ? 'checked' : ''} />
</th>
${columns.map(col => `
                                            <th class="border px-3 py-2 text-sm" style="width: ${columnWidths[col]};">
                                                <div class="truncate" title="${col}">${col}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paginatedData.map((row, idx) => {
                                        const actualIdx = (state.currentPage - 1) * state.itemsPerPage + idx;
                                        return `
                                            <tr class="${state.selectedRows.has(actualIdx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                               <td class="border px-2 py-2 text-center sticky left-0 bg-white z-10" style="width: 50px;">
    <input type="checkbox" class="row-checkbox" data-idx="${actualIdx}" ${state.selectedRows.has(actualIdx) ? 'checked' : ''} />
</td>
${columns.map(col => `
                                                    <td class="border px-3 py-2 text-sm" style="width: ${columnWidths[col]}; max-width: ${columnWidths[col]};">
                                                        ${state.isEditing ? `
                                                            <input type="text" value="${row[col] || ''}" class="table-cell-input cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                        ` : `
                                                            <div class="truncate" title="${row[col] || '-'}">${row[col] || '-'}</div>
                                                        `}
                                                    </td>
                                                `).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${paginatedData.length === 0 ? `
                                        <tr>
                                            <td colspan="${columns.length + 2}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">📋</div>
                                                <div>데이터가 없습니다</div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>

                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                전체 ${state.filteredData.length}건
                                ${state.filteredData.length > 0 ? ` 중 ${((state.currentPage - 1) * state.itemsPerPage) + 1}-${Math.min(state.currentPage * state.itemsPerPage, state.filteredData.length)}건 표시` : ''}
                                ${state.selectedRows.size > 0 ? ` (${state.selectedRows.size}건 선택됨)` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="prevPageBtn" ${state.currentPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">◀</button>
                                <span class="px-4 py-2">${state.currentPage} / ${totalPages || 1}</span>
                                <button id="nextPageBtn" ${state.currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">▶</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderApplicationTab() {
            const currentAppData = (state.applicationData[state.targetYear] || []).filter(row => row !== null && row !== undefined);
            
            const uniqueAppRegions = [...new Set(currentAppData.map(row => row['행정구역']).filter(Boolean))].sort();

            let filteredApplicationData = currentAppData.map((row, idx) => ({...row, _originalIdx: idx}));
            
            if (state.applicationFilters.region.length > 0) {
                filteredApplicationData = filteredApplicationData.filter(row => 
                    state.applicationFilters.region.includes(row['행정구역'])
                );
            }

            if (state.applicationFilters.inspector) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['검사원'] === state.applicationFilters.inspector
                );
            }

            if (state.applicationFilters.inspectionResult) {
    filteredApplicationData = filteredApplicationData.filter(row =>
        row['검사결과'] === state.applicationFilters.inspectionResult
    );
}

if (state.applicationFilters.receiptLocation) {
    filteredApplicationData = filteredApplicationData.filter(row =>
        row['접수처'] === state.applicationFilters.receiptLocation
    );
}

if (state.applicationFilters.baseMonth) {
    filteredApplicationData = filteredApplicationData.filter(row => {
        const baseDate = row['기준일'];
        if (!baseDate) return false;
        const month = parseInt(baseDate.split('-')[1]);
        return month === parseInt(state.applicationFilters.baseMonth);
    });
}

if (state.applicationFilters.applicationDateFrom) {
    filteredApplicationData = filteredApplicationData.filter(row =>
        row['신청일'] >= state.applicationFilters.applicationDateFrom
    );
}

if (state.applicationFilters.applicationDateTo) {
    filteredApplicationData = filteredApplicationData.filter(row =>
        row['신청일'] <= state.applicationFilters.applicationDateTo
    );
}

if (state.applicationFilters.inspectionDateFrom) {
    filteredApplicationData = filteredApplicationData.filter(row =>
        row['검사일'] >= state.applicationFilters.inspectionDateFrom
    );
}

if (state.applicationFilters.inspectionDateTo) {
    filteredApplicationData = filteredApplicationData.filter(row =>
        row['검사일'] <= state.applicationFilters.inspectionDateTo
    );
}

if (state.applicationFilters.fee) {
    filteredApplicationData = filteredApplicationData.filter(row =>
        String(row['수수료']).includes(state.applicationFilters.fee)
    );
}

          if (state.applicationSearchTerm) {
    filteredApplicationData = filteredApplicationData.filter(row =>
        Object.values(row).some(val =>
            String(val).toLowerCase().includes(state.applicationSearchTerm.toLowerCase())
        )
    );
}

// 필증번호 기준 정렬 (없는 것 상단, 있는 것 내림차순)
filteredApplicationData.sort((a, b) => {
    const certA = a['필증번호'] || '';
    const certB = b['필증번호'] || '';
    if (certA === '' && certB === '') return 0;
    if (certA === '') return -1;
    if (certB === '') return 1;
    return certB.localeCompare(certA);
});
            
            const totalAppPages = Math.ceil(filteredApplicationData.length / state.itemsPerPage);
            
            const paginatedAppData = filteredApplicationData.slice(
                (state.currentApplicationPage - 1) * state.itemsPerPage,
                state.currentApplicationPage * state.itemsPerPage
            );

            return `
                <div>
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">해당년도</label>
                                    <select id="targetYearSelect" class="px-3 py-2 border rounded">
                                        ${state.yearRange.map(year => `<option value="${year}" ${year === state.targetYear ? 'selected' : ''}>${year}년</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">검사예정년도</label>
                                    <select id="inspectionYearSelect" class="px-3 py-2 border rounded">
                                        ${state.yearRange.map(year => `<option value="${year}" ${year === state.inspectionYear ? 'selected' : ''}>${year}년</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mb-4 flex-wrap">
    <button id="appUploadBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">📤 업로드</button>
    <button id="appAddRowBtn" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">행 추가</button>
    <button id="appDeleteRowBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">🗑️ 행 삭제</button>
    <button id="appEditToggleBtn" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">${state.isEditingApplication ? '편집완료' : '편집'}</button>
    <button id="appSaveBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">저장</button>
    <button id="appDownloadBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">📥 다운로드</button>
    <button id="appCertBtn" class="px-4 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700">✨ 필증번호 재생성</button>
    <button id="appMapBtn" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800">🗺️ MAP</button>
    <button id="cutBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">✂️ 잘라내기</button>
    <button id="cancelBtn" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">취소</button>
</div>

                      <div class="grid grid-cols-4 gap-4 mb-4">
   <div>
    <label class="block text-sm font-semibold mb-1">행정구역</label>
    <select id="appRegionFilter" class="w-full px-3 py-2 border rounded text-sm">
        <option value="">전체</option>
        ${uniqueAppRegions.map(r => `<option value="${r}" ${state.applicationFilters.region.includes(r) ? 'selected' : ''}>${r}</option>`).join('')}
    </select>
</div>
    <div>
        <label class="block text-sm font-semibold mb-1">검사원</label>
        <select id="appInspectorFilter" class="w-full px-3 py-2 border rounded text-sm">
            <option value="">선택</option>
            ${state.inspectors.map(i => `<option value="${i}" ${state.applicationFilters.inspector === i ? 'selected' : ''}>${i}</option>`).join('')}
        </select>
    </div>
    <div>
        <label class="block text-sm font-semibold mb-1">검사결과</label>
        <select id="appResultFilter" class="w-full px-3 py-2 border rounded text-sm">
            <option value="">선택</option>
            ${state.inspectionResults.map(r => `<option value="${r}" ${state.applicationFilters.inspectionResult === r ? 'selected' : ''}>${r}</option>`).join('')}
        </select>
    </div>
    <div>
        <label class="block text-sm font-semibold mb-1">접수처</label>
        <select id="appReceiptFilter" class="w-full px-3 py-2 border rounded text-sm">
            <option value="">선택</option>
            ${state.receiptLocations.map(l => `<option value="${l}" ${state.applicationFilters.receiptLocation === l ? 'selected' : ''}>${l}</option>`).join('')}
        </select>
    </div>
</div>
<div class="grid grid-cols-4 gap-4 mb-4">
    <div>
        <label class="block text-sm font-semibold mb-1">신청일</label>
        <div class="flex gap-1">
            <input type="date" id="appDateFrom" value="${state.applicationFilters.applicationDateFrom}" class="flex-1 px-2 py-2 border rounded text-sm" />
            <input type="date" id="appDateTo" value="${state.applicationFilters.applicationDateTo}" class="flex-1 px-2 py-2 border rounded text-sm" />
        </div>
    </div>
    <div>
        <label class="block text-sm font-semibold mb-1">검사일</label>
        <div class="flex gap-1">
            <input type="date" id="appInspDateFrom" value="${state.applicationFilters.inspectionDateFrom}" class="flex-1 px-2 py-2 border rounded text-sm" />
            <input type="date" id="appInspDateTo" value="${state.applicationFilters.inspectionDateTo}" class="flex-1 px-2 py-2 border rounded text-sm" />
        </div>
    </div>
    <div>
        <label class="block text-sm font-semibold mb-1">기준월</label>
        <select id="appBaseMonthFilter" class="w-full px-3 py-2 border rounded text-sm">
            <option value="">선택</option>
            ${Array.from({length: 12}, (_, i) => `<option value="${i+1}" ${state.applicationFilters.baseMonth === String(i+1) ? 'selected' : ''}>${i+1}월</option>`).join('')}
        </select>
    </div>
    <div>
        <label class="block text-sm font-semibold mb-1">수수료</label>
        <input type="text" id="appFeeFilter" value="${state.applicationFilters.fee}" placeholder="수수료 입력" class="w-full px-3 py-2 border rounded text-sm" />
    </div>
</div>
<div class="flex gap-4 items-end mb-4">
    <div class="flex-1">
        <label class="block text-sm font-semibold mb-1">검색</label>
        <div class="flex gap-1">
            <input type="text" id="appSearchInput" value="${state.applicationSearchTerm}" placeholder="시설명, 시설번호, 주소 등 검색..." class="flex-1 px-3 py-2 border rounded text-sm" />
            <button id="appSearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">🔍</button>
        </div>
    </div>
    <button id="appFilterResetBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">🔄 필터 초기화</button>
</div> 
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse text-sm" style="table-layout: fixed; min-width: 2600px;">
                                <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                       <th class="border px-2 py-2" style="width: 50px;">
    <input type="checkbox" id="selectAllAppRows" ${state.selectedApplicationRows.size === filteredApplicationData.length && filteredApplicationData.length > 0 ? 'checked' : ''} />
</th>
${applicationColumns.map(col => `
                                            <th class="border px-2 py-2" style="width: ${columnWidths[col]};">
                                                <div class="truncate" title="${col}">${col}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paginatedAppData.map((row, idx) => {
                                        const originalIdx = row._originalIdx;
                                        return `
                                            <tr class="${state.selectedApplicationRows.has(originalIdx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                                <td class="border px-2 py-1 text-center" style="width: 50px;">
    <input type="checkbox" class="app-row-checkbox" data-idx="${originalIdx}" ${state.selectedApplicationRows.has(originalIdx) ? 'checked' : ''} />
</td>
${applicationColumns.map(col => `
                                                    <td class="border px-2 py-1 text-sm" style="width: ${columnWidths[col]};">
                                                        ${state.isEditingApplication ? `
                                                            ${col.includes('일') ? `
                                                                <input type="date" value="${row[col] || ''}" class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                            ` : col === '검사원' ? `
                                                                <select class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${state.inspectors.map(i => `<option value="${i}" ${i === row[col] ? 'selected' : ''}>${i}</option>`).join('')}
                                                                </select>
                                                            ` : col === '검사결과' ? `
                                                                <select class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${state.inspectionResults.map(r => `<option value="${r}" ${r === row[col] ? 'selected' : ''}>${r}</option>`).join('')}
                                                                </select>
                                                            ` : col === '접수처' ? `
                                                                <select class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${state.receiptLocations.map(l => `<option value="${l}" ${l === row[col] ? 'selected' : ''}>${l}</option>`).join('')}
                                                                </select>
                                                            ` : `
                                                                <input type="text" value="${row[col] || ''}" class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                            `}
                                                        ` : `
                                                            <div class="truncate ${col === '수수료' ? 'text-right' : ''}" title="${row[col] || '-'}">${col === '수수료' ? (formatCurrency(row[col]) || '-') : (row[col] || '-')}</div>
                                                        `}
                                                    </td>
                                                `).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${paginatedAppData.length === 0 ? `
                                        <tr>
                                            <td colspan="${applicationColumns.length + 2}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">📋</div>
                                                <div>데이터가 없습니다</div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                전체 ${filteredApplicationData.length}건
                                ${state.selectedApplicationRows.size > 0 ? ` (${state.selectedApplicationRows.size}건 선택됨)` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="appPrevPageBtn" ${state.currentApplicationPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">◀</button>
                                <span class="px-4 py-2">${state.currentApplicationPage} / ${totalAppPages || 1}</span>
                                <button id="appNextPageBtn" ${state.currentApplicationPage === totalAppPages || totalAppPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">▶</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuarterTab() {
            return `
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">분기 탭</h2>
                    <p class="text-gray-600">분기 기능은 원본과 동일하게 작동합니다.</p>
                </div>
            `;
        }

        function renderPathwayTab() {
    const currentPathwayData = state.pathwayData[state.selectedYear] || [];
    
    const uniquePathwayRegions = [...new Set(currentPathwayData.map(row => row['행정구역']).filter(Boolean))].sort();
    
    let filteredPathwayData = [...currentPathwayData];
    
    if (state.pathway.filters.region) {
        filteredPathwayData = filteredPathwayData.filter(row => row['행정구역'] === state.pathway.filters.region);
    }
    
    if (state.pathway.searchTerm) {
        filteredPathwayData = filteredPathwayData.filter(row =>
            Object.values(row).some(val =>
                String(val).toLowerCase().includes(state.pathway.searchTerm.toLowerCase())
            )
        );
    }
    
    const totalPathwayPages = Math.ceil(filteredPathwayData.length / state.itemsPerPage);
    const paginatedPathwayData = filteredPathwayData.slice(
        (state.pathway.currentPage - 1) * state.itemsPerPage,
        state.pathway.currentPage * state.itemsPerPage
    );

    return `
        <div>
            <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-4">
                <h2 class="text-xl font-bold text-yellow-800 flex items-center gap-2">
                    <span>🏠</span> 경로당 점검: ${state.selectedYear}년
                </h2>
            </div>
            
            <div class="bg-white rounded-lg p-4 mb-4 shadow">
                <div class="flex gap-2 mb-4 flex-wrap">
                    <button id="pathwayUploadBtn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">📤 업로드 (Excel/CSV)</button>
                    <button id="pathwayDownloadBtn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">📥 다운로드</button>
                    <button id="pathwayDeleteBtn" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">🗑️ 삭제</button>
                    <button id="pathwaySaveBtn" class="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">💾 저장</button>
                    <button id="pathwayEditToggleBtn" class="flex items-center gap-2 bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">✏️ ${state.pathway.isEditing ? '완료' : '편집'}</button>
                    <button id="pathwayAddRowBtn" class="flex items-center gap-2 bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">➕ 행 추가</button>
                    <button id="pathwayMapBtn" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">🗺️ MAP</button>
                </div>
                
                <div class="flex gap-4 items-end">
                    <div>
                        <label class="block text-sm font-semibold mb-1">행정구역</label>
                        <select id="pathwayRegionFilter" class="px-3 py-2 border rounded">
                            <option value="">전체</option>
                            ${pathwayOptions.regions.map(r => `<option value="${r}" ${state.pathway.filters.region === r ? 'selected' : ''}>${r}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-semibold mb-1">검색</label>
                        <input type="text" id="pathwaySearchInput" value="${state.pathway.searchTerm}" placeholder="검색어 입력..." class="w-full px-3 py-2 border rounded" />
                    </div>
                    <button id="pathwaySearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">🔍 조회</button>
                    <button id="pathwayResetBtn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">🔄 초기화</button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto" style="max-height: 600px;">
                    <table class="w-full border-collapse text-sm" style="table-layout: fixed; min-width: 2000px;">
                        <thead class="bg-blue-600 text-white sticky top-0 z-10">
                            <tr>
                                <th class="border px-2 py-2" style="width: 50px;">
                                    <input type="checkbox" id="selectAllPathwayRows" ${state.pathway.selectedRows.size === filteredPathwayData.length && filteredPathwayData.length > 0 ? 'checked' : ''} />
                                </th>
                                ${pathwayColumns.map(col => `
                                    <th class="border px-2 py-2" style="width: ${col === '새주소' ? '200px' : col === '시설명' ? '150px' : '100px'};">
                                        <div class="truncate" title="${col}">${col}</div>
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${paginatedPathwayData.map((row, idx) => {
                                const actualIdx = (state.pathway.currentPage - 1) * state.itemsPerPage + idx;
                                return `
                                    <tr class="${state.pathway.selectedRows.has(actualIdx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                        <td class="border px-2 py-1 text-center" style="width: 50px;">
                                            <input type="checkbox" class="pathway-row-checkbox" data-idx="${actualIdx}" ${state.pathway.selectedRows.has(actualIdx) ? 'checked' : ''} />
                                        </td>
                                        ${pathwayColumns.map(col => `
                                            <td class="border px-2 py-1 text-sm">
                                                ${state.pathway.isEditing ? `
                                                    ${col === '사용가스' ? `
                                                        <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                            <option value="">선택</option>
                                                            ${pathwayOptions.gas.map(g => `<option value="${g}" ${g === row[col] ? 'selected' : ''}>${g}</option>`).join('')}
                                                        </select>
                                                    ` : col === '차단기' || col === '타이머' || col === 'CO경보기' ? `
                                                        <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                            <option value="">선택</option>
                                                            ${pathwayOptions.device.map(d => `<option value="${d}" ${d === row[col] ? 'selected' : ''}>${d}</option>`).join('')}
                                                        </select>
                                                    ` : col === '누설' ? `
                                                        <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                            <option value="">선택</option>
                                                            ${pathwayOptions.leak.map(l => `<option value="${l}" ${l === row[col] ? 'selected' : ''}>${l}</option>`).join('')}
                                                        </select>
                                                    ` : col === '점검자' ? `
                                                        <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                            <option value="">선택</option>
                                                            ${pathwayOptions.inspectors.map(i => `<option value="${i}" ${i === row[col] ? 'selected' : ''}>${i}</option>`).join('')}
                                                        </select>
                                                    ` : col === '점검일' ? `
                                                        <input type="date" value="${row[col] || ''}" class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                    ` : `
                                                        <input type="text" value="${row[col] || ''}" class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                    `}
                                                ` : `
                                                    <div class="truncate" title="${row[col] || '-'}">${row[col] || '-'}</div>
                                                `}
                                            </td>
                                        `).join('')}
                                    </tr>
                                `;
                            }).join('')}
                            ${paginatedPathwayData.length === 0 ? `
                                <tr>
                                    <td colspan="${pathwayColumns.length + 1}" class="text-center py-8 text-gray-500">
                                        <div class="text-4xl mb-2">🏠</div>
                                        <div>데이터가 없습니다</div>
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
                
                <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                    <div class="text-sm text-gray-600">
                        전체 ${filteredPathwayData.length}건
                        ${state.pathway.selectedRows.size > 0 ? ` (${state.pathway.selectedRows.size}건 선택됨)` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="pathwayPrevPageBtn" ${state.pathway.currentPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">◀</button>
                        <span class="px-4 py-2">${state.pathway.currentPage} / ${totalPathwayPages || 1}</span>
                        <button id="pathwayNextPageBtn" ${state.pathway.currentPage === totalPathwayPages || totalPathwayPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">▶</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}
        function renderLoadingModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                        <div class="animate-pulse text-4xl mb-4">⏳</div>
                        <p class="text-lg font-semibold mb-2">파일 처리 중...</p>
                        <div class="w-64 bg-gray-200 rounded-full h-4 mb-2">
                            <div class="bg-blue-600 h-4 rounded-full transition-all" style="width: ${state.loadingProgress}%;"></div>
                        </div>
                        <p class="text-sm text-gray-600">${state.loadingProgress}%</p>
                    </div>
                </div>
            `;
        }

        function renderDuplicateModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4">
                        <div class="bg-orange-500 text-white px-6 py-4">
                            <h3 class="text-xl font-bold">⚠️ 중복된 시설번호 발견</h3>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-700 mb-4">
                                중복된 시설번호가 <strong class="text-orange-600">${state.duplicateInfo.duplicates.length}개</strong> 발견되었습니다.
                            </p>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t">
                            <button id="cancelDupBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">취소</button>
                            <button id="confirmDupBtn" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold">계속 진행</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDeleteModal() {
            const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4">
                        <div class="bg-red-500 text-white px-6 py-4">
                            <h3 class="text-xl font-bold">🗑️ 데이터 삭제 확인</h3>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-700 mb-4">선택된 <strong class="text-red-600">${selectedData.length}개</strong>의 항목을 삭제하시겠습니까?</p>
                            <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                                <p class="text-sm text-yellow-800"><strong>⚠️ 주의:</strong> 이 작업은 되돌릴 수 없습니다.</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t">
                            <button id="cancelDeleteBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">취소</button>
                            <button id="confirmDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">삭제</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAppDeleteModal() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedData = currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx));
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4">
                        <div class="bg-red-500 text-white px-6 py-4">
                            <h3 class="text-xl font-bold">🗑️ 데이터 삭제 확인</h3>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-700 mb-4">선택된 <strong class="text-red-600">${selectedData.length}개</strong>의 항목을 삭제하시겠습니까?</p>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t">
                            <button id="cancelAppDeleteBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">취소</button>
                            <button id="confirmAppDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">삭제</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFooter() {
            return `
                <div class="container mx-auto px-4 py-4 text-sm text-gray-600 flex items-center justify-between flex-wrap gap-4">
                    <p>검색결과 (Total: ${state.filteredData.length}개)</p>
                    <div class="flex items-center gap-4">
                        <!-- 동기화 상태 표시 -->
                        <div class="sync-indicator ${state.cloudStatus}">
                            <span class="sync-dot ${state.cloudStatus}"></span>
                            ${state.cloudStatus === 'online' ? '클라우드 연결됨' : 
                              state.cloudStatus === 'syncing' ? '동기화 중...' : 
                              '오프라인'}
                        </div>
                        ${state.lastSaved ? `
                            <p class="text-xs text-gray-500">
                                마지막 저장: ${state.lastSaved.toLocaleTimeString()}
                            </p>
                        ` : ''}
                        <p class="text-xs text-green-600 font-semibold">💾 영구 저장 모드</p>
                    </div>
                </div>
            `;
        }

        function initMap(locations) {
            const mapContainer = document.getElementById('mapContainer');
            if (!mapContainer || typeof kakao === 'undefined') {
                setTimeout(() => initMap(locations), 500);
                return;
            }

            kakao.maps.load(function() {
                const mapOption = {
                    center: new kakao.maps.LatLng(35.1796, 129.0756),
                    level: 7
                };

                const map = new kakao.maps.Map(mapContainer, mapOption);
                const geocoder = new kakao.maps.services.Geocoder();
                const bounds = new kakao.maps.LatLngBounds();
                let processedCount = 0;
                let totalCount = locations.length;

                locations.forEach((location) => {
                    const address = location['새주소'];
                    if (!address) {
                        processedCount++;
                        return;
                    }

                    geocoder.addressSearch(address, function(result, status) {
                        processedCount++;
                        state.mapLoadingProgress = Math.floor((processedCount / totalCount) * 100);
                        
                        if (status === kakao.maps.services.Status.OK && result[0]) {
                            const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                            bounds.extend(coords);

                            const marker = new kakao.maps.Marker({ position: coords, map: map });

                            const infowindow = new kakao.maps.InfoWindow({
                                content: '<div style="padding:10px;font-size:12px;"><strong>' + location['시설명'] + '</strong><br/>' + location['새주소'] + '</div>'
                            });

                            kakao.maps.event.addListener(marker, 'mouseover', function() { infowindow.open(map, marker); });
                            kakao.maps.event.addListener(marker, 'mouseout', function() { infowindow.close(); });
                        }

                        if (processedCount === totalCount) {
                            setTimeout(function() {
                                if (!bounds.isEmpty()) map.setBounds(bounds);
                                state.isLoadingMap = false;
                            }, 300);
                        }
                    });
                });
            });
        }

        // ======================== 이벤트 리스너 ========================
        function attachEventListeners() {
            try {
                // 탭 버튼
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        state.activeTab = e.target.dataset.tab;
                        render();
                    });
                });

                // 연도 선택
                const yearSelect = document.getElementById('yearSelect');
                if (yearSelect) yearSelect.addEventListener('change', (e) => {
                    state.selectedYear = parseInt(e.target.value);
                    render();
                });

                // 클라우드 버튼
                const cloudSaveBtn = document.getElementById('cloudSaveBtn');
                if (cloudSaveBtn) cloudSaveBtn.addEventListener('click', cloudSaveData);

                const cloudLoadBtn = document.getElementById('cloudLoadBtn');
                if (cloudLoadBtn) cloudLoadBtn.addEventListener('click', cloudLoadData);

                const cloudLoadWelcomeBtn = document.getElementById('cloudLoadWelcomeBtn');
                if (cloudLoadWelcomeBtn) cloudLoadWelcomeBtn.addEventListener('click', cloudLoadData);

                const historyBtn = document.getElementById('historyBtn');
                if (historyBtn) historyBtn.addEventListener('click', loadHistory);

                // 히스토리 모달
                const historyCloseBtn = document.getElementById('historyCloseBtn');
                if (historyCloseBtn) historyCloseBtn.addEventListener('click', () => {
                    state.showHistoryModal = false;
                    render();
                });

                const historyRefreshBtn = document.getElementById('historyRefreshBtn');
                if (historyRefreshBtn) historyRefreshBtn.addEventListener('click', loadHistory);

                // 환영 화면
                const sampleDataBtn = document.getElementById('sampleDataBtn');
                if (sampleDataBtn) sampleDataBtn.addEventListener('click', createSampleData);

                const welcomeFileInput = document.getElementById('welcomeFileInput');
                if (welcomeFileInput) welcomeFileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

                const emptyStartBtn = document.getElementById('emptyStartBtn');
                if (emptyStartBtn) emptyStartBtn.addEventListener('click', () => {
                    state.showWelcome = false;
                    render();
                });

                // 관리자
                const adminLoginBtn = document.getElementById('adminLoginBtn');
                if (adminLoginBtn) adminLoginBtn.addEventListener('click', () => {
                    const pwd = document.getElementById('adminPassword').value;
                    if (pwd === 'kgt7848848!') {
                        state.showAdmin = true;
                        render();
                    } else {
                        alert('비밀번호가 올바르지 않습니다.');
                    }
                });

                const clearAllBtn = document.getElementById('clearAllBtn');
                if (clearAllBtn) clearAllBtn.addEventListener('click', clearAllData);

                // 통합 탭 버튼들
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv,.xlsx,.xls';
                    uploadBtn.addEventListener('click', () => input.click());
                    input.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
                }

                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) downloadBtn.addEventListener('click', () => {
                    state.showDownloadMenu = !state.showDownloadMenu;
                    render();
                });

                const downloadExcelBtn = document.getElementById('downloadExcelBtn');
                if (downloadExcelBtn) downloadExcelBtn.addEventListener('click', downloadAsExcel);

                const downloadCSVBtn = document.getElementById('downloadCSVBtn');
                if (downloadCSVBtn) downloadCSVBtn.addEventListener('click', downloadAsCSV);

                const sampleBtn = document.getElementById('sampleBtn');
                if (sampleBtn) sampleBtn.addEventListener('click', createSampleData);

                const editToggleBtn = document.getElementById('editToggleBtn');
                if (editToggleBtn) editToggleBtn.addEventListener('click', () => {
                    state.isEditing = !state.isEditing;
                    render();
                });

                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) saveBtn.addEventListener('click', () => {
                    saveDataToStorage();
                    alert('💾 데이터가 저장되었습니다.');
                });

                const copyBtn = document.getElementById('copyBtn');
                if (copyBtn) copyBtn.addEventListener('click', copyToApplication);

                const deleteBtn = document.getElementById('deleteBtn');
                if (deleteBtn) deleteBtn.addEventListener('click', deleteSelectedRows);

                const detailBtn = document.getElementById('detailBtn');
                if (detailBtn) detailBtn.addEventListener('click', openDetailModal);

                // 행정구역 드롭다운
                const regionDropdownBtn = document.getElementById('regionDropdownBtn');
                if (regionDropdownBtn) regionDropdownBtn.addEventListener('click', () => {
                    state.showRegionDropdown = !state.showRegionDropdown;
                    render();
                });

                // 조회 버튼
                const searchBtn = document.getElementById('searchBtn');
                if (searchBtn) searchBtn.addEventListener('click', () => {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) state.searchTerm = searchInput.value;
                    state.currentPage = 1;
                    render();
                });

                const searchInput = document.getElementById('searchInput');
                if (searchInput) searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        state.searchTerm = e.target.value;
                        state.currentPage = 1;
                        render();
                    }
                });

                // 필터 초기화
                const mainFilterResetBtn = document.getElementById('mainFilterResetBtn');
                if (mainFilterResetBtn) mainFilterResetBtn.addEventListener('click', () => {
                    state.filters = { region: [], month: '', inspectionHistory: '' };
                    state.searchTerm = '';
                    state.currentPage = 1;
                    state.showRegionDropdown = false;
                    render();
                });

                // 행 선택
                const selectAllRows = document.getElementById('selectAllRows');
                if (selectAllRows) selectAllRows.addEventListener('change', () => {
                    if (selectAllRows.checked) {
                        state.selectedRows = new Set(state.filteredData.map((_, i) => i));
                    } else {
                        state.selectedRows = new Set();
                    }
                    render();
                });

                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.selectedRows.add(idx);
                        } else {
                            state.selectedRows.delete(idx);
                        }
                    });
                });

               

                // 셀 편집
                document.querySelectorAll('.cell-edit').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const col = e.target.dataset.col;
                        state.data[state.selectedYear][idx][col] = e.target.value;
                    });
                });

                // 지역 필터
                const selectAllRegions = document.getElementById('selectAllRegions');
                if (selectAllRegions) selectAllRegions.addEventListener('change', (e) => {
                    const uniqueRegions = [...new Set(
                        (state.data[state.selectedYear] || []).map(row => (row['행정구역'] || '').replace(/[\\\/]/g, '').trim()).filter(Boolean)
                    )];
                    state.filters.region = e.target.checked ? [...uniqueRegions] : [];
                    render();
                });

                document.querySelectorAll('.region-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const region = e.target.value;
                        if (e.target.checked) {
                            state.filters.region.push(region);
                        } else {
                            state.filters.region = state.filters.region.filter(r => r !== region);
                        }
                    });
                });

                // 페이지네이션
                const prevPageBtn = document.getElementById('prevPageBtn');
                if (prevPageBtn) prevPageBtn.addEventListener('click', () => {
                    state.currentPage = Math.max(1, state.currentPage - 1);
                    render();
                });

                const nextPageBtn = document.getElementById('nextPageBtn');
                if (nextPageBtn) nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);
                    state.currentPage = Math.min(totalPages, state.currentPage + 1);
                    render();
                });

                // 신청접수대장 탭
                const targetYearSelect = document.getElementById('targetYearSelect');
                if (targetYearSelect) targetYearSelect.addEventListener('change', (e) => {
                    state.targetYear = parseInt(e.target.value);
                    render();
                });

                const inspectionYearSelect = document.getElementById('inspectionYearSelect');
                if (inspectionYearSelect) inspectionYearSelect.addEventListener('change', (e) => {
                    state.inspectionYear = parseInt(e.target.value);
                    render();
                });

               const appUploadBtn = document.getElementById('appUploadBtn');
if (appUploadBtn) {
    const appInput = document.createElement('input');
    appInput.type = 'file';
    appInput.accept = '.csv,.xlsx,.xls';
    appUploadBtn.addEventListener('click', () => appInput.click());
    appInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
            state.isLoading = true;
            state.loadingProgress = 30;
            render();
            const fileExt = file.name.split('.').pop().toLowerCase();
            let parsedData;
            if (fileExt === 'xlsx' || fileExt === 'xls') {
                parsedData = await parseExcelFile(file);
            } else if (fileExt === 'csv') {
                parsedData = await parseCSVFile(file);
            }
            if (!parsedData || !Array.isArray(parsedData)) {
                throw new Error('파일을 파싱할 수 없습니다.');
            }
            // 월사용예정량을 사용량으로 매핑
            parsedData.forEach(row => {
                if (row['월사용예정량'] && !row['사용량']) {
                    row['사용량'] = row['월사용예정량'];
                }
            });
            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }
            state.applicationData[state.targetYear] = [...parsedData, ...state.applicationData[state.targetYear]];
            state.isLoading = false;
            saveDataToStorage();
            alert(`✅ ${parsedData.length}개의 데이터가 신청접수대장에 업로드되었습니다.`);
            render();
        } catch (error) {
            state.isLoading = false;
            alert('파일 처리 오류: ' + error.message);
            render();
        }
    });
} 

                const appAddRowBtn = document.getElementById('appAddRowBtn');
                if (appAddRowBtn) appAddRowBtn.addEventListener('click', addApplicationRow);

                const appDeleteRowBtn = document.getElementById('appDeleteRowBtn');
                if (appDeleteRowBtn) appDeleteRowBtn.addEventListener('click', deleteSelectedApplicationRows);

                const appCertBtn = document.getElementById('appCertBtn');
                if (appCertBtn) appCertBtn.addEventListener('click', generateCertificateNumbers);

                const appSaveBtn = document.getElementById('appSaveBtn');
                if (appSaveBtn) appSaveBtn.addEventListener('click', () => {
                    saveDataToStorage();
                    alert('💾 데이터가 저장되었습니다.');
                });

                const appDownloadBtn = document.getElementById('appDownloadBtn');
if (appDownloadBtn) appDownloadBtn.addEventListener('click', () => {
    const currentAppData = state.applicationData[state.targetYear] || [];
    const dataToDownload = state.selectedApplicationRows.size > 0
        ? currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx))
        : currentAppData;
    if (dataToDownload.length === 0) {
        alert('다운로드할 데이터가 없습니다.');
        return;
    }
    const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: applicationColumns });
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, '신청접수대장');
    XLSX.writeFile(workbook, `신청접수대장_${state.targetYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
});
                
                const appEditToggleBtn = document.getElementById('appEditToggleBtn');
                if (appEditToggleBtn) appEditToggleBtn.addEventListener('click', () => {
                    state.isEditingApplication = !state.isEditingApplication;
                    render();
                });

                const selectAllAppRows = document.getElementById('selectAllAppRows');
                if (selectAllAppRows) selectAllAppRows.addEventListener('change', (e) => {
                    const currentAppData = state.applicationData[state.targetYear] || [];
                    if (e.target.checked) {
                        state.selectedApplicationRows = new Set(currentAppData.map((_, i) => i));
                    } else {
                        state.selectedApplicationRows = new Set();
                    }
                    render();
                });

                document.querySelectorAll('.app-row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.selectedApplicationRows.add(idx);
                        } else {
                            state.selectedApplicationRows.delete(idx);
                        }
                    });
                });

               
                document.querySelectorAll('.app-cell-edit').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const col = e.target.dataset.col;
                        state.applicationData[state.targetYear][idx][col] = e.target.value;
                        
                        if (col === '신청일' && e.target.value && !state.applicationData[state.targetYear][idx]['필증번호']) {
                            state.applicationData[state.targetYear][idx]['필증번호'] = generateCertificateNumber(e.target.value, state.targetYear);
                        }
                        
                        saveDataToStorage();
                    });
                });

                const cutBtn = document.getElementById('cutBtn');
                if (cutBtn) cutBtn.addEventListener('click', cutToInspectionYear);

               const cancelBtn = document.getElementById('cancelBtn');
                if (cancelBtn) cancelBtn.addEventListener('click', moveToCancel);

                const appMapBtn = document.getElementById('appMapBtn');
                if (appMapBtn) appMapBtn.addEventListener('click', () => {
                    const currentAppData = state.applicationData[state.targetYear] || [];
                    const selectedData = state.selectedApplicationRows.size > 0
                        ? currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx))
                        : [];
                    if (selectedData.length === 0) {
                        alert('지도에 표시할 행을 선택해주세요.');
                        return;
                    }
                    state.mapData = selectedData;
                    state.showMapModal = true;
                    state.isLoadingMap = true;
                    state.mapLoadingProgress = 0;
                    render();
                    setTimeout(() => initMap(selectedData), 100);
                });

                const appDetailBtn = document.getElementById('appDetailBtn');
                if (appDetailBtn) appDetailBtn.addEventListener('click', openAppDetailModal);

                const appSearchBtn = document.getElementById('appSearchBtn');
                if (appSearchBtn) appSearchBtn.addEventListener('click', () => {
                    const searchInput = document.getElementById('appSearchInput');
                    if (searchInput) state.applicationSearchTerm = searchInput.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appSearchInput = document.getElementById('appSearchInput');
                if (appSearchInput) appSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        state.applicationSearchTerm = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    }
                });

                const appRegionFilter = document.getElementById('appRegionFilter');
if (appRegionFilter) appRegionFilter.addEventListener('change', (e) => {
    state.applicationFilters.region = e.target.value ? [e.target.value] : [];
    state.currentApplicationPage = 1;
    render();
});

const appInspectorFilter = document.getElementById('appInspectorFilter');
if (appInspectorFilter) appInspectorFilter.addEventListener('change', (e) => {
    state.applicationFilters.inspector = e.target.value;
    state.currentApplicationPage = 1;
    render();
});

const appResultFilter = document.getElementById('appResultFilter');
if (appResultFilter) appResultFilter.addEventListener('change', (e) => {
    state.applicationFilters.inspectionResult = e.target.value;
    state.currentApplicationPage = 1;
    render();
});

const appReceiptFilter = document.getElementById('appReceiptFilter');
if (appReceiptFilter) appReceiptFilter.addEventListener('change', (e) => {
    state.applicationFilters.receiptLocation = e.target.value;
    state.currentApplicationPage = 1;
    render();
});

const appBaseMonthFilter = document.getElementById('appBaseMonthFilter');
if (appBaseMonthFilter) appBaseMonthFilter.addEventListener('change', (e) => {
    state.applicationFilters.baseMonth = e.target.value;
    state.currentApplicationPage = 1;
    render();
});

const appDateFrom = document.getElementById('appDateFrom');
if (appDateFrom) appDateFrom.addEventListener('change', (e) => {
    state.applicationFilters.applicationDateFrom = e.target.value;
    state.currentApplicationPage = 1;
    render();
});

const appDateTo = document.getElementById('appDateTo');
if (appDateTo) appDateTo.addEventListener('change', (e) => {
    state.applicationFilters.applicationDateTo = e.target.value;
    state.currentApplicationPage = 1;
    render();
});

const appInspDateFrom = document.getElementById('appInspDateFrom');
if (appInspDateFrom) appInspDateFrom.addEventListener('change', (e) => {
    state.applicationFilters.inspectionDateFrom = e.target.value;
    state.currentApplicationPage = 1;
    render();
});

const appInspDateTo = document.getElementById('appInspDateTo');
if (appInspDateTo) appInspDateTo.addEventListener('change', (e) => {
    state.applicationFilters.inspectionDateTo = e.target.value;
    state.currentApplicationPage = 1;
    render();
});

const appFeeFilter = document.getElementById('appFeeFilter');
if (appFeeFilter) appFeeFilter.addEventListener('change', (e) => {
    state.applicationFilters.fee = e.target.value;
    state.currentApplicationPage = 1;
    render();
});

const appFilterResetBtn = document.getElementById('appFilterResetBtn');
if (appFilterResetBtn) appFilterResetBtn.addEventListener('click', () => {
                    state.applicationFilters = { region: [], inspector: '', receiptLocation: '', inspectionResult: '', applicationDateFrom: '', applicationDateTo: '', inspectionDateFrom: '', inspectionDateTo: '', baseMonth: '', fee: '', facilityCert: '', certificateStatus: '', insuranceStatus: '' };
                    state.applicationSearchTerm = '';
                    state.currentApplicationPage = 1;
                    render();
                });

                const appPrevPageBtn = document.getElementById('appPrevPageBtn');
                if (appPrevPageBtn) appPrevPageBtn.addEventListener('click', () => {
                    state.currentApplicationPage = Math.max(1, state.currentApplicationPage - 1);
                    render();
                });

                const appNextPageBtn = document.getElementById('appNextPageBtn');
                if (appNextPageBtn) appNextPageBtn.addEventListener('click', () => {
                    const currentAppData = state.applicationData[state.targetYear] || [];
                    const totalPages = Math.ceil(currentAppData.length / state.itemsPerPage);
                    state.currentApplicationPage = Math.min(totalPages, state.currentApplicationPage + 1);
                    render();
                });

                // 모달 버튼들
                const cancelDupBtn = document.getElementById('cancelDupBtn');
                if (cancelDupBtn) cancelDupBtn.addEventListener('click', () => {
                    state.showDuplicateModal = false;
                    render();
                });

                const confirmDupBtn = document.getElementById('confirmDupBtn');
                if (confirmDupBtn) confirmDupBtn.addEventListener('click', confirmDuplicateCopy);

                const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
                if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => {
                    state.showDeleteModal = false;
                    render();
                });

                const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
                if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', confirmDelete);

                const cancelAppDeleteBtn = document.getElementById('cancelAppDeleteBtn');
                if (cancelAppDeleteBtn) cancelAppDeleteBtn.addEventListener('click', () => {
                    state.showAppDeleteModal = false;
                    render();
                });

                const confirmAppDeleteBtn = document.getElementById('confirmAppDeleteBtn');
                if (confirmAppDeleteBtn) confirmAppDeleteBtn.addEventListener('click', confirmAppDelete);

                // 상세보기 모달
                const detailCancelBtn = document.getElementById('detailCancelBtn');
                if (detailCancelBtn) detailCancelBtn.addEventListener('click', closeDetailModal);

                const detailCloseBtn = document.getElementById('detailCloseBtn');
                if (detailCloseBtn) detailCloseBtn.addEventListener('click', closeDetailModal);

                const detailSaveBtn = document.getElementById('detailSaveBtn');
                if (detailSaveBtn) detailSaveBtn.addEventListener('click', saveFromDetailModal);

                const detailAddBtn = document.getElementById('detailAddBtn');
                if (detailAddBtn) detailAddBtn.addEventListener('click', () => {
                    columns.forEach(col => {
                        const input = document.getElementById(`detail-${col}`);
                        if (input) state.detailModalData[col] = input.value;
                    });
                    addFromDetailModal();
                });

                const appDetailCancelBtn = document.getElementById('appDetailCancelBtn');
                if (appDetailCancelBtn) appDetailCancelBtn.addEventListener('click', closeAppDetailModal);

                const appDetailCloseBtn = document.getElementById('appDetailCloseBtn');
                if (appDetailCloseBtn) appDetailCloseBtn.addEventListener('click', closeAppDetailModal);

                const appDetailSaveBtn = document.getElementById('appDetailSaveBtn');
                if (appDetailSaveBtn) appDetailSaveBtn.addEventListener('click', saveFromAppDetailModal);

                const appDetailAddBtn = document.getElementById('appDetailAddBtn');
                if (appDetailAddBtn) appDetailAddBtn.addEventListener('click', addFromAppDetailModal);

                // 경로당 탭 이벤트
const pathwayUploadBtn = document.getElementById('pathwayUploadBtn');
if (pathwayUploadBtn) {
    const pathwayInput = document.createElement('input');
    pathwayInput.type = 'file';
    pathwayInput.accept = '.csv,.xlsx,.xls';
    pathwayUploadBtn.addEventListener('click', () => pathwayInput.click());
    pathwayInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
            state.isLoading = true;
            state.loadingProgress = 30;
            render();
            const fileExt = file.name.split('.').pop().toLowerCase();
            let parsedData;
            if (fileExt === 'xlsx' || fileExt === 'xls') {
                parsedData = await parseExcelFile(file);
            } else if (fileExt === 'csv') {
                parsedData = await parseCSVFile(file);
            }
            if (!state.pathwayData[state.selectedYear]) {
                state.pathwayData[state.selectedYear] = [];
            }
            state.pathwayData[state.selectedYear] = [...parsedData, ...state.pathwayData[state.selectedYear]];
            state.isLoading = false;
            saveDataToStorage();
            alert(`✅ ${parsedData.length}개의 데이터가 경로당에 업로드되었습니다.`);
            render();
        } catch (error) {
            state.isLoading = false;
            alert('파일 처리 오류: ' + error.message);
            render();
        }
    });
}

const pathwayDownloadBtn = document.getElementById('pathwayDownloadBtn');
if (pathwayDownloadBtn) pathwayDownloadBtn.addEventListener('click', () => {
    const dataToDownload = state.pathway.selectedRows.size > 0
        ? (state.pathwayData[state.selectedYear] || []).filter((_, idx) => state.pathway.selectedRows.has(idx))
        : (state.pathwayData[state.selectedYear] || []);
    if (dataToDownload.length === 0) {
        alert('다운로드할 데이터가 없습니다.');
        return;
    }
    const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: pathwayColumns });
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, '경로당');
    XLSX.writeFile(workbook, `경로당_${state.selectedYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
});

const pathwayDeleteBtn = document.getElementById('pathwayDeleteBtn');
if (pathwayDeleteBtn) pathwayDeleteBtn.addEventListener('click', () => {
    if (state.pathway.selectedRows.size === 0) {
        alert('삭제할 행을 선택해주세요.');
        return;
    }
    if (confirm(`${state.pathway.selectedRows.size}개 항목을 삭제하시겠습니까?`)) {
        const currentData = state.pathwayData[state.selectedYear] || [];
        state.pathwayData[state.selectedYear] = currentData.filter((_, idx) => !state.pathway.selectedRows.has(idx));
        state.pathway.selectedRows = new Set();
        saveDataToStorage();
        alert('삭제되었습니다.');
        render();
    }
});

const pathwaySaveBtn = document.getElementById('pathwaySaveBtn');
if (pathwaySaveBtn) pathwaySaveBtn.addEventListener('click', () => {
    saveDataToStorage();
    alert('💾 데이터가 저장되었습니다.');
});

const pathwayEditToggleBtn = document.getElementById('pathwayEditToggleBtn');
if (pathwayEditToggleBtn) pathwayEditToggleBtn.addEventListener('click', () => {
    state.pathway.isEditing = !state.pathway.isEditing;
    render();
});

const pathwayAddRowBtn = document.getElementById('pathwayAddRowBtn');
if (pathwayAddRowBtn) pathwayAddRowBtn.addEventListener('click', () => {
    const newRow = {};
    pathwayColumns.forEach(col => newRow[col] = '');
    if (!state.pathwayData[state.selectedYear]) {
        state.pathwayData[state.selectedYear] = [];
    }
    state.pathwayData[state.selectedYear] = [newRow, ...state.pathwayData[state.selectedYear]];
    saveDataToStorage();
    render();
});

const pathwayMapBtn = document.getElementById('pathwayMapBtn');
if (pathwayMapBtn) pathwayMapBtn.addEventListener('click', () => {
    const selectedData = state.pathway.selectedRows.size > 0
        ? (state.pathwayData[state.selectedYear] || []).filter((_, idx) => state.pathway.selectedRows.has(idx))
        : [];
    if (selectedData.length === 0) {
        alert('지도에 표시할 행을 선택해주세요.');
        return;
    }
    state.mapData = selectedData;
    state.showMapModal = true;
    state.isLoadingMap = true;
    state.mapLoadingProgress = 0;
    render();
    setTimeout(() => initMap(selectedData), 100);
});

const pathwayRegionFilter = document.getElementById('pathwayRegionFilter');
if (pathwayRegionFilter) pathwayRegionFilter.addEventListener('change', (e) => {
    state.pathway.filters.region = e.target.value;
    state.pathway.currentPage = 1;
    render();
});

const pathwaySearchBtn = document.getElementById('pathwaySearchBtn');
if (pathwaySearchBtn) pathwaySearchBtn.addEventListener('click', () => {
    const searchInput = document.getElementById('pathwaySearchInput');
    if (searchInput) state.pathway.searchTerm = searchInput.value;
    state.pathway.currentPage = 1;
    render();
});

const pathwaySearchInput = document.getElementById('pathwaySearchInput');
if (pathwaySearchInput) pathwaySearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        state.pathway.searchTerm = e.target.value;
        state.pathway.currentPage = 1;
        render();
    }
});

const pathwayResetBtn = document.getElementById('pathwayResetBtn');
if (pathwayResetBtn) pathwayResetBtn.addEventListener('click', () => {
    state.pathway.filters.region = '';
    state.pathway.searchTerm = '';
    state.pathway.currentPage = 1;
    render();
});

const selectAllPathwayRows = document.getElementById('selectAllPathwayRows');
if (selectAllPathwayRows) selectAllPathwayRows.addEventListener('change', (e) => {
    const currentData = state.pathwayData[state.selectedYear] || [];
    if (e.target.checked) {
        state.pathway.selectedRows = new Set(currentData.map((_, i) => i));
    } else {
        state.pathway.selectedRows = new Set();
    }
    render();
});

document.querySelectorAll('.pathway-row-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
        const idx = parseInt(e.target.dataset.idx);
        if (e.target.checked) {
            state.pathway.selectedRows.add(idx);
        } else {
            state.pathway.selectedRows.delete(idx);
        }
    });
});

document.querySelectorAll('.pathway-cell-edit').forEach(input => {
    input.addEventListener('change', (e) => {
        const idx = parseInt(e.target.dataset.idx);
        const col = e.target.dataset.col;
        state.pathwayData[state.selectedYear][idx][col] = e.target.value;
        saveDataToStorage();
    });
});

const pathwayPrevPageBtn = document.getElementById('pathwayPrevPageBtn');
if (pathwayPrevPageBtn) pathwayPrevPageBtn.addEventListener('click', () => {
    state.pathway.currentPage = Math.max(1, state.pathway.currentPage - 1);
    render();
});

const pathwayNextPageBtn = document.getElementById('pathwayNextPageBtn');
if (pathwayNextPageBtn) pathwayNextPageBtn.addEventListener('click', () => {
    const currentData = state.pathwayData[state.selectedYear] || [];
    const totalPages = Math.ceil(currentData.length / state.itemsPerPage);
    state.pathway.currentPage = Math.min(totalPages, state.pathway.currentPage + 1);
    render();
});

                // 지도 모달
                const mapCloseBtn = document.getElementById('mapCloseBtn');
                if (mapCloseBtn) mapCloseBtn.addEventListener('click', () => {
                    state.showMapModal = false;
                    state.mapData = [];
                    state.isLoadingMap = false;
                    render();
                });

                const mapCancelBtn = document.getElementById('mapCancelBtn');
                if (mapCancelBtn) mapCancelBtn.addEventListener('click', () => {
                    state.showMapModal = false;
                    state.mapData = [];
                    state.isLoadingMap = false;
                    render();
                });

                const mapPrintBtn = document.getElementById('mapPrintBtn');
                if (mapPrintBtn) mapPrintBtn.addEventListener('click', () => window.print());

            } catch (error) {
                console.error('이벤트 리스너 첨부 오류:', error);
            }
        }

        // ======================== 초기화 ========================
        window.addEventListener('load', function() {
            try {
                loadFromLocalStorage();
                updateFilters();
                render();
            } catch (error) {
                console.error('초기화 오류:', error);
            }
        });

        // 자동저장
        setInterval(() => {
            if (state.settings.autoSave && (Object.keys(state.data).length > 0 || Object.keys(state.applicationData).length > 0)) {
                saveDataToStorage();
            }
        }, state.settings.autoSaveInterval * 1000);
    </script>
</body>
</html>











