ì§ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.....<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µì¸ê²€ì‚¬ê¸°ê´€ ì•ˆì „ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    
     <!-- ì•„ì´ì½˜ ì„¤ì • -->
<link rel="icon" type="image/png" href="kgt-logo-192.png">
<link rel="apple-touch-icon" href="kgt-logo-192.png">
<meta name="theme-color" content="#5B4FCF">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c8f5719a2be48f3875087006ce782934&libraries=services&autoload=false"></script>
   
    <style>
        .scroll-x-auto { -webkit-overflow-scrolling: touch; }
        .table-cell-input { width: 100%; padding: 2px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .no-cell { cursor: pointer; user-select: none; }
        .no-cell:hover { background-color: #dbeafe !important; }
        th { resize: horizontal; overflow: hidden; min-width: 50px; }
        td { overflow: hidden; text-overflow: ellipsis; }
        @media print {
            body * { visibility: hidden; }
            .fixed.inset-0 { position: absolute; top: 0; left: 0; visibility: visible; padding: 0 !important; background: white !important; }
            .fixed.inset-0 * { visibility: visible; }
            .fixed.inset-0 > div { width: 100% !important; height: 100vh !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; border-radius: 0 !important; }
            #mapContainer { height: calc(100vh - 80px) !important; flex: 1 !important; }
            #mapLoadingBar { display: none !important; }
            .p-2.bg-gray-50 { padding: 2px !important; max-height: 50px !important; }
            .flex.gap-2.justify-end { display: none !important; }
            #mapFacilityOverlay { display: block !important; }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-sky-400 to-sky-200 min-h-screen">
    <div id="app"></div>

    <script>
        const GOOGLE_CONFIG = {
            SPREADSHEET_ID: '1s_rI5f5rb65o0sDW7KMDGbPSuHc0jJ-mwlT-ZDZ3Imo',
            WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbyyJdTWamI83Bet-w07pGIWh26rn_4NrrW15Bi2HfsYxV62sQHxuSr8HcXf7LZ9SaxQ8Q/exec'
        };

            const state = {
            currentYear: new Date().getFullYear(),
            activeTab: 'í†µí•©',
            selectedYear: new Date().getFullYear(),
            data: {},
            filteredData: [],
            applicationData: {},
            quarterData: {},
            cancellationData: {},
            pathwayData: {},
            resourceData: {}, 
            currentPage: 1,
            selectedRows: new Set(),
            isLoading: false,
            loadingProgress: 0,
            searchTerm: '',
            isEditing: false,
            showAdmin: false,
            adminPassword: '',
            showWelcome: true,
            lastSaved: null,
            showDownloadMenu: false,
            showAppDownloadMenu: false,
            uploadedFileName: '',
            showDuplicateModal: false,
            duplicateInfo: { duplicates: [], selectedData: [] },
            inspectionYear: new Date().getFullYear(),
            targetYear: new Date().getFullYear(),
            applicationFilters: {
                region: [], inspector: '', receiptLocation: '', inspectionResult: '',
                applicationDateFrom: '', applicationDateTo: '', inspectionDateFrom: '', inspectionDateTo: '',
                baseMonth: '', fee: '', facilityCert: '', certificateStatus: '', insuranceStatus: ''
            },
            applicationSearchTerm: '',
            selectedApplicationRows: new Set(),
            isEditingApplication: false,
            currentApplicationPage: 1,
            selectedQuarterRows: new Set(),
            isEditingQuarter: false,
            currentQuarterPage: 1,
            isEditingCancellation: false,
            selectedCancellationRows: new Set(),
            showDeleteModal: false,
            showAppDeleteModal: false,
            showDetailModal: false,
            detailModalData: {},
            detailModalSelectedIdx: null,
            showAppDetailModal: false,
            appDetailModalData: {},
            appDetailModalSelectedIdx: null,
            filters: { region: [], month: '', inspectionHistory: '' },
            showRegionDropdown: false,
            showMonthDropdown: false,
            showInspectionDropdown: false,
            settings: { companyName: 'ê³µì¸ê²€ì‚¬ê¸°ê´€', maxFileSize: 100, autoSave: true, autoSaveInterval: 30 },
            itemsPerPage: 50,
            inspectors: ['ìµœì¤‘ìˆ˜', 'ê¹€íƒì‹ ', 'ê¹€ì¶˜ì‹', 'ê¹€ì •ë§Œ'],
            receiptLocations: ['ì§€ë¡œ', 'êµ­ë¯¼', 'ë¶€ì‚°', 'ë†í˜‘', 'ê²½ë‚¨', 'í›„ë‚©', 'ê¸°íƒ€'],
            inspectionResults: ['í•©ê²©', 'ë¶ˆí•©ê²©', 'ì´ì¤‘ë‚©ë¶€','ê³µë€', 'ê¸°íƒ€'],
            yearRange: Array.from({ length: 37 }, (_, i) => 2014 + i),
            cancelReasons: ['ì…ê¸ˆ ë¯¸í™•ì¸', 'ê³ ê° ìš”ì²­', 'ì¤‘ë³µ ì‹ ì²­', 'ê¸°íƒ€'],
            showMapModal: false,
            mapData: [],
            isLoadingMap: false,
            mapLoadingProgress: 0,
            quarter: {
                selectedQuarter: 'Q1',
                selectedRecipient: '',
                quarters: ['1ë¶„ê¸°', '2ë¶„ê¸°', '3ë¶„ê¸°', '4ë¶„ê¸°'],
                recipients: {
                    'ë¶€ì‚°ì‹œì²­': ['ë¶€ì‚° ê°•ì„œêµ¬', 'ë¶€ì‚° ë‚¨êµ¬', 'ë¶€ì‚° ë™êµ¬', 'ë¶€ì‚° ë¶€ì‚°ì§„êµ¬', 'ë¶€ì‚° ì‚¬ìƒêµ¬', 'ë¶€ì‚° ì‚¬í•˜êµ¬', 'ë¶€ì‚° ì„œêµ¬', 'ë¶€ì‚° ìˆ˜ì˜êµ¬', 'ë¶€ì‚° ì˜ë„êµ¬', 'ë¶€ì‚° ì¤‘êµ¬', 'ë¶€ì‚° í•´ìš´ëŒ€êµ¬', 'ë¶€ì‚° ê¸ˆì •êµ¬', 'ë¶€ì‚° ê¸°ì¥êµ°', 'ë¶€ì‚° ë™ë˜êµ¬', 'ë¶€ì‚° ì—°ì œêµ¬', 'ë¶€ì‚° ë¶êµ¬'],
                    'ê°•ì„œêµ¬ì²­ì¥': ['ë¶€ì‚° ê°•ì„œêµ¬'], 'ë‚¨êµ¬ì²­ì¥': ['ë¶€ì‚° ë‚¨êµ¬'], 'ë™êµ¬ì²­ì¥': ['ë¶€ì‚° ë™êµ¬'],
                    'ë¶€ì‚°ì§„êµ¬ì²­ì¥': ['ë¶€ì‚° ë¶€ì‚°ì§„êµ¬'], 'ì‚¬ìƒêµ¬ì²­ì¥': ['ë¶€ì‚° ì‚¬ìƒêµ¬'], 'ì‚¬í•˜êµ¬ì²­ì¥': ['ë¶€ì‚° ì‚¬í•˜êµ¬'],
                    'ì„œêµ¬ì²­ì¥': ['ë¶€ì‚° ì„œêµ¬'], 'ìˆ˜ì˜êµ¬ì²­ì¥': ['ë¶€ì‚° ìˆ˜ì˜êµ¬'], 'ì˜ë„êµ¬ì²­ì¥': ['ë¶€ì‚° ì˜ë„êµ¬'],
                    'ì¤‘êµ¬ì²­ì¥': ['ë¶€ì‚° ì¤‘êµ¬'], 'í•´ìš´ëŒ€êµ¬ì²­ì¥': ['ë¶€ì‚° í•´ìš´ëŒ€êµ¬'], 'ê¸ˆì •êµ¬ì²­ì¥': ['ë¶€ì‚° ê¸ˆì •êµ¬'],
                    'ê¸°ì¥êµ°ìˆ˜': ['ë¶€ì‚° ê¸°ì¥êµ°'], 'ë™ë˜êµ¬ì²­ì¥': ['ë¶€ì‚° ë™ë˜êµ¬'], 'ì—°ì œêµ¬ì²­ì¥': ['ë¶€ì‚° ì—°ì œêµ¬'],
                    'ë¶êµ¬ì²­ì¥': ['ë¶€ì‚° ë¶êµ¬'], 'ìš¸ì‚°ê´‘ì—­ì‹œ ë¶êµ¬ì²­ì¥': ['ìš¸ì‚° ë¶êµ¬'],
                    'ê¹€í•´ì‹œì²­': ['ê²½ë‚¨ ê¹€í•´ì‹œ'], 'ì–‘ì‚°ì‹œì²­': ['ê²½ë‚¨ ì–‘ì‚°ì‹œ'], 'ì‚¬ì²œì‹œì²­': ['ê²½ë‚¨ ì‚¬ì²œì‹œ'],
                    'í†µì˜ì‹œì²­': ['ê²½ë‚¨ í†µì˜ì‹œ'], 'ê±°ì œì‹œì²­': ['ê²½ë‚¨ ê±°ì œì‹œ'], 'í¬í•­ì‹œì²­': ['ê²½ë¶ í¬í•­ì‹œ'],
                    'ê²½ì£¼ì‹œì²­': ['ê²½ë¶ ê²½ì£¼ì‹œ'], 'êµ¬ë¯¸ì‹œì²­': ['ê²½ë¶ êµ¬ë¯¸ì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ë¶€ì‚°ì§€ì—­ë³¸ë¶€': ['ë¶€ì‚° ê°•ì„œêµ¬', 'ë¶€ì‚° ë‚¨êµ¬', 'ë¶€ì‚° ë™êµ¬', 'ë¶€ì‚° ë¶€ì‚°ì§„êµ¬', 'ë¶€ì‚° ì‚¬ìƒêµ¬', 'ë¶€ì‚° ì‚¬í•˜êµ¬', 'ë¶€ì‚° ì„œêµ¬', 'ë¶€ì‚° ìˆ˜ì˜êµ¬', 'ë¶€ì‚° ì˜ë„êµ¬', 'ë¶€ì‚° ì¤‘êµ¬'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ë¶ë¶€ì§€ì‚¬': ['ë¶€ì‚° í•´ìš´ëŒ€êµ¬', 'ë¶€ì‚° ê¸ˆì •êµ¬', 'ë¶€ì‚° ê¸°ì¥êµ°', 'ë¶€ì‚° ë™ë˜êµ¬', 'ë¶€ì‚° ì—°ì œêµ¬', 'ë¶€ì‚° ë¶êµ¬'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ìš¸ì‚°ì§€ì‚¬': ['ìš¸ì‚° ë¶êµ¬'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ì°½ì›ì§€ì‚¬': ['ê²½ë‚¨ ê¹€í•´ì‹œ', 'ê²½ë‚¨ ì–‘ì‚°ì‹œ', 'ê²½ë‚¨ í†µì˜ì‹œ', 'ê²½ë‚¨ ê±°ì œì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ì§„ì£¼ì§€ì‚¬': ['ê²½ë‚¨ ì‚¬ì²œì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ê²½ë¶ë™ë¶€ì§€ì‚¬': ['ê²½ë¶ í¬í•­ì‹œ', 'ê²½ë¶ ê²½ì£¼ì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ëŒ€êµ¬ê²½ë¶ì§€ì—­ë³¸ë¶€': ['ê²½ë¶ êµ¬ë¯¸ì‹œ'],
                    'ì–‘ì‚°ì‹œì²­ ì›…ìƒì¶œì¥ì†Œ ê²½ì¬í™˜ê²½ê³¼': ['ê²½ë‚¨ ì–‘ì‚°ì‹œ']
                }
            },
            pathway: { searchTerm: '', selectedRows: new Set(), isEditing: false, currentPage: 1, filters: { region: '' }, showDownloadMenu: false },
            resource: { files: [], selectedFiles: new Set(), currentFolder: '', searchTerm: '', fileStorage: {} },
            salesUnlocked: false,            resourceUnlocked: false
            };
                    
        const columns = ['ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'êµ¬ì£¼ì†Œ', 'ì‚¬ìš©ëŸ‰', 'ì „í™”ë²ˆí˜¸', 'ê¸°ì¤€ì¼', 'ì•ˆì „ê´€ë¦¬ìëª…', 'ìê²©ì¦ë²ˆí˜¸', 'ë³´í—˜ì‚¬', 'ë³´í—˜ë§Œê¸°ì¼', 'ë©”ëª¨', 'ì‚¬ì—…ìë²ˆí˜¸', 'ëŒ€í‘œìëª…', 'ì—…íƒœ', 'ì¢…ëª©', 'ì´ë©”ì¼', 'ë©´ì œëŒ€ìƒ', 'ê²€ì‚¬ì´ë ¥'];
        const applicationColumns = ['ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'êµ¬ì£¼ì†Œ', 'ì‚¬ìš©ëŸ‰', 'ì „í™”ë²ˆí˜¸', 'ê¸°ì¤€ì¼', 'ì•ˆì „ê´€ë¦¬ìëª…', 'ìê²©ì¦ë²ˆí˜¸', 'ë³´í—˜ì‚¬', 'ë³´í—˜ë§Œê¸°ì¼', 'ë©”ëª¨', 'ê²€ì‚¬ì¼', 'ì‹ ì²­ì¼', 'ê²€ì‚¬ì›', 'ê²€ì‚¬ê²°ê³¼', 'í•„ì¦ë²ˆí˜¸', 'ìˆ˜ìˆ˜ë£Œ', 'ì ‘ìˆ˜ì²˜', 'ê³„ì‚°ì„œë°œí–‰ì¼', 'ë©”ëª¨2', 'ê²€ì‚¬í™•ì¸'];
        const quarterColumns = ['ë¶„ê¸°', 'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ì‹ ì²­ì¼', 'ê²€ì‚¬ì¼', 'ê²€ì‚¬ì›', 'ê²€ì‚¬ê²°ê³¼', 'í•„ì¦ë²ˆí˜¸', 'ë©”ëª¨'];
        const cancellationColumns = ['ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'ì‹ ì²­ì¼', 'ì·¨ì†Œì‚¬ìœ ', 'ì·¨ì†Œì¼', 'ìˆ˜ìˆ˜ë£Œ', 'ì ‘ìˆ˜ì²˜','ê³„ì¢Œ', 'ë¹„ê³ '];
        const pathwayColumns = ['ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìë©´ë™', 'ìƒˆì£¼ì†Œ', 'ì „í™”ë²ˆí˜¸', 'ì‚¬ìš©ê°€ìŠ¤', 'ì°¨ë‹¨ê¸°', 'íƒ€ì´ë¨¸', 'COê²½ë³´ê¸°', 'ëˆ„ì„¤', 'ì ê²€ì¼', 'ì ê²€ì', 'ë¹„ê³ ', 'ì°¸ì¡°'];
        const pathwayOptions = { regions: ['ìš¸ì£¼êµ°', 'ë¶êµ¬', 'ë‚¨êµ¬', 'ì¤‘êµ¬', 'ë™êµ¬'], gas: ['LPG', 'ë„ì‹œê°€ìŠ¤', 'LPG+ë„ì‹œê°€ìŠ¤'], device: ['ì„¤ì¹˜', 'ë¯¸ì„¤ì¹˜', 'ë¶ˆëŸ‰', 'í•´ë‹¹ì—†ìŠ´'], leak: ['ìœ ', 'ë¬´'], inspectors: ['ìµœì¤‘ìˆ˜', 'ê¹€íƒì‹ ', 'ê¹€ì¶˜ì‹'] };
        const columnWidths = { 'ì‹œì„¤ë²ˆí˜¸': '120px', 'ì‹œì„¤ëª…': '150px', 'í–‰ì •êµ¬ì—­': '100px', 'ìƒˆì£¼ì†Œ': '200px', 'êµ¬ì£¼ì†Œ': '120px', 'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰': '100px', 'ì „í™”ë²ˆí˜¸': '110px', 'ê¸°ì¤€ì¼': '100px', 'ì•ˆì „ê´€ë¦¬ìëª…': '90px', 'ìê²©ì¦ë²ˆí˜¸': '120px', 'ë³´í—˜ì‚¬': '70px', 'ë³´í—˜ë§Œê¸°ì¼': '100px', 'ë©”ëª¨': '150px', 'ê²€ì‚¬ì¼': '100px', 'ì‹ ì²­ì¼': '100px', 'ê²€ì‚¬ì›': '90px', 'ê²€ì‚¬ê²°ê³¼': '70px', 'í•„ì¦ë²ˆí˜¸': '140px', 'ìˆ˜ìˆ˜ë£Œ': '80px', 'ì ‘ìˆ˜ì²˜': '70px', 'ê³„ì‚°ì„œë°œí–‰ì¼': '110px', 'ë©”ëª¨2': '150px', 'ê²€ì‚¬í™•ì¸': '70px', 'ì·¨ì†Œë²ˆí˜¸': '120px', 'ì·¨ì†Œì‚¬ìœ ': '150px', 'ì·¨ì†Œì¼': '100px', 'ì²˜ë¦¬ì': '90px', 'ë¹„ê³ ': '150px' };

// ======================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ========================
        function formatCurrency(value) {
            if (!value || value === '') return '';
            const num = parseInt(String(value).replace(/,/g, ''));
            if (isNaN(num)) return value;
            return num.toLocaleString();
        }

        function generateCertificateNumber(applicationDate, currentIdx) {
            if (!applicationDate) return '';
            const appYear = parseInt(applicationDate.substring(0, 4));
            const appYY = applicationDate.substring(2, 4);
            const appMM = applicationDate.substring(5, 7);
            const appDD = applicationDate.substring(8, 10);
            const currentAppData = state.applicationData[state.targetYear] || [];
            
            if (appYear !== state.inspectionYear) {
                const inspYY = String(state.inspectionYear).substring(2, 4);
                const prefix = `KGT${inspYY}0101-`;
                let maxNum = 0;
                currentAppData.forEach((row, idx) => {
                    if (idx !== currentIdx && row['í•„ì¦ë²ˆí˜¸'] && row['í•„ì¦ë²ˆí˜¸'].startsWith(prefix)) {
                        const numPart = parseInt(row['í•„ì¦ë²ˆí˜¸'].split('-')[1]);
                        if (!isNaN(numPart) && numPart > maxNum) maxNum = numPart;
                    }
                });
                return prefix + String(maxNum + 1).padStart(3, '0');
            }
            
            const prefix = `KGT${appYY}${appMM}${appDD}-`;
            let maxNum = 0;
            currentAppData.forEach((row, idx) => {
                if (idx !== currentIdx && row['í•„ì¦ë²ˆí˜¸'] && row['í•„ì¦ë²ˆí˜¸'].startsWith(prefix)) {
                    const numPart = parseInt(row['í•„ì¦ë²ˆí˜¸'].split('-')[1]);
                    if (!isNaN(numPart) && numPart > maxNum) maxNum = numPart;
                }
            });
            return prefix + String(maxNum + 1).padStart(3, '0');
        }

        async function saveToGoogleSheet(dataToSave) {
    try {
        const jsonData = JSON.stringify({ action: 'bulkSave', allData: dataToSave });
        const sizeInMB = (new Blob([jsonData]).size / (1024 * 1024)).toFixed(2);
        console.log(`ğŸ“¤ êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ ì‹œë„: ${sizeInMB}MB`);
        
        if (parseFloat(sizeInMB) > 500) {
            console.error('âŒ ë°ì´í„°ê°€ 500MBë¥¼ ì´ˆê³¼');
            alert('âŒ ë°ì´í„°ê°€ 500MBë¥¼ ì´ˆê³¼í–ˆìë‹ˆë‹¤ .');
            return false;
        }
        
       const response = await fetch(GOOGLE_CONFIG.WEB_APP_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'text/plain' },
    body: jsonData
});
        console.log('âœ… êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ ìš”ì²­ ì™„ë£Œ');
        return true;
    } catch (e) {
        console.error('êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ ì˜¤ë¥˜:', e);
        alert('âŒ êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
        return false;
    }
}

        async function loadFromGoogleSheet() {
            try {
                const response = await fetch(GOOGLE_CONFIG.WEB_APP_URL + '?action=getAllData', {
                    method: 'GET'
                });
                const result = await response.json();
                if (result && result.data) {
                    if (result.data.data) state.data = result.data.data;
                    if (result.data.applicationData) state.applicationData = result.data.applicationData;
                    if (result.data.quarterData) state.quarterData = result.data.quarterData;
                    if (result.data.cancellationData) state.cancellationData = result.data.cancellationData;
                    if (result.data.pathwayData) state.pathwayData = result.data.pathwayData;
                    if (result.data.resourceData) state.resourceData = result.data.resourceData;
                    if (result.data.settings) state.settings = result.data.settings;
                    if (result.data.uploadedFileName) state.uploadedFileName = result.data.uploadedFileName;
                    if (result.data.selectedYear) state.selectedYear = result.data.selectedYear;
                    if (result.data.lastSaved) state.lastSaved = new Date(result.data.lastSaved);
                    const totalData = Object.values(state.data).reduce((sum, yearData) => sum + (yearData ? yearData.length : 0), 0);
                    if (totalData > 0) state.showWelcome = false;
                    console.log('âœ… êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                    return true;
                }
                return false;
            } catch (e) {
                console.error('êµ¬ê¸€ ì‹œíŠ¸ ë¡œë“œ ì˜¤ë¥˜:', e);
                return false;
            }
        }

        function saveToLocalStorage(dataToSave) {
    try {
        const jsonString = JSON.stringify(dataToSave);
        const sizeInMB = (new Blob([jsonString]).size / (1024 * 1024)).toFixed(2);
        if (parseFloat(sizeInMB) > 4.5) {
            console.warn(`âš ï¸ localStorage í¬ê¸° ì´ˆê³¼ (${sizeInMB}MB) - êµ¬ê¸€ ì‹œíŠ¸ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.`);
            return 'google_only';
        }
        localStorage.setItem('safetySystemData', jsonString);
        console.log(`âœ… localStorage ì €ì¥ ì™„ë£Œ (${sizeInMB}MB)`);
        return true;
    } catch (e) {
        if (e.name === 'QuotaExceededError') {
            console.warn('âš ï¸ localStorage ê³µê°„ ì´ˆê³¼ - êµ¬ê¸€ ì‹œíŠ¸ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.');
            return 'google_only';
        }
        console.error('ì €ì¥ ì˜¤ë¥˜:', e);
        return 'google_only';
    }
}
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('safetySystemData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    if (parsed.data) state.data = parsed.data;
                    if (parsed.applicationData) state.applicationData = parsed.applicationData;
                    if (parsed.quarterData) state.quarterData = parsed.quarterData;
                    if (parsed.cancellationData) state.cancellationData = parsed.cancellationData;
                    if (parsed.pathwayData) state.pathwayData = parsed.pathwayData;
                    if (parsed.resourceData) state.resourceData = parsed.resourceData;
                    if (parsed.resourceFileStorage) state.resource.fileStorage = parsed.resourceFileStorage;
                    if (parsed.settings) state.settings = parsed.settings;
                    if (parsed.uploadedFileName) state.uploadedFileName = parsed.uploadedFileName;
                    if (parsed.selectedYear) state.selectedYear = parsed.selectedYear;
                    if (parsed.lastSaved) state.lastSaved = new Date(parsed.lastSaved);
                    const totalData = Object.values(state.data).reduce((sum, yearData) => sum + (yearData ? yearData.length : 0), 0);
                    if (totalData > 0) {
                        state.showWelcome = false;
                        const sizeInMB = (new Blob([savedData]).size / (1024 * 1024)).toFixed(2);
                        console.log(`âœ… ì €ì¥ëœ ë°ì´í„° ë³µì›: ${totalData}ê±´ (${sizeInMB}MB)`);
                    }
                } else {
                    console.log('âŒ localStorageì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                alert('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
            }
        }

        function getStorageSize() {
            try {
                const savedData = localStorage.getItem('safetySystemData');
                if (savedData) return (new Blob([savedData]).size / (1024 * 1024)).toFixed(2);
                return '0.00';
            } catch (e) { return 'N/A'; }
        }

        function normalizeDate(dateValue) {
            if (!dateValue || dateValue === '') return '';
            if (typeof dateValue === 'number') {
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }
            const dateStr = String(dateValue).trim();
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split('.');
                return `${parts[0]}-${String(parts[1]).padStart(2, '0')}-${String(parts[2]).padStart(2, '0')}`;
            }
            if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                return `${parts[0]}-${String(parts[1]).padStart(2, '0')}-${String(parts[2]).padStart(2, '0')}`;
            }
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                return `${parts[2]}-${String(parts[0]).padStart(2, '0')}-${String(parts[1]).padStart(2, '0')}`;
            }
            return dateStr;
        }

        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                reader.onload = (e) => {
                    try {
                        state.loadingProgress = 60;
                        render();
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        state.loadingProgress = 70;
                        render();
                        let targetSheet = null;
                        let maxRows = 0;
                        if (workbook.SheetNames.includes('ì ‘ìˆ˜')) {
                            targetSheet = workbook.Sheets['ì ‘ìˆ˜'];
                        } else {
                            workbook.SheetNames.forEach(sheetName => {
                                const sheet = workbook.Sheets[sheetName];
                                const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                                if (data.length > maxRows) { maxRows = data.length; targetSheet = sheet; }
                            });
                        }
                        if (!targetSheet) targetSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(targetSheet, { header: 1 });
                        if (jsonData.length < 2) { reject(new Error('ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.')); return; }
                        state.loadingProgress = 85;
                        render();
                        const headers = jsonData[0].map(h => String(h || '').trim());
                        const dateColumns = ['ê¸°ì¤€ì¼', 'ê²€ì‚¬ì¼', 'ì‹ ì²­ì¼', 'ë³´í—˜ë§Œê¸°ì¼', 'ê³„ì‚°ì„œë°œí–‰ì¼'];
                        const parsedData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const hasData = jsonData[i].some(cell => cell !== undefined && cell !== null && String(cell).trim() !== '');
                            if (!hasData) continue;
                            const obj = {};
                            headers.forEach((header, idx) => {
                                let value = jsonData[i][idx];
                                if (value === undefined || value === null) obj[header] = '';
                                else obj[header] = dateColumns.includes(header) ? normalizeDate(value) : String(value).trim();
                            });
                            parsedData.push(obj);
                        }
                        state.loadingProgress = 100;
                        render();
                        resolve(parsedData);
                    } catch (error) { reject(error); }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                reader.onload = (e) => {
                    try {
                        state.loadingProgress = 60;
                        render();
                        const text = e.target.result;
                        if (!text || text.trim() === '') { reject(new Error('íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.')); return; }
                        const rows = [];
                        let currentRow = '';
                        let insideQuotes = false;
                        const chars = text.replace(/\r\n/g, '\n').split('');
                        for (let i = 0; i < chars.length; i++) {
                            const char = chars[i];
                            if (char === '"') { insideQuotes = !insideQuotes; currentRow += char; }
                            else if (char === '\n' && !insideQuotes) { if (currentRow.trim()) rows.push(currentRow); currentRow = ''; }
                            else currentRow += char;
                        }
                        if (currentRow.trim()) rows.push(currentRow);
                        const lines = rows;
                        if (lines.length < 2) { reject(new Error('ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.')); return; }
                        state.loadingProgress = 80;
                        render();
                        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                        const dateColumns = ['ê¸°ì¤€ì¼', 'ê²€ì‚¬ì¼', 'ì‹ ì²­ì¼', 'ë³´í—˜ë§Œê¸°ì¼', 'ê³„ì‚°ì„œë°œí–‰ì¼'];
                        const parsedData = [];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i];
                            if (!line.trim()) continue;
                            const values = [];
                            let currentValue = '';
                            let insideQuotes = false;
                            for (let j = 0; j < line.length; j++) {
                                const char = line[j];
                                if (char === '"') insideQuotes = !insideQuotes;
                                else if (char === ',' && !insideQuotes) { values.push(currentValue.trim().replace(/^"|"$/g, '')); currentValue = ''; }
                                else currentValue += char;
                            }
                            values.push(currentValue.trim().replace(/^"|"$/g, ''));
                            while (values.length < headers.length) values.push('');
                            const hasData = values.some(v => v && String(v).trim() !== '');
                            if (!hasData) continue;
                            const obj = {};
                            headers.forEach((header, idx) => {
                                let value = (values[idx] || '').replace(/[\\]/g, '').trim();
                                obj[header] = dateColumns.includes(header) ? normalizeDate(value) : value;
                            });
                            parsedData.push(obj);
                        }
                        state.loadingProgress = 100;
                        render();
                        resolve(parsedData);
                    } catch (error) { reject(error); }
                };
                reader.readAsText(file, 'EUC-KR');
            });
        }

        async function handleFileUpload(file) {
            if (!file) return;
            const maxSize = state.settings.maxFileSize * 1024 * 1024;
            if (file.size > maxSize) { alert(`íŒŒì¼ í¬ê¸°ê°€ ${state.settings.maxFileSize}MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`); return; }
            state.isLoading = true;
            state.loadingProgress = 30;
            state.uploadedFileName = file.name;
            render();
            try {
                let parsedData;
                const fileExt = file.name.split('.').pop().toLowerCase();
                if (fileExt === 'xlsx' || fileExt === 'xls') parsedData = await parseExcelFile(file);
                else if (fileExt === 'csv') parsedData = await parseCSVFile(file);
                else throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (.xlsx, .xls, .csvë§Œ ê°€ëŠ¥)');
                if (parsedData.length === 0) { alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); state.isLoading = false; render(); return; }
                if (!state.data[state.selectedYear]) state.data[state.selectedYear] = [];
                state.data[state.selectedYear] = parsedData;
                state.lastSaved = new Date();
                setTimeout(() => {
                    state.isLoading = false;
                    const storageSize = getStorageSize();
                    let message = `âœ… ${parsedData.length}ê°œì˜ ë°ì´í„°ê°€ ${state.selectedYear}ë…„ë„ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\níŒŒì¼ëª…: ${file.name}`;
                    if (parseFloat(storageSize) > 3) message += `\n\nâš ï¸ ì €ì¥ ê³µê°„: ${storageSize}MB/5MB\nê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ìë™ ì €ì¥ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                    alert(message);
                    saveDataToStorage();
                    render();
                }, 300);
            } catch (error) {
                console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                state.isLoading = false;
                render();
            }
        }

        function downloadAsExcel() {
            const dataToDownload = state.selectedRows.size > 0 ? state.filteredData.filter((_, idx) => state.selectedRows.has(idx)) : state.filteredData;
            if (dataToDownload.length === 0) { alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: columns });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ì•ˆì „ê´€ë¦¬');
            XLSX.writeFile(workbook, `ì•ˆì „ê´€ë¦¬_${new Date().toISOString().split('T')[0]}.xlsx`);
            state.showDownloadMenu = false;
            render();
        }

        function downloadAsCSV() {
            const dataToDownload = state.selectedRows.size > 0 ? state.filteredData.filter((_, idx) => state.selectedRows.has(idx)) : state.filteredData;
            if (dataToDownload.length === 0) { alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const csvContent = [columns.join(','), ...dataToDownload.map(row => columns.map(col => { const value = row[col] || ''; return value.includes(',') || value.includes('"') ? `"${value.replace(/"/g, '""')}"` : value; }).join(','))].join('\n');
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ì•ˆì „ê´€ë¦¬_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            state.showDownloadMenu = false;
            render();
        }

        function createSampleData() {
            const sampleData = [
                { 'ì‹œì„¤ë²ˆí˜¸': '00458912-0001', 'ì‹œì„¤ëª…': 'ì¥ìˆ˜ë§ˆì„ëª©ìš•íƒ•', 'í–‰ì •êµ¬ì—­': 'ë¶€ì‚°', 'ìƒˆì£¼ì†Œ': 'ë¶€ì‚°ê´‘ì—­ì‹œ ê¸°ì¥êµ° ê¸°ì¥ì êµë¦¬ 334-6ë²ˆì§€', 'êµ¬ì£¼ì†Œ': '', 'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰': '6,334.00ã¡', 'ì „í™”ë²ˆí˜¸': '051-724-2552', 'ê¸°ì¤€ì¼': '2025-02-03', 'ì•ˆì „ê´€ë¦¬ìëª…': '', 'ìê²©ì¦ë²ˆí˜¸': '', 'ë³´í—˜ì‚¬': '', 'ë³´í—˜ë§Œê¸°ì¼': '2028-11-22', 'ë©”ëª¨': '', 'ê²€ì‚¬ì¼': '2002-01-30', 'ì‹ ì²­ì¼': '', 'ê²€ì‚¬ì›': 'ë¬¸ì„œì˜', 'ê²€ì‚¬ê²°ê³¼': '', 'í•„ì¦ë²ˆí˜¸': '', 'ìˆ˜ìˆ˜ë£Œ': '', 'ì ‘ìˆ˜ì²˜': 'ë¹„ëŒ€ìƒ', 'ê³„ì‚°ì„œë°œí–‰ì¼': '', 'ë¹„ê³ ': '', 'ê²€ì‚¬í™•ì¸': '', 'ì‚¬ì—…ìë²ˆí˜¸': '', 'ëŒ€í‘œìëª…': '', 'ì—…íƒœ': '', 'ì¢…ëª©': '', 'ì´ë©”ì¼': '', 'ë©´ì œëŒ€ìƒ': '', 'ê²€ì‚¬ì´ë ¥': 'Y' },
                { 'ì‹œì„¤ë²ˆí˜¸': '01525996-0001', 'ì‹œì„¤ëª…': 'í”¼í”ŒëŸ¬í•œì˜ì›', 'í–‰ì •êµ¬ì—­': 'ë¶€ì‚°', 'ìƒˆì£¼ì†Œ': 'ë¶€ì‚°ê´‘ì—­ì‹œ ê¸°ì¥êµ° ì •ê´€ì ìš©ìˆ˜ë¦¬ 12 83-3ë²ˆì§€', 'êµ¬ì£¼ì†Œ': '', 'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰': '1,322.00ã¡', 'ì „í™”ë²ˆí˜¸': '051-728-6999', 'ê¸°ì¤€ì¼': '2025-05-07', 'ì•ˆì „ê´€ë¦¬ìëª…': '', 'ìê²©ì¦ë²ˆí˜¸': '', 'ë³´í—˜ì‚¬': '', 'ë³´í—˜ë§Œê¸°ì¼': '', 'ë©”ëª¨': '', 'ê²€ì‚¬ì¼': '2011-01-05', 'ì‹ ì²­ì¼': '', 'ê²€ì‚¬ì›': '', 'ê²€ì‚¬ê²°ê³¼': '', 'í•„ì¦ë²ˆí˜¸': '', 'ìˆ˜ìˆ˜ë£Œ': '', 'ì ‘ìˆ˜ì²˜': 'ë¹„ëŒ€ìƒ', 'ê³„ì‚°ì„œë°œí–‰ì¼': '', 'ë¹„ê³ ': '', 'ê²€ì‚¬í™•ì¸': '', 'ì‚¬ì—…ìë²ˆí˜¸': '', 'ëŒ€í‘œìëª…': '', 'ì—…íƒœ': '', 'ì¢…ëª©': '', 'ì´ë©”ì¼': '', 'ë©´ì œëŒ€ìƒ': '', 'ê²€ì‚¬ì´ë ¥': '' }
            ];
            if (!state.data[state.selectedYear]) state.data[state.selectedYear] = [];
            state.data[state.selectedYear] = sampleData;
            state.uploadedFileName = 'ìƒ˜í”Œë°ì´í„°.xlsx';
            state.lastSaved = new Date();
            state.showWelcome = false;
            alert('ìƒ˜í”Œ ë°ì´í„° 2ê±´ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            saveDataToStorage();
            updateFilters();
            render();
        }

        function updateFilters() {
            let result = [...(state.data[state.selectedYear] || [])];
            if (state.filters.region.length > 0) {
                result = result.filter(row => {
                    const region = (row['í–‰ì •êµ¬ì—­'] || '').replace(/[\\\/]/g, '').trim();
                    return state.filters.region.includes(region);
                });
            }
            if (state.filters.month) {
            result = result.filter(row => {
                const baseDate = row['ê¸°ì¤€ì¼'];
                if (!baseDate) return false;
                const month = parseInt(baseDate.split('-')[1]);
                return month === parseInt(state.filters.month);
            });
        }
            if (state.filters.inspectionHistory) {
                result = result.filter(row => {
                    const history = row['ê²€ì‚¬ì´ë ¥'];
                    if (state.filters.inspectionHistory === 'Y') return history === 'Y';
                    if (state.filters.inspectionHistory === 'N') return !history || history === '' || history === 'N';
                    return true;
                });
            }
            if (state.searchTerm) {
                result = result.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(state.searchTerm.toLowerCase())));
            }
            state.filteredData = result;
            
        }

       async function saveDataToStorage() {
    const toSave = {
        data: state.data, applicationData: state.applicationData, quarterData: state.quarterData,
        cancellationData: state.cancellationData, pathwayData: state.pathwayData, resourceData: state.resourceData,
        resourceFileStorage: state.resource.fileStorage, settings: state.settings, uploadedFileName: state.uploadedFileName,
        selectedYear: state.selectedYear, lastSaved: new Date().toISOString(), timestamp: new Date().toISOString()
    };
    saveToLocalStorage(toSave);
    await saveToGoogleSheet(toSave);
    state.lastSaved = new Date();
    return true;
}

        function confirmDuplicateCopy() {
            if (!state.applicationData[state.targetYear]) state.applicationData[state.targetYear] = [];
            state.applicationData[state.targetYear] = [...state.duplicateInfo.selectedData, ...state.applicationData[state.targetYear]];
            state.showDuplicateModal = false;
            state.activeTab = 'ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥';
            state.selectedRows = new Set();
            alert(`${state.duplicateInfo.selectedData.length}ê°œ í•­ëª©ì´ ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥ìœ¼ë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveDataToStorage();
            render();
        }

        function moveToCancel() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedData = currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx));
            if (selectedData.length === 0) { alert('ì·¨ì†Œí•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if (!state.cancellationData[state.targetYear]) state.cancellationData[state.targetYear] = [];
            const cancellationItems = selectedData.map((item) => ({ 'ì‹œì„¤ë²ˆí˜¸': item['ì‹œì„¤ë²ˆí˜¸'], 'ì‹œì„¤ëª…': item['ì‹œì„¤ëª…'], 'í–‰ì •êµ¬ì—­': item['í–‰ì •êµ¬ì—­'], 'ìƒˆì£¼ì†Œ': item['ìƒˆì£¼ì†Œ'] || '', 'í•„ì¦ë²ˆí˜¸': item['í•„ì¦ë²ˆí˜¸'], 'ì‹ ì²­ì¼': item['ì‹ ì²­ì¼'], 'ì·¨ì†Œì‚¬ìœ ': '', 'ì·¨ì†Œì¼': '', 'ìˆ˜ìˆ˜ë£Œ': '', 'ì ‘ìˆ˜ì²˜': '', 'ê³„ì¢Œ': '', 'ë¹„ê³ ': '' }));
            state.cancellationData[state.targetYear] = [...cancellationItems, ...state.cancellationData[state.targetYear]];
            const remainingApplicationData = currentAppData.filter((_, idx) => !state.selectedApplicationRows.has(idx));
            state.applicationData[state.targetYear] = remainingApplicationData;
            state.selectedApplicationRows = new Set();
            alert(`${selectedData.length}ê°œ í•­ëª©ì´ ì·¨ì†ŒëŒ€ì¥ìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveDataToStorage();
            render();
        }

        function cutToInspectionYear() {
            if (state.targetYear === state.inspectionYear) { alert('âš ï¸ í•´ë‹¹ë…„ë„ì™€ ê²€ì‚¬ì˜ˆì •ë…„ë„ê°€ ê°™ìŠµë‹ˆë‹¤.\nì˜ë¼ë‚´ê¸°ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
            if (state.selectedApplicationRows.size === 0) { alert('ì˜ë¼ë‚¼ ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedIndices = Array.from(state.selectedApplicationRows).sort((a, b) => b - a);
            const selectedData = selectedIndices.map(idx => ({...currentAppData[idx]}));
            const cutCount = selectedData.length;
            const targetInspectionYear = state.inspectionYear;
            if (!state.applicationData[state.inspectionYear]) state.applicationData[state.inspectionYear] = [];
            state.applicationData[state.inspectionYear] = [...selectedData, ...state.applicationData[state.inspectionYear]];
            selectedIndices.forEach(idx => { state.applicationData[state.targetYear].splice(idx, 1); });
            state.targetYear = state.inspectionYear;
            state.selectedApplicationRows = new Set();
            alert(`âœ‚ï¸ ${cutCount}ê°œ í•­ëª©ì´ ${targetInspectionYear}ë…„ë„ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveDataToStorage();
            render();
        }

        function clearAllData() {
            if (confirm('âš ï¸ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì €ì¥ëœ ë°ì´í„°ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) {
                localStorage.removeItem('safetySystemData');
                state.data = {}; state.applicationData = {}; state.quarterData = {}; state.cancellationData = {};
                state.pathwayData = {}; state.resourceData = {}; state.uploadedFileName = ''; state.lastSaved = null;
                state.showWelcome = true; state.showAdmin = false;
                alert('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                render();
            }
        }
        function copyToApplication() {
                if (state.selectedRows.size === 0) { alert('ë³µì‚¬í•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
                const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx)).map(item => ({...item}));
                const existingFacilityNumbers = (state.applicationData[state.targetYear] || []).map(row => row['ì‹œì„¤ë²ˆí˜¸']);
                const duplicates = selectedData.filter(item => existingFacilityNumbers.includes(item['ì‹œì„¤ë²ˆí˜¸']));
                if (duplicates.length > 0) {
                    state.duplicateInfo = { duplicates, selectedData };
                    state.showDuplicateModal = true;
                    render();
                    return;
                }
                if (!state.applicationData[state.targetYear]) state.applicationData[state.targetYear] = [];
                state.applicationData[state.targetYear] = [...selectedData, ...state.applicationData[state.targetYear]];
                state.activeTab = 'ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥';
                state.selectedRows = new Set();
                alert(`${selectedData.length}ê°œ í•­ëª©ì´ ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥ìœ¼ë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                saveDataToStorage();
                render();
            }
        function deleteSelectedRows() {
            if (state.selectedRows.size === 0) { alert('ì‚­ì œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            state.showDeleteModal = true;
            render();
        }

        function confirmDelete() {
            const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
            selectedData.forEach(selectedItem => { state.data[state.selectedYear] = state.data[state.selectedYear].filter(item => item !== selectedItem); });
            state.selectedRows = new Set();
            state.showDeleteModal = false;
            alert(`${selectedData.length}ê°œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveDataToStorage();
            updateFilters();
            render();
        }

        function addApplicationRow() {
            const newRow = {};
            applicationColumns.forEach(col => { newRow[col] = ''; });
            if (!state.applicationData[state.targetYear]) state.applicationData[state.targetYear] = [];
            state.applicationData[state.targetYear] = [newRow, ...state.applicationData[state.targetYear]];
            saveDataToStorage();
            render();
        }

        function deleteSelectedApplicationRows() {
            if (state.selectedApplicationRows.size === 0) { alert('ì‚­ì œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            state.showAppDeleteModal = true;
            render();
        }

        function confirmAppDelete() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedIndices = Array.from(state.selectedApplicationRows);
            const newData = currentAppData.filter((_, idx) => !selectedIndices.includes(idx));
            state.applicationData[state.targetYear] = newData;
            state.selectedApplicationRows = new Set();
            state.showAppDeleteModal = false;
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            saveDataToStorage();
            render();
        }
        // ======================== ëª¨ë‹¬ ë Œë”ë§ í•¨ìˆ˜ ========================
        function renderDetailModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
                    <div class="bg-white rounded-lg shadow-2xl my-8 w-full max-w-4xl mx-4 max-h-[95vh] overflow-y-auto">
                        <div class="bg-pink-600 text-white px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">ğŸ‘ï¸</span>
                                ${state.detailModalSelectedIdx !== null ? 'ìƒì„¸ë³´ê¸°' : 'ìƒˆ ë°ì´í„° ì¶”ê°€'}
                            </h3>
                            <button id="detailCloseBtn" class="text-white hover:text-gray-200 text-2xl">âœ•</button>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${columns.map(col => `
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">${col}</label>
                                        <input type="text" id="detail-${col}" value="${state.detailModalData[col] || ''}" 
                                               class="w-full px-3 py-2 border rounded text-sm" 
                                               ${col.includes('ì¼') ? 'type="date"' : ''} />
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t sticky bottom-0 z-10">
                            <button id="detailCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">ì·¨ì†Œ</button>
                            ${state.detailModalSelectedIdx !== null ? `
                                <button id="detailSaveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">ğŸ’¾ ìˆ˜ì •</button>
                            ` : `
                                <button id="detailAddBtn" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-semibold">â• ì¶”ê°€</button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAppDetailModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
                    <div class="bg-white rounded-lg shadow-2xl my-8 w-full max-w-4xl mx-4 max-h-[95vh] overflow-y-auto">
                        <div class="bg-pink-600 text-white px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">ğŸ‘ï¸</span>
                                ${state.appDetailModalSelectedIdx !== null ? 'ìƒì„¸ë³´ê¸° (ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥)' : 'ìƒˆ ë°ì´í„° ì¶”ê°€ (ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥)'}
                            </h3>
                            <button id="appDetailCloseBtn" class="text-white hover:text-gray-200 text-2xl">âœ•</button>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${applicationColumns.map(col => `
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">${col}</label>
                                        ${col === 'ê²€ì‚¬ì›' ? `
                                            <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                                <option value="">ì„ íƒ</option>
                                                ${state.inspectors.map(i => `<option value="${i}" ${i === state.appDetailModalData[col] ? 'selected' : ''}>${i}</option>`).join('')}
                                            </select>
                                        ` : col === 'ê²€ì‚¬ê²°ê³¼' ? `
                                            <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                                <option value="">ì„ íƒ</option>
                                                ${state.inspectionResults.map(r => `<option value="${r}" ${r === state.appDetailModalData[col] ? 'selected' : ''}>${r}</option>`).join('')}
                                            </select>
                                        ` : col === 'ì ‘ìˆ˜ì²˜' ? `
                                            <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                                <option value="">ì„ íƒ</option>
                                                ${state.receiptLocations.map(l => `<option value="${l}" ${l === state.appDetailModalData[col] ? 'selected' : ''}>${l}</option>`).join('')}
                                            </select>
                                        ` : col.includes('ì¼') ? `
                                            <input type="date" id="appDetail-${col}" value="${state.appDetailModalData[col] || ''}" class="w-full px-3 py-2 border rounded text-sm" />
                                        ` : `
                                            <input type="text" id="appDetail-${col}" value="${state.appDetailModalData[col] || ''}" class="w-full px-3 py-2 border rounded text-sm" />
                                        `}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t sticky bottom-0 z-10">
                            <button id="appDetailCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">ì·¨ì†Œ</button>
                            ${state.appDetailModalSelectedIdx !== null ? `
                                <button id="appDetailSaveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">ğŸ’¾ ìˆ˜ì •</button>
                            ` : `
                                <button id="appDetailAddBtn" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-semibold">â• ì¶”ê°€</button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function openAppDetailModal() {
            if (state.selectedApplicationRows.size === 1) {
                const selectedIdx = Array.from(state.selectedApplicationRows)[0];
                const currentAppData = state.applicationData[state.targetYear] || [];
                const selectedData = currentAppData[selectedIdx];
                state.appDetailModalData = { ...selectedData };
                state.appDetailModalSelectedIdx = selectedIdx;
            } else {
                state.appDetailModalData = {};
                state.appDetailModalSelectedIdx = null;
                applicationColumns.forEach(col => { state.appDetailModalData[col] = ''; });
            }
            state.showAppDetailModal = true;
            render();
        }

        function closeAppDetailModal() { state.showAppDetailModal = false; render(); }

        function saveFromAppDetailModal() {
            applicationColumns.forEach(col => {
                const input = document.getElementById(`appDetail-${col}`);
                if (input) state.appDetailModalData[col] = input.value;
            });
            if (state.appDetailModalSelectedIdx !== null && state.appDetailModalSelectedIdx >= 0) {
                state.applicationData[state.targetYear][state.appDetailModalSelectedIdx] = { ...state.appDetailModalData };
            }
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showAppDetailModal = false;
            alert('ğŸ’¾ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            render();
        }

        function addFromAppDetailModal() {
            applicationColumns.forEach(col => {
                const input = document.getElementById(`appDetail-${col}`);
                if (input) state.appDetailModalData[col] = input.value;
            });
            const newRow = { ...state.appDetailModalData };
            if (!state.applicationData[state.targetYear]) state.applicationData[state.targetYear] = [];
            state.applicationData[state.targetYear] = [newRow, ...state.applicationData[state.targetYear]];
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showAppDetailModal = false;
            alert('ë°ì´í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            render();
        }

        function renderMapModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto p-4">
                    <div class="bg-white rounded-lg shadow-2xl my-8" style="width: 210mm; max-width: 210mm; height: 297mm; display: flex; flex-direction: column; overflow: hidden;">
                        <div class="flex items-center justify-between p-6 border-b sticky top-0 bg-white z-10">
                            <h3 class="text-2xl font-bold">ğŸ—ºï¸ ì‹œì„¤ ìœ„ì¹˜ ì§€ë„</h3>
                            <button id="mapCloseBtn" class="text-gray-600 hover:text-gray-900 text-3xl font-bold">âœ•</button>
                        </div>
                        <div style="position: relative;">
                            <div id="mapContainer" style="width: 100%; height: 800px; background: #f0f0f0; border: 1px solid #ccc;"></div>
                            <div id="mapFacilityOverlay" style="position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 100; display: none;">
                                <h4 style="margin: 0 0 8px 0; font-weight: bold; font-size: 14px; color: #333;">ğŸ“ ì‹œì„¤ ëª©ë¡</h4>
                                ${state.mapData.map((item, idx) => `
                                    <div style="padding: 4px 0; border-bottom: 1px solid #eee; font-size: 12px;">
                                        <strong>${idx + 1}. ${item['ì‹œì„¤ëª…']}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div id="mapLoadingBar" style="padding: 1.5rem; background: #eff6ff; border-top: 1px solid #bfdbfe; ${state.isLoadingMap ? '' : 'display: none;'}">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-blue-700">ì§€ë„ ë¡œë”© ì¤‘...</span>
                                <span id="mapProgressText" class="text-sm font-bold text-blue-600">${state.mapLoadingProgress}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="mapProgressBar" class="bg-blue-600 h-3 rounded-full transition-all" style="width: ${state.mapLoadingProgress}%;"></div>
                            </div>
                        </div>
                        <div class="p-2 bg-gray-50 border-t max-h-24 overflow-y-auto">
                            <h4 class="font-bold mb-1 text-sm">ğŸ“ ì„ íƒëœ ì‹œì„¤ ì£¼ì†Œ</h4>
                
