<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µì¸ê²€ì‚¬ê¸°ê´€ ì•ˆì „ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c8f5719a2be48f3875087006ce782934&libraries=services&autoload=false"></script>
   
    <style>
        .scroll-x-auto {
            -webkit-overflow-scrolling: touch;
        }
        .table-cell-input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .no-cell {
            cursor: pointer;
            user-select: none;
        }
        .no-cell:hover {
            background-color: #dbeafe !important;
        }
        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .sync-indicator.online {
            background-color: #dcfce7;
            color: #166534;
        }
        .sync-indicator.offline {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .sync-indicator.syncing {
            background-color: #fef3c7;
            color: #92400e;
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .sync-dot.online { background-color: #22c55e; }
        .sync-dot.offline { background-color: #ef4444; }
        .sync-dot.syncing { background-color: #f59e0b; animation: pulse 1s infinite; }
        th {
            resize: horizontal;
            overflow: hidden;
            min-width: 50px;
        }
        td {
            overflow: hidden;
            text-overflow: ellipsis;
        }
       @media print {
    body * {
        visibility: hidden;
    }
    .fixed.inset-0 {
        position: absolute;
        top: 0;
        left: 0;
        visibility: visible;
        padding: 0 !important;
        background: white !important;
    }
    .fixed.inset-0 * {
        visibility: visible;
    }
    .fixed.inset-0 > div {
        width: 100% !important;
        height: 100vh !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: none !important;
        border-radius: 0 !important;
    }
    #mapContainer {
        height: calc(100vh - 80px) !important;
        flex: 1 !important;
    }
    #mapLoadingBar {
        display: none !important;
    }
    .p-2.bg-gray-50 {
        padding: 2px !important;
        max-height: 50px !important;
    }
    .flex.gap-2.justify-end {
        display: none !important;
    }
    #mapFacilityOverlay {
        display: block !important;
    }
    @page {
        size: A4;
        margin: 0;
    }
}
    </style>
</head>
<body class="bg-gradient-to-b from-sky-400 to-sky-200 min-h-screen">
    <div id="app"></div>

    <script>
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbwW4nCygWXl2MBCqOhy_zP8Xkhk_g0eUQx0LtEpEaLE42F7-n7jPCjGb95ZiHKNcZxHpw/exec',
            USER_ID: 'KGT_' + Date.now(),
            ENABLE_CLOUD: true
        };

        const state = {
            currentYear: new Date().getFullYear(),
            activeTab: 'í†µí•©',
            selectedYear: new Date().getFullYear(),
            data: {},
            filteredData: [],
            applicationData: {},
            quarterData: {},
            cancellationData: {},
            pathwayData: {},
            resourceData: {}, 
            currentPage: 1,
            selectedRows: new Set(),
            isLoading: false,
            loadingProgress: 0,
            searchTerm: '',
            isEditing: false,
            showAdmin: false,
            adminPassword: '',
            showWelcome: true,
            lastSaved: null,
            showDownloadMenu: false,
            showAppDownloadMenu: false,
            uploadedFileName: '',
            showDuplicateModal: false,
            duplicateInfo: { duplicates: [], selectedData: [] },
            inspectionYear: new Date().getFullYear(),
            targetYear: new Date().getFullYear(),
            applicationFilters: {
                region: [],
                inspector: '',
                receiptLocation: '',
                inspectionResult: '',
                applicationDateFrom: '',
                applicationDateTo: '',
                inspectionDateFrom: '',
                inspectionDateTo: '',
                baseMonth: '',
                fee: '',
                facilityCert: '',
                certificateStatus: '',
                insuranceStatus: ''
            },
            applicationSearchTerm: '',
            selectedApplicationRows: new Set(),
            isEditingApplication: false,
            currentApplicationPage: 1,
            selectedQuarterRows: new Set(),
            isEditingQuarter: false,
            currentQuarterPage: 1,
            isEditingCancellation: false,
            selectedCancellationRows: new Set(),
            showDeleteModal: false,
            showAppDeleteModal: false,
            showDetailModal: false,
            detailModalData: {},
            detailModalSelectedIdx: null,
            showAppDetailModal: false,
            appDetailModalData: {},
            appDetailModalSelectedIdx: null,
            filters: {
                region: [],
                month: '',
                inspectionHistory: ''
            },
            showRegionDropdown: false,
            showMonthDropdown: false,
            showInspectionDropdown: false,
            settings: {
                companyName: 'ê³µì¸ê²€ì‚¬ê¸°ê´€',
                maxFileSize: 100,
                autoSave: true,
                autoSaveInterval: 30
            },
            itemsPerPage: 50,
            inspectors: ['ìµœì¤‘ìˆ˜', 'ê¹€íƒì‹ ', 'ê¹€ì¶˜ì‹', 'ê¹€ì •ë§Œ'],
            receiptLocations: ['ì§€ë¡œ', 'êµ­ë¯¼', 'ë¶€ì‚°', 'ë†í˜‘', 'ê²½ë‚¨', 'í›„ë‚©', 'ê¸°íƒ€'],
            inspectionResults: ['í•©ê²©', 'ë¶ˆí•©ê²©', 'ì´ì¤‘ë‚©ë¶€','ê³µë€', 'ê¸°íƒ€'],
            yearRange: Array.from({ length: 37 }, (_, i) => 2014 + i),
            cancelReasons: ['ì…ê¸ˆ ë¯¸í™•ì¸', 'ê³ ê° ìš”ì²­', 'ì¤‘ë³µ ì‹ ì²­', 'ê¸°íƒ€'],
            showMapModal: false,
            mapData: [],
            isLoadingMap: false,
            mapLoadingProgress: 0,
            cloudStatus: 'offline',
            lastCloudSync: null,
            showHistoryModal: false,
            historyData: [],
            isLoadingHistory: false,
            quarter: {
                selectedQuarter: 'Q1',
                selectedRecipient: '',
                quarters: ['1ë¶„ê¸°', '2ë¶„ê¸°', '3ë¶„ê¸°', '4ë¶„ê¸°'],
                recipients: {
                    'ë¶€ì‚°ì‹œì²­': ['ë¶€ì‚° ê°•ì„œêµ¬', 'ë¶€ì‚° ë‚¨êµ¬', 'ë¶€ì‚° ë™êµ¬', 'ë¶€ì‚° ë¶€ì‚°ì§„êµ¬', 'ë¶€ì‚° ì‚¬ìƒêµ¬', 'ë¶€ì‚° ì‚¬í•˜êµ¬', 'ë¶€ì‚° ì„œêµ¬', 'ë¶€ì‚° ìˆ˜ì˜êµ¬', 'ë¶€ì‚° ì˜ë„êµ¬', 'ë¶€ì‚° ì¤‘êµ¬', 'ë¶€ì‚° í•´ìš´ëŒ€êµ¬', 'ë¶€ì‚° ê¸ˆì •êµ¬', 'ë¶€ì‚° ê¸°ì¥êµ°', 'ë¶€ì‚° ë™ë˜êµ¬', 'ë¶€ì‚° ì—°ì œêµ¬', 'ë¶€ì‚° ë¶êµ¬'],
                    'ê°•ì„œêµ¬ì²­ì¥': ['ë¶€ì‚° ê°•ì„œêµ¬'],
                    'ë‚¨êµ¬ì²­ì¥': ['ë¶€ì‚° ë‚¨êµ¬'],
                    'ë™êµ¬ì²­ì¥': ['ë¶€ì‚° ë™êµ¬'],
                    'ë¶€ì‚°ì§„êµ¬ì²­ì¥': ['ë¶€ì‚° ë¶€ì‚°ì§„êµ¬'],
                    'ì‚¬ìƒêµ¬ì²­ì¥': ['ë¶€ì‚° ì‚¬ìƒêµ¬'],
                    'ì‚¬í•˜êµ¬ì²­ì¥': ['ë¶€ì‚° ì‚¬í•˜êµ¬'],
                    'ì„œêµ¬ì²­ì¥': ['ë¶€ì‚° ì„œêµ¬'],
                    'ìˆ˜ì˜êµ¬ì²­ì¥': ['ë¶€ì‚° ìˆ˜ì˜êµ¬'],
                    'ì˜ë„êµ¬ì²­ì¥': ['ë¶€ì‚° ì˜ë„êµ¬'],
                    'ì¤‘êµ¬ì²­ì¥': ['ë¶€ì‚° ì¤‘êµ¬'],
                    'í•´ìš´ëŒ€êµ¬ì²­ì¥': ['ë¶€ì‚° í•´ìš´ëŒ€êµ¬'],
                    'ê¸ˆì •êµ¬ì²­ì¥': ['ë¶€ì‚° ê¸ˆì •êµ¬'],
                    'ê¸°ì¥êµ°ìˆ˜': ['ë¶€ì‚° ê¸°ì¥êµ°'],
                    'ë™ë˜êµ¬ì²­ì¥': ['ë¶€ì‚° ë™ë˜êµ¬'],
                    'ì—°ì œêµ¬ì²­ì¥': ['ë¶€ì‚° ì—°ì œêµ¬'],
                    'ë¶êµ¬ì²­ì¥': ['ë¶€ì‚° ë¶êµ¬'],
                    'ìš¸ì‚°ê´‘ì—­ì‹œ ë¶êµ¬ì²­ì¥': ['ìš¸ì‚° ë¶êµ¬'],
                    'ê¹€í•´ì‹œì²­': ['ê²½ë‚¨ ê¹€í•´ì‹œ'],
                    'ì–‘ì‚°ì‹œì²­': ['ê²½ë‚¨ ì–‘ì‚°ì‹œ'],
                    'ì‚¬ì²œì‹œì²­': ['ê²½ë‚¨ ì‚¬ì²œì‹œ'],
                    'í†µì˜ì‹œì²­': ['ê²½ë‚¨ í†µì˜ì‹œ'],
                    'ê±°ì œì‹œì²­': ['ê²½ë‚¨ ê±°ì œì‹œ'],
                    'í¬í•­ì‹œì²­': ['ê²½ë¶ í¬í•­ì‹œ'],
                    'ê²½ì£¼ì‹œì²­': ['ê²½ë¶ ê²½ì£¼ì‹œ'],
                    'êµ¬ë¯¸ì‹œì²­': ['ê²½ë¶ êµ¬ë¯¸ì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ë¶€ì‚°ì§€ì—­ë³¸ë¶€': ['ë¶€ì‚° ê°•ì„œêµ¬', 'ë¶€ì‚° ë‚¨êµ¬', 'ë¶€ì‚° ë™êµ¬', 'ë¶€ì‚° ë¶€ì‚°ì§„êµ¬', 'ë¶€ì‚° ì‚¬ìƒêµ¬', 'ë¶€ì‚° ì‚¬í•˜êµ¬', 'ë¶€ì‚° ì„œêµ¬', 'ë¶€ì‚° ìˆ˜ì˜êµ¬', 'ë¶€ì‚° ì˜ë„êµ¬', 'ë¶€ì‚° ì¤‘êµ¬'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ë¶ë¶€ì§€ì‚¬': ['ë¶€ì‚° í•´ìš´ëŒ€êµ¬', 'ë¶€ì‚° ê¸ˆì •êµ¬', 'ë¶€ì‚° ê¸°ì¥êµ°', 'ë¶€ì‚° ë™ë˜êµ¬', 'ë¶€ì‚° ì—°ì œêµ¬', 'ë¶€ì‚° ë¶êµ¬'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ìš¸ì‚°ì§€ì‚¬': ['ìš¸ì‚° ë¶êµ¬'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ì°½ì›ì§€ì‚¬': ['ê²½ë‚¨ ê¹€í•´ì‹œ', 'ê²½ë‚¨ ì–‘ì‚°ì‹œ', 'ê²½ë‚¨ í†µì˜ì‹œ', 'ê²½ë‚¨ ê±°ì œì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ì§„ì£¼ì§€ì‚¬': ['ê²½ë‚¨ ì‚¬ì²œì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ê²½ë¶ë™ë¶€ì§€ì‚¬': ['ê²½ë¶ í¬í•­ì‹œ', 'ê²½ë¶ ê²½ì£¼ì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ëŒ€êµ¬ê²½ë¶ì§€ì—­ë³¸ë¶€': ['ê²½ë¶ êµ¬ë¯¸ì‹œ'],
                     'ì–‘ì‚°ì‹œì²­ ì›…ìƒì¶œì¥ì†Œ ê²½ì¬í™˜ê²½ê³¼': ['ê²½ë‚¨ ì–‘ì‚°ì‹œ']
                }
            },
           
            pathway: {
                searchTerm: '',
                selectedRows: new Set(),
                isEditing: false,
                currentPage: 1,
                filters: {
                    region: ''
                },
                showDownloadMenu: false
            },
            resource: {
                files: [],
                selectedFiles: new Set(),
                currentFolder: '',
                searchTerm: '',
                fileStorage: {}
            }
        };
        
        const columns = [
           'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'êµ¬ì£¼ì†Œ', 'ì‚¬ìš©ëŸ‰', 
            'ì „í™”ë²ˆí˜¸', 'ê¸°ì¤€ì¼', 'ì•ˆì „ê´€ë¦¬ìëª…', 'ìê²©ì¦ë²ˆí˜¸', 'ë³´í—˜ì‚¬', 'ë³´í—˜ë§Œê¸°ì¼', 
            'ë©”ëª¨', 'ì‚¬ì—…ìë²ˆí˜¸', 'ëŒ€í‘œìëª…', 
            'ì—…íƒœ', 'ì¢…ëª©', 'ì´ë©”ì¼', 'ë©´ì œëŒ€ìƒ', 'ê²€ì‚¬ì´ë ¥'
        ];

        const applicationColumns = [
            'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'êµ¬ì£¼ì†Œ', 'ì‚¬ìš©ëŸ‰', 
            'ì „í™”ë²ˆí˜¸', 'ê¸°ì¤€ì¼', 'ì•ˆì „ê´€ë¦¬ìëª…', 'ìê²©ì¦ë²ˆí˜¸', 'ë³´í—˜ì‚¬', 'ë³´í—˜ë§Œê¸°ì¼', 
            'ë©”ëª¨', 'ê²€ì‚¬ì¼', 'ì‹ ì²­ì¼', 'ê²€ì‚¬ì›', 'ê²€ì‚¬ê²°ê³¼', 'í•„ì¦ë²ˆí˜¸', 'ìˆ˜ìˆ˜ë£Œ', 
            'ì ‘ìˆ˜ì²˜', 'ê³„ì‚°ì„œë°œí–‰ì¼', 'ë©”ëª¨2', 'ê²€ì‚¬í™•ì¸'
        ];

        const quarterColumns = [
            'ë¶„ê¸°', 'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ì‹ ì²­ì¼', 'ê²€ì‚¬ì¼', 'ê²€ì‚¬ì›', 'ê²€ì‚¬ê²°ê³¼', 'í•„ì¦ë²ˆí˜¸', 'ë©”ëª¨'
        ];

        const cancellationColumns = [
            'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'ì‹ ì²­ì¼', 'ì·¨ì†Œì‚¬ìœ ', 'ì·¨ì†Œì¼', 'ìˆ˜ìˆ˜ë£Œ', 'ì ‘ìˆ˜ì²˜','ê³„ì¢Œ', 'ë¹„ê³ '
        ];

        const pathwayColumns = [
            'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìë©´ë™', 'ìƒˆì£¼ì†Œ', 'ì „í™”ë²ˆí˜¸', 'ì‚¬ìš©ê°€ìŠ¤', 'ì°¨ë‹¨ê¸°', 'íƒ€ì´ë¨¸', 'COê²½ë³´ê¸°', 'ëˆ„ì„¤', 'ì ê²€ì¼', 'ì ê²€ì', 'ë¹„ê³ ', 'ì°¸ì¡°'
        ];

        const pathwayOptions = {
            regions: ['ìš¸ì£¼êµ°', 'ë¶êµ¬', 'ë‚¨êµ¬', 'ì¤‘êµ¬', 'ë™êµ¬'],
            gas: ['LPG', 'ë„ì‹œê°€ìŠ¤', 'LPG+ë„ì‹œê°€ìŠ¤'],
            device: ['ì„¤ì¹˜', 'ë¯¸ì„¤ì¹˜', 'ë¶ˆëŸ‰', 'í•´ë‹¹ì—†ìŠ´'],
            leak: ['ìœ ', 'ë¬´'],
            inspectors: ['ìµœì¤‘ìˆ˜', 'ê¹€íƒì‹ ', 'ê¹€ì¶˜ì‹']
        };

        const columnWidths = {
            'ì‹œì„¤ë²ˆí˜¸': '120px', 'ì‹œì„¤ëª…': '150px', 'í–‰ì •êµ¬ì—­': '100px', 'ìƒˆì£¼ì†Œ': '200px',
            'êµ¬ì£¼ì†Œ': '120px', 'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰': '100px', 'ì „í™”ë²ˆí˜¸': '110px', 'ê¸°ì¤€ì¼': '100px',
            'ì•ˆì „ê´€ë¦¬ìëª…': '90px', 'ìê²©ì¦ë²ˆí˜¸': '120px', 'ë³´í—˜ì‚¬': '70px', 'ë³´í—˜ë§Œê¸°ì¼': '100px',
            'ë©”ëª¨': '150px', 'ê²€ì‚¬ì¼': '100px', 'ì‹ ì²­ì¼': '100px', 'ê²€ì‚¬ì›': '90px',
            'ê²€ì‚¬ê²°ê³¼': '70px', 'í•„ì¦ë²ˆí˜¸': '140px', 'ìˆ˜ìˆ˜ë£Œ': '80px', 'ì ‘ìˆ˜ì²˜': '70px',
            'ê³„ì‚°ì„œë°œí–‰ì¼': '110px', 'ë©”ëª¨2': '150px', 'ê²€ì‚¬í™•ì¸': '70px',
            'ì·¨ì†Œë²ˆí˜¸': '120px', 'ì·¨ì†Œì‚¬ìœ ': '150px', 'ì·¨ì†Œì¼': '100px', 'ì²˜ë¦¬ì': '90px', 'ë¹„ê³ ': '150px'
        };
        // ======================== í´ë¼ìš°ë“œ API í•¨ìˆ˜ ========================
       async function cloudSaveData() {
            if (!CONFIG.ENABLE_CLOUD || !CONFIG.API_URL) {
                alert('âš ï¸ í´ë¼ìš°ë“œ ì €ì¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\nì„¤ì • ë°©ë²•:\n1. Google Sheets ìƒì„±\n2. Apps Script ë°°í¬\n3. CONFIG.API_URL ì„¤ì •\n4. CONFIG.ENABLE_CLOUD = true');
                return;
            }

            state.cloudStatus = 'syncing';
            render();

            try {
                const allData = {
                    data: state.data,
                    applicationData: state.applicationData,
                    quarterData: state.quarterData,
                    cancellationData: state.cancellationData,
                    pathwayData: state.pathwayData
                };

                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'bulkSave',
                        allData: allData,
                        userId: CONFIG.USER_ID
                    })
                });

                const result = await response.json();

                if (result.success) {
                    state.cloudStatus = 'online';
                    state.lastCloudSync = new Date();
                    alert(`â˜ï¸ í´ë¼ìš°ë“œ ì €ì¥ ì™„ë£Œ!\n${result.message}`);
                } else {
                    throw new Error(result.error || 'ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                state.cloudStatus = 'offline';
                console.error('í´ë¼ìš°ë“œ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('âŒ í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
            render();
        }
                async function cloudLoadData() {
            if (!CONFIG.ENABLE_CLOUD || !CONFIG.API_URL) {
                alert('âš ï¸ í´ë¼ìš°ë“œ ì €ì¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('â˜ï¸ í´ë¼ìš°ë“œì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í˜„ì¬ ë¡œì»¬ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) {
                return;
            }

            state.isLoading = true;
            state.loadingProgress = 30;
            state.cloudStatus = 'syncing';
            render();

            try {
               const response = await fetch(`${CONFIG.API_URL}?action=getAllData`, {
                    method: 'GET',
                    mode: 'cors',
                    redirect: 'follow'
                });
                const result = await response.json();

                state.loadingProgress = 80;
                render();

                if (result.success && result.data) {
                    if (result.data.data) state.data = result.data.data;
                    if (result.data.applicationData) state.applicationData = result.data.applicationData;
                    if (result.data.quarterData) state.quarterData = result.data.quarterData;
                    if (result.data.cancellationData) state.cancellationData = result.data.cancellationData;
                    if (result.data.pathwayData) state.pathwayData = result.data.pathwayData;

                    state.cloudStatus = 'online';
                    state.lastCloudSync = new Date();
                    state.showWelcome = false;
                    
                    // localStorage ì €ì¥ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
                    try {
                        saveDataToStorage();
                    } catch (e) {
                        console.log('ë¡œì»¬ ì €ì¥ ìƒëµ (í´ë¼ìš°ë“œ ì‚¬ìš© ì¤‘)');
                    }
```

---

## ì‚¬ìš© ë°©ë²•

1. **í´ë¼ìš°ë“œ ì €ì¥:** í—¤ë”ì˜ `â˜ï¸ í´ë¼ìš°ë“œ ì €ì¥` ë²„íŠ¼ í´ë¦­
2. **í´ë¼ìš°ë“œ ë¶ˆëŸ¬ì˜¤ê¸°:** í—¤ë”ì˜ `ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°` ë²„íŠ¼ í´ë¦­

---

## ì¤‘ìš” ì°¸ê³ ì‚¬í•­

í˜„ì¬ ì„¤ì •ëœ Google Apps Script URL:
```
https://script.google.com/macros/s/AKfycbwW4nCygWXl2MBCqOhy_zP8Xkhk_g0eUQx0LtEpEaLE42F7-n7jPCjGb95ZiHKNcZxHpw/exec
                    
                    const totalData = Object.values(state.data).reduce((sum, arr) => sum + (arr?.length || 0), 0);
                    alert(`â˜ï¸ í´ë¼ìš°ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ!\nì´ ${totalData}ê±´ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                } else {
                    throw new Error(result.error || 'ë°ì´í„° ì—†ìŒ');
                }
            } catch (error) {
                state.cloudStatus = 'offline';
                console.error('í´ë¼ìš°ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('âŒ í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }

            state.isLoading = false;
            state.loadingProgress = 100;
            render();
        }

        // ======================== ìë™ í´ë¼ìš°ë“œ ë¡œë“œ ========================
async function autoCloudLoad() {
    try {
        state.cloudStatus = 'syncing';
        render();

        const response = await fetch(`${CONFIG.API_URL}?action=getAllData`, {
            method: 'GET',
            mode: 'cors',
            redirect: 'follow'
        });
        const result = await response.json();

        if (result.success && result.data) {
            // ê¸°ì¡´ ë¡œì»¬ ë°ì´í„°ì™€ í´ë¼ìš°ë“œ ë°ì´í„° ë³‘í•©
            if (result.data.data) {
                Object.keys(result.data.data).forEach(year => {
                    if (!state.data[year]) state.data[year] = [];
                    // ì¤‘ë³µ ì œê±°í•˜ë©° ë³‘í•©
                    const existingIds = new Set(state.data[year].map(r => r['ì‹œì„¤ë²ˆí˜¸']));
                    result.data.data[year].forEach(row => {
                        if (!existingIds.has(row['ì‹œì„¤ë²ˆí˜¸'])) {
                            state.data[year].push(row);
                        }
                    });
                });
            }
            
            if (result.data.applicationData) {
                Object.keys(result.data.applicationData).forEach(year => {
                    if (!state.applicationData[year]) state.applicationData[year] = [];
                    const existingIds = new Set(state.applicationData[year].map(r => r['ì‹œì„¤ë²ˆí˜¸'] + r['ì‹ ì²­ì¼']));
                    result.data.applicationData[year].forEach(row => {
                        const key = row['ì‹œì„¤ë²ˆí˜¸'] + row['ì‹ ì²­ì¼'];
                        if (!existingIds.has(key)) {
                            state.applicationData[year].push(row);
                        }
                    });
                });
            }
            
            if (result.data.quarterData) {
                Object.keys(result.data.quarterData).forEach(year => {
                    if (!state.quarterData[year]) state.quarterData[year] = [];
                    state.quarterData[year] = result.data.quarterData[year];
                });
            }
            
            if (result.data.cancellationData) {
                Object.keys(result.data.cancellationData).forEach(year => {
                    if (!state.cancellationData[year]) state.cancellationData[year] = [];
                    state.cancellationData[year] = result.data.cancellationData[year];
                });
            }
            
            if (result.data.pathwayData) {
                Object.keys(result.data.pathwayData).forEach(year => {
                    if (!state.pathwayData[year]) state.pathwayData[year] = [];
                    state.pathwayData[year] = result.data.pathwayData[year];
                });
            }
            
            if (result.data.resourceData) {
                Object.keys(result.data.resourceData).forEach(year => {
                    if (!state.resourceData[year]) state.resourceData[year] = [];
                    state.resourceData[year] = result.data.resourceData[year];
                });
            }

            state.cloudStatus = 'online';
            state.lastCloudSync = new Date();
            state.showWelcome = false;
            
            console.log('â˜ï¸ í´ë¼ìš°ë“œ ë°ì´í„° ìë™ ë¡œë“œ ì™„ë£Œ');
        } else {
            state.cloudStatus = 'online';
            console.log('â˜ï¸ í´ë¼ìš°ë“œ ì—°ê²°ë¨ (ìƒˆ ë°ì´í„° ì—†ìŒ)');
        }
    } catch (error) {
        state.cloudStatus = 'offline';
        console.error('í´ë¼ìš°ë“œ ìë™ ë¡œë“œ ì‹¤íŒ¨:', error);
    }
    render();
}
       
        async function autoCloudSave() {
    if (!CONFIG.ENABLE_CLOUD || !CONFIG.API_URL) return;
    
    try {
        const allData = {
            data: state.data,
            applicationData: state.applicationData,
            quarterData: state.quarterData,
            cancellationData: state.cancellationData,
            pathwayData: state.pathwayData,
            resourceData: state.resourceData
        };

        const response = await fetch(CONFIG.API_URL, {
            method: 'POST',
            mode: 'cors',
            redirect: 'follow',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'bulkSave',
                allData: allData,
                userId: CONFIG.USER_ID
            })
        });

        const result = await response.json();

        if (result.success) {
            state.cloudStatus = 'online';
            state.lastCloudSync = new Date();
            console.log('â˜ï¸ ìë™ ì €ì¥ ì™„ë£Œ:', new Date().toLocaleTimeString());
        }
    } catch (error) {
        console.error('ìë™ ì €ì¥ ì‹¤íŒ¨:', error);
    }
}

        async function loadHistory() {
            if (!CONFIG.ENABLE_CLOUD || !CONFIG.API_URL) {
                alert('âš ï¸ í´ë¼ìš°ë“œê°€ ë¹„í™œì„±í™”ë˜ì–´ íˆìŠ¤í† ë¦¬ë¥¼ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            state.isLoadingHistory = true;
            state.showHistoryModal = true;
            render();

            try {
               const response = await fetch(`${CONFIG.API_URL}?action=getHistory`, {
                    method: 'GET',
                    mode: 'cors',
                    redirect: 'follow'
                });
                const result = await response.json();

                if (result.success) {
                    state.historyData = result.data || [];
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                state.historyData = [];
            }

            state.isLoadingHistory = false;
            render();
        }

        // ======================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ========================
        function formatCurrency(value) {
            if (!value || value === '') return '';
            const num = parseInt(String(value).replace(/,/g, ''));
            if (isNaN(num)) return value;
            return num.toLocaleString();
        }

        function generateCertificateNumber(applicationDate, currentIdx) {
            if (!applicationDate) return '';
            
            const appYear = parseInt(applicationDate.substring(0, 4));
            const appYY = applicationDate.substring(2, 4);
            const appMM = applicationDate.substring(5, 7);
            const appDD = applicationDate.substring(8, 10);
            
            const currentAppData = state.applicationData[state.targetYear] || [];
            
            // ì˜ˆì™¸ ì¡°ê±´: ì‹ ì²­ë…„ê³¼ ê²€ì‚¬ì˜ˆì •ë…„ë„ê°€ ë‹¤ë¥¸ ê²½ìš°
            if (appYear !== state.inspectionYear) {
                const inspYY = String(state.inspectionYear).substring(2, 4);
                const prefix = `KGT${inspYY}0101-`;
                
                let maxNum = 0;
                currentAppData.forEach((row, idx) => {
                    if (idx !== currentIdx && row['í•„ì¦ë²ˆí˜¸'] && row['í•„ì¦ë²ˆí˜¸'].startsWith(prefix)) {
                        const numPart = parseInt(row['í•„ì¦ë²ˆí˜¸'].split('-')[1]);
                        if (!isNaN(numPart) && numPart > maxNum) {
                            maxNum = numPart;
                        }
                    }
                });
                
                return prefix + String(maxNum + 1).padStart(3, '0');
            }
            
            // ê¸°ë³¸ í˜•ì‹: KGTyymmdd-XXX
            const prefix = `KGT${appYY}${appMM}${appDD}-`;
            
            let maxNum = 0;
            currentAppData.forEach((row, idx) => {
                if (idx !== currentIdx && row['í•„ì¦ë²ˆí˜¸'] && row['í•„ì¦ë²ˆí˜¸'].startsWith(prefix)) {
                    const numPart = parseInt(row['í•„ì¦ë²ˆí˜¸'].split('-')[1]);
                    if (!isNaN(numPart) && numPart > maxNum) {
                        maxNum = numPart;
                    }
                }
            });
            
            return prefix + String(maxNum + 1).padStart(3, '0');
        }

      function saveToLocalStorage(dataToSave) {
     try {
        const jsonString = JSON.stringify(dataToSave);
        const sizeInMB = (new Blob([jsonString]).size / (1024 * 1024)).toFixed(2);
        
        if (parseFloat(sizeInMB) > 4.5) {
            alert('âš ï¸ ë°ì´í„° í¬ê¸° ì´ˆê³¼: ' + sizeInMB + 'MB\n4.5MB ì´í•˜ë¡œ ì¤„ì—¬ì£¼ì„¸ìš”.');
            return false;
        }
        
        localStorage.setItem('safetySystemData', jsonString);
        console.log(`âœ… ì €ì¥ ì™„ë£Œ (${sizeInMB}MB)`);
        return true;
    } catch (e) {
        if (e.name === 'QuotaExceededError') {
            alert('âš ï¸ ì €ì¥ ê³µê°„ ì´ˆê³¼! ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ì„¸ìš”.');
            state.settings.autoSave = false;
            return false;
        }
        console.error('ì €ì¥ ì˜¤ë¥˜:', e);
        return false;
    }
}

        function loadFromLocalStorage() {
    try {
        const savedData = localStorage.getItem('safetySystemData');
        if (savedData) {
            const parsed = JSON.parse(savedData);
            if (parsed.data) state.data = parsed.data;
            if (parsed.applicationData) state.applicationData = parsed.applicationData;
            if (parsed.quarterData) state.quarterData = parsed.quarterData;
            if (parsed.cancellationData) state.cancellationData = parsed.cancellationData;
            if (parsed.pathwayData) state.pathwayData = parsed.pathwayData;
            if (parsed.resourceData) state.resourceData = parsed.resourceData;
            if (parsed.resourceFileStorage) state.resource.fileStorage = parsed.resourceFileStorage;
            if (parsed.settings) state.settings = parsed.settings;
            if (parsed.uploadedFileName) state.uploadedFileName = parsed.uploadedFileName;
            if (parsed.selectedYear) state.selectedYear = parsed.selectedYear;
            if (parsed.lastSaved) state.lastSaved = new Date(parsed.lastSaved);
            
            const totalData = Object.values(state.data).reduce((sum, yearData) => sum + (yearData ? yearData.length : 0), 0);
            if (totalData > 0) {
                state.showWelcome = false;
                const sizeInMB = (new Blob([savedData]).size / (1024 * 1024)).toFixed(2);
                console.log(`âœ… ì €ì¥ëœ ë°ì´í„° ë³µì›: ${totalData}ê±´ (${sizeInMB}MB)`);
            }
        } else {
            console.log('âŒ localStorageì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (e) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
        alert('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
    }
}
        function getStorageSize() {
            try {
                const savedData = localStorage.getItem('safetySystemData');
                if (savedData) {
                    const sizeInMB = (new Blob([savedData]).size / (1024 * 1024)).toFixed(2);
                    return sizeInMB;
                }
                return '0.00';
            } catch (e) {
                return 'N/A';
            }
        }

        function normalizeDate(dateValue) {
            if (!dateValue || dateValue === '') return '';
            
            if (typeof dateValue === 'number') {
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            const dateStr = String(dateValue).trim();
            
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            
            if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split('.');
                return `${parts[0]}-${String(parts[1]).padStart(2, '0')}-${String(parts[2]).padStart(2, '0')}`;
            }
            
            if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                return `${parts[0]}-${String(parts[1]).padStart(2, '0')}-${String(parts[2]).padStart(2, '0')}`;
            }
            
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                return `${parts[2]}-${String(parts[0]).padStart(2, '0')}-${String(parts[1]).padStart(2, '0')}`;
            }
            
            return dateStr;
        }

        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                reader.onload = (e) => {
                    try {
                        state.loadingProgress = 60;
                        render();
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        state.loadingProgress = 70;
                        render();
                        
                        let targetSheet = null;
                        let maxRows = 0;

                        if (workbook.SheetNames.includes('ì ‘ìˆ˜')) {
                            targetSheet = workbook.Sheets['ì ‘ìˆ˜'];
                        } else {
                            workbook.SheetNames.forEach(sheetName => {
                                const sheet = workbook.Sheets[sheetName];
                                const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                                if (data.length > maxRows) {
                                    maxRows = data.length;
                                    targetSheet = sheet;
                                }
                            });
                        }

                        if (!targetSheet) {
                            targetSheet = workbook.Sheets[workbook.SheetNames[0]];
                        }

                        const jsonData = XLSX.utils.sheet_to_json(targetSheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'));
                            return;
                        }
                        
                        state.loadingProgress = 85;
                        render();
                        
                        const headers = jsonData[0].map(h => String(h || '').trim());
                        const dateColumns = ['ê¸°ì¤€ì¼', 'ê²€ì‚¬ì¼', 'ì‹ ì²­ì¼', 'ë³´í—˜ë§Œê¸°ì¼', 'ê³„ì‚°ì„œë°œí–‰ì¼'];
                        const parsedData = [];
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const hasData = jsonData[i].some(cell => cell !== undefined && cell !== null && String(cell).trim() !== '');
                            if (!hasData) continue;
                            
                            const obj = {};
                            headers.forEach((header, idx) => {
                                let value = jsonData[i][idx];
                                if (value === undefined || value === null) {
                                    obj[header] = '';
                                } else {
                                    if (dateColumns.includes(header)) {
                                        obj[header] = normalizeDate(value);
                                    } else {
                                        obj[header] = String(value).trim();
                                    }
                                }
                            });
                            parsedData.push(obj);
                        }
                        
                        state.loadingProgress = 100;
                        render();
                        resolve(parsedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                reader.onload = (e) => {
                    try {
                        state.loadingProgress = 60;
                        render();
                        
                        const text = e.target.result;

                        if (!text || text.trim() === '') {
                            reject(new Error('íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'));
                            return;
                        }

                        const rows = [];
                        let currentRow = '';
                        let insideQuotes = false;
                        const chars = text.replace(/\r\n/g, '\n').split('');

                        for (let i = 0; i < chars.length; i++) {
                            const char = chars[i];
                            if (char === '"') {
                                insideQuotes = !insideQuotes;
                                currentRow += char;
                            } else if (char === '\n' && !insideQuotes) {
                                if (currentRow.trim()) {
                                    rows.push(currentRow);
                                }
                                currentRow = '';
                            } else {
                                currentRow += char;
                            }
                        }
                        if (currentRow.trim()) {
                            rows.push(currentRow);
                        }

                        const lines = rows;

                        if (lines.length < 2) {
                            reject(new Error('ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'));
                            return;
                        }

                        state.loadingProgress = 80;
                        render();
                        
                        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                        const dateColumns = ['ê¸°ì¤€ì¼', 'ê²€ì‚¬ì¼', 'ì‹ ì²­ì¼', 'ë³´í—˜ë§Œê¸°ì¼', 'ê³„ì‚°ì„œë°œí–‰ì¼'];
                        
                        const parsedData = [];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i];
                            if (!line.trim()) continue;
                            
                            const values = [];
                            let currentValue = '';
                            let insideQuotes = false;
                            
                            for (let j = 0; j < line.length; j++) {
                                const char = line[j];
                                if (char === '"') {
                                    insideQuotes = !insideQuotes;
                                } else if (char === ',' && !insideQuotes) {
                                    values.push(currentValue.trim().replace(/^"|"$/g, ''));
                                    currentValue = '';
                                } else {
                                    currentValue += char;
                                }
                            }
                            values.push(currentValue.trim().replace(/^"|"$/g, ''));
                            
                            while (values.length < headers.length) {
                                values.push('');
                            }

                            const hasData = values.some(v => v && String(v).trim() !== '');
                            if (!hasData) continue;

                            const obj = {};
                            headers.forEach((header, idx) => {
                                let value = (values[idx] || '').replace(/[\\]/g, '').trim();
                                if (dateColumns.includes(header)) {
                                    obj[header] = normalizeDate(value);
                                } else {
                                    obj[header] = value;
                                }
                            });
                            parsedData.push(obj);
                        }

                        state.loadingProgress = 100;
                        render();
                        resolve(parsedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsText(file, 'EUC-KR');
            });
        }

        async function handleFileUpload(file) {
            if (!file) return;

            const maxSize = state.settings.maxFileSize * 1024 * 1024;
            if (file.size > maxSize) {
                alert(`íŒŒì¼ í¬ê¸°ê°€ ${state.settings.maxFileSize}MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                return;
            }

            state.isLoading = true;
            state.loadingProgress = 30;
            state.uploadedFileName = file.name;
            render();

            try {
                let parsedData;
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                if (fileExt === 'xlsx' || fileExt === 'xls') {
                    parsedData = await parseExcelFile(file);
                } else if (fileExt === 'csv') {
                    parsedData = await parseCSVFile(file);
                } else {
                    throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (.xlsx, .xls, .csvë§Œ ê°€ëŠ¥)');
                }

                if (parsedData.length === 0) {
                    alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    state.isLoading = false;
                    render();
                    return;
                }

                if (!state.data[state.selectedYear]) {
                    state.data[state.selectedYear] = [];
                }
                state.data[state.selectedYear] = parsedData;
                
                state.lastSaved = new Date();
                
                setTimeout(() => {
                    state.isLoading = false;
                    const storageSize = getStorageSize();
                    let message = `âœ… ${parsedData.length}ê°œì˜ ë°ì´í„°ê°€ ${state.selectedYear}ë…„ë„ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\níŒŒì¼ëª…: ${file.name}`;
                    
                    if (parseFloat(storageSize) > 3) {
                        message += `\n\nâš ï¸ ì €ì¥ ê³µê°„: ${storageSize}MB/5MB\nê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ìë™ ì €ì¥ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                    }
                    
                    alert(message);
                    saveDataToStorage();
                    render();
                }, 300);

            } catch (error) {
                console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                state.isLoading = false;
                render();
            }
        }

        function downloadAsExcel() {
            const dataToDownload = state.selectedRows.size > 0
                ? state.filteredData.filter((_, idx) => state.selectedRows.has(idx))
                : state.filteredData;

            if (dataToDownload.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: columns });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ì•ˆì „ê´€ë¦¬');
            
            const fileName = `ì•ˆì „ê´€ë¦¬_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            state.showDownloadMenu = false;
            render();
        }

        function downloadAsCSV() {
            const dataToDownload = state.selectedRows.size > 0
                ? state.filteredData.filter((_, idx) => state.selectedRows.has(idx))
                : state.filteredData;

            if (dataToDownload.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const csvContent = [
                columns.join(','),
                ...dataToDownload.map(row => 
                    columns.map(col => {
                        const value = row[col] || '';
                        return value.includes(',') || value.includes('"') 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ì•ˆì „ê´€ë¦¬_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            state.showDownloadMenu = false;
            render();
        }

        

        function createSampleData() {
            const sampleData = [
                {
                    'ì‹œì„¤ë²ˆí˜¸': '00458912-0001', 'ì‹œì„¤ëª…': 'ì¥ìˆ˜ë§ˆì„ëª©ìš•íƒ•', 'í–‰ì •êµ¬ì—­': 'ë¶€ì‚°',
                    'ìƒˆì£¼ì†Œ': 'ë¶€ì‚°ê´‘ì—­ì‹œ ê¸°ì¥êµ° ê¸°ì¥ì êµë¦¬ 334-6ë²ˆì§€', 'êµ¬ì£¼ì†Œ': '',
                    'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰': '6,334.00ã¡', 'ì „í™”ë²ˆí˜¸': '051-724-2552', 'ê¸°ì¤€ì¼': '2025-02-03',
                    'ì•ˆì „ê´€ë¦¬ìëª…': '', 'ìê²©ì¦ë²ˆí˜¸': '', 'ë³´í—˜ì‚¬': '', 'ë³´í—˜ë§Œê¸°ì¼': '2028-11-22',
                    'ë©”ëª¨': '', 'ê²€ì‚¬ì¼': '2002-01-30', 'ì‹ ì²­ì¼': '', 'ê²€ì‚¬ì›': 'ë¬¸ì„œì˜',
                    'ê²€ì‚¬ê²°ê³¼': '', 'í•„ì¦ë²ˆí˜¸': '', 'ìˆ˜ìˆ˜ë£Œ': '', 'ì ‘ìˆ˜ì²˜': 'ë¹„ëŒ€ìƒ',
                    'ê³„ì‚°ì„œë°œí–‰ì¼': '', 'ë¹„ê³ ': '', 'ê²€ì‚¬í™•ì¸': '', 'ì‚¬ì—…ìë²ˆí˜¸': '',
                    'ëŒ€í‘œìëª…': '', 'ì—…íƒœ': '', 'ì¢…ëª©': '', 'ì´ë©”ì¼': '', 'ë©´ì œëŒ€ìƒ': '', 'ê²€ì‚¬ì´ë ¥': 'Y'
                },
                {
                    'ì‹œì„¤ë²ˆí˜¸': '01525996-0001', 'ì‹œì„¤ëª…': 'í”¼í”ŒëŸ¬í•œì˜ì›', 'í–‰ì •êµ¬ì—­': 'ë¶€ì‚°',
                    'ìƒˆì£¼ì†Œ': 'ë¶€ì‚°ê´‘ì—­ì‹œ ê¸°ì¥êµ° ì •ê´€ì ìš©ìˆ˜ë¦¬ 12 83-3ë²ˆì§€', 'êµ¬ì£¼ì†Œ': '',
                    'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰': '1,322.00ã¡', 'ì „í™”ë²ˆí˜¸': '051-728-6999', 'ê¸°ì¤€ì¼': '2025-05-07',
                    'ì•ˆì „ê´€ë¦¬ìëª…': '', 'ìê²©ì¦ë²ˆí˜¸': '', 'ë³´í—˜ì‚¬': '', 'ë³´í—˜ë§Œê¸°ì¼': '',
                    'ë©”ëª¨': '', 'ê²€ì‚¬ì¼': '2011-01-05', 'ì‹ ì²­ì¼': '', 'ê²€ì‚¬ì›': '',
                    'ê²€ì‚¬ê²°ê³¼': '', 'í•„ì¦ë²ˆí˜¸': '', 'ìˆ˜ìˆ˜ë£Œ': '', 'ì ‘ìˆ˜ì²˜': 'ë¹„ëŒ€ìƒ',
                    'ê³„ì‚°ì„œë°œí–‰ì¼': '', 'ë¹„ê³ ': '', 'ê²€ì‚¬í™•ì¸': '', 'ì‚¬ì—…ìë²ˆí˜¸': '',
                    'ëŒ€í‘œìëª…': '', 'ì—…íƒœ': '', 'ì¢…ëª©': '', 'ì´ë©”ì¼': '', 'ë©´ì œëŒ€ìƒ': '', 'ê²€ì‚¬ì´ë ¥': ''
                }
            ];
            if (!state.data[state.selectedYear]) {
                state.data[state.selectedYear] = [];
            }
            state.data[state.selectedYear] = sampleData;
            state.uploadedFileName = 'ìƒ˜í”Œë°ì´í„°.xlsx';
            state.lastSaved = new Date();
            state.showWelcome = false;
            alert('ìƒ˜í”Œ ë°ì´í„° 2ê±´ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            saveDataToStorage();
            updateFilters();
            render();
        }

        function updateFilters() {
            let result = [...(state.data[state.selectedYear] || [])];
            
            if (state.filters.region.length > 0) {
                result = result.filter(row => {
                    const region = (row['í–‰ì •êµ¬ì—­'] || '').replace(/[\\\/]/g, '').trim();
                    return state.filters.region.includes(region);
                });
            }
            
            if (state.filters.month) {
                result = result.filter(row => {
                    const baseDate = row['ê²€ì‚¬ì¼'];
                    if (!baseDate) return false;
                    const month = parseInt(baseDate.split('-')[1]);
                    return month === parseInt(state.filters.month);
                });
            }

            if (state.filters.inspectionHistory) {
                result = result.filter(row => {
                    const history = row['ê²€ì‚¬ì´ë ¥'];
                    if (state.filters.inspectionHistory === 'Y') return history === 'Y';
                    if (state.filters.inspectionHistory === 'N') return !history || history === '' || history === 'N';
                    return true;
                });
            }
            
            if (state.searchTerm) {
                result = result.filter(row =>
                    Object.values(row).some(val =>
                        String(val).toLowerCase().includes(state.searchTerm.toLowerCase())
                    )
                );
            }
            
            state.filteredData = result;
            state.currentPage = 1;
        }

        function copyToApplication() {
            const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
            
            if (selectedData.length === 0) {
                alert('ë³µì‚¬í•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }

            const duplicates = selectedData.filter(item =>
                state.applicationData[state.targetYear].some(app => app['ì‹œì„¤ë²ˆí˜¸'] === item['ì‹œì„¤ë²ˆí˜¸'])
            );

            if (duplicates.length > 0) {
                state.duplicateInfo = { duplicates, selectedData };
                state.showDuplicateModal = true;
                render();
                return;
            }

            selectedData.forEach(row => {
                if (row['ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰'] && !row['ì‚¬ìš©ëŸ‰']) {
                    row['ì‚¬ìš©ëŸ‰'] = row['ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰'];
                }
            });

            const existingData = state.applicationData[state.targetYear] || [];
            state.applicationData[state.targetYear] = [...selectedData, ...existingData];
                
            state.activeTab = 'ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥';
            state.selectedRows = new Set();
            alert(`${selectedData.length}ê°œ í•­ëª©ì´ ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥ìœ¼ë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveDataToStorage();
            render();
        }

        function confirmDuplicateCopy() {
            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }

            state.applicationData[state.targetYear] = [...state.duplicateInfo.selectedData, ...state.applicationData[state.targetYear]];
                        
            state.showDuplicateModal = false;
            state.activeTab = 'ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥';
            state.selectedRows = new Set();
            alert(`${state.duplicateInfo.selectedData.length}ê°œ í•­ëª©ì´ ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥ìœ¼ë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveDataToStorage();
            render();
        }

        function moveToCancel() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedData = currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx));
            
            if (selectedData.length === 0) {
                alert('ì·¨ì†Œí•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!state.cancellationData[state.targetYear]) {
                state.cancellationData[state.targetYear] = [];
            }

            const cancellationItems = selectedData.map((item) => ({
                'ì‹œì„¤ë²ˆí˜¸': item['ì‹œì„¤ë²ˆí˜¸'],
                'ì‹œì„¤ëª…': item['ì‹œì„¤ëª…'],
                'í–‰ì •êµ¬ì—­': item['í–‰ì •êµ¬ì—­'],
                'ìƒˆì£¼ì†Œ': item['ìƒˆì£¼ì†Œ'] || '',
                'í•„ì¦ë²ˆí˜¸': item['í•„ì¦ë²ˆí˜¸'],
                'ì‹ ì²­ì¼': item['ì‹ ì²­ì¼'],
                'ì·¨ì†Œì‚¬ìœ ': '',
                'ì·¨ì†Œì¼': '',
                'ìˆ˜ìˆ˜ë£Œ': '',
                'ì ‘ìˆ˜ì²˜': '',
                'ê³„ì¢Œ': '',
                'ë¹„ê³ ': ''
            }));

            state.cancellationData[state.targetYear] = [...cancellationItems, ...state.cancellationData[state.targetYear]];
            
            const remainingApplicationData = currentAppData.filter((_, idx) => !state.selectedApplicationRows.has(idx));
            state.applicationData[state.targetYear] = remainingApplicationData;
            
            state.selectedApplicationRows = new Set();
            alert(`${selectedData.length}ê°œ í•­ëª©ì´ ì·¨ì†ŒëŒ€ì¥ìœ¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveDataToStorage();
            render();
        }

        function cutToInspectionYear() {
            if (state.targetYear === state.inspectionYear) {
                alert('âš ï¸ í•´ë‹¹ë…„ë„ì™€ ê²€ì‚¬ì˜ˆì •ë…„ë„ê°€ ê°™ìŠµë‹ˆë‹¤.\nì˜ë¼ë‚´ê¸°ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            if (state.selectedApplicationRows.size === 0) {
                alert('ì˜ë¼ë‚¼ ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedIndices = Array.from(state.selectedApplicationRows).sort((a, b) => b - a);
            const selectedData = selectedIndices.map(idx => ({...currentAppData[idx]}));

            const cutCount = selectedData.length;
            const targetInspectionYear = state.inspectionYear;

            if (!state.applicationData[state.inspectionYear]) {
                state.applicationData[state.inspectionYear] = [];
            }

            state.applicationData[state.inspectionYear] = [...selectedData, ...state.applicationData[state.inspectionYear]];

            selectedIndices.forEach(idx => {
                state.applicationData[state.targetYear].splice(idx, 1);
            });

            state.targetYear = state.inspectionYear;
            state.selectedApplicationRows = new Set();

            alert(`âœ‚ï¸ ${cutCount}ê°œ í•­ëª©ì´ ${targetInspectionYear}ë…„ë„ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveDataToStorage();
            render();
        }

        function saveDataToStorage() {
    // í´ë¼ìš°ë“œ ëª¨ë“œë©´ ë¡œì»¬ ì €ì¥ ê±´ë„ˆë›°ê¸°
    if (CONFIG.ENABLE_CLOUD) {
        state.lastSaved = new Date();
        return true;
    }
    
    const toSave = {
        data: state.data,
        applicationData: state.applicationData,
        quarterData: state.quarterData,
        cancellationData: state.cancellationData,
        pathwayData: state.pathwayData,
        resourceData: state.resourceData,
        settings: state.settings,
        uploadedFileName: state.uploadedFileName,
        selectedYear: state.selectedYear,
        lastSaved: new Date().toISOString(),
        timestamp: new Date().toISOString()
    };
    const saved = saveToLocalStorage(toSave);
    if (saved) {
        state.lastSaved = new Date();
        return true;
    } else {
        console.warn('âš ï¸ ì €ì¥ ì‹¤íŒ¨. ë¶ˆí•„ìš”í•œ ë°ì´í„°ë¥¼ ì‚­ì œí•´ì£¼ì„¸ìš”.');
        return false;
    }
}

        function clearAllData() {
            if (confirm('âš ï¸ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì €ì¥ëœ ë°ì´í„°ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) {
                localStorage.removeItem('safetySystemData');
                state.data = {};
                state.applicationData = {};
                state.quarterData = {};
                state.cancellationData = {};
                state.pathwayData = {};
                state.resourceData = {};
                state.uploadedFileName = '';
                state.lastSaved = null;
                state.showWelcome = true;
                state.showAdmin = false;
                alert('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                render();
            }
        }

        function deleteSelectedRows() {
            if (state.selectedRows.size === 0) {
                alert('ì‚­ì œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            state.showDeleteModal = true;
            render();
        }

        function confirmDelete() {
            const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
            
            selectedData.forEach(selectedItem => {
                state.data[state.selectedYear] = state.data[state.selectedYear].filter(item => item !== selectedItem);
            });
            
            state.selectedRows = new Set();
            state.showDeleteModal = false;
            alert(`${selectedData.length}ê°œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveDataToStorage();
            updateFilters();
            render();
        }

        function addApplicationRow() {
            const newRow = {};
            applicationColumns.forEach(col => {
                newRow[col] = '';
            });
            
            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }
            state.applicationData[state.targetYear] = [newRow, ...state.applicationData[state.targetYear]];
            saveDataToStorage();
            render();
        }

        function deleteSelectedApplicationRows() {
            if (state.selectedApplicationRows.size === 0) {
                alert('ì‚­ì œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            state.showAppDeleteModal = true;
            render();
        }

        function confirmAppDelete() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedIndices = Array.from(state.selectedApplicationRows);
            const newData = currentAppData.filter((_, idx) => !selectedIndices.includes(idx));
            state.applicationData[state.targetYear] = newData;
            
            state.selectedApplicationRows = new Set();
            state.showAppDeleteModal = false;
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            saveDataToStorage();
            render();
        }
        // ======================== íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ë Œë”ë§ ========================
        function renderHistoryModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
                    <div class="bg-white rounded-lg shadow-2xl my-8 w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
                        
                        <div class="bg-purple-600 text-white px-6 py-4 flex items-center justify-between">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">ğŸ“œ</span>
                                ìˆ˜ì • íˆìŠ¤í† ë¦¬
                            </h3>
                            <button id="historyCloseBtn" class="text-white hover:text-gray-200 text-2xl">âœ•</button>
                        </div>

                        <div class="flex-1 overflow-y-auto p-6">
                            ${state.isLoadingHistory ? `
                                <div class="flex items-center justify-center py-12">
                                    <div class="text-center">
                                        <div class="animate-pulse text-4xl mb-4">â³</div>
                                        <p>íˆìŠ¤í† ë¦¬ ë¡œë”© ì¤‘...</p>
                                    </div>
                                </div>
                            ` : state.historyData.length === 0 ? `
                                <div class="text-center py-12 text-gray-500">
                                    <div class="text-5xl mb-4">ğŸ“­</div>
                                    <p>íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                    <p class="text-sm mt-2">í´ë¼ìš°ë“œì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ë©´ íˆìŠ¤í† ë¦¬ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${state.historyData.map((item, idx) => `
                                        <div class="bg-gray-50 border rounded-lg p-4 hover:bg-gray-100">
                                            <div class="flex items-start justify-between">
                                                <div class="flex items-center gap-3">
                                                    <span class="text-2xl">
                                                        ${item['ì‘ì—…'] === 'ë°ì´í„° ì €ì¥' ? 'ğŸ’¾' : 
                                                          item['ì‘ì—…'] === 'í–‰ ìˆ˜ì •' ? 'âœï¸' : 
                                                          item['ì‘ì—…'] === 'í–‰ ì¶”ê°€' ? 'â•' : 
                                                          item['ì‘ì—…'] === 'í–‰ ì‚­ì œ' ? 'ğŸ—‘ï¸' : 'ğŸ“'}
                                                    </span>
                                                    <div>
                                                        <p class="font-semibold text-gray-800">${item['ì‘ì—…']}</p>
                                                        <p class="text-sm text-gray-600">${item['ìƒì„¸ë‚´ìš©']}</p>
                                                        ${item['ì‹œì„¤ë²ˆí˜¸'] ? `<p class="text-xs text-gray-500">ì‹œì„¤: ${item['ì‹œì„¤ë²ˆí˜¸']} - ${item['ì‹œì„¤ëª…'] || ''}</p>` : ''}
                                                    </div>
                                                </div>
                                                <div class="text-right text-sm text-gray-500">
                                                    <p>${new Date(item['íƒ€ì„ìŠ¤íƒ¬í”„']).toLocaleDateString()}</p>
                                                    <p>${new Date(item['íƒ€ì„ìŠ¤íƒ¬í”„']).toLocaleTimeString()}</p>
                                                    <p class="text-xs">${item['ì‚¬ìš©ì']}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>

                        <div class="bg-gray-50 px-6 py-4 border-t">
                            <button id="historyRefreshBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 font-semibold">
                                ğŸ”„ ìƒˆë¡œê³ ì¹¨
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDetailModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
                    <div class="bg-white rounded-lg shadow-2xl my-8 w-full max-w-4xl mx-4 max-h-[95vh] overflow-y-auto">
                        <div class="bg-pink-600 text-white px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">ğŸ‘ï¸</span>
                                ${state.detailModalSelectedIdx !== null ? 'ìƒì„¸ë³´ê¸°' : 'ìƒˆ ë°ì´í„° ì¶”ê°€'}
                            </h3>
                            <button id="detailCloseBtn" class="text-white hover:text-gray-200 text-2xl">âœ•</button>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${columns.map(col => `
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">${col}</label>
                                        <input type="text" id="detail-${col}" value="${state.detailModalData[col] || ''}" 
                                               class="w-full px-3 py-2 border rounded text-sm" 
                                               ${col.includes('ì¼') ? 'type="date"' : ''} />
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t sticky bottom-0 z-10">
                            <button id="detailCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                                ì·¨ì†Œ
                            </button>
                            ${state.detailModalSelectedIdx !== null ? `
                                <button id="detailSaveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                                    ğŸ’¾ ìˆ˜ì •
                                </button>
                            ` : `
                                <button id="detailAddBtn" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-semibold">
                                    â• ì¶”ê°€
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAppDetailModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
                    <div class="bg-white rounded-lg shadow-2xl my-8 w-full max-w-4xl mx-4 max-h-[95vh] overflow-y-auto">
                        <div class="bg-pink-600 text-white px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">ğŸ‘ï¸</span>
                                ${state.appDetailModalSelectedIdx !== null ? 'ìƒì„¸ë³´ê¸° (ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥)' : 'ìƒˆ ë°ì´í„° ì¶”ê°€ (ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥)'}
                            </h3>
                            <button id="appDetailCloseBtn" class="text-white hover:text-gray-200 text-2xl">âœ•</button>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${applicationColumns.map(col => `
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">${col}</label>
                                        ${col === 'ê²€ì‚¬ì›' ? `
                                            <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                                <option value="">ì„ íƒ</option>
                                                ${state.inspectors.map(i => `<option value="${i}" ${i === state.appDetailModalData[col] ? 'selected' : ''}>${i}</option>`).join('')}
                                            </select>
                                        ` : col === 'ê²€ì‚¬ê²°ê³¼' ? `
                                            <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                                <option value="">ì„ íƒ</option>
                                                ${state.inspectionResults.map(r => `<option value="${r}" ${r === state.appDetailModalData[col] ? 'selected' : ''}>${r}</option>`).join('')}
                                            </select>
                                        ` : col === 'ì ‘ìˆ˜ì²˜' ? `
                                            <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                                <option value="">ì„ íƒ</option>
                                                ${state.receiptLocations.map(l => `<option value="${l}" ${l === state.appDetailModalData[col] ? 'selected' : ''}>${l}</option>`).join('')}
                                            </select>
                                        ` : col.includes('ì¼') ? `
                                            <input type="date" id="appDetail-${col}" value="${state.appDetailModalData[col] || ''}" class="w-full px-3 py-2 border rounded text-sm" />
                                        ` : `
                                            <input type="text" id="appDetail-${col}" value="${state.appDetailModalData[col] || ''}" class="w-full px-3 py-2 border rounded text-sm" />
                                        `}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t sticky bottom-0 z-10">
                            <button id="appDetailCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                                ì·¨ì†Œ
                            </button>
                            ${state.appDetailModalSelectedIdx !== null ? `
                                <button id="appDetailSaveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                                    ğŸ’¾ ìˆ˜ì •
                                </button>
                            ` : `
                                <button id="appDetailAddBtn" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-semibold">
                                    â• ì¶”ê°€
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function openAppDetailModal() {
            if (state.selectedApplicationRows.size === 1) {
                const selectedIdx = Array.from(state.selectedApplicationRows)[0];
                const currentAppData = state.applicationData[state.targetYear] || [];
                const selectedData = currentAppData[selectedIdx];
                state.appDetailModalData = { ...selectedData };
                state.appDetailModalSelectedIdx = selectedIdx;
            } else {
                state.appDetailModalData = {};
                state.appDetailModalSelectedIdx = null;
                applicationColumns.forEach(col => {
                    state.appDetailModalData[col] = '';
                });
            }
            state.showAppDetailModal = true;
            render();
        }

        function closeAppDetailModal() {
            state.showAppDetailModal = false;
            render();
        }

        function saveFromAppDetailModal() {
            applicationColumns.forEach(col => {
                const input = document.getElementById(`appDetail-${col}`);
                if (input) {
                    state.appDetailModalData[col] = input.value;
                }
            });
            
            if (state.appDetailModalSelectedIdx !== null && state.appDetailModalSelectedIdx >= 0) {
                state.applicationData[state.targetYear][state.appDetailModalSelectedIdx] = { ...state.appDetailModalData };
            }
            
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showAppDetailModal = false;
            alert('ğŸ’¾ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            render();
        }

        function addFromAppDetailModal() {
            applicationColumns.forEach(col => {
                const input = document.getElementById(`appDetail-${col}`);
                if (input) {
                    state.appDetailModalData[col] = input.value;
                }
            });
            
            const newRow = { ...state.appDetailModalData };
            
            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }
            state.applicationData[state.targetYear] = [newRow, ...state.applicationData[state.targetYear]];
            
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showAppDetailModal = false;
            alert('ë°ì´í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            render();
        }

                    function renderMapModal() {
                        return `
                            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto p-4">
                                <div class="bg-white rounded-lg shadow-2xl my-8" style="width: 210mm; max-width: 210mm; height: 297mm; display: flex; flex-direction: column; overflow: hidden;">
                                    <div class="flex items-center justify-between p-6 border-b sticky top-0 bg-white z-10">
                                        <h3 class="text-2xl font-bold">ğŸ—ºï¸ ì‹œì„¤ ìœ„ì¹˜ ì§€ë„</h3>
                                        <button id="mapCloseBtn" class="text-gray-600 hover:text-gray-900 text-3xl font-bold">âœ•</button>
                        </div>
                       <div style="position: relative;">
                        <div id="mapContainer" style="width: 100%; height: 800px; background: #f0f0f0; border: 1px solid #ccc;"></div>
                        <div id="mapFacilityOverlay" style="position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 100; display: none;">
                            <h4 style="margin: 0 0 8px 0; font-weight: bold; font-size: 14px; color: #333;">ğŸ“ ì‹œì„¤ ëª©ë¡</h4>
                            ${state.mapData.map((item, idx) => `
                                <div style="padding: 4px 0; border-bottom: 1px solid #eee; font-size: 12px;">
                                    <strong>${idx + 1}. ${item['ì‹œì„¤ëª…']}</strong>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                        <div id="mapLoadingBar" style="padding: 1.5rem; background: #eff6ff; border-top: 1px solid #bfdbfe; ${state.isLoadingMap ? '' : 'display: none;'}">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-blue-700">ì§€ë„ ë¡œë”© ì¤‘...</span>
                                <span id="mapProgressText" class="text-sm font-bold text-blue-600">${state.mapLoadingProgress}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="mapProgressBar" class="bg-blue-600 h-3 rounded-full transition-all" style="width: ${state.mapLoadingProgress}%;"></div>
                            </div>
                        </div>
                        <div class="p-2 bg-gray-50 border-t max-h-24 overflow-y-auto">
                            <h4 class="font-bold mb-1 text-sm">ğŸ“ ì„ íƒëœ ì‹œì„¤ ì£¼ì†Œ</h4>
                            <div class="space-y-3">
                                ${state.mapData.map((item) => `
                                    <div class="bg-white p-4 rounded border-l-4 border-blue-500">
                                        <p class="font-semibold">${item['ì‹œì„¤ëª…']}</p>
                                        <p class="text-sm text-gray-600">ì‹œì„¤ë²ˆí˜¸: ${item['ì‹œì„¤ë²ˆí˜¸']}</p>
                                        <p class="text-sm text-gray-700">ğŸ“® ${item['ìƒˆì£¼ì†Œ']}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="flex gap-2 justify-end p-2 border-t bg-white">
                            <button id="mapPrintBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                                ğŸ–¨ï¸ ì¸ì‡„
                            </button>
                            <button id="mapCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                                ë‹«ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function openDetailModal() {
            if (state.selectedRows.size === 1) {
                const selectedIdx = Array.from(state.selectedRows)[0];
                const selectedData = state.filteredData[selectedIdx];
                state.detailModalData = { ...selectedData };
                state.detailModalSelectedIdx = (state.data[state.selectedYear] || []).indexOf(selectedData);
            } else {
                state.detailModalData = {};
                state.detailModalSelectedIdx = null;
                columns.forEach(col => {
                    state.detailModalData[col] = '';
                });
            }
            state.showDetailModal = true;
            render();
        }

        function closeDetailModal() {
            state.showDetailModal = false;
            render();
        }

        function saveFromDetailModal() {
            columns.forEach(col => {
                const input = document.getElementById(`detail-${col}`);
                if (input) {
                    state.detailModalData[col] = input.value;
                }
            });
            
            if (state.detailModalSelectedIdx !== null && state.detailModalSelectedIdx >= 0) {
                state.data[state.selectedYear][state.detailModalSelectedIdx] = { ...state.detailModalData };
            } else {
                if (!state.data[state.selectedYear]) {
                    state.data[state.selectedYear] = [];
                }
                state.data[state.selectedYear] = [{ ...state.detailModalData }, ...state.data[state.selectedYear]];
            }
            
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showDetailModal = false;
            alert('ğŸ’¾ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            updateFilters();
            render();
        }

        function addFromDetailModal() {
            const newRow = { ...state.detailModalData };
            if (!state.data[state.selectedYear]) {
                state.data[state.selectedYear] = [];
            }
            state.data[state.selectedYear] = [newRow, ...state.data[state.selectedYear]];
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showDetailModal = false;
            alert('ë°ì´í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            updateFilters();
            render();
        }
        // ======================== ë Œë”ë§ í•¨ìˆ˜ ========================
        function render() {
            try {
                updateFilters();
                const app = document.getElementById('app');
                if (!app) {
                    console.error('#app ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                app.innerHTML = renderApp();
                attachEventListeners();
            } catch (error) {
                console.error('ë Œë”ë§ ì˜¤ë¥˜:', error);
                const app = document.getElementById('app');
                if (app) {
                    app.innerHTML = `<div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
                }
            }
        }

        function renderApp() {
            return `
                <div class="min-h-screen bg-gradient-to-b from-sky-400 to-sky-200">
                    ${renderHeader()}
                    ${renderTabs()}
                    <div class="container mx-auto px-4 py-6">
                        ${renderContent()}
                    </div>
                    ${renderFooter()}
                    ${state.isLoading ? renderLoadingModal() : ''}
                    ${state.showDuplicateModal ? renderDuplicateModal() : ''}
                    ${state.showDeleteModal ? renderDeleteModal() : ''}
                    ${state.showAppDeleteModal ? renderAppDeleteModal() : ''}
                    ${state.showDetailModal ? renderDetailModal() : ''}
                    ${state.showAppDetailModal ? renderAppDetailModal() : ''}
                    ${state.showMapModal ? renderMapModal() : ''}
                    ${state.showHistoryModal ? renderHistoryModal() : ''}
                </div>
            `;
        }

        function renderHeader() {
            const years = Array.from({ length: 10 }, (_, i) => state.currentYear - i);
            return `
                <div class="bg-gradient-to-r from-sky-400 to-sky-500 text-white">
                    <div class="container mx-auto px-4 py-6">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div>
                                <h1 class="text-3xl font-bold">ê³µì¸ê²€ì‚¬ê¸°ê´€</h1>
                                <p class="text-lg">ì•ˆì „ê´€ë¦¬ì‹œìŠ¤í…œ v2.1 â˜ï¸ (í´ë¼ìš°ë“œ ì—°ë™)</p>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <button id="cloudSaveBtn" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg font-semibold flex items-center gap-2 text-sm">
                                    â˜ï¸ í´ë¼ìš°ë“œ ì €ì¥
                                </button>
                                <button id="cloudLoadBtn" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg font-semibold flex items-center gap-2 text-sm">
                                    ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°
                                </button>
                                <button id="historyBtn" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg font-semibold flex items-center gap-2 text-sm">
                                    ğŸ“œ íˆìŠ¤í† ë¦¬
                                </button>
                            </div>
                            
                            <div class="text-right">
                                <label class="block text-sm mb-1">ë‹¹í•´ ì—°ë„</label>
                                <select id="yearSelect" class="px-4 py-2 text-gray-900 rounded border-2 border-white">
                                    ${years.map(year => `<option value="${year}" ${year === state.selectedYear ? 'selected' : ''}>${year}ë…„</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTabs() {
            const tabs = ['í†µí•©', 'ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥', 'ë¶„ê¸°', 'ê²½ë¡œë‹¹', 'ë§¤ì¶œë¶„ì„', 'ì·¨ì†Œ', 'ìë£Œì‹¤', 'ê´€ë¦¬ì'];
            return `
                <div class="bg-white border-b shadow-sm">
                    <div class="container mx-auto px-4">
                        <div class="flex gap-1 overflow-x-auto">
                            ${tabs.map(tab => `
                                <button class="tab-btn px-6 py-3 font-semibold whitespace-nowrap ${state.activeTab === tab ? 'bg-blue-600 text-white border-b-4 border-blue-800' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}" data-tab="${tab}">
                                    ${tab}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContent() {
            if (state.showWelcome && Object.keys(state.data).length === 0 && state.activeTab === 'í†µí•©') {
                return renderWelcome();
            }
            
            if (state.activeTab === 'ê´€ë¦¬ì') {
                return renderAdmin();
            }
            
            if (state.activeTab === 'ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥') {
                return renderApplicationTab();
            }

            if (state.activeTab === 'ë¶„ê¸°') {
                return renderQuarterTab();
            }

            if (state.activeTab === 'ë§¤ì¶œë¶„ì„') {
                return renderSalesAnalysisTab();
            }

            if (state.activeTab === 'ê²½ë¡œë‹¹') {
                return renderPathwayTab();
            }

           if (state.activeTab === 'ìë£Œì‹¤') {
                return renderResourceTab();
            }

            if (state.activeTab === 'ì·¨ì†Œ') {
                return `<div class="bg-white rounded-lg p-6 shadow"><h2 class="text-xl font-bold">ì·¨ì†Œ íƒ­</h2><p class="text-gray-600 mt-2">ì·¨ì†Œ ê¸°ëŠ¥ì€ ì›ë³¸ê³¼ ë™ì¼í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤.</p></div>`;
            }
            
            return renderMainTab();
        }

        function renderWelcome() {
            return `
                <div class="flex items-center justify-center min-h-96">
                    <div class="bg-white p-12 rounded-2xl shadow-2xl max-w-2xl text-center">
                        <h2 class="text-4xl font-bold mb-6 text-blue-600">ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                        <p class="text-xl mb-8 text-gray-700">ê³µì¸ê²€ì‚¬ê¸°ê´€ ì•ˆì „ê´€ë¦¬ì‹œìŠ¤í…œ</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <button id="sampleDataBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-6 rounded-xl hover:from-blue-600 hover:to-blue-700 shadow-lg transform hover:scale-105 transition-all">
                                <div class="text-4xl mb-3">ğŸ¯</div>
                                <div class="text-lg font-bold mb-2">ìƒ˜í”Œ ë°ì´í„°</div>
                                <div class="text-sm opacity-90">í…ŒìŠ¤íŠ¸ìš© 2ê±´ ìƒì„±</div>
                            </button>

                            <label class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-6 rounded-xl hover:from-green-600 hover:to-green-700 shadow-lg transform hover:scale-105 transition-all cursor-pointer">
                                <div class="text-4xl mb-3">ğŸ“</div>
                                <div class="text-lg font-bold mb-2">íŒŒì¼ ì—…ë¡œë“œ</div>
                                <div class="text-sm opacity-90">Excel/CSV ê°€ì ¸ì˜¤ê¸°</div>
                                <input type="file" id="welcomeFileInput" accept=".csv,.xlsx,.xls" class="hidden" />
                            </label>

                            <button id="cloudLoadWelcomeBtn" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-6 rounded-xl hover:from-purple-600 hover:to-purple-700 shadow-lg transform hover:scale-105 transition-all">
                                <div class="text-4xl mb-3">â˜ï¸</div>
                                <div class="text-lg font-bold mb-2">í´ë¼ìš°ë“œ ë¶ˆëŸ¬ì˜¤ê¸°</div>
                                <div class="text-sm opacity-90">ì €ì¥ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</div>
                            </button>
                        </div>

                        <button id="emptyStartBtn" class="mt-6 text-gray-500 hover:text-gray-700 underline">
                            ë¹ˆ í™”ë©´ìœ¼ë¡œ ì‹œì‘
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAdmin() {
            if (!state.showAdmin) {
                return `
                    <div class="flex items-center justify-center h-96">
                        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
                            <h2 class="text-xl font-bold mb-4">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
                            <input type="password" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" class="w-full px-4 py-2 border rounded mb-4" />
                            <button id="adminLoginBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                ë¡œê·¸ì¸
                            </button>
                        </div>
                    </div>
                `;
            }
            
            const totalMainData = Object.values(state.data).reduce((sum, yearData) => sum + yearData.length, 0);
            const totalAppData = Object.values(state.applicationData).reduce((sum, yearData) => sum + (yearData ? yearData.length : 0), 0);
            
            return `
                <div class="p-6 bg-white rounded-lg">
                    <h2 class="text-2xl font-bold mb-6">ì‹œìŠ¤í…œ ê´€ë¦¬</h2>
                    <div class="space-y-6">
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold mb-4">ì‹œìŠ¤í…œ ì •ë³´</h3>
                            <div class="bg-gray-50 p-4 rounded space-y-2 text-sm">
                                <p><strong>ë²„ì „:</strong> 2.1.0 (í´ë¼ìš°ë“œ ì—°ë™)</p>
                                <p><strong>ì „ì²´ ë°ì´í„°:</strong> ${totalMainData}ê±´</p>
                                <p><strong>ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥:</strong> ${totalAppData}ê±´</p>
                                <p><strong>ì €ì¥ ê³µê°„:</strong> ${getStorageSize()} MB / ~5 MB</p>
                                <p><strong>í´ë¼ìš°ë“œ:</strong> ${CONFIG.ENABLE_CLOUD ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}</p>
                                ${state.lastCloudSync ? `<p><strong>ë§ˆì§€ë§‰ ë™ê¸°í™”:</strong> ${state.lastCloudSync.toLocaleString()}</p>` : ''}
                            </div>
                        </div>
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold mb-4 text-red-600">ìœ„í—˜ êµ¬ì—­</h3>
                            <button id="clearAllBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-semibold">
                                ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainTab() {
            const uniqueRegions = [...new Set(
                (state.data[state.selectedYear] || []).map(row => (row['í–‰ì •êµ¬ì—­'] || '').replace(/[\\\/]/g, '').trim()).filter(Boolean)
            )].sort();

            const totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);
            const paginatedData = state.filteredData.slice(
                (state.currentPage - 1) * state.itemsPerPage,
                state.currentPage * state.itemsPerPage
            );

            return `
                <div>
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <button id="uploadBtn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ğŸ“¤ ì—…ë¡œë“œ</button>
                             <button id="uploadGoogleSheetBtn" class="flex items-center gap-2 bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800">ğŸ“— êµ¬ê¸€ì‹œíŠ¸</button>
                            <div class="relative">
                                <button id="downloadBtn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                              ${state.showDownloadMenu ? `
                            <div class="absolute top-full mt-1 right-0 bg-white border rounded shadow-lg z-20 w-48">
                                <button id="downloadExcelBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left">ğŸ“Š Excel ë‹¤ìš´ë¡œë“œ</button>
                                <button id="downloadCSVBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left border-t">ğŸ“„ CSV ë‹¤ìš´ë¡œë“œ</button>
                                <button id="downloadGoogleSheetBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left border-t">ğŸ“— êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë‚´ë³´ë‚´ê¸°</button>
                            </div>
                        ` : ''}  
                            </div>
                            <button id="sampleBtn" class="flex items-center gap-2 bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">ğŸ¯ ìƒ˜í”Œ ë°ì´í„°</button>
                            <button id="editToggleBtn" class="flex items-center gap-2 bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">âœï¸ ${state.isEditing ? 'ì™„ë£Œ' : 'í¸ì§‘'}</button>
                            <button id="saveBtn" class="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">ğŸ’¾ ì €ì¥</button>
                            <button id="copyBtn" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ğŸ“‹ ì‹ ì²­</button>
                            <button id="deleteBtn" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">ğŸ—‘ï¸ ì‚­ì œ</button>
                            <button id="detailBtn" class="flex items-center gap-2 bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">ğŸ‘ï¸ ìƒì„¸ë³´ê¸°/ì¶”ê°€</button>
                        </div>

                        ${state.uploadedFileName ? `
                            <div class="mb-4 px-3 py-2 bg-blue-50 border border-blue-200 rounded text-sm flex items-center justify-between">
                                <span>ğŸ“‚ <strong>${state.uploadedFileName}</strong> (${(state.data[state.selectedYear] || []).length}ê±´)</span>
                                ${state.lastSaved ? `<span class="text-gray-600 text-xs">ë§ˆì§€ë§‰ ì €ì¥: ${state.lastSaved.toLocaleTimeString()}</span>` : ''}
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                            <div class="relative">
                                <label class="block text-xs font-semibold mb-1">í–‰ì •êµ¬ì—­</label>
                                <button id="regionDropdownBtn" class="w-full px-2 py-1 border rounded text-left text-xs bg-white hover:bg-gray-50">
                                    ${state.filters.region.length === 0 ? 'ì„ íƒ...' : state.filters.region.join(', ')}
                                </button>
                                ${state.showRegionDropdown ? `
                                    <div class="absolute top-full left-0 right-0 border border-t-0 rounded-b bg-white z-50 max-h-32 overflow-y-auto text-xs">
                                        <div class="space-y-1 p-1">
                                            ${uniqueRegions.length === 0 ? `<div class="text-gray-400 py-2 px-1">ë°ì´í„° ì—†ìŒ</div>` : `
                                                <label class="flex items-center cursor-pointer hover:bg-blue-50 px-1 py-0.5 rounded">
                                                    <input type="checkbox" id="selectAllRegions" ${state.filters.region.length === uniqueRegions.length && uniqueRegions.length > 0 ? 'checked' : ''} class="mr-1" />
                                                    <span class="font-semibold text-blue-700">ì „ì²´</span>
                                                </label>
                                                ${uniqueRegions.map(region => `
                                                    <label class="flex items-center cursor-pointer hover:bg-gray-50 px-1 py-0.5 rounded region-checkbox">
                                                        <input type="checkbox" value="${region}" ${state.filters.region.includes(region) ? 'checked' : ''} class="mr-1" />
                                                        <span>${region}</span>
                                                    </label>
                                                `).join('')}
                                            `}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div>
                                <label class="block text-xs font-semibold mb-1">ê²€ìƒ‰</label>
                                <div class="flex gap-1">
                                    <input type="text" id="searchInput" value="${state.searchTerm}" placeholder="ê²€ìƒ‰..." class="flex-1 px-2 py-1 border rounded text-xs" />
                                    <button id="searchBtn" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">ğŸ”</button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold mb-1">ê¸°ì¤€ì›”</label>
                                <select id="mainBaseMonthFilter" class="w-full px-2 py-1 border rounded text-xs">
                                    <option value="">ì „ì²´</option>
                                    ${Array.from({length: 12}, (_, i) => `<option value="${i+1}" ${state.filters.month === String(i+1) ? 'selected' : ''}>${i+1}ì›”</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">ê²€ì‚¬ì´ë ¥</label>
                                <select id="mainInspectionHistoryFilter" class="w-full px-2 py-1 border rounded text-xs">
                                    <option value="">ì „ì²´</option>
                                    <option value="Y" ${state.filters.inspectionHistory === 'Y' ? 'selected' : ''}>Y</option>
                                    <option value="N" ${state.filters.inspectionHistory === 'N' ? 'selected' : ''}>N</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">í•„í„° ì´ˆê¸°í™”</label>
                                <button id="mainFilterResetBtn" class="w-full px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-xs">ğŸ”„ ì´ˆê¸°í™”</button>
                            </div> 
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse" style="table-layout: fixed; min-width: 2520px;">
                                <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2 sticky left-0 bg-blue-600 z-20" style="width: 50px;">
                                            <input type="checkbox" id="selectAllRows" ${state.selectedRows.size === state.filteredData.length && state.filteredData.length > 0 ? 'checked' : ''} />
                                        </th>
                                    
                                       ${columns.map(col => `
                                            <th class="border px-3 py-2 text-sm" style="width: 120px;">
                                                <div class="truncate" title="${col}">${col}</div>
                                            </th>
                                        `).join('')} 
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paginatedData.map((row, idx) => {
                                        const actualIdx = (state.currentPage - 1) * state.itemsPerPage + idx;
                                        return `
                                       <tr class="${state.selectedRows.has(actualIdx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                        <td class="border px-2 py-2 text-center sticky left-0 bg-white z-10" style="width: 50px;">
                                            <input type="checkbox" class="row-checkbox" data-idx="${actualIdx}" ${state.selectedRows.has(actualIdx) ? 'checked' : ''} />
                                        </td>
                                        ${columns.map(col => `
                                            <td class="border px-3 py-2 text-sm" style="width: 120px; max-width: 120px;">
                                                ${state.isEditing ? `
                                                    <input type="text" value="${row[col] || ''}" class="table-cell-input cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                             ` : `
                                                <div class="truncate ${col === 'ì‚¬ìš©ëŸ‰' ? 'text-right' : ''}" title="${row[col] || '-'}">${col === 'ì‚¬ìš©ëŸ‰' ? (formatCurrency(row[col]) || '-') : (row[col] || '-')}</div>
                                            `} 
                                            </td>
                                        `).join('')}
                                    </tr>    
                                        `;
                                    }).join('')}
                                    ${paginatedData.length === 0 ? `
                                        <tr>
                                            <td colspan="${columns.length + 2}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">ğŸ“‹</div>
                                                <div>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>

                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                ì „ì²´ ${state.filteredData.length}ê±´
                                ${state.filteredData.length > 0 ? ` ì¤‘ ${((state.currentPage - 1) * state.itemsPerPage) + 1}-${Math.min(state.currentPage * state.itemsPerPage, state.filteredData.length)}ê±´ í‘œì‹œ` : ''}
                                ${state.selectedRows.size > 0 ? ` (${state.selectedRows.size}ê±´ ì„ íƒë¨)` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="prevPageBtn" ${state.currentPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">â—€</button>
                                <span class="px-4 py-2">${state.currentPage} / ${totalPages || 1}</span>
                                <button id="nextPageBtn" ${state.currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">â–¶</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderApplicationTab() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            
            const uniqueAppRegions = [...new Set(currentAppData.map(row => row['í–‰ì •êµ¬ì—­']).filter(Boolean))].sort();

            let filteredApplicationData = currentAppData
                .map((row, idx) => row !== null && row !== undefined ? {...row, _originalIdx: idx} : null)
                .filter(row => row !== null);
            
            if (state.applicationFilters.region.length > 0) {
                filteredApplicationData = filteredApplicationData.filter(row => 
                    state.applicationFilters.region.includes(row['í–‰ì •êµ¬ì—­'])
                );
            }

            if (state.applicationFilters.inspector) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['ê²€ì‚¬ì›'] === state.applicationFilters.inspector
                );
            }

            if (state.applicationFilters.inspectionResult) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['ê²€ì‚¬ê²°ê³¼'] === state.applicationFilters.inspectionResult
                );
            }

            if (state.applicationFilters.receiptLocation) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['ì ‘ìˆ˜ì²˜'] === state.applicationFilters.receiptLocation
                );
            }

            if (state.applicationFilters.baseMonth) {
                filteredApplicationData = filteredApplicationData.filter(row => {
                    const baseDate = row['ê¸°ì¤€ì¼'];
                    if (!baseDate) return false;
                    const month = parseInt(baseDate.split('-')[1]);
                    return month === parseInt(state.applicationFilters.baseMonth);
                });
            }

            if (state.applicationFilters.applicationDateFrom) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['ì‹ ì²­ì¼'] >= state.applicationFilters.applicationDateFrom
                );
            }

            if (state.applicationFilters.applicationDateTo) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['ì‹ ì²­ì¼'] <= state.applicationFilters.applicationDateTo
                );
            }

            if (state.applicationFilters.inspectionDateFrom) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['ê²€ì‚¬ì¼'] >= state.applicationFilters.inspectionDateFrom
                );
            }

            if (state.applicationFilters.inspectionDateTo) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['ê²€ì‚¬ì¼'] <= state.applicationFilters.inspectionDateTo
                );
            }

            if (state.applicationFilters.fee) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    String(row['ìˆ˜ìˆ˜ë£Œ']).includes(state.applicationFilters.fee)
                );
            }

            if (state.applicationSearchTerm) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    Object.values(row).some(val =>
                        String(val).toLowerCase().includes(state.applicationSearchTerm.toLowerCase())
                    )
                );
            }
            
            // í•„ì¦ë²ˆí˜¸ ê¸°ì¤€ ì •ë ¬: ë¹ˆ ê°’ì€ ë§¨ ìœ„, ë‚˜ë¨¸ì§€ëŠ” ë‚´ë¦¼ì°¨ìˆœ
            filteredApplicationData.sort((a, b) => {
                const certA = a['í•„ì¦ë²ˆí˜¸'] || '';
                const certB = b['í•„ì¦ë²ˆí˜¸'] || '';
                
                if (!certA && !certB) return 0;
                if (!certA) return -1;
                if (!certB) return 1;
                return certB.localeCompare(certA);
            });
            
            const totalAppPages = Math.ceil(filteredApplicationData.length / state.itemsPerPage);
            
            const paginatedAppData = filteredApplicationData.slice(
                (state.currentApplicationPage - 1) * state.itemsPerPage,
                state.currentApplicationPage * state.itemsPerPage
            );

            return `
                <div>
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">í•´ë‹¹ë…„ë„</label>
                                    <select id="targetYearSelect" class="px-3 py-2 border rounded">
                                        ${state.yearRange.map(year => `<option value="${year}" ${year === state.targetYear ? 'selected' : ''}>${year}ë…„</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">ê²€ì‚¬ì˜ˆì •ë…„ë„</label>
                                    <select id="inspectionYearSelect" class="px-3 py-2 border rounded">
                                        ${state.yearRange.map(year => `<option value="${year}" ${year === state.inspectionYear ? 'selected' : ''}>${year}ë…„</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <button id="appUploadBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ğŸ“¤ ì—…ë¡œë“œ</button>
                            <button id="appAddRowBtn" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">í–‰ ì¶”ê°€</button>
                            <button id="appDeleteRowBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">ğŸ—‘ï¸ í–‰ ì‚­ì œ</button>
                            <button id="appEditToggleBtn" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">${state.isEditingApplication ? 'í¸ì§‘ì™„ë£Œ' : 'í¸ì§‘'}</button>
                            <button id="appSaveBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">ì €ì¥</button>
                            <div class="relative">
                            <button id="appDownloadBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                            ${state.showAppDownloadMenu ? `
                                <div class="absolute top-full mt-1 right-0 bg-white border rounded shadow-lg z-20 w-48">
                                    <button id="appDownloadExcelBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left">ğŸ“Š Excel ë‹¤ìš´ë¡œë“œ</button>
                                    <button id="appDownloadCSVBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left border-t">ğŸ“„ CSV ë‹¤ìš´ë¡œë“œ</button>
                                </div>
                            ` : ''}
                        </div>                            
                            <button id="appMapBtn" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800">ğŸ—ºï¸ MAP</button>
                            <button id="cutBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">âœ‚ï¸ ë‚´ë…„ìœ¼ë¡œ</button>
                            <button id="cancelBtn" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">ì·¨ì†Œ</button>
                            <button id="appDetailBtn" class="px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700">ğŸ‘ï¸ ìƒì„¸ë³´ê¸°</button>
                        </div>

                        <div class="grid grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">í–‰ì •êµ¬ì—­</label>
                                <select id="appRegionFilter" class="w-full px-3 py-2 border rounded text-sm">
                                    <option value="">ì „ì²´</option>
                                    ${uniqueAppRegions.map(r => `<option value="${r}" ${state.applicationFilters.region.includes(r) ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ê²€ì‚¬ì›</label>
                                <select id="appInspectorFilter" class="w-full px-3 py-2 border rounded text-sm">
                                    <option value="">ì„ íƒ</option>
                                    ${state.inspectors.map(i => `<option value="${i}" ${state.applicationFilters.inspector === i ? 'selected' : ''}>${i}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ê²€ì‚¬ê²°ê³¼</label>
                                <select id="appResultFilter" class="w-full px-3 py-2 border rounded text-sm">
                                    <option value="">ì„ íƒ</option>
                                    ${state.inspectionResults.map(r => `<option value="${r}" ${state.applicationFilters.inspectionResult === r ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ì ‘ìˆ˜ì²˜</label>
                                <select id="appReceiptFilter" class="w-full px-3 py-2 border rounded text-sm">
                                    <option value="">ì„ íƒ</option>
                                    ${state.receiptLocations.map(l => `<option value="${l}" ${state.applicationFilters.receiptLocation === l ? 'selected' : ''}>${l}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">ì‹ ì²­ì¼</label>
                                <div class="flex gap-1">
                                    <input type="date" id="appDateFrom" value="${state.applicationFilters.applicationDateFrom}" class="flex-1 px-2 py-2 border rounded text-sm" />
                                    <input type="date" id="appDateTo" value="${state.applicationFilters.applicationDateTo}" class="flex-1 px-2 py-2 border rounded text-sm" />
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ê²€ì‚¬ì¼</label>
                                <div class="flex gap-1">
                                    <input type="date" id="appInspDateFrom" value="${state.applicationFilters.inspectionDateFrom}" class="flex-1 px-2 py-2 border rounded text-sm" />
                                    <input type="date" id="appInspDateTo" value="${state.applicationFilters.inspectionDateTo}" class="flex-1 px-2 py-2 border rounded text-sm" />
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ê¸°ì¤€ì›”</label>
                                <select id="appBaseMonthFilter" class="w-full px-3 py-2 border rounded text-sm">
                                    <option value="">ì„ íƒ</option>
                                    ${Array.from({length: 12}, (_, i) => `<option value="${i+1}" ${state.applicationFilters.baseMonth === String(i+1) ? 'selected' : ''}>${i+1}ì›”</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ìˆ˜ìˆ˜ë£Œ</label>
                                <input type="text" id="appFeeFilter" value="${state.applicationFilters.fee}" placeholder="ìˆ˜ìˆ˜ë£Œ ì…ë ¥" class="w-full px-3 py-2 border rounded text-sm" />
                            </div>
                        </div>
                        <div class="flex gap-4 items-end mb-4">
                            <div class="flex-1">
                                <label class="block text-sm font-semibold mb-1">ê²€ìƒ‰</label>
                                <div class="flex gap-1">
                                    <input type="text" id="appSearchInput" value="${state.applicationSearchTerm}" placeholder="ì‹œì„¤ëª…, ì‹œì„¤ë²ˆí˜¸, ì£¼ì†Œ ë“± ê²€ìƒ‰..." class="flex-1 px-3 py-2 border rounded text-sm" />
                                    <button id="appSearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">ğŸ”</button>
                                </div>
                            </div>
                            <button id="appFilterResetBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">ğŸ”„ í•„í„° ì´ˆê¸°í™”</button>
                        </div> 
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse text-sm" style="table-layout: fixed; min-width: 2600px;">
                                <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2" style="width: 50px;">
                                            <input type="checkbox" id="selectAllAppRows" ${state.selectedApplicationRows.size === filteredApplicationData.length && filteredApplicationData.length > 0 ? 'checked' : ''} />
                                        </th>
                                        ${applicationColumns.map(col => `
                                            <th class="border px-2 py-2" style="width: ${columnWidths[col]};">
                                                <div class="truncate" title="${col}">${col}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paginatedAppData.map((row, idx) => {
                                        const originalIdx = row._originalIdx;
                                        return `
                                            <tr class="${state.selectedApplicationRows.has(originalIdx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                                <td class="border px-2 py-1 text-center" style="width: 50px;">
                                                    <input type="checkbox" class="app-row-checkbox" data-idx="${originalIdx}" ${state.selectedApplicationRows.has(originalIdx) ? 'checked' : ''} />
                                                </td>
                                                ${applicationColumns.map(col => `
                                                    <td class="border px-2 py-1 text-sm" style="width: ${columnWidths[col]};">
                                                        ${state.isEditingApplication ? `
                                                            ${col.includes('ì¼') ? `
                                                                <input type="date" value="${row[col] || ''}" class="table-cell-input app-cell-edit" data-idx="${originalIdx}" data-col="${col}" />
                                                            ` : col === 'ê²€ì‚¬ì›' ? `
                                                                <select class="table-cell-input app-cell-edit" data-idx="${originalIdx}" data-col="${col}">
                                                                    <option value="">ì„ íƒ</option>
                                                                    ${state.inspectors.map(i => `<option value="${i}" ${i === row[col] ? 'selected' : ''}>${i}</option>`).join('')}
                                                                </select>
                                                            ` : col === 'ê²€ì‚¬ê²°ê³¼' ? `
                                                                <select class="table-cell-input app-cell-edit" data-idx="${originalIdx}" data-col="${col}">
                                                                    <option value="">ì„ íƒ</option>
                                                                    ${state.inspectionResults.map(r => `<option value="${r}" ${r === row[col] ? 'selected' : ''}>${r}</option>`).join('')}
                                                                </select>
                                                            ` : col === 'ì ‘ìˆ˜ì²˜' ? `
                                                                <select class="table-cell-input app-cell-edit" data-idx="${originalIdx}" data-col="${col}">
                                                                    <option value="">ì„ íƒ</option>
                                                                    ${state.receiptLocations.map(l => `<option value="${l}" ${l === row[col] ? 'selected' : ''}>${l}</option>`).join('')}
                                                                </select>
                                                            ` : `
                                                                <input type="text" value="${row[col] || ''}" class="table-cell-input app-cell-edit" data-idx="${originalIdx}" data-col="${col}" />
                                                            `}
                                                        ` : `
                                                          <div class="truncate ${col === 'ìˆ˜ìˆ˜ë£Œ' ? 'text-right' : col === 'ì‚¬ìš©ëŸ‰' ? 'text-right' : ''}" title="${row[col] || '-'}">${col === 'ìˆ˜ìˆ˜ë£Œ' || col === 'ì‚¬ìš©ëŸ‰' ? (formatCurrency(row[col]) || '-') : (row[col] || '-')}</div>  
                                                        `}
                                                    </td>
                                                `).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${paginatedAppData.length === 0 ? `
                                        <tr>
                                            <td colspan="${applicationColumns.length + 2}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">ğŸ“‹</div>
                                                <div>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                ì „ì²´ ${filteredApplicationData.length}ê±´
                                ${state.selectedApplicationRows.size > 0 ? ` (${state.selectedApplicationRows.size}ê±´ ì„ íƒë¨)` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="appPrevPageBtn" ${state.currentApplicationPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">â—€</button>
                                <span class="px-4 py-2">${state.currentApplicationPage} / ${totalAppPages || 1}</span>
                                <button id="appNextPageBtn" ${state.currentApplicationPage === totalAppPages || totalAppPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">â–¶</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

       function renderQuarterTab() {
            const quarterColumns = ['ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'ê¸°ì¤€ì¼', 'ê²€ì‚¬ì¼', 'í•„ì¦ë²ˆí˜¸'];
            
            const recipientList = Object.keys(state.quarter.recipients);
            
            // ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥ì—ì„œ ê²€ì‚¬ê²°ê³¼ê°€ "í•©ê²©"ì¸ ë°ì´í„°ë§Œ í•„í„°ë§
            const currentAppData = state.applicationData[state.targetYear] || [];
            let filteredData = currentAppData.filter(row => row['ê²€ì‚¬ê²°ê³¼'] === 'í•©ê²©');
            
            // ë¶„ê¸° í•„í„°ë§ (ê¸°ì¤€ì¼ ê¸°ì¤€)
            if (state.quarter.selectedQuarter) {
                const quarterMonths = {
                    '1ë¶„ê¸°': [1, 2, 3],
                    '2ë¶„ê¸°': [4, 5, 6],
                    '3ë¶„ê¸°': [7, 8, 9],
                    '4ë¶„ê¸°': [10, 11, 12]
                };
                const months = quarterMonths[state.quarter.selectedQuarter] || [];
                filteredData = filteredData.filter(row => {
                    const baseDate = row['ê¸°ì¤€ì¼'];
                    if (!baseDate) return false;
                    const month = parseInt(baseDate.split('-')[1]);
                    return months.includes(month);
                });
            }
            
            // ìˆ˜ì‹ ì²˜ í•„í„°ë§
            if (state.quarter.selectedRecipient) {
                const regions = state.quarter.recipients[state.quarter.selectedRecipient] || [];
                filteredData = filteredData.filter(row => {
                    const rowRegion = row['í–‰ì •êµ¬ì—­'] || '';
                    return regions.some(r => rowRegion.includes(r) || rowRegion === r);
                });
            }
            
            // í–‰ì •êµ¬ì—­ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            filteredData.sort((a, b) => {
                const regionA = a['í–‰ì •êµ¬ì—­'] || '';
                const regionB = b['í–‰ì •êµ¬ì—­'] || '';
                return regionA.localeCompare(regionB, 'ko');
            });

            return `
                <div>
                    <div class="bg-blue-50 border border-blue-300 rounded-lg p-4 mb-4">
                        <h2 class="text-xl font-bold text-blue-800 flex items-center gap-2">
                            <span>ğŸ“Š</span> ë¶„ê¸°ë³„ ê²€ì‚¬í˜„í™©: ${state.targetYear}ë…„
                        </h2>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex gap-4 items-end flex-wrap">
                            <div>
                                <label class="block text-sm font-semibold mb-1">í•´ë‹¹ë…„ë„</label>
                                <select id="quarterTargetYearSelect" class="px-3 py-2 border rounded">
                                    ${state.yearRange.map(year => `<option value="${year}" ${year === state.targetYear ? 'selected' : ''}>${year}ë…„</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ë¶„ê¸° ì„ íƒ</label>
                                <select id="quarterSelect" class="px-3 py-2 border rounded">
                                    <option value="">ì „ì²´</option>
                                    ${state.quarter.quarters.map(q => `<option value="${q}" ${state.quarter.selectedQuarter === q ? 'selected' : ''}>${q}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">ìˆ˜ì‹ ì²˜</label>
                                <select id="recipientSelect" class="px-3 py-2 border rounded min-w-[200px]">
                                    <option value="">ì „ì²´</option>
                                    ${recipientList.map(r => `<option value="${r}" ${state.quarter.selectedRecipient === r ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                            </div>
                            <button id="quarterDownloadExcelBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">ğŸ“¥ Excel ë‹¤ìš´ë¡œë“œ</button>
                            <button id="quarterDownloadCSVBtn" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">ğŸ“„ CSV ë‹¤ìš´ë¡œë“œ</button>
                            <button id="quarterPrintBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ğŸ–¨ï¸ ì¸ì‡„</button>
                            <button id="quarterResetBtn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ğŸ”„ ì´ˆê¸°í™”</button>
                        </div>
                    </div>

                    <div id="quarterPrintArea" class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse text-sm" style="table-layout: fixed;">
                                <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2" style="width: 50px;">No</th>
                                        ${quarterColumns.map(col => `
                                            <th class="border px-2 py-2" style="width: ${col === 'ìƒˆì£¼ì†Œ' ? '250px' : col === 'ì‹œì„¤ëª…' ? '150px' : col === 'ì‹œì„¤ë²ˆí˜¸' ? '130px' : col === 'í•„ì¦ë²ˆí˜¸' ? '140px' : '100px'};">
                                                ${col}
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredData.map((row, idx) => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="border px-2 py-1 text-center">${idx + 1}</td>
                                            ${quarterColumns.map(col => `
                                                <td class="border px-2 py-1 text-sm">
                                                    <div class="truncate" title="${row[col] || '-'}">${row[col] || '-'}</div>
                                                </td>
                                            `).join('')}
                                        </tr>
                                    `).join('')}
                                    ${filteredData.length === 0 ? `
                                        <tr>
                                            <td colspan="${quarterColumns.length + 1}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">ğŸ“Š</div>
                                                <div>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                                                <div class="text-sm mt-2">ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥ì—ì„œ ê²€ì‚¬ê²°ê³¼ê°€ "í•©ê²©"ì¸ ë°ì´í„°ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                ì „ì²´ ${filteredData.length}ê±´
                                ${state.quarter.selectedQuarter ? ` | ${state.quarter.selectedQuarter}` : ''}
                                ${state.quarter.selectedRecipient ? ` | ${state.quarter.selectedRecipient}` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSalesAnalysisTab() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            
            // 1. ê¸°ì¤€ì›”ë³„, í–‰ì •êµ¬ì—­ë³„ ì§‘ê³„
            const baseMonthStats = {};
            // 2. ì‹ ì²­ì›”ë³„, í–‰ì •êµ¬ì—­ë³„ ì§‘ê³„
            const appMonthStats = {};
            
            // í–‰ì •êµ¬ì—­ ëª©ë¡ ìˆ˜ì§‘
            const allRegions = new Set();
            
            currentAppData.forEach(row => {
                const region = row['í–‰ì •êµ¬ì—­'] || 'ë¯¸ë¶„ë¥˜';
                const fee = parseInt(String(row['ìˆ˜ìˆ˜ë£Œ'] || '0').replace(/,/g, '')) || 0;
                
                allRegions.add(region);
                
                // ê¸°ì¤€ì¼ì—ì„œ ì›” ì¶”ì¶œ
                const baseDate = row['ê¸°ì¤€ì¼'];
                if (baseDate) {
                    const baseMonth = parseInt(baseDate.split('-')[1]);
                    if (baseMonth >= 1 && baseMonth <= 12) {
                        if (!baseMonthStats[baseMonth]) {
                            baseMonthStats[baseMonth] = {};
                        }
                        if (!baseMonthStats[baseMonth][region]) {
                            baseMonthStats[baseMonth][region] = { count: 0, fee: 0 };
                        }
                        baseMonthStats[baseMonth][region].count++;
                        baseMonthStats[baseMonth][region].fee += fee;
                    }
                }
                
                // ì‹ ì²­ì¼ì—ì„œ ì›” ì¶”ì¶œ
                const appDate = row['ì‹ ì²­ì¼'];
                if (appDate) {
                    const appMonth = parseInt(appDate.split('-')[1]);
                    if (appMonth >= 1 && appMonth <= 12) {
                        if (!appMonthStats[appMonth]) {
                            appMonthStats[appMonth] = {};
                        }
                        if (!appMonthStats[appMonth][region]) {
                            appMonthStats[appMonth][region] = { count: 0, fee: 0 };
                        }
                        appMonthStats[appMonth][region].count++;
                        appMonthStats[appMonth][region].fee += fee;
                    }
                }
            });
            
            const sortedRegions = [...allRegions].sort((a, b) => a.localeCompare(b, 'ko'));
            
            // ê¸°ì¤€ì›” í…Œì´ë¸” ìƒì„± í•¨ìˆ˜
            function createMonthTable(stats, title, bgColor) {
                let totalCount = 0;
                let totalFee = 0;
                const monthTotals = {};
                const regionTotals = {};
                
                // ì›”ë³„, ì§€ì—­ë³„ í•©ê³„ ê³„ì‚°
                for (let m = 1; m <= 12; m++) {
                    monthTotals[m] = { count: 0, fee: 0 };
                    if (stats[m]) {
                        sortedRegions.forEach(region => {
                            if (stats[m][region]) {
                                monthTotals[m].count += stats[m][region].count;
                                monthTotals[m].fee += stats[m][region].fee;
                            }
                        });
                    }
                }
                
                sortedRegions.forEach(region => {
                    regionTotals[region] = { count: 0, fee: 0 };
                    for (let m = 1; m <= 12; m++) {
                        if (stats[m] && stats[m][region]) {
                            regionTotals[region].count += stats[m][region].count;
                            regionTotals[region].fee += stats[m][region].fee;
                            totalCount += stats[m][region].count;
                            totalFee += stats[m][region].fee;
                        }
                    }
                });
                
                return `
                    <div class="mb-8">
                        <h3 class="text-lg font-bold mb-3 ${bgColor} text-white px-4 py-2 rounded">${title}</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="border px-2 py-2 sticky left-0 bg-gray-100 z-10">í–‰ì •êµ¬ì—­</th>
                                        ${Array.from({length: 12}, (_, i) => `<th class="border px-2 py-1 text-center" colspan="2">${i+1}ì›”</th>`).join('')}
                                        <th class="border px-2 py-1 text-center bg-yellow-100" colspan="2">í•©ê³„</th>
                                    </tr>
                                    <tr>
                                        <th class="border px-2 py-1 sticky left-0 bg-gray-100 z-10"></th>
                                        ${Array.from({length: 12}, () => `<th class="border px-1 py-1 text-xs">ê±´ìˆ˜</th><th class="border px-1 py-1 text-xs">ìˆ˜ìˆ˜ë£Œ</th>`).join('')}
                                        <th class="border px-1 py-1 text-xs bg-yellow-100">ê±´ìˆ˜</th>
                                        <th class="border px-1 py-1 text-xs bg-yellow-100">ìˆ˜ìˆ˜ë£Œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedRegions.map(region => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="border px-2 py-1 font-semibold sticky left-0 bg-white z-10">${region}</td>
                                            ${Array.from({length: 12}, (_, i) => {
                                                const m = i + 1;
                                                const data = stats[m] && stats[m][region] ? stats[m][region] : { count: 0, fee: 0 };
                                                return `
                                                    <td class="border px-1 py-1 text-center">${data.count || '-'}</td>
                                                    <td class="border px-1 py-1 text-right">${data.fee ? data.fee.toLocaleString() : '-'}</td>
                                                `;
                                            }).join('')}
                                            <td class="border px-1 py-1 text-center font-bold bg-yellow-50">${regionTotals[region].count || '-'}</td>
                                            <td class="border px-1 py-1 text-right font-bold bg-yellow-50">${regionTotals[region].fee ? regionTotals[region].fee.toLocaleString() : '-'}</td>
                                        </tr>
                                    `).join('')}
                                    <tr class="bg-blue-50 font-bold">
                                        <td class="border px-2 py-1 sticky left-0 bg-blue-50 z-10">ì›” í•©ê³„</td>
                                        ${Array.from({length: 12}, (_, i) => {
                                            const m = i + 1;
                                            return `
                                                <td class="border px-1 py-1 text-center">${monthTotals[m].count || '-'}</td>
                                                <td class="border px-1 py-1 text-right">${monthTotals[m].fee ? monthTotals[m].fee.toLocaleString() : '-'}</td>
                                            `;
                                        }).join('')}
                                        <td class="border px-1 py-1 text-center bg-green-100">${totalCount || '-'}</td>
                                        <td class="border px-1 py-1 text-right bg-green-100">${totalFee ? totalFee.toLocaleString() : '-'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div>
                    <div class="bg-purple-50 border border-purple-300 rounded-lg p-4 mb-4">
                        <h2 class="text-xl font-bold text-purple-800 flex items-center gap-2">
                            <span>ğŸ“Š</span> ë§¤ì¶œë¶„ì„: ${state.targetYear}ë…„
                        </h2>
                        <p class="text-sm text-purple-600 mt-1">ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥ ë°ì´í„° ê¸°ì¤€ (ì´ ${currentAppData.length}ê±´)</p>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex gap-4 items-center mb-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">í•´ë‹¹ë…„ë„</label>
                                <select id="salesTargetYearSelect" class="px-3 py-2 border rounded">
                                    ${state.yearRange.map(year => `<option value="${year}" ${year === state.targetYear ? 'selected' : ''}>${year}ë…„</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex-1"></div>
                            <div class="text-sm text-gray-600">
                                <span class="font-semibold">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</span> ${new Date().toLocaleTimeString()}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-4">
                        ${createMonthTable(baseMonthStats, 'ğŸ“… ê¸°ì¤€ì›”ë³„ / í–‰ì •êµ¬ì—­ë³„ ê±´ìˆ˜ ë° ìˆ˜ìˆ˜ë£Œ', 'bg-blue-600')}
                        ${createMonthTable(appMonthStats, 'ğŸ“ ì‹ ì²­ì›”ë³„ / í–‰ì •êµ¬ì—­ë³„ ê±´ìˆ˜ ë° ìˆ˜ìˆ˜ë£Œ', 'bg-green-600')}
                    </div>
                </div>
            `;
        }

        function getQuarterFilteredData() {
            const quarterColumns = ['ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'ê¸°ì¤€ì¼', 'ê²€ì‚¬ì¼', 'í•„ì¦ë²ˆí˜¸'];
            const currentAppData = state.applicationData[state.targetYear] || [];
            let filteredData = currentAppData.filter(row => row['ê²€ì‚¬ê²°ê³¼'] === 'í•©ê²©');
            
            if (state.quarter.selectedQuarter) {
                const quarterMonths = {
                    '1ë¶„ê¸°': [1, 2, 3],
                    '2ë¶„ê¸°': [4, 5, 6],
                    '3ë¶„ê¸°': [7, 8, 9],
                    '4ë¶„ê¸°': [10, 11, 12]
                };
                const months = quarterMonths[state.quarter.selectedQuarter] || [];
                filteredData = filteredData.filter(row => {
                    const baseDate = row['ê¸°ì¤€ì¼'];
                    if (!baseDate) return false;
                    const month = parseInt(baseDate.split('-')[1]);
                    return months.includes(month);
                });
            }
            
            if (state.quarter.selectedRecipient) {
                const regions = state.quarter.recipients[state.quarter.selectedRecipient] || [];
                filteredData = filteredData.filter(row => {
                    const rowRegion = row['í–‰ì •êµ¬ì—­'] || '';
                    return regions.some(r => rowRegion.includes(r) || rowRegion === r);
                });
            }
            
            filteredData.sort((a, b) => {
                const regionA = a['í–‰ì •êµ¬ì—­'] || '';
                const regionB = b['í–‰ì •êµ¬ì—­'] || '';
                return regionA.localeCompare(regionB, 'ko');
            });
            
            return { filteredData, quarterColumns };
        }

        function downloadQuarterExcel() {
            const { filteredData, quarterColumns } = getQuarterFilteredData();
            
            if (filteredData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const exportData = filteredData.map(row => {
                const obj = {};
                quarterColumns.forEach(col => {
                    obj[col] = row[col] || '';
                });
                return obj;
            });
            
            const worksheet = XLSX.utils.json_to_sheet(exportData, { header: quarterColumns });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ë¶„ê¸°í˜„í™©');
            
            const fileName = `ë¶„ê¸°í˜„í™©_${state.targetYear}ë…„_${state.quarter.selectedQuarter || 'ì „ì²´'}_${state.quarter.selectedRecipient || 'ì „ì²´'}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }

        function downloadQuarterCSV() {
            const { filteredData, quarterColumns } = getQuarterFilteredData();
            
            if (filteredData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const csvContent = [
                quarterColumns.join(','),
                ...filteredData.map(row => 
                    quarterColumns.map(col => {
                        const value = row[col] || '';
                        return value.includes(',') || value.includes('"') 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ë¶„ê¸°í˜„í™©_${state.targetYear}ë…„_${state.quarter.selectedQuarter || 'ì „ì²´'}_${state.quarter.selectedRecipient || 'ì „ì²´'}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function printQuarterReport() {
            const { filteredData, quarterColumns } = getQuarterFilteredData();
            
            if (filteredData.length === 0) {
                alert('ì¸ì‡„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í–‰ì •êµ¬ì—­ë³„ë¡œ ê·¸ë£¹í•‘
            const groupedData = {};
            filteredData.forEach(row => {
                const region = row['í–‰ì •êµ¬ì—­'] || 'ê¸°íƒ€';
                if (!groupedData[region]) {
                    groupedData[region] = [];
                }
                groupedData[region].push(row);
            });
            
            const ROWS_PER_PAGE = 34; // í—¤ë” ì œì™¸ 34ê°œ ë°ì´í„°
            let pages = [];
            
            Object.keys(groupedData).sort((a, b) => a.localeCompare(b, 'ko')).forEach(region => {
                const regionData = groupedData[region];
                for (let i = 0; i < regionData.length; i += ROWS_PER_PAGE) {
                    pages.push({
                        region: region,
                        data: regionData.slice(i, i + ROWS_PER_PAGE)
                    });
                }
            });
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ë¶„ê¸°ë³„ ê²€ì‚¬í˜„í™©</title>
                    <style>
                        @page { size: A4 portrait; margin: 10mm; }
                        body { font-family: 'Malgun Gothic', sans-serif; font-size: 10px; }
                        .page { page-break-after: always; }
                        .page:last-child { page-break-after: avoid; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #333; padding: 3px 5px; text-align: left; }
                        th { background-color: #2563eb; color: white; font-size: 9px; }
                        td { font-size: 9px; }
                        .header-info { margin-bottom: 10px; font-size: 12px; font-weight: bold; }
                        .page-info { text-align: right; font-size: 9px; margin-bottom: 5px; }
                    </style>
                </head>
                <body>
                    ${pages.map((page, pageIdx) => `
                        <div class="page">
                            <div class="header-info">
                                ${state.targetYear}ë…„ ${state.quarter.selectedQuarter || ''} ê²€ì‚¬í˜„í™© 
                                ${state.quarter.selectedRecipient ? `- ${state.quarter.selectedRecipient}` : ''}
                            </div>
                            <div class="page-info">í˜ì´ì§€ ${pageIdx + 1} / ${pages.length} | í–‰ì •êµ¬ì—­: ${page.region}</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width:25px;">No</th>
                                        ${quarterColumns.map(col => `<th>${col}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${page.data.map((row, idx) => `
                                        <tr>
                                            <td>${idx + 1}</td>
                                            ${quarterColumns.map(col => `<td>${row[col] || ''}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `).join('')}
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function renderPathwayTab() {
    const currentPathwayData = state.pathwayData[state.selectedYear] || [];
    
    const uniquePathwayRegions = [...new Set(currentPathwayData.map(row => row['í–‰ì •êµ¬ì—­']).filter(Boolean))].sort();
    
    let filteredPathwayData = [...currentPathwayData];
    
    if (state.pathway.filters.region) {
        filteredPathwayData = filteredPathwayData.filter(row => row['í–‰ì •êµ¬ì—­'] === state.pathway.filters.region);
    }
    
    if (state.pathway.searchTerm) {
        filteredPathwayData = filteredPathwayData.filter(row =>
            Object.values(row).some(val =>
                String(val).toLowerCase().includes(state.pathway.searchTerm.toLowerCase())
            )
        );
    }
    
    const totalPathwayPages = Math.ceil(filteredPathwayData.length / state.itemsPerPage);
    const paginatedPathwayData = filteredPathwayData.slice(
        (state.pathway.currentPage - 1) * state.itemsPerPage,
        state.pathway.currentPage * state.itemsPerPage
    );

    return `
        <div>
            <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-4">
                <h2 class="text-xl font-bold text-yellow-800 flex items-center gap-2">
                    <span>ğŸ </span> ê²½ë¡œë‹¹ ì ê²€: ${state.selectedYear}ë…„
                </h2>
            </div>
            
            <div class="bg-white rounded-lg p-4 mb-4 shadow">
                <div class="flex gap-2 mb-4 flex-wrap">
                    <button id="pathwayUploadBtn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ğŸ“¤ ì—…ë¡œë“œ (Excel/CSV)</button>
                    <button id="pathwayDownloadBtn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                    <button id="pathwayDeleteBtn" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">ğŸ—‘ï¸ ì‚­ì œ</button>
                    <button id="pathwaySaveBtn" class="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">ğŸ’¾ ì €ì¥</button>
                    <button id="pathwayEditToggleBtn" class="flex items-center gap-2 bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">âœï¸ ${state.pathway.isEditing ? 'ì™„ë£Œ' : 'í¸ì§‘'}</button>
                    <button id="pathwayAddRowBtn" class="flex items-center gap-2 bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">â• í–‰ ì¶”ê°€</button>
                    <button id="pathwayMapBtn" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ğŸ—ºï¸ MAP</button>
                </div>
                
                <div class="flex gap-4 items-end">
                    <div>
                        <label class="block text-sm font-semibold mb-1">í–‰ì •êµ¬ì—­</label>
                        <select id="pathwayRegionFilter" class="px-3 py-2 border rounded">
                            <option value="">ì „ì²´</option>
                            ${pathwayOptions.regions.map(r => `<option value="${r}" ${state.pathway.filters.region === r ? 'selected' : ''}>${r}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-semibold mb-1">ê²€ìƒ‰</label>
                        <input type="text" id="pathwaySearchInput" value="${state.pathway.searchTerm}" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." class="w-full px-3 py-2 border rounded" />
                    </div>
                    <button id="pathwaySearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ğŸ” ì¡°íšŒ</button>
                    <button id="pathwayResetBtn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ğŸ”„ ì´ˆê¸°í™”</button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto" style="max-height: 600px;">
                    <table class="w-full border-collapse text-sm" style="table-layout: fixed; min-width: 2000px;">
                        <thead class="bg-blue-600 text-white sticky top-0 z-10">
                            <tr>
                                <th class="border px-2 py-2" style="width: 50px;">
                                    <input type="checkbox" id="selectAllPathwayRows" ${state.pathway.selectedRows.size === filteredPathwayData.length && filteredPathwayData.length > 0 ? 'checked' : ''} />
                                </th>
                                ${pathwayColumns.map(col => `
                                    <th class="border px-2 py-2" style="width: ${col === 'ìƒˆì£¼ì†Œ' ? '200px' : col === 'ì‹œì„¤ëª…' ? '150px' : '100px'};">
                                        <div class="truncate" title="${col}">${col}</div>
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${paginatedPathwayData.map((row, idx) => {
                                const actualIdx = (state.pathway.currentPage - 1) * state.itemsPerPage + idx;
                                return `
                                    <tr class="${state.pathway.selectedRows.has(actualIdx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                        <td class="border px-2 py-1 text-center" style="width: 50px;">
                                            <input type="checkbox" class="pathway-row-checkbox" data-idx="${actualIdx}" ${state.pathway.selectedRows.has(actualIdx) ? 'checked' : ''} />
                                        </td>
                                        ${pathwayColumns.map(col => `
                                            <td class="border px-2 py-1 text-sm">
                                                ${state.pathway.isEditing ? `
                                                    ${col === 'ì‚¬ìš©ê°€ìŠ¤' ? `
                                                        <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                            <option value="">ì„ íƒ</option>
                                                            ${pathwayOptions.gas.map(g => `<option value="${g}" ${g === row[col] ? 'selected' : ''}>${g}</option>`).join('')}
                                                        </select>
                                                    ` : col === 'ì°¨ë‹¨ê¸°' || col === 'íƒ€ì´ë¨¸' || col === 'COê²½ë³´ê¸°' ? `
                                                        <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                            <option value="">ì„ íƒ</option>
                                                            ${pathwayOptions.device.map(d => `<option value="${d}" ${d === row[col] ? 'selected' : ''}>${d}</option>`).join('')}
                                                        </select>
                                                    ` : col === 'ëˆ„ì„¤' ? `
                                                        <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                            <option value="">ì„ íƒ</option>
                                                            ${pathwayOptions.leak.map(l => `<option value="${l}" ${l === row[col] ? 'selected' : ''}>${l}</option>`).join('')}
                                                        </select>
                                                    ` : col === 'ì ê²€ì' ? `
                                                        <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                            <option value="">ì„ íƒ</option>
                                                            ${pathwayOptions.inspectors.map(i => `<option value="${i}" ${i === row[col] ? 'selected' : ''}>${i}</option>`).join('')}
                                                        </select>
                                                    ` : col === 'ì ê²€ì¼' ? `
                                                        <input type="date" value="${row[col] || ''}" class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                    ` : `
                                                        <input type="text" value="${row[col] || ''}" class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                    `}
                                                ` : `
                                                   <div class="truncate ${col === 'ì‚¬ìš©ëŸ‰' ? 'text-left' : ''}" title="${row[col] || '-'}">${row[col] || '-'}</div> 
                                                `}
                                            </td>
                                        `).join('')}
                                    </tr>
                                `;
                            }).join('')}
                            ${paginatedPathwayData.length === 0 ? `
                                <tr>
                                    <td colspan="${pathwayColumns.length + 1}" class="text-center py-8 text-gray-500">
                                        <div class="text-4xl mb-2">ğŸ </div>
                                        <div>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
                
                <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                    <div class="text-sm text-gray-600">
                        ì „ì²´ ${filteredPathwayData.length}ê±´
                        ${state.pathway.selectedRows.size > 0 ? ` (${state.pathway.selectedRows.size}ê±´ ì„ íƒë¨)` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="pathwayPrevPageBtn" ${state.pathway.currentPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">â—€</button>
                        <span class="px-4 py-2">${state.pathway.currentPage} / ${totalPathwayPages || 1}</span>
                        <button id="pathwayNextPageBtn" ${state.pathway.currentPage === totalPathwayPages || totalPathwayPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">â–¶</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}
       
       function renderResourceTab() {
            const currentResourceData = state.resourceData[state.selectedYear] || [];
            
            let filteredResourceData = [...currentResourceData];
            
            if (state.resource.currentFolder) {
                filteredResourceData = filteredResourceData.filter(row => row['í´ë”'] === state.resource.currentFolder);
            }
            
            if (state.resource.searchTerm) {
                filteredResourceData = filteredResourceData.filter(row =>
                    Object.values(row).some(val =>
                        String(val).toLowerCase().includes(state.resource.searchTerm.toLowerCase())
                    )
                );
            }
            
            const uniqueFolders = [...new Set(currentResourceData.map(row => row['í´ë”']).filter(Boolean))].sort();
            
            const resourceColumns = ['í´ë”', 'íŒŒì¼ëª…', 'íŒŒì¼í˜•ì‹', 'íŒŒì¼í¬ê¸°', 'ì„¤ëª…', 'ë“±ë¡ì¼', 'ë“±ë¡ì'];

            const getFileIcon = (fileType) => {
                const type = (fileType || '').toLowerCase();
                if (type.includes('pdf') || type.includes('acrobat')) return 'ğŸ“•';
                if (type.includes('xls') || type.includes('excel')) return 'ğŸ“Š';
                if (type.includes('hwp') || type.includes('í•œê¸€')) return 'ğŸ“˜';
                if (type.includes('doc') || type.includes('word')) return 'ğŸ“„';
                if (type.includes('ppt') || type.includes('powerpoint')) return 'ğŸ“™';
                if (type.includes('jpg') || type.includes('png') || type.includes('gif') || type.includes('image')) return 'ğŸ–¼ï¸';
                if (type.includes('zip') || type.includes('rar')) return 'ğŸ—œï¸';
                return 'ğŸ“';
            };

            return `
                <div>
                    <div class="bg-indigo-50 border border-indigo-300 rounded-lg p-4 mb-4">
                        <h2 class="text-xl font-bold text-indigo-800 flex items-center gap-2">
                            <span>ğŸ“</span> ìë£Œì‹¤: ${state.selectedYear}ë…„
                        </h2>
                        <p class="text-sm text-indigo-600 mt-1">PDF, Excel, í•œê¸€ ë“± ë‹¤ì–‘í•œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <label class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 cursor-pointer">
                                ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ
                                <input type="file" id="resourceFileUpload" multiple accept=".pdf,.xlsx,.xls,.hwp,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.zip,.rar,.csv" class="hidden" />
                            </label>
                            <button id="resourceDownloadSelectedBtn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ğŸ“¥ ì„ íƒ ë‹¤ìš´ë¡œë“œ</button>
                            <button id="resourceDeleteBtn" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">ğŸ—‘ï¸ ì‚­ì œ</button>
                            <button id="resourceExportListBtn" class="flex items-center gap-2 bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">ğŸ“‹ ëª©ë¡ ë‚´ë³´ë‚´ê¸°</button>
                        </div>
                        
                        <div class="flex gap-4 items-end">
                            <div>
                                <label class="block text-sm font-semibold mb-1">í´ë”</label>
                                <select id="resourceFolderFilter" class="px-3 py-2 border rounded min-w-[150px]">
                                    <option value="">ì „ì²´</option>
                                    ${uniqueFolders.map(f => `<option value="${f}" ${state.resource.currentFolder === f ? 'selected' : ''}>${f}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-semibold mb-1">ê²€ìƒ‰</label>
                                <input type="text" id="resourceSearchInput" value="${state.resource.searchTerm}" placeholder="íŒŒì¼ëª…, ì„¤ëª… ë“± ê²€ìƒ‰..." class="w-full px-3 py-2 border rounded" />
                            </div>
                            <button id="resourceSearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ğŸ” ì¡°íšŒ</button>
                            <button id="resourceResetBtn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ğŸ”„ ì´ˆê¸°í™”</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse text-sm">
                                <thead class="bg-indigo-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2" style="width: 50px;">
                                            <input type="checkbox" id="selectAllResourceRows" ${state.resource.selectedFiles.size === filteredResourceData.length && filteredResourceData.length > 0 ? 'checked' : ''} />
                                        </th>
                                        <th class="border px-2 py-2" style="width: 50px;">No</th>
                                        <th class="border px-2 py-2" style="width: 50px;">í˜•ì‹</th>
                                        ${resourceColumns.map(col => `
                                            <th class="border px-3 py-2" style="width: ${col === 'ì„¤ëª…' ? '200px' : col === 'íŒŒì¼ëª…' ? '200px' : col === 'í´ë”' ? '100px' : '100px'};">
                                                ${col}
                                            </th>
                                        `).join('')}
                                        <th class="border px-2 py-2" style="width: 80px;">ë‹¤ìš´ë¡œë“œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredResourceData.map((row, idx) => `
                                        <tr class="${state.resource.selectedFiles.has(idx) ? 'bg-indigo-50' : 'hover:bg-gray-50'}">
                                            <td class="border px-2 py-1 text-center">
                                                <input type="checkbox" class="resource-row-checkbox" data-idx="${idx}" ${state.resource.selectedFiles.has(idx) ? 'checked' : ''} />
                                            </td>
                                            <td class="border px-2 py-1 text-center">${idx + 1}</td>
                                            <td class="border px-2 py-1 text-center text-xl">${getFileIcon(row['íŒŒì¼í˜•ì‹'])}</td>
                                            ${resourceColumns.map(col => `
                                                <td class="border px-3 py-1">
                                                    ${col === 'ë“±ë¡ì¼' ? `
                                                        <input type="date" value="${row[col] || ''}" class="w-full px-2 py-1 border rounded text-sm resource-cell-edit" data-idx="${idx}" data-col="${col}" />
                                                    ` : col === 'íŒŒì¼ëª…' ? `
                                                        <div class="truncate font-medium text-blue-600" title="${row[col] || ''}">${row[col] || '-'}</div>
                                                    ` : col === 'íŒŒì¼í¬ê¸°' ? `
                                                        <div class="text-right text-gray-600">${row[col] || '-'}</div>
                                                    ` : `
                                                        <input type="text" value="${row[col] || ''}" class="w-full px-2 py-1 border rounded text-sm resource-cell-edit" data-idx="${idx}" data-col="${col}" />
                                                    `}
                                                </td>
                                            `).join('')}
                                            <td class="border px-2 py-1 text-center">
                                                ${row['fileId'] ? `
                                                    <button class="resource-download-btn px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600" data-idx="${idx}">ğŸ“¥</button>
                                                ` : '-'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${filteredResourceData.length === 0 ? `
                                        <tr>
                                            <td colspan="${resourceColumns.length + 4}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">ğŸ“</div>
                                                <div>íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
                                                <div class="text-sm mt-2">PDF, Excel, í•œê¸€ ë“± íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                ì „ì²´ ${filteredResourceData.length}ê±´
                                ${state.resource.selectedFiles.size > 0 ? ` (${state.resource.selectedFiles.size}ê±´ ì„ íƒë¨)` : ''}
                            </div>
                            <div class="text-xs text-gray-500">
                                ì§€ì› í˜•ì‹: PDF, Excel, í•œê¸€, Word, PowerPoint, ì´ë¯¸ì§€, ì••ì¶•íŒŒì¼
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderLoadingModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                        <div class="animate-pulse text-4xl mb-4">â³</div>
                        <p class="text-lg font-semibold mb-2">íŒŒì¼ ì²˜ë¦¬ ì¤‘...</p>
                        <div class="w-64 bg-gray-200 rounded-full h-4 mb-2">
                            <div class="bg-blue-600 h-4 rounded-full transition-all" style="width: ${state.loadingProgress}%;"></div>
                        </div>
                        <p class="text-sm text-gray-600">${state.loadingProgress}%</p>
                    </div>
                </div>
            `;
        }

        function renderDuplicateModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4">
                        <div class="bg-orange-500 text-white px-6 py-4">
                            <h3 class="text-xl font-bold">âš ï¸ ì¤‘ë³µëœ ì‹œì„¤ë²ˆí˜¸ ë°œê²¬</h3>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-700 mb-4">
                                ì¤‘ë³µëœ ì‹œì„¤ë²ˆí˜¸ê°€ <strong class="text-orange-600">${state.duplicateInfo.duplicates.length}ê°œ</strong> ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t">
                            <button id="cancelDupBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">ì·¨ì†Œ</button>
                            <button id="confirmDupBtn" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold">ê³„ì† ì§„í–‰</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDeleteModal() {
            const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4">
                        <div class="bg-red-500 text-white px-6 py-4">
                            <h3 class="text-xl font-bold">ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ í™•ì¸</h3>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-700 mb-4">ì„ íƒëœ <strong class="text-red-600">${selectedData.length}ê°œ</strong>ì˜ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                            <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                                <p class="text-sm text-yellow-800"><strong>âš ï¸ ì£¼ì˜:</strong> ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t">
                            <button id="cancelDeleteBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">ì·¨ì†Œ</button>
                            <button id="confirmDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAppDeleteModal() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedData = currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx));
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4">
                        <div class="bg-red-500 text-white px-6 py-4">
                            <h3 class="text-xl font-bold">ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ í™•ì¸</h3>
                        </div>
                        <div class="p-6">
                            <p class="text-gray-700 mb-4">ì„ íƒëœ <strong class="text-red-600">${selectedData.length}ê°œ</strong>ì˜ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t">
                            <button id="cancelAppDeleteBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">ì·¨ì†Œ</button>
                            <button id="confirmAppDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFooter() {
            return `
                <div class="container mx-auto px-4 py-4 text-sm text-gray-600 flex items-center justify-between flex-wrap gap-4">
                    <p>ê²€ìƒ‰ê²°ê³¼ (Total: ${state.filteredData.length}ê°œ)</p>
                    <div class="flex items-center gap-4">
                        <div class="sync-indicator ${state.cloudStatus}">
                            <span class="sync-dot ${state.cloudStatus}"></span>
                            ${state.cloudStatus === 'online' ? 'í´ë¼ìš°ë“œ ì—°ê²°ë¨' : 
                              state.cloudStatus === 'syncing' ? 'ë™ê¸°í™” ì¤‘...' : 
                              'ì˜¤í”„ë¼ì¸'}
                        </div>
                        ${state.lastSaved ? `
                            <p class="text-xs text-gray-500">
                                ë§ˆì§€ë§‰ ì €ì¥: ${state.lastSaved.toLocaleTimeString()}
                            </p>
                        ` : ''}
                        <p class="text-xs text-green-600 font-semibold">ğŸ’¾ ì˜êµ¬ ì €ì¥ ëª¨ë“œ</p>
                    </div>
                </div>
            `;
        }

        function initMap(locations) {
            const mapContainer = document.getElementById('mapContainer');
            if (!mapContainer || typeof kakao === 'undefined') {
                setTimeout(() => initMap(locations), 500);
                return;
            }

            kakao.maps.load(function() {
                const mapOption = {
                    center: new kakao.maps.LatLng(35.1796, 129.0756),
                    level: 7
                };

                const map = new kakao.maps.Map(mapContainer, mapOption);
                const geocoder = new kakao.maps.services.Geocoder();
                const bounds = new kakao.maps.LatLngBounds();
                let processedCount = 0;
                let totalCount = locations.length;

                locations.forEach((location) => {
                    const address = location['ìƒˆì£¼ì†Œ'];
                    if (!address) {
                        processedCount++;
                        return;
                    }

                    geocoder.addressSearch(address, function(result, status) {
                        processedCount++;
                        state.mapLoadingProgress = Math.floor((processedCount / totalCount) * 100);
                        
                        if (status === kakao.maps.services.Status.OK && result[0]) {
                            const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                            bounds.extend(coords);

                          const marker = new kakao.maps.Marker({ position: coords, map: map });

                            const customOverlay = new kakao.maps.CustomOverlay({
                                position: coords,
                                content: '<div style="padding:3px 8px;background:#fff;border:1px solid #333;border-radius:4px;font-size:11px;font-weight:bold;white-space:nowrap;box-shadow:1px 1px 3px rgba(0,0,0,0.3);">' + location['ì‹œì„¤ëª…'] + '</div>',
                                yAnchor: 2.5,
                                map: map
                            }); 
                        }

                        if (processedCount === totalCount) {
                            setTimeout(function() {
                                if (!bounds.isEmpty()) map.setBounds(bounds);
                                state.isLoadingMap = false;
                            }, 300);
                        }
                    });
                });
            });
        }

        // ======================== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ========================
        function attachEventListeners() {
            try {
                // íƒ­ ë²„íŠ¼
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        state.activeTab = e.target.dataset.tab;
                        render();
                    });
                });

                // ì—°ë„ ì„ íƒ
                const yearSelect = document.getElementById('yearSelect');
                if (yearSelect) yearSelect.addEventListener('change', (e) => {
                    state.selectedYear = parseInt(e.target.value);
                    render();
                });

                // í´ë¼ìš°ë“œ ë²„íŠ¼
                const cloudSaveBtn = document.getElementById('cloudSaveBtn');
                if (cloudSaveBtn) cloudSaveBtn.addEventListener('click', cloudSaveData);

                const cloudLoadBtn = document.getElementById('cloudLoadBtn');
                if (cloudLoadBtn) cloudLoadBtn.addEventListener('click', cloudLoadData);

                const cloudLoadWelcomeBtn = document.getElementById('cloudLoadWelcomeBtn');
                if (cloudLoadWelcomeBtn) cloudLoadWelcomeBtn.addEventListener('click', cloudLoadData);

                const historyBtn = document.getElementById('historyBtn');
                if (historyBtn) historyBtn.addEventListener('click', loadHistory);

                // íˆìŠ¤í† ë¦¬ ëª¨ë‹¬
                const historyCloseBtn = document.getElementById('historyCloseBtn');
                if (historyCloseBtn) historyCloseBtn.addEventListener('click', () => {
                    state.showHistoryModal = false;
                    render();
                });

                const historyRefreshBtn = document.getElementById('historyRefreshBtn');
                if (historyRefreshBtn) historyRefreshBtn.addEventListener('click', loadHistory);

                // í™˜ì˜ í™”ë©´
                const sampleDataBtn = document.getElementById('sampleDataBtn');
                if (sampleDataBtn) sampleDataBtn.addEventListener('click', createSampleData);

                const welcomeFileInput = document.getElementById('welcomeFileInput');
                if (welcomeFileInput) welcomeFileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

                const emptyStartBtn = document.getElementById('emptyStartBtn');
                if (emptyStartBtn) emptyStartBtn.addEventListener('click', () => {
                    state.showWelcome = false;
                    render();
                });

                // ê´€ë¦¬ì
                const adminLoginBtn = document.getElementById('adminLoginBtn');
                if (adminLoginBtn) adminLoginBtn.addEventListener('click', () => {
                    const pwd = document.getElementById('adminPassword').value;
                    if (pwd === 'kgt7848848!') {
                        state.showAdmin = true;
                        render();
                    } else {
                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                });

                const clearAllBtn = document.getElementById('clearAllBtn');
                if (clearAllBtn) clearAllBtn.addEventListener('click', clearAllData);

                // í†µí•© íƒ­ ë²„íŠ¼ë“¤
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv,.xlsx,.xls';
                    uploadBtn.addEventListener('click', () => input.click());
                    input.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
                }

                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) downloadBtn.addEventListener('click', () => {
                    state.showDownloadMenu = !state.showDownloadMenu;
                    render();
                });

                const downloadExcelBtn = document.getElementById('downloadExcelBtn');
                if (downloadExcelBtn) downloadExcelBtn.addEventListener('click', downloadAsExcel);

                const downloadCSVBtn = document.getElementById('downloadCSVBtn');
                if (downloadCSVBtn) downloadCSVBtn.addEventListener('click', downloadAsCSV);

                const sampleBtn = document.getElementById('sampleBtn');
                if (sampleBtn) sampleBtn.addEventListener('click', createSampleData);

                const editToggleBtn = document.getElementById('editToggleBtn');
                if (editToggleBtn) editToggleBtn.addEventListener('click', () => {
                    state.isEditing = !state.isEditing;
                    render();
                });

                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) saveBtn.addEventListener('click', () => {
                    const saved = saveDataToStorage();
                    if (saved) {
                        alert('ğŸ’¾ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('âŒ ì €ì¥ ì‹¤íŒ¨! ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\në¶ˆí•„ìš”í•œ ë°ì´í„°ë¥¼ ì‚­ì œí•´ì£¼ì„¸ìš”.');
                    }
                });

                const copyBtn = document.getElementById('copyBtn');
                if (copyBtn) copyBtn.addEventListener('click', copyToApplication);

                const deleteBtn = document.getElementById('deleteBtn');
                if (deleteBtn) deleteBtn.addEventListener('click', deleteSelectedRows);

                const detailBtn = document.getElementById('detailBtn');
                if (detailBtn) detailBtn.addEventListener('click', openDetailModal);

                // í–‰ì •êµ¬ì—­ ë“œë¡­ë‹¤ìš´
                const regionDropdownBtn = document.getElementById('regionDropdownBtn');
                if (regionDropdownBtn) regionDropdownBtn.addEventListener('click', () => {
                    state.showRegionDropdown = !state.showRegionDropdown;
                    render();
                });

                // ì¡°íšŒ ë²„íŠ¼
                const searchBtn = document.getElementById('searchBtn');
                if (searchBtn) searchBtn.addEventListener('click', () => {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) state.searchTerm = searchInput.value;
                    state.currentPage = 1;
                    render();
                });

                const searchInput = document.getElementById('searchInput');
                if (searchInput) searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        state.searchTerm = e.target.value;
                        state.currentPage = 1;
                        render();
                    }
                });

                // ê¸°ì¤€ì›” í•„í„°
                const mainBaseMonthFilter = document.getElementById('mainBaseMonthFilter');
                if (mainBaseMonthFilter) mainBaseMonthFilter.addEventListener('change', (e) => {
                    state.filters.month = e.target.value;
                    state.currentPage = 1;
                    render();
                });
                
                // ê²€ì‚¬ì´ë ¥ í•„í„°
                const mainInspectionHistoryFilter = document.getElementById('mainInspectionHistoryFilter');
                if (mainInspectionHistoryFilter) mainInspectionHistoryFilter.addEventListener('change', (e) => {
                    state.filters.inspectionHistory = e.target.value;
                    state.currentPage = 1;
                    render();
                });
                                
                // í•„í„° ì´ˆê¸°í™”
                const mainFilterResetBtn = document.getElementById('mainFilterResetBtn');
                if (mainFilterResetBtn) mainFilterResetBtn.addEventListener('click', () => {
                    state.filters = { region: [], month: '', inspectionHistory: '' };
                    state.searchTerm = '';
                    state.currentPage = 1;
                    state.showRegionDropdown = false;
                    render();
                });

                // í–‰ ì„ íƒ
                const selectAllRows = document.getElementById('selectAllRows');
                if (selectAllRows) selectAllRows.addEventListener('change', () => {
                    if (selectAllRows.checked) {
                        state.selectedRows = new Set(state.filteredData.map((_, i) => i));
                    } else {
                        state.selectedRows = new Set();
                    }
                    render();
                });

                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.selectedRows.add(idx);
                        } else {
                            state.selectedRows.delete(idx);
                        }
                    });
                });

                // ì…€ í¸ì§‘
                document.querySelectorAll('.cell-edit').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const col = e.target.dataset.col;
                        state.data[state.selectedYear][idx][col] = e.target.value;
                    });
                });

                // ì§€ì—­ í•„í„°
                const selectAllRegions = document.getElementById('selectAllRegions');
                if (selectAllRegions) selectAllRegions.addEventListener('change', (e) => {
                    const uniqueRegions = [...new Set(
                        (state.data[state.selectedYear] || []).map(row => (row['í–‰ì •êµ¬ì—­'] || '').replace(/[\\\/]/g, '').trim()).filter(Boolean)
                    )];
                    state.filters.region = e.target.checked ? [...uniqueRegions] : [];
                    render();
                });

                document.querySelectorAll('.region-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const region = e.target.value;
                        if (e.target.checked) {
                            state.filters.region.push(region);
                        } else {
                            state.filters.region = state.filters.region.filter(r => r !== region);
                        }
                    });
                });

                // í˜ì´ì§€ë„¤ì´ì…˜
                const prevPageBtn = document.getElementById('prevPageBtn');
                if (prevPageBtn) prevPageBtn.addEventListener('click', () => {
                    state.currentPage = Math.max(1, state.currentPage - 1);
                    render();
                });

                const nextPageBtn = document.getElementById('nextPageBtn');
                if (nextPageBtn) nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);
                    state.currentPage = Math.min(totalPages, state.currentPage + 1);
                    render();
                });

                // ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥ íƒ­
                const targetYearSelect = document.getElementById('targetYearSelect');
                if (targetYearSelect) targetYearSelect.addEventListener('change', (e) => {
                    state.targetYear = parseInt(e.target.value);
                    render();
                });

                const inspectionYearSelect = document.getElementById('inspectionYearSelect');
                if (inspectionYearSelect) inspectionYearSelect.addEventListener('change', (e) => {
                    state.inspectionYear = parseInt(e.target.value);
                    render();
                });

                const appUploadBtn = document.getElementById('appUploadBtn');
                if (appUploadBtn) {
                    const appInput = document.createElement('input');
                    appInput.type = 'file';
                    appInput.accept = '.csv,.xlsx,.xls';
                    appUploadBtn.addEventListener('click', () => appInput.click());
                    appInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        try {
                            state.isLoading = true;
                            state.loadingProgress = 30;
                            render();
                            const fileExt = file.name.split('.').pop().toLowerCase();
                            let parsedData;
                            if (fileExt === 'xlsx' || fileExt === 'xls') {
                                parsedData = await parseExcelFile(file);
                            } else if (fileExt === 'csv') {
                                parsedData = await parseCSVFile(file);
                            }
                            if (!parsedData || !Array.isArray(parsedData)) {
                                throw new Error('íŒŒì¼ì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                            parsedData.forEach(row => {
                                if (row['ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰'] && !row['ì‚¬ìš©ëŸ‰']) {
                                    row['ì‚¬ìš©ëŸ‰'] = row['ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰'];
                                }
                                if (row['ë¹„ê³ '] && !row['ë©”ëª¨2']) {
                                    row['ë©”ëª¨2'] = row['ë¹„ê³ '];
                                }
                            });
                            if (!state.applicationData[state.targetYear]) {
                                state.applicationData[state.targetYear] = [];
                            }
                            state.applicationData[state.targetYear] = [...parsedData, ...state.applicationData[state.targetYear]];
                            state.isLoading = false;
                            saveDataToStorage();
                            alert(`âœ… ${parsedData.length}ê°œì˜ ë°ì´í„°ê°€ ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥ì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                            render();
                        } catch (error) {
                            state.isLoading = false;
                            alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ' + error.message);
                            render();
                        }
                    });
                }

                const appAddRowBtn = document.getElementById('appAddRowBtn');
                if (appAddRowBtn) appAddRowBtn.addEventListener('click', addApplicationRow);

                const appDeleteRowBtn = document.getElementById('appDeleteRowBtn');
                if (appDeleteRowBtn) appDeleteRowBtn.addEventListener('click', deleteSelectedApplicationRows);

                const appSaveBtn = document.getElementById('appSaveBtn');
                if (appSaveBtn) appSaveBtn.addEventListener('click', () => {
                    saveDataToStorage();
                    alert('ğŸ’¾ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                });

                const appDownloadBtn = document.getElementById('appDownloadBtn');
                if (appDownloadBtn) appDownloadBtn.addEventListener('click', () => {
                    state.showAppDownloadMenu = !state.showAppDownloadMenu;
                    render();
                });

                const appDownloadExcelBtn = document.getElementById('appDownloadExcelBtn');
                if (appDownloadExcelBtn) appDownloadExcelBtn.addEventListener('click', () => {
                    const currentAppData = state.applicationData[state.targetYear] || [];
                    const dataToDownload = state.selectedApplicationRows.size > 0
                        ? currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx))
                        : currentAppData;
                    if (dataToDownload.length === 0) {
                        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: applicationColumns });
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥');
                    XLSX.writeFile(workbook, `ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥_${state.targetYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
                    state.showAppDownloadMenu = false;
                    render();
                });

                const appDownloadCSVBtn = document.getElementById('appDownloadCSVBtn');
                if (appDownloadCSVBtn) appDownloadCSVBtn.addEventListener('click', () => {
                    const currentAppData = state.applicationData[state.targetYear] || [];
                    const dataToDownload = state.selectedApplicationRows.size > 0
                        ? currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx))
                        : currentAppData;
                    if (dataToDownload.length === 0) {
                        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    const csvContent = [
                        applicationColumns.join(','),
                        ...dataToDownload.map(row => 
                            applicationColumns.map(col => {
                                const value = row[col] || '';
                                return value.includes(',') || value.includes('"') 
                                    ? `"${value.replace(/"/g, '""')}"` 
                                    : value;
                            }).join(',')
                        )
                    ].join('\n');
                    const BOM = '\uFEFF';
                    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥_${state.targetYear}_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    state.showAppDownloadMenu = false;
                    render();
                });
                                
                const appEditToggleBtn = document.getElementById('appEditToggleBtn');
                if (appEditToggleBtn) appEditToggleBtn.addEventListener('click', () => {
                    state.isEditingApplication = !state.isEditingApplication;
                    render();
                });

                document.querySelectorAll('.pathway-row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.pathway.selectedRows.add(idx);
                        } else {
                            state.pathway.selectedRows.delete(idx);
                        }
                    });
                });

                document.querySelectorAll('.pathway-cell-edit').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const col = e.target.dataset.col;
                        if (!state.pathwayData[state.selectedYear]) {
                            state.pathwayData[state.selectedYear] = [];
                        }
                        if (state.pathwayData[state.selectedYear][idx]) {
                            state.pathwayData[state.selectedYear][idx][col] = e.target.value;
                            saveDataToStorage();
                        }
                    });
                });

                const selectAllAppRows = document.getElementById('selectAllAppRows');
                if (selectAllAppRows) selectAllAppRows.addEventListener('change', (e) => {
                    const currentAppData = state.applicationData[state.targetYear] || [];
                    if (e.target.checked) {
                        state.selectedApplicationRows = new Set(currentAppData.map((_, i) => i));
                    } else {
                        state.selectedApplicationRows = new Set();
                    }
                    render();
                });

                document.querySelectorAll('.app-row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.selectedApplicationRows.add(idx);
                        } else {
                            state.selectedApplicationRows.delete(idx);
                        }
                    });
                });

                const cutBtn = document.getElementById('cutBtn');
                if (cutBtn) cutBtn.addEventListener('click', cutToInspectionYear);

                const cancelBtn = document.getElementById('cancelBtn');
                if (cancelBtn) cancelBtn.addEventListener('click', moveToCancel);

                const appMapBtn = document.getElementById('appMapBtn');
                if (appMapBtn) appMapBtn.addEventListener('click', () => {
                    const currentAppData = state.applicationData[state.targetYear] || [];
                    const selectedData = state.selectedApplicationRows.size > 0
                        ? currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx))
                        : [];
                    if (selectedData.length === 0) {
                        alert('ì§€ë„ì— í‘œì‹œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    state.mapData = selectedData;
                    state.showMapModal = true;
                    state.isLoadingMap = true;
                    state.mapLoadingProgress = 0;
                    render();
                    setTimeout(() => initMap(selectedData), 100);
                });

                const appDetailBtn = document.getElementById('appDetailBtn');
                if (appDetailBtn) appDetailBtn.addEventListener('click', openAppDetailModal);

                const appSearchBtn = document.getElementById('appSearchBtn');
                if (appSearchBtn) appSearchBtn.addEventListener('click', () => {
                    const searchInput = document.getElementById('appSearchInput');
                    if (searchInput) state.applicationSearchTerm = searchInput.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appSearchInput = document.getElementById('appSearchInput');
                if (appSearchInput) appSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        state.applicationSearchTerm = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    }
                });

                const appRegionFilter = document.getElementById('appRegionFilter');
                if (appRegionFilter) appRegionFilter.addEventListener('change', (e) => {
                    state.applicationFilters.region = e.target.value ? [e.target.value] : [];
                    state.currentApplicationPage = 1;
                    render();
                });

                const appInspectorFilter = document.getElementById('appInspectorFilter');
                if (appInspectorFilter) appInspectorFilter.addEventListener('change', (e) => {
                    state.applicationFilters.inspector = e.target.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appResultFilter = document.getElementById('appResultFilter');
                if (appResultFilter) appResultFilter.addEventListener('change', (e) => {
                    state.applicationFilters.inspectionResult = e.target.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appReceiptFilter = document.getElementById('appReceiptFilter');
                if (appReceiptFilter) appReceiptFilter.addEventListener('change', (e) => {
                    state.applicationFilters.receiptLocation = e.target.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appBaseMonthFilter = document.getElementById('appBaseMonthFilter');
                if (appBaseMonthFilter) appBaseMonthFilter.addEventListener('change', (e) => {
                    state.applicationFilters.baseMonth = e.target.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appDateFrom = document.getElementById('appDateFrom');
                if (appDateFrom) appDateFrom.addEventListener('change', (e) => {
                    state.applicationFilters.applicationDateFrom = e.target.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appDateTo = document.getElementById('appDateTo');
                if (appDateTo) appDateTo.addEventListener('change', (e) => {
                    state.applicationFilters.applicationDateTo = e.target.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appInspDateFrom = document.getElementById('appInspDateFrom');
                if (appInspDateFrom) appInspDateFrom.addEventListener('change', (e) => {
                    state.applicationFilters.inspectionDateFrom = e.target.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appInspDateTo = document.getElementById('appInspDateTo');
                if (appInspDateTo) appInspDateTo.addEventListener('change', (e) => {
                    state.applicationFilters.inspectionDateTo = e.target.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appFeeFilter = document.getElementById('appFeeFilter');
                if (appFeeFilter) appFeeFilter.addEventListener('change', (e) => {
                    state.applicationFilters.fee = e.target.value;
                    state.currentApplicationPage = 1;
                    render();
                });

                const appFilterResetBtn = document.getElementById('appFilterResetBtn');
                if (appFilterResetBtn) appFilterResetBtn.addEventListener('click', () => {
                    state.applicationFilters = { region: [], inspector: '', receiptLocation: '', inspectionResult: '', applicationDateFrom: '', applicationDateTo: '', inspectionDateFrom: '', inspectionDateTo: '', baseMonth: '', fee: '', facilityCert: '', certificateStatus: '', insuranceStatus: '' };
                    state.applicationSearchTerm = '';
                    state.currentApplicationPage = 1;
                    render();
                });

                const appPrevPageBtn = document.getElementById('appPrevPageBtn');
                if (appPrevPageBtn) appPrevPageBtn.addEventListener('click', () => {
                    state.currentApplicationPage = Math.max(1, state.currentApplicationPage - 1);
                    render();
                });

                const appNextPageBtn = document.getElementById('appNextPageBtn');
                if (appNextPageBtn) appNextPageBtn.addEventListener('click', () => {
                    const currentAppData = state.applicationData[state.targetYear] || [];
                    const totalPages = Math.ceil(currentAppData.length / state.itemsPerPage);
                    state.currentApplicationPage = Math.min(totalPages, state.currentApplicationPage + 1);
                    render();
                });

                // ëª¨ë‹¬ ë²„íŠ¼ë“¤
                const cancelDupBtn = document.getElementById('cancelDupBtn');
                if (cancelDupBtn) cancelDupBtn.addEventListener('click', () => {
                    state.showDuplicateModal = false;
                    render();
                });

                const confirmDupBtn = document.getElementById('confirmDupBtn');
                if (confirmDupBtn) confirmDupBtn.addEventListener('click', confirmDuplicateCopy);

                const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
                if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => {
                    state.showDeleteModal = false;
                    render();
                });

                const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
                if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', confirmDelete);

                const cancelAppDeleteBtn = document.getElementById('cancelAppDeleteBtn');
                if (cancelAppDeleteBtn) cancelAppDeleteBtn.addEventListener('click', () => {
                    state.showAppDeleteModal = false;
                    render();
                });

                const confirmAppDeleteBtn = document.getElementById('confirmAppDeleteBtn');
                if (confirmAppDeleteBtn) confirmAppDeleteBtn.addEventListener('click', confirmAppDelete);

                // ìƒì„¸ë³´ê¸° ëª¨ë‹¬
                const detailCancelBtn = document.getElementById('detailCancelBtn');
                if (detailCancelBtn) detailCancelBtn.addEventListener('click', closeDetailModal);

                const detailCloseBtn = document.getElementById('detailCloseBtn');
                if (detailCloseBtn) detailCloseBtn.addEventListener('click', closeDetailModal);

                const detailSaveBtn = document.getElementById('detailSaveBtn');
                if (detailSaveBtn) detailSaveBtn.addEventListener('click', saveFromDetailModal);

                const detailAddBtn = document.getElementById('detailAddBtn');
                if (detailAddBtn) detailAddBtn.addEventListener('click', () => {
                    columns.forEach(col => {
                        const input = document.getElementById(`detail-${col}`);
                        if (input) state.detailModalData[col] = input.value;
                    });
                    addFromDetailModal();
                });

                const appDetailCancelBtn = document.getElementById('appDetailCancelBtn');
                if (appDetailCancelBtn) appDetailCancelBtn.addEventListener('click', closeAppDetailModal);

                const appDetailCloseBtn = document.getElementById('appDetailCloseBtn');
                if (appDetailCloseBtn) appDetailCloseBtn.addEventListener('click', closeAppDetailModal);

                const appDetailSaveBtn = document.getElementById('appDetailSaveBtn');
                if (appDetailSaveBtn) appDetailSaveBtn.addEventListener('click', saveFromAppDetailModal);

                const appDetailAddBtn = document.getElementById('appDetailAddBtn');
                if (appDetailAddBtn) appDetailAddBtn.addEventListener('click', addFromAppDetailModal);

                // ê²½ë¡œë‹¹ íƒ­ ì´ë²¤íŠ¸
                const pathwayUploadBtn = document.getElementById('pathwayUploadBtn');
                if (pathwayUploadBtn) {
                    const pathwayInput = document.createElement('input');
                    pathwayInput.type = 'file';
                    pathwayInput.accept = '.csv,.xlsx,.xls';
                    pathwayUploadBtn.addEventListener('click', () => pathwayInput.click());
                    pathwayInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        try {
                            state.isLoading = true;
                            state.loadingProgress = 30;
                            render();
                            const fileExt = file.name.split('.').pop().toLowerCase();
                            let parsedData;
                            if (fileExt === 'xlsx' || fileExt === 'xls') {
                                parsedData = await parseExcelFile(file);
                            } else if (fileExt === 'csv') {
                                parsedData = await parseCSVFile(file);
                            }
                            if (!state.pathwayData[state.selectedYear]) {
                                state.pathwayData[state.selectedYear] = [];
                            }
                            state.pathwayData[state.selectedYear] = [...parsedData, ...state.pathwayData[state.selectedYear]];
                            state.isLoading = false;
                            saveDataToStorage();
                            alert(`âœ… ${parsedData.length}ê°œì˜ ë°ì´í„°ê°€ ê²½ë¡œë‹¹ì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                            render();
                        } catch (error) {
                            state.isLoading = false;
                            alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ' + error.message);
                            render();
                        }
                    });
                }

                const pathwayDownloadBtn = document.getElementById('pathwayDownloadBtn');
                if (pathwayDownloadBtn) pathwayDownloadBtn.addEventListener('click', () => {
                    const dataToDownload = state.pathway.selectedRows.size > 0
                        ? (state.pathwayData[state.selectedYear] || []).filter((_, idx) => state.pathway.selectedRows.has(idx))
                        : (state.pathwayData[state.selectedYear] || []);
                    if (dataToDownload.length === 0) {
                        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: pathwayColumns });
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'ê²½ë¡œë‹¹');
                    XLSX.writeFile(workbook, `ê²½ë¡œë‹¹_${state.selectedYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
                });

                const pathwayDeleteBtn = document.getElementById('pathwayDeleteBtn');
                if (pathwayDeleteBtn) pathwayDeleteBtn.addEventListener('click', () => {
                    if (state.pathway.selectedRows.size === 0) {
                        alert('ì‚­ì œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    if (confirm(`${state.pathway.selectedRows.size}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        const currentData = state.pathwayData[state.selectedYear] || [];
                        state.pathwayData[state.selectedYear] = currentData.filter((_, idx) => !state.pathway.selectedRows.has(idx));
                        state.pathway.selectedRows = new Set();
                        saveDataToStorage();
                        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        render();
                    }
                });

                const pathwaySaveBtn = document.getElementById('pathwaySaveBtn');
                if (pathwaySaveBtn) pathwaySaveBtn.addEventListener('click', () => {
                    saveDataToStorage();
                    alert('ğŸ’¾ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                });

                const pathwayEditToggleBtn = document.getElementById('pathwayEditToggleBtn');
                if (pathwayEditToggleBtn) pathwayEditToggleBtn.addEventListener('click', () => {
                    state.pathway.isEditing = !state.pathway.isEditing;
                    render();
                });

                const pathwayAddRowBtn = document.getElementById('pathwayAddRowBtn');
                if (pathwayAddRowBtn) pathwayAddRowBtn.addEventListener('click', () => {
                    const newRow = {};
                    pathwayColumns.forEach(col => newRow[col] = '');
                    if (!state.pathwayData[state.selectedYear]) {
                        state.pathwayData[state.selectedYear] = [];
                    }
                    state.pathwayData[state.selectedYear] = [newRow, ...state.pathwayData[state.selectedYear]];
                    saveDataToStorage();
                    render();
                });

                const pathwayMapBtn = document.getElementById('pathwayMapBtn');
                if (pathwayMapBtn) pathwayMapBtn.addEventListener('click', () => {
                    const selectedData = state.pathway.selectedRows.size > 0
                        ? (state.pathwayData[state.selectedYear] || []).filter((_, idx) => state.pathway.selectedRows.has(idx))
                        : [];
                    if (selectedData.length === 0) {
                        alert('ì§€ë„ì— í‘œì‹œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    state.mapData = selectedData;
                    state.showMapModal = true;
                    state.isLoadingMap = true;
                    state.mapLoadingProgress = 0;
                    render();
                    setTimeout(() => initMap(selectedData), 100);
                });

                const pathwayRegionFilter = document.getElementById('pathwayRegionFilter');
                if (pathwayRegionFilter) pathwayRegionFilter.addEventListener('change', (e) => {
                    state.pathway.filters.region = e.target.value;
                    state.pathway.currentPage = 1;
                    render();
                });

                const pathwaySearchBtn = document.getElementById('pathwaySearchBtn');
                if (pathwaySearchBtn) pathwaySearchBtn.addEventListener('click', () => {
                    const searchInput = document.getElementById('pathwaySearchInput');
                    if (searchInput) state.pathway.searchTerm = searchInput.value;
                    state.pathway.currentPage = 1;
                    render();
                });

                const pathwaySearchInput = document.getElementById('pathwaySearchInput');
                if (pathwaySearchInput) pathwaySearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        state.pathway.searchTerm = e.target.value;
                        state.pathway.currentPage = 1;
                        render();
                    }
                });

                const pathwayResetBtn = document.getElementById('pathwayResetBtn');
                if (pathwayResetBtn) pathwayResetBtn.addEventListener('click', () => {
                    state.pathway.filters.region = '';
                    state.pathway.searchTerm = '';
                    state.pathway.currentPage = 1;
                    render();
                });

                const selectAllPathwayRows = document.getElementById('selectAllPathwayRows');
                if (selectAllPathwayRows) selectAllPathwayRows.addEventListener('change', (e) => {
                    const currentData = state.pathwayData[state.selectedYear] || [];
                    if (e.target.checked) {
                        state.pathway.selectedRows = new Set(currentData.map((_, i) => i));
                    } else {
                        state.pathway.selectedRows = new Set();
                    }
                    render();
                });

                document.querySelectorAll('.app-cell-edit').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const col = e.target.dataset.col;
                        state.applicationData[state.targetYear][idx][col] = e.target.value;
                        
                        // ì‹ ì²­ì¼ ë³€ê²½ ì‹œ í•„ì¦ë²ˆí˜¸ ìë™ ìƒì„±
                        if (col === 'ì‹ ì²­ì¼' && e.target.value) {
                            const certNumber = generateCertificateNumber(e.target.value, idx);
                            state.applicationData[state.targetYear][idx]['í•„ì¦ë²ˆí˜¸'] = certNumber;
                            render();
                        }
                        
                        saveDataToStorage();
                    });
                });

                const pathwayPrevPageBtn = document.getElementById('pathwayPrevPageBtn');
                if (pathwayPrevPageBtn) pathwayPrevPageBtn.addEventListener('click', () => {
                    state.pathway.currentPage = Math.max(1, state.pathway.currentPage - 1);
                    render();
                });

                const pathwayNextPageBtn = document.getElementById('pathwayNextPageBtn');
                if (pathwayNextPageBtn) pathwayNextPageBtn.addEventListener('click', () => {
                    const currentData = state.pathwayData[state.selectedYear] || [];
                    const totalPages = Math.ceil(currentData.length / state.itemsPerPage);
                    state.pathway.currentPage = Math.min(totalPages, state.pathway.currentPage + 1);
                    render();
                });

               // ë¶„ê¸° íƒ­ ì´ë²¤íŠ¸
                const quarterTargetYearSelect = document.getElementById('quarterTargetYearSelect');
                if (quarterTargetYearSelect) quarterTargetYearSelect.addEventListener('change', (e) => {
                    state.targetYear = parseInt(e.target.value);
                    render();
                });

                const quarterSelect = document.getElementById('quarterSelect');
                if (quarterSelect) quarterSelect.addEventListener('change', (e) => {
                    state.quarter.selectedQuarter = e.target.value;
                    render();
                });

                const recipientSelect = document.getElementById('recipientSelect');
                if (recipientSelect) recipientSelect.addEventListener('change', (e) => {
                    state.quarter.selectedRecipient = e.target.value;
                    render();
                });

                const quarterDownloadExcelBtn = document.getElementById('quarterDownloadExcelBtn');
                if (quarterDownloadExcelBtn) quarterDownloadExcelBtn.addEventListener('click', downloadQuarterExcel);

                const quarterDownloadCSVBtn = document.getElementById('quarterDownloadCSVBtn');
                if (quarterDownloadCSVBtn) quarterDownloadCSVBtn.addEventListener('click', downloadQuarterCSV);

                const quarterPrintBtn = document.getElementById('quarterPrintBtn');
                if (quarterPrintBtn) quarterPrintBtn.addEventListener('click', printQuarterReport);

                const quarterResetBtn = document.getElementById('quarterResetBtn');
                if (quarterResetBtn) quarterResetBtn.addEventListener('click', () => {
                    state.quarter.selectedQuarter = '';
                    state.quarter.selectedRecipient = '';
                    render();
                });

                // ë§¤ì¶œë¶„ì„ íƒ­
                const salesTargetYearSelect = document.getElementById('salesTargetYearSelect');
                if (salesTargetYearSelect) salesTargetYearSelect.addEventListener('change', (e) => {
                    state.targetYear = parseInt(e.target.value);
                    render();
                });
                
                // ì§€ë„ ëª¨ë‹¬
                const mapCloseBtn = document.getElementById('mapCloseBtn');
                if (mapCloseBtn) mapCloseBtn.addEventListener('click', () => {
                    state.showMapModal = false;
                    state.mapData = [];
                    state.isLoadingMap = false;
                    render();
                });

                const mapCancelBtn = document.getElementById('mapCancelBtn');
                if (mapCancelBtn) mapCancelBtn.addEventListener('click', () => {
                    state.showMapModal = false;
                    state.mapData = [];
                    state.isLoadingMap = false;
                    render();
                });

             const mapPrintBtn = document.getElementById('mapPrintBtn');
                if (mapPrintBtn) mapPrintBtn.addEventListener('click', () => window.print());

                // ìë£Œì‹¤ íƒ­ ì´ë²¤íŠ¸
              // ìë£Œì‹¤ íƒ­ ì´ë²¤íŠ¸
                const resourceFileUpload = document.getElementById('resourceFileUpload');
                if (resourceFileUpload) {
                    resourceFileUpload.addEventListener('change', async (e) => {
                        const files = e.target.files;
                        if (!files || files.length === 0) return;
                        
                        const formatFileSize = (bytes) => {
                            if (bytes === 0) return '0 Bytes';
                            const k = 1024;
                            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                        };
                        
                        const getFileType = (fileName) => {
                            const ext = fileName.split('.').pop().toLowerCase();
                            const typeMap = {
                                'pdf': 'PDF (Adobe Acrobat)',
                                'xlsx': 'Excel',
                                'xls': 'Excel',
                                'hwp': 'í•œê¸€',
                                'doc': 'Word',
                                'docx': 'Word',
                                'ppt': 'PowerPoint',
                                'pptx': 'PowerPoint',
                                'jpg': 'ì´ë¯¸ì§€',
                                'jpeg': 'ì´ë¯¸ì§€',
                                'png': 'ì´ë¯¸ì§€',
                                'gif': 'ì´ë¯¸ì§€',
                                'zip': 'ì••ì¶•íŒŒì¼',
                                'rar': 'ì••ì¶•íŒŒì¼',
                                'csv': 'CSV'
                            };
                            return typeMap[ext] || ext.toUpperCase();
                        };
                        
                        if (!state.resourceData[state.selectedYear]) {
                            state.resourceData[state.selectedYear] = [];
                        }
                        if (!state.resource.fileStorage[state.selectedYear]) {
                            state.resource.fileStorage[state.selectedYear] = {};
                        }
                        
                        let uploadCount = 0;
                        for (const file of files) {
                            const fileId = 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                state.resource.fileStorage[state.selectedYear][fileId] = {
                                    name: file.name,
                                    type: file.type,
                                    data: event.target.result
                                };
                            };
                            reader.readAsDataURL(file);
                            
                            const newRow = {
                                'í´ë”': '',
                                'íŒŒì¼ëª…': file.name,
                                'íŒŒì¼í˜•ì‹': getFileType(file.name),
                                'íŒŒì¼í¬ê¸°': formatFileSize(file.size),
                                'ì„¤ëª…': '',
                                'ë“±ë¡ì¼': new Date().toISOString().split('T')[0],
                                'ë“±ë¡ì': '',
                                'fileId': fileId
                            };
                            
                            state.resourceData[state.selectedYear] = [newRow, ...state.resourceData[state.selectedYear]];
                            uploadCount++;
                        }
                        
                        saveDataToStorage();
                        alert(`âœ… ${uploadCount}ê°œì˜ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        e.target.value = '';
                        render();
                    });
                }

                const resourceDownloadSelectedBtn = document.getElementById('resourceDownloadSelectedBtn');
                if (resourceDownloadSelectedBtn) resourceDownloadSelectedBtn.addEventListener('click', () => {
                    if (state.resource.selectedFiles.size === 0) {
                        alert('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    const currentData = state.resourceData[state.selectedYear] || [];
                    const fileStorage = state.resource.fileStorage[state.selectedYear] || {};
                    
                    state.resource.selectedFiles.forEach(idx => {
                        const row = currentData[idx];
                        if (row && row.fileId && fileStorage[row.fileId]) {
                            const fileInfo = fileStorage[row.fileId];
                            const link = document.createElement('a');
                            link.href = fileInfo.data;
                            link.download = fileInfo.name;
                            link.click();
                        }
                    });
                });

                document.querySelectorAll('.resource-download-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const currentData = state.resourceData[state.selectedYear] || [];
                        const fileStorage = state.resource.fileStorage[state.selectedYear] || {};
                        const row = currentData[idx];
                        
                        if (row && row.fileId && fileStorage[row.fileId]) {
                            const fileInfo = fileStorage[row.fileId];
                            const link = document.createElement('a');
                            link.href = fileInfo.data;
                            link.download = fileInfo.name;
                            link.click();
                        } else {
                            alert('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    });
                });

                const resourceDeleteBtn = document.getElementById('resourceDeleteBtn');
                if (resourceDeleteBtn) resourceDeleteBtn.addEventListener('click', () => {
                    if (state.resource.selectedFiles.size === 0) {
                        alert('ì‚­ì œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    if (confirm(`${state.resource.selectedFiles.size}ê°œ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        const currentData = state.resourceData[state.selectedYear] || [];
                        const fileStorage = state.resource.fileStorage[state.selectedYear] || {};
                        
                        state.resource.selectedFiles.forEach(idx => {
                            const row = currentData[idx];
                            if (row && row.fileId && fileStorage[row.fileId]) {
                                delete fileStorage[row.fileId];
                            }
                        });
                        
                        state.resourceData[state.selectedYear] = currentData.filter((_, idx) => !state.resource.selectedFiles.has(idx));
                        state.resource.selectedFiles = new Set();
                        saveDataToStorage();
                        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        render();
                    }
                });

                const resourceExportListBtn = document.getElementById('resourceExportListBtn');
                if (resourceExportListBtn) resourceExportListBtn.addEventListener('click', () => {
                    const currentData = state.resourceData[state.selectedYear] || [];
                    if (currentData.length === 0) {
                        alert('ë‚´ë³´ë‚¼ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    const exportColumns = ['í´ë”', 'íŒŒì¼ëª…', 'íŒŒì¼í˜•ì‹', 'íŒŒì¼í¬ê¸°', 'ì„¤ëª…', 'ë“±ë¡ì¼', 'ë“±ë¡ì'];
                    const worksheet = XLSX.utils.json_to_sheet(currentData.map(row => {
                        const obj = {};
                        exportColumns.forEach(col => obj[col] = row[col] || '');
                        return obj;
                    }), { header: exportColumns });
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'ìë£Œì‹¤ëª©ë¡');
                    XLSX.writeFile(workbook, `ìë£Œì‹¤ëª©ë¡_${state.selectedYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
                });

                const resourceFolderFilter = document.getElementById('resourceFolderFilter');
                if (resourceFolderFilter) resourceFolderFilter.addEventListener('change', (e) => {
                    state.resource.currentFolder = e.target.value;
                    render();
                });

                const resourceSearchBtn = document.getElementById('resourceSearchBtn');
                if (resourceSearchBtn) resourceSearchBtn.addEventListener('click', () => {
                    const searchInput = document.getElementById('resourceSearchInput');
                    if (searchInput) state.resource.searchTerm = searchInput.value;
                    render();
                });

                const resourceSearchInput = document.getElementById('resourceSearchInput');
                if (resourceSearchInput) resourceSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        state.resource.searchTerm = e.target.value;
                        render();
                    }
                });

                const resourceResetBtn = document.getElementById('resourceResetBtn');
                if (resourceResetBtn) resourceResetBtn.addEventListener('click', () => {
                    state.resource.currentFolder = '';
                    state.resource.searchTerm = '';
                    render();
                });

                const selectAllResourceRows = document.getElementById('selectAllResourceRows');
                if (selectAllResourceRows) selectAllResourceRows.addEventListener('change', (e) => {
                    const currentData = state.resourceData[state.selectedYear] || [];
                    if (e.target.checked) {
                        state.resource.selectedFiles = new Set(currentData.map((_, i) => i));
                    } else {
                        state.resource.selectedFiles = new Set();
                    }
                    render();
                });

                document.querySelectorAll('.resource-row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.resource.selectedFiles.add(idx);
                        } else {
                            state.resource.selectedFiles.delete(idx);
                        }
                    });
                });

                document.querySelectorAll('.resource-cell-edit').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const col = e.target.dataset.col;
                        if (!state.resourceData[state.selectedYear]) {
                            state.resourceData[state.selectedYear] = [];
                        }
                        if (state.resourceData[state.selectedYear][idx]) {
                            state.resourceData[state.selectedYear][idx][col] = e.target.value;
                            saveDataToStorage();
                        }
                    });
                });

            } catch (error) {
                console.error('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì²¨ë¶€ ì˜¤ë¥˜:', error);
            }
        }  

        // ======================== ì´ˆê¸°í™” ========================
        window.addEventListener('load', async function() {
    try {
        loadFromLocalStorage();
        updateFilters();
        render();
        
        // í´ë¼ìš°ë“œ ìë™ ë¡œë“œ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
        if (CONFIG.ENABLE_CLOUD && CONFIG.API_URL) {
            await autoCloudLoad();
        }
              // ìë£Œì‹¤ íƒ­ ì´ë²¤íŠ¸
                const resourceUploadBtn = document.getElementById('resourceUploadBtn');
                if (resourceUploadBtn) {
                    const resourceInput = document.createElement('input');
                    resourceInput.type = 'file';
                    resourceInput.accept = '.csv,.xlsx,.xls';
                    resourceUploadBtn.addEventListener('click', () => resourceInput.click());
                    resourceInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        try {
                            state.isLoading = true;
                            state.loadingProgress = 30;
                            render();
                            const fileExt = file.name.split('.').pop().toLowerCase();
                            let parsedData;
                            if (fileExt === 'xlsx' || fileExt === 'xls') {
                                parsedData = await parseExcelFile(file);
                            } else if (fileExt === 'csv') {
                                parsedData = await parseCSVFile(file);
                            }
                            if (!state.resourceData[state.selectedYear]) {
                                state.resourceData[state.selectedYear] = [];
                            }
                            state.resourceData[state.selectedYear] = [...parsedData, ...state.resourceData[state.selectedYear]];
                            state.isLoading = false;
                            saveDataToStorage();
                            alert(`âœ… ${parsedData.length}ê°œì˜ ë°ì´í„°ê°€ ìë£Œì‹¤ì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                            render();
                        } catch (error) {
                            state.isLoading = false;
                            alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ' + error.message);
                            render();
                        }
                    });
                }

                const resourceDownloadExcelBtn = document.getElementById('resourceDownloadExcelBtn');
                if (resourceDownloadExcelBtn) resourceDownloadExcelBtn.addEventListener('click', () => {
                    const currentData = state.resourceData[state.selectedYear] || [];
                    const dataToDownload = state.resource.selectedFiles.size > 0
                        ? currentData.filter((_, idx) => state.resource.selectedFiles.has(idx))
                        : currentData;
                    if (dataToDownload.length === 0) {
                        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    const resourceColumns = ['í´ë”', 'íŒŒì¼ëª…', 'ì„¤ëª…', 'ë“±ë¡ì¼', 'ë“±ë¡ì', 'ë¹„ê³ '];
                    const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: resourceColumns });
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'ìë£Œì‹¤');
                    XLSX.writeFile(workbook, `ìë£Œì‹¤_${state.selectedYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
                });

                const resourceDownloadCSVBtn = document.getElementById('resourceDownloadCSVBtn');
                if (resourceDownloadCSVBtn) resourceDownloadCSVBtn.addEventListener('click', () => {
                    const currentData = state.resourceData[state.selectedYear] || [];
                    const dataToDownload = state.resource.selectedFiles.size > 0
                        ? currentData.filter((_, idx) => state.resource.selectedFiles.has(idx))
                        : currentData;
                    if (dataToDownload.length === 0) {
                        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    const resourceColumns = ['í´ë”', 'íŒŒì¼ëª…', 'ì„¤ëª…', 'ë“±ë¡ì¼', 'ë“±ë¡ì', 'ë¹„ê³ '];
                    const csvContent = [
                        resourceColumns.join(','),
                        ...dataToDownload.map(row => 
                            resourceColumns.map(col => {
                                const value = row[col] || '';
                                return value.includes(',') || value.includes('"') 
                                    ? `"${value.replace(/"/g, '""')}"` 
                                    : value;
                            }).join(',')
                        )
                    ].join('\n');
                    const BOM = '\uFEFF';
                    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `ìë£Œì‹¤_${state.selectedYear}_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                });

                const resourceDeleteBtn = document.getElementById('resourceDeleteBtn');
                if (resourceDeleteBtn) resourceDeleteBtn.addEventListener('click', () => {
                    if (state.resource.selectedFiles.size === 0) {
                        alert('ì‚­ì œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    if (confirm(`${state.resource.selectedFiles.size}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        const currentData = state.resourceData[state.selectedYear] || [];
                        state.resourceData[state.selectedYear] = currentData.filter((_, idx) => !state.resource.selectedFiles.has(idx));
                        state.resource.selectedFiles = new Set();
                        saveDataToStorage();
                        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        render();
                    }
                });

                const resourceAddRowBtn = document.getElementById('resourceAddRowBtn');
                if (resourceAddRowBtn) resourceAddRowBtn.addEventListener('click', () => {
                    const resourceColumns = ['í´ë”', 'íŒŒì¼ëª…', 'ì„¤ëª…', 'ë“±ë¡ì¼', 'ë“±ë¡ì', 'ë¹„ê³ '];
                    const newRow = {};
                    resourceColumns.forEach(col => newRow[col] = '');
                    newRow['ë“±ë¡ì¼'] = new Date().toISOString().split('T')[0];
                    if (!state.resourceData[state.selectedYear]) {
                        state.resourceData[state.selectedYear] = [];
                    }
                    state.resourceData[state.selectedYear] = [newRow, ...state.resourceData[state.selectedYear]];
                    saveDataToStorage();
                    render();
                });

                const resourceSaveBtn = document.getElementById('resourceSaveBtn');
                if (resourceSaveBtn) resourceSaveBtn.addEventListener('click', () => {
                    saveDataToStorage();
                    alert('ğŸ’¾ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                });

                const resourceFolderFilter = document.getElementById('resourceFolderFilter');
                if (resourceFolderFilter) resourceFolderFilter.addEventListener('change', (e) => {
                    state.resource.currentFolder = e.target.value;
                    render();
                });

                const resourceSearchBtn = document.getElementById('resourceSearchBtn');
                if (resourceSearchBtn) resourceSearchBtn.addEventListener('click', () => {
                    const searchInput = document.getElementById('resourceSearchInput');
                    if (searchInput) state.resource.searchTerm = searchInput.value;
                    render();
                });

                const resourceSearchInput = document.getElementById('resourceSearchInput');
                if (resourceSearchInput) resourceSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        state.resource.searchTerm = e.target.value;
                        render();
                    }
                });

                const resourceResetBtn = document.getElementById('resourceResetBtn');
                if (resourceResetBtn) resourceResetBtn.addEventListener('click', () => {
                    state.resource.currentFolder = '';
                    state.resource.searchTerm = '';
                    render();
                });

                const selectAllResourceRows = document.getElementById('selectAllResourceRows');
                if (selectAllResourceRows) selectAllResourceRows.addEventListener('change', (e) => {
                    const currentData = state.resourceData[state.selectedYear] || [];
                    if (e.target.checked) {
                        state.resource.selectedFiles = new Set(currentData.map((_, i) => i));
                    } else {
                        state.resource.selectedFiles = new Set();
                    }
                    render();
                });

                document.querySelectorAll('.resource-row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.resource.selectedFiles.add(idx);
                        } else {
                            state.resource.selectedFiles.delete(idx);
                        }
                    });
                });

                document.querySelectorAll('.resource-cell-edit').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const col = e.target.dataset.col;
                        if (!state.resourceData[state.selectedYear]) {
                            state.resourceData[state.selectedYear] = [];
                        }
                        if (state.resourceData[state.selectedYear][idx]) {
                            state.resourceData[state.selectedYear][idx][col] = e.target.value;
                            saveDataToStorage();
                        }
                    });
                });  
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        });

        // ìë™ì €ì¥
        setInterval(() => {
            if (state.settings.autoSave && (Object.keys(state.data).length > 0 || Object.keys(state.applicationData).length > 0)) {
                saveDataToStorage();
            }
        }, state.settings.autoSaveInterval * 1000);
    </script>
</body>
</html>




