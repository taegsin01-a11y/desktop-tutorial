
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공인검사기관 안전관리시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- 이 부분 위에 추가 -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c8f5719a2be48f3875087006ce782934&libraries=services&autoload=false"></script>
   
    <style>
        .scroll-x-auto {
            -webkit-overflow-scrolling: touch;
        }
        .table-cell-input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-sky-400 to-sky-200 min-h-screen">
    <div id="app"></div>

    <script>
        // ======================== 전역 상태 ========================
        const state = {
            currentYear: new Date().getFullYear(),
            activeTab: '통합',
            selectedYear: new Date().getFullYear(),
            data: {},
            filteredData: [],
            applicationData: {},
            quarterData: {},
            cancellationData: {},
            pathwayData: {},
            resourceData: {}, 
            currentPage: 1,
            selectedRows: new Set(),
            isLoading: false,
            loadingProgress: 0,
            searchTerm: '',
            isEditing: false,
            showAdmin: false,
            adminPassword: '',
            showWelcome: true,
            lastSaved: null,
            showDownloadMenu: false,
            uploadedFileName: '',
            showDuplicateModal: false,
            duplicateInfo: { duplicates: [], selectedData: [] },
            inspectionYear: new Date().getFullYear(),
            targetYear: new Date().getFullYear(),
            applicationFilters: {
                region: [],
                inspector: '',
                receiptLocation: '',
                inspectionResult: '',
                applicationDateFrom: '',
                applicationDateTo: '',
                inspectionDateFrom: '',
                inspectionDateTo: '',
                baseMonth: '',
                fee: '',
                facilityCert: '',
                certificateStatus: '',
                insuranceStatus: ''
            },
            applicationSearchTerm: '',
            selectedApplicationRows: new Set(),
            isEditingApplication: false,
            currentApplicationPage: 1,
            selectedQuarterRows: new Set(),
            isEditingQuarter: false,
            currentQuarterPage: 1,
            isEditingCancellation: false,
            selectedCancellationRows: new Set(),
            showDeleteModal: false,
            showAppDeleteModal: false,
            showDetailModal: false,
            detailModalData: {},
            detailModalSelectedIdx: null,
            showAppDetailModal: false,
            appDetailModalData: {},
            appDetailModalSelectedIdx: null,
            filters: {
                region: [],
                month: '',
                inspectionHistory: ''
            },
            showRegionDropdown: false,
            showMonthDropdown: false,
            showInspectionDropdown: false,
            settings: {
                companyName: '공인검사기관',
                maxFileSize: 100,
                autoSave: true,
                autoSaveInterval: 30
            },
            itemsPerPage: 50,
            inspectors: ['최중수', '김택신', '김춘식', '김정만'],
            receiptLocations: ['지로', '국민', '부산', '농협', '경남', '후납', '기타'],
            inspectionResults: ['합격', '불합격', '이중납부','공란', '기타'],
            yearRange: Array.from({ length: 37 }, (_, i) => 2014 + i),
            cancelReasons: ['입금 미확인', '고객 요청', '중복 신청', '기타'],
            showMapModal: false,
            mapData: [],
            isLoadingMap: false,
            mapLoadingProgress: 0,
            showMapModal: false,
            mapData: [],
            isLoadingMap: false,
            mapLoadingProgress: 0,
            quarter: {
                selectedQuarter: 'Q1',
                selectedRecipient: '',
                quarters: ['1분기', '2분기', '3분기', '4분기'],
                recipients: {
                    '부산시청': ['부산 강서구', '부산 남구', '부산 동구', '부산 부산진구', '부산 사상구', '부산 사하구', '부산 서구', '부산 수영구', '부산 영도구', '부산 중구', '부산 해운대구', '부산 금정구', '부산 기장군', '부산 동래구', '부산 연제구', '부산 북구'],
                    '강서구청장': ['부산 강서구'],
                    '남구청장': ['부산 남구'],
                    '동구청장': ['부산 동구'],
                    '부산진구청장': ['부산 부산진구'],
                    '사상구청장': ['부산 사상구'],
                    '사하구청장': ['부산 사하구'],
                    '서구청장': ['부산 서구'],
                    '수영구청장': ['부산 수영구'],
                    '영도구청장': ['부산 영도구'],
                    '중구청장': ['부산 중구'],
                    '해운대구청장': ['부산 해운대구'],
                    '금정구청장': ['부산 금정구'],
                    '기장군수': ['부산 기장군'],
                    '동래구청장': ['부산 동래구'],
                    '연제구청장': ['부산 연제구'],
                    '북구청장': ['부산 북구'],
                    '울산광역시 북구청장': ['울산 북구'],
                    '김해시청': ['경남 김해시'],
                    '양산시청': ['경남 양산시'],
                    '사천시청': ['경남 사천시'],
                    '통영시청': ['경남 통영시'],
                    '거제시청': ['경남 거제시'],
                    '포항시청': ['경북 포항시'],
                    '경주시청': ['경북 경주시'],
                    '구미시청': ['경북 구미시'],
                    '한국가스안전공사 부산지역본부': ['부산 강서구', '부산 남구', '부산 동구', '부산 부산진구', '부산 사상구', '부산 사하구', '부산 서구', '부산 수영구', '부산 영도구', '부산 중구'],
                    '한국가스안전공사 북부지사': ['부산 해운대구', '부산 금정구', '부산 기장군', '부산 동래구', '부산 연제구', '부산 북구'],
                    '한국가스안전공사 울산지사': ['울산 북구'],
                    '한국가스안전공사 창원지사': ['경남 김해시', '경남 양산시', '경남 통영시', '경남 거제시'],
                    '한국가스안전공사 진주지사': ['경남 사천시'],
                    '한국가스안전공사 경북동부지사': ['경북 포항시', '경북 경주시'],
                    '한국가스안전공사 대구경북지역본부': ['경북 구미시']
                }
            },
              pathway: {
                searchTerm: '',
                selectedRows: new Set(),
                isEditing: false,
                currentPage: 1,
                filters: {
                    region: ''
                },
                showDownloadMenu: false
            }
        };
        
            const columns = [
            '시설번호', '시설명', '행정구역', '새주소', '구주소', '월사용예정량', 
            '전화번호', '기준일', '안전관리자명', '자격증번호', '보험사', '보험만기일', 
            '메모', '검사일', '신청일', '검사원', '검사결과', '필증번호', '수수료', 
            '접수처', '계산서발행일', '비고', '검사확인', '사업자번호', '대표자명', 
            '업태', '종목', '이메일', '면제대상', '검사이력'
        ];

        const applicationColumns = [
            '시설번호', '시설명', '행정구역', '새주소', '구주소', '월사용예정량', 
            '전화번호', '기준일', '안전관리자명', '자격증번호', '보험사', '보험만기일', 
            '메모', '검사일', '신청일', '검사원', '검사결과', '필증번호', '수수료', 
            '접수처', '계산서발행일', '메모2', '검사확인'
        ];

        const quarterColumns = [
             '분기', '시설번호', '시설명', '행정구역', '신청일', '검사일', '검사원', '검사결과', '필증번호', '메모'
        ];

        const cancellationColumns = [
             '시설번호', '시설명', '행정구역', '새주소', '신청일', '취소사유', '취소일', '수수료', '접수처','계좌', '비고'
        ];

         const pathwayColumns = [
            '시설번호', '시설명', '행정구역', '읍면동', '새주소', '전화번호', '사용가스', '차단기', '타이머', 'CO경보기', '누설', '점검일', '점검자', '비고', '참조'
        ];

        const pathwayOptions = {
            regions: ['울주군', '북구', '남구', '중구', '동구'],
            gas: ['LPG', '도시가스', 'LPG+도시가스'],
            device: ['설치', '미설치', '불량', '해당없슴'],
            leak: ['유', '무'],
            inspectors: ['최중수', '김택신', '김춘식']
        };

        const columnWidths = {
            '시설번호': '120px', '시설명': '150px', '행정구역': '100px', '새주소': '200px',
            '구주소': '120px', '월사용예정량': '100px', '전화번호': '110px', '기준일': '100px',
            '안전관리자명': '90px', '자격증번호': '120px', '보험사': '70px', '보험만기일': '100px',
            '메모': '150px', '검사일': '100px', '신청일': '100px', '검사원': '90px',
            '검사결과': '70px', '필증번호': '140px', '수수료': '80px', '접수처': '70px',
            '계산서발행일': '110px', '메모2': '150px', '검사확인': '70px',
            '취소번호': '120px', '취소사유': '150px', '취소일': '100px', '처리자': '90px', '비고': '150px'
        };

        // ======================== 유틸리티 함수 ========================
        function formatCurrency(value) {
            if (!value || value === '') return '';
            const num = parseInt(String(value).replace(/,/g, ''));
            if (isNaN(num)) return value;
            return num.toLocaleString();
        }

       function saveToLocalStorage(dataToSave) {
    try {
        const jsonString = JSON.stringify(dataToSave);
        const sizeInMB = (new Blob([jsonString]).size / (1024 * 1024)).toFixed(2);
        
        if (parseFloat(sizeInMB) > 15) {
            console.warn(`⚠️ 데이터 크기가 큽니다: ${sizeInMB}MB`);
            return false;
        }
        
        localStorage.setItem('safetySystemData', jsonString);
        console.log(`✅ 저장 완료 (${sizeInMB}MB)`);
        return true;
    } catch (e) {
        if (e.name === 'QuotaExceededError') {
            console.error('⚠️ 저장 공간 초과. 데이터를 정리하세요.');
            state.settings.autoSave = false;
            return false;
        }
        console.error('저장 오류:', e);
        return false;
    }
} 

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('safetySystemData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    if (parsed.data) state.data = parsed.data;
                    if (parsed.applicationData) state.applicationData = parsed.applicationData;
                    if (parsed.quarterData) state.quarterData = parsed.quarterData;
                    if (parsed.cancellationData) state.cancellationData = parsed.cancellationData;
                    if (parsed.pathwayData) state.pathwayData = parsed.pathwayData;
                    if (parsed.resourceData) state.resourceData = parsed.resourceData;
                    if (parsed.settings) state.settings = parsed.settings;
                    if (parsed.uploadedFileName) state.uploadedFileName = parsed.uploadedFileName;
                    if (parsed.selectedYear) state.selectedYear = parsed.selectedYear;
                    if (parsed.lastSaved) state.lastSaved = new Date(parsed.lastSaved);
                    
                    const totalData = Object.values(state.data).reduce((sum, yearData) => sum + yearData.length, 0);
                    if (totalData > 0) {
                        state.showWelcome = false;
                        const sizeInMB = (new Blob([savedData]).size / (1024 * 1024)).toFixed(2);
                        console.log(`✅ 저장된 데이터 복원: ${totalData}건 (${sizeInMB}MB)`);
                    }
                }
            } catch (e) {
                console.error('데이터 로드 실패:', e);
            }
        }

        function getStorageSize() {
            try {
                const savedData = localStorage.getItem('safetySystemData');
                if (savedData) {
                    const sizeInMB = (new Blob([savedData]).size / (1024 * 1024)).toFixed(2);
                    return sizeInMB;
                }
                return '0.00';
            } catch (e) {
                return 'N/A';
            }
        }

        function normalizeDate(dateValue) {
            if (!dateValue || dateValue === '') return '';
            
            if (typeof dateValue === 'number') {
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            const dateStr = String(dateValue).trim();
            
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            
            if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split('.');
                const year = parts[0];
                const month = String(parts[1]).padStart(2, '0');
                const day = String(parts[2]).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                const year = parts[0];
                const month = String(parts[1]).padStart(2, '0');
                const day = String(parts[2]).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                const year = parts[2];
                const month = String(parts[0]).padStart(2, '0');
                const day = String(parts[1]).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return dateStr;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}.${month}.${day}`;
            } catch (e) {
                return dateString;
            }
        }

        function getQuarterFromDate(dateString) {
            if (!dateString) return '';
            try {
                const match = dateString.match(/(\d{4})[-./](\d{1,2})[-./](\d{1,2})/);
                if (match) {
                    const month = parseInt(match[2]);
                    if (month <= 3) return 'Q1';
                    if (month <= 6) return 'Q2';
                    if (month <= 9) return 'Q3';
                    return 'Q4';
                }
            } catch (e) {}
            return '';
        }

       function generateCertificateNumber(date, year) {
    // 신청일이 없으면 빈 문자열 반환
    if (!date || date === '') {
        return '';
    }
    
    // 모든 연도의 신청접수대장 데이터를 합침
    const allAppData = Object.values(state.applicationData).flat();
    
    if (state.targetYear !== state.inspectionYear) {
        // 해당년도와 검사예정년도가 다를 때: KGT{yy}0101-001 형식
        const yy = String(state.inspectionYear).slice(2);
        const prefix = `KGT${yy}0101`;
        
        const existingNumbers = allAppData
            .filter(row => row['필증번호']?.startsWith(prefix))
            .map(row => {
                const match = row['필증번호']?.match(/-(\d{3})$/);
                return match ? parseInt(match[1]) : 0;
            })
            .filter(num => num > 0);
        
        const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
        return `${prefix}-${String(nextNumber).padStart(3, '0')}`;
    }
    
    // 해당년도와 검사예정년도가 같을 때: 신청일 기준 KGT{yyMMdd}-001 형식
    const targetDate = new Date(date);
    const yy = String(targetDate.getFullYear()).slice(2);
    const MM = String(targetDate.getMonth() + 1).padStart(2, '0');
    const dd = String(targetDate.getDate()).padStart(2, '0');
    
    const prefix = `KGT${yy}${MM}${dd}`;
    
    const existingNumbers = allAppData
        .filter(row => row['필증번호']?.startsWith(prefix))
        .map(row => {
            const match = row['필증번호']?.match(/-(\d{3})$/);
            return match ? parseInt(match[1]) : 0;
        })
        .filter(num => num > 0);
    
    const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
    return `${prefix}-${String(nextNumber).padStart(3, '0')}`;
}
       
        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onerror = () => reject(new Error('파일 읽기 실패'));
                
                reader.onload = (e) => {
                    try {
                        state.loadingProgress = 60;
                        render();
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        state.loadingProgress = 70;
                        render();
                        
                        // 데이터가 가장 많은 시트 또는 '접수' 시트 찾기
            let targetSheet = null;
            let maxRows = 0;

            // '접수' 시트가 있으면 우선 사용
            if (workbook.SheetNames.includes('접수')) {
                targetSheet = workbook.Sheets['접수'];
            } else {
                // 없으면 데이터가 가장 많은 시트 찾기
                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    if (data.length > maxRows) {
                        maxRows = data.length;
                        targetSheet = sheet;
                    }
                });
            }

if (!targetSheet) {
    targetSheet = workbook.Sheets[workbook.SheetNames[0]];
}

const jsonData = XLSX.utils.sheet_to_json(targetSheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('데이터가 없거나 형식이 올바르지 않습니다.'));
                            return;
                        }
                        
                        state.loadingProgress = 85;
                        render();
                        
                        const headers = jsonData[0].map(h => String(h || '').trim());
                        const dateColumns = ['기준일', '검사일', '신청일', '보험만기일', '계산서발행일'];
                        const parsedData = [];
                        
                      for (let i = 1; i < jsonData.length; i++) {
                      // 행의 모든 셀이 비어있는지 확인
                        const hasData = jsonData[i].some(cell => cell !== undefined && cell !== null && String(cell).trim() !== '');
                        if (!hasData) continue;
    
                        const obj = {};
                        headers.forEach((header, idx) => {
                         let value = jsonData[i][idx];
                         if (value === undefined || value === null) {
                            obj[header] = '';
                         } else {
                             if (dateColumns.includes(header)) {
                                obj[header] = normalizeDate(value);
                        } else {
                            obj[header] = String(value).trim();
            }
        }
    });
    parsedData.push(obj);
} 
                        
                        state.loadingProgress = 100;
                        render();
                        resolve(parsedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.readAsArrayBuffer(file);
              });
        }

        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onerror = () => reject(new Error('파일 읽기 실패'));
                
                reader.onload = (e) => {
                    try {
                        state.loadingProgress = 60;
                        render();
                        
                        const text = e.target.result;
                        
                        if (!text || text.trim() === '') {
                            reject(new Error('파일이 비어있습니다.'));
                            return;
                        }

                       const lines = text
                            .replace(/\r\n/g, '\n')
                            .split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0);

                        if (lines.length < 2) {
                            reject(new Error('데이터가 없거나 형식이 올바르지 않습니다.'));
                            return;
                        }

                        state.loadingProgress = 80;
                        render();
                        
                        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                        const dateColumns = ['기준일', '검사일', '신청일', '보험만기일', '계산서발행일'];
                        
                        const parsedData = [];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i];
                            if (!line.trim()) continue;
                            
                            const values = [];
                            let currentValue = '';
                            let insideQuotes = false;
                            
                            for (let j = 0; j < line.length; j++) {
                                const char = line[j];
                                if (char === '"') {
                                    insideQuotes = !insideQuotes;
                                } else if (char === ',' && !insideQuotes) {
                                    values.push(currentValue.trim().replace(/^"|"$/g, ''));
                                    currentValue = '';
                                } else {
                                    currentValue += char;
                                }
                            }
                            values.push(currentValue.trim().replace(/^"|"$/g, ''));
                            
                    // 열 개수가 부족하면 빈 문자열로 채움
                    while (values.length < headers.length) {
                        values.push('');
                    }

                    // 모든 셀이 비어있는지 확인
                    const hasData = values.some(v => v && String(v).trim() !== '');
                    if (!hasData) continue;

                    const obj = {};
                    headers.forEach((header, idx) => {
                        let value = (values[idx] || '').replace(/[\\]/g, '').trim();
                        if (dateColumns.includes(header)) {
                            obj[header] = normalizeDate(value);
                        } else {
                            obj[header] = value;
                        }
                    });
                    parsedData.push(obj);                           }

                        state.loadingProgress = 100;
                        render();
                        resolve(parsedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.readAsText(file, 'EUC-KR');
            });
        }

        async function handleFileUpload(file) {
            if (!file) return;

            const maxSize = state.settings.maxFileSize * 1024 * 1024;
            if (file.size > maxSize) {
                alert(`파일 크기가 ${state.settings.maxFileSize}MB를 초과합니다.`);
                return;
            }

            state.isLoading = true;
            state.loadingProgress = 30;
            state.uploadedFileName = file.name;
            render();

            try {
                let parsedData;
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                if (fileExt === 'xlsx' || fileExt === 'xls') {
                    parsedData = await parseExcelFile(file);
                } else if (fileExt === 'csv') {
                    parsedData = await parseCSVFile(file);
                } else {
                    throw new Error('지원하지 않는 파일 형식입니다. (.xlsx, .xls, .csv만 가능)');
                }

                if (parsedData.length === 0) {
                    alert('유효한 데이터가 없습니다.');
                    state.isLoading = false;
                    render();
                    return;
                }

                if (!state.data[state.selectedYear]) {
                    state.data[state.selectedYear] = [];
                }
                state.data[state.selectedYear] = parsedData;
                
                state.lastSaved = new Date();
                
                setTimeout(() => {
                    state.isLoading = false;
                    const storageSize = getStorageSize();
                    let message = `✅ ${parsedData.length}개의 데이터가 ${state.selectedYear}년도로 업로드되었습니다.\n파일명: ${file.name}`;
                    
                    if (parseFloat(storageSize) > 3) {
                        message += `\n\n⚠️ 저장 공간: ${storageSize}MB/5MB\n공간이 부족하면 자동 저장이 실패할 수 있습니다.`;
                    }
                    
                    alert(message);
                    saveDataToStorage();
                    render();
                }, 300);

            } catch (error) {
                console.error('파일 처리 오류:', error);
                alert('파일 처리 중 오류가 발생했습니다: ' + error.message);
                state.isLoading = false;
                render();
            }
        }

        function downloadAsExcel() {
            const dataToDownload = state.selectedRows.size > 0
                ? state.filteredData.filter((_, idx) => state.selectedRows.has(idx))
                : state.filteredData;

            if (dataToDownload.length === 0) {
                alert('다운로드할 데이터가 없습니다.');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: columns });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '안전관리');
            
            const wscols = columns.map(() => ({ wch: 15 }));
            worksheet['!cols'] = wscols;
            
            const fileName = `안전관리_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            state.showDownloadMenu = false;
            render();
        }

        function downloadAsCSV() {
            const dataToDownload = state.selectedRows.size > 0
                ? state.filteredData.filter((_, idx) => state.selectedRows.has(idx))
                : state.filteredData;

            if (dataToDownload.length === 0) {
                alert('다운로드할 데이터가 없습니다.');
                return;
            }

            const csvContent = [
                columns.join(','),
                ...dataToDownload.map(row => 
                    columns.map(col => {
                        const value = row[col] || '';
                        return value.includes(',') || value.includes('"') 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `안전관리_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            state.showDownloadMenu = false;
            render();
        }

        function createSampleData() {
            const sampleData = [
                {
                    '시설번호': '00458912-0001', '시설명': '장수마을목욕탕', '행정구역': '부산',
                    '새주소': '부산광역시 기장군 기장읍 교리 334-6번지', '구주소': '',
                    '월사용예정량': '6,334.00㎡', '전화번호': '051-724-2552', '기준일': '2025-02-03',
                    '안전관리자명': '', '자격증번호': '', '보험사': '', '보험만기일': '2028-11-22',
                    '메모': '', '검사일': '2002-01-30', '신청일': '', '검사원': '문서영',
                    '검사결과': '', '필증번호': '', '수수료': '', '접수처': '비대상',
                    '계산서발행일': '', '비고': '', '검사확인': '', '사업자번호': '',
                    '대표자명': '', '업태': '', '종목': '', '이메일': '', '면제대상': '', '검사이력': 'Y'
                },
                {
                    '시설번호': '01525996-0001', '시설명': '피플러한의원', '행정구역': '부산',
                    '새주소': '부산광역시 기장군 정관읍 용수리 12 83-3번지', '구주소': '',
                    '월사용예정량': '1,322.00㎡', '전화번호': '051-728-6999', '기준일': '2025-05-07',
                    '안전관리자명': '', '자격증번호': '', '보험사': '', '보험만기일': '',
                    '메모': '', '검사일': '2011-01-05', '신청일': '', '검사원': '',
                    '검사결과': '', '필증번호': '', '수수료': '', '접수처': '비대상',
                    '계산서발행일': '', '비고': '', '검사확인': '', '사업자번호': '',
                    '대표자명': '', '업태': '', '종목': '', '이메일': '', '면제대상': '', '검사이력': ''
                }
            ];
            if (!state.data[state.selectedYear]) {
                state.data[state.selectedYear] = [];
            }
            state.data[state.selectedYear] = sampleData;
            state.uploadedFileName = '샘플데이터.xlsx';
            state.lastSaved = new Date();
            state.showWelcome = false;
            alert('샘플 데이터 2건이 생성되었습니다.');
            saveDataToStorage();
            updateFilters();
            render();
        }

        function updateFilters() {
            let result = [...(state.data[state.selectedYear] || [])];
            
            if (state.filters.region.length > 0) {
                result = result.filter(row => {
                    const region = (row['행정구역'] || '').replace(/[\\\/]/g, '').trim();
                    return state.filters.region.includes(region);
                });
            }
            
           
            if (state.filters.inspectionHistory) {
                result = result.filter(row => {
                    const history = row['검사이력'];
                    if (state.filters.inspectionHistory === 'Y') return history === 'Y';
                    if (state.filters.inspectionHistory === 'N') return !history || history === '' || history === 'N';
                    return true;
                });
            }
            
            if (state.searchTerm) {
                result = result.filter(row =>
                    Object.values(row).some(val =>
                        String(val).toLowerCase().includes(state.searchTerm.toLowerCase())
                    )
                );
            }
            
            state.filteredData = result;
            state.currentPage = 1;
        }

        function copyToApplication() {
    const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
    
    if (selectedData.length === 0) {
        alert('복사할 데이터를 선택해주세요.');
        return;
    }

    if (!state.applicationData[state.targetYear]) {
        state.applicationData[state.targetYear] = [];
    }

    const duplicates = selectedData.filter(item =>
        state.applicationData[state.targetYear].some(app => app['시설번호'] === item['시설번호'])
    );

    if (duplicates.length > 0) {
        state.duplicateInfo = { duplicates, selectedData };
        state.showDuplicateModal = true;
        render();
        return;
    }

    // 필증번호 자동 생성 (신청일이 있을 때만)
selectedData.forEach(row => {
    if (row['신청일'] && row['신청일'] !== '') {
        row['필증번호'] = generateCertificateNumber(row['신청일'], state.targetYear);
    } else {
        row['필증번호'] = '';
    }
});

   const existingData = state.applicationData[state.targetYear] || [];
state.applicationData[state.targetYear] = [...selectedData, ...existingData];
        
    state.activeTab = '신청접수대장';
    state.selectedRows = new Set();
    alert(`${selectedData.length}개 항목이 신청접수대장으로 복사되었습니다.`);
    saveDataToStorage();
    render();
}
        
        function confirmDuplicateCopy() {
            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }
            // 필증번호 자동 생성 (-001부터 순차 증가)


selectedData.forEach((row, idx) => {
    row['필증번호'] = `${prefix}-${String(maxNumber + idx + 1).padStart(3, '0')}`;
});

            state.applicationData[state.targetYear] = [...state.duplicateInfo.selectedData, ...state.applicationData[state.targetYear]];
                        
            state.showDuplicateModal = false;
            state.activeTab = '신청접수대장';
            state.selectedRows = new Set();
            alert(`${state.duplicateInfo.selectedData.length}개 항목이 신청접수대장으로 복사되었습니다.`);
            saveDataToStorage();
            render();
        }

        function moveToCancel() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            const selectedData = currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx));
            
            if (selectedData.length === 0) {
                alert('취소할 데이터를 선택해주세요.');
                return;
            }

            if (!state.cancellationData[state.targetYear]) {
                state.cancellationData[state.targetYear] = [];
            }

            const cancellationItems = selectedData.map((item, idx) => ({
                '시설번호': item['시설번호'],
                '시설명': item['시설명'],
                '행정구역': item['행정구역'],
                '새주소': item['새주소'] || '',
                '필증번호': item['필증번호'],
                '신청일': item['신청일'],
                '취소사유': '',
                '취소일': '',
                '수수료': '',
                '접수처': '',
                '계좌': '',
                '비고': ''
            }));

            state.cancellationData[state.targetYear] = [...cancellationItems, ...state.cancellationData[state.targetYear]];
            
            const remainingApplicationData = currentAppData.filter((_, idx) => !state.selectedApplicationRows.has(idx));
            state.applicationData[state.targetYear] = remainingApplicationData;
            
            state.selectedApplicationRows = new Set();
            alert(`${selectedData.length}개 항목이 취소대장으로 이동되었습니다.`);
            saveDataToStorage();
            render();
        }

      function cutToInspectionYear() {
    if (state.targetYear === state.inspectionYear) {
        alert('⚠️ 해당년도와 검사예정년도가 같습니다.\n잘라내기가 필요하지 않습니다.');
        return;
    }

    if (state.selectedApplicationRows.size === 0) {
        alert('잘라낼 데이터를 선택해주세요.');
        return;
    }

    const currentAppData = state.applicationData[state.targetYear] || [];
    const selectedIndices = Array.from(state.selectedApplicationRows).sort((a, b) => b - a);
    const selectedData = selectedIndices.map(idx => ({...currentAppData[idx]}));

    const cutCount = selectedData.length;
    const targetInspectionYear = state.inspectionYear;

    if (!state.applicationData[state.inspectionYear]) {
        state.applicationData[state.inspectionYear] = [];
    }

    // 필증번호 자동 생성 (신청일이 있을 때만)
    const yy = String(state.inspectionYear).slice(2);
    const prefix = `KGT${yy}0101`;
    
    // 모든 연도의 데이터에서 같은 prefix를 가진 최대 번호 찾기
    const allAppData = Object.values(state.applicationData).flat();
    const existingNumbers = allAppData
        .filter(row => row['필증번호']?.startsWith(prefix))
        .map(row => {
            const match = row['필증번호']?.match(/-(\d{3})$/);
            return match ? parseInt(match[1]) : 0;
        })
        .filter(num => num > 0);
    
    let maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
    
    selectedData.forEach(row => {
        if (row['신청일'] && row['신청일'] !== '') {
            maxNumber++;
            row['필증번호'] = `${prefix}-${String(maxNumber).padStart(3, '0')}`;
        } else {
            row['필증번호'] = '';
        }
    });

    // 맨 앞에 배치
    state.applicationData[state.inspectionYear] = [...selectedData, ...state.applicationData[state.inspectionYear]];

    // 해당년도에서 삭제
    selectedIndices.forEach(idx => {
        state.applicationData[state.targetYear].splice(idx, 1);
    });

    state.targetYear = state.inspectionYear;
    state.selectedApplicationRows = new Set();

    alert(`✂️ ${cutCount}개 항목이 ${targetInspectionYear}년도로 이동되었습니다.`);
    saveDataToStorage();
    render();
}

       function saveDataToStorage() {
    const toSave = {
        data: state.data,
        applicationData: state.applicationData,
        quarterData: state.quarterData,
        cancellationData: state.cancellationData,
        pathwayData: state.pathwayData,
        resourceData: state.resourceData,
        settings: state.settings,
        uploadedFileName: state.uploadedFileName,
        selectedYear: state.selectedYear,
        lastSaved: new Date().toISOString(),
        timestamp: new Date().toISOString()
    };
    const saved = saveToLocalStorage(toSave);
    if (saved) {
        state.lastSaved = new Date();
    } else {
        console.warn('⚠️ 저장 실패. 불필요한 데이터를 삭제해주세요.');
    }
}

        function clearAllData() {
            if (confirm('⚠️ 모든 데이터를 삭제하시겠습니까?\n(저장된 데이터도 모두 삭제됩니다)')) {
                localStorage.removeItem('safetySystemData');
                state.data = {};
                state.applicationData = {};
                state.quarterData = {};
                state.cancellationData = {};
                state.pathwayData = {};
                state.resourceData = {};
                state.uploadedFileName = '';
                state.lastSaved = null;
                state.showWelcome = true;
                state.showAdmin = false;
                alert('✅ 모든 데이터가 삭제되었습니다.');
                render();
            }
        }

        function deleteSelectedRows() {
            if (state.selectedRows.size === 0) {
                alert('삭제할 행을 선택해주세요.');
                return;
            }
            state.showDeleteModal = true;
            render();
        }

        function confirmDelete() {
            const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
            
            selectedData.forEach(selectedItem => {
                state.data[state.selectedYear] = state.data[state.selectedYear].filter(item => item !== selectedItem);
            });
            
            state.selectedRows = new Set();
            state.showDeleteModal = false;
            alert(`${selectedData.length}개 항목이 삭제되었습니다.`);
            saveDataToStorage();
            updateFilters();
            render();
        }

       function addApplicationRow() {
        const newRow = {};
        applicationColumns.forEach(col => {
            newRow[col] = '';
        });
        // 신청일이 없으므로 필증번호도 빈 값
        newRow['필증번호'] = '';
        
    if (!state.applicationData[state.targetYear]) {
            state.applicationData[state.targetYear] = [];
        }
        state.applicationData[state.targetYear] = [newRow, ...state.applicationData[state.targetYear]];
        saveDataToStorage();
        render();
}

        function addQuarterRow() {
            const newRow = {
                '분기': '', '시설번호': '', '시설명': '', '행정구역': '', '신청일': '', 
                '검사일': '', '검사원': '', '검사결과': '', '필증번호': '', '메모': ''
            };
            
                    if (!state.quarterData[state.selectedYear]) {
                state.quarterData[state.selectedYear] = [];
            }
            state.quarterData[state.selectedYear] = [newRow, ...state.quarterData[state.selectedYear]];
            
            saveDataToStorage();
            render();
        }

        function deleteSelectedApplicationRows() {
    if (state.selectedApplicationRows.size === 0) {
        alert('삭제할 행을 선택해주세요.');
        return;
    }
    state.showAppDeleteModal = true;
    render();
}

function confirmAppDelete() {
    const currentAppData = state.applicationData[state.targetYear] || [];
    const selectedIndices = Array.from(state.selectedApplicationRows);
    const newData = currentAppData.filter((_, idx) => !selectedIndices.includes(idx));
    state.applicationData[state.targetYear] = newData;
    
    state.selectedApplicationRows = new Set();
    state.showAppDeleteModal = false;
    alert('삭제되었습니다.');
    saveDataToStorage();
    render();
}
        function deleteSelectedQuarterRows() {
            if (state.selectedQuarterRows.size === 0) {
                alert('삭제할 행을 선택해주세요.');
                return;
            }
            
            if (confirm(`선택한 ${state.selectedQuarterRows.size}개의 행을 삭제하시겠습니까?`)) {
                const newData = (state.quarterData[state.selectedYear] || []).filter((_, idx) => !state.selectedQuarterRows.has(idx));
                state.quarterData[state.selectedYear] = newData;
                
                state.selectedQuarterRows = new Set();
                alert('삭제되었습니다.');
                saveDataToStorage();
                render();
            }
        }

        function deleteSelectedCancellationRows() {
            if (state.selectedCancellationRows.size === 0) {
                alert('삭제할 행을 선택해주세요.');
                return;
            }
            
            if (confirm(`선택한 ${state.selectedCancellationRows.size}개의 행을 삭제하시겠습니까?`)) {
                const newData = (state.cancellationData[state.targetYear] || []).filter((_, idx) => !state.selectedCancellationRows.has(idx));
                state.cancellationData[state.targetYear] = newData;
                
                state.selectedCancellationRows = new Set();
                alert('삭제되었습니다.');
                saveDataToStorage();
                render();
            }
        }

        function generateCertificateNumbers() {
            if (state.selectedApplicationRows.size === 0) {
                alert('필증번호를 생성할 행을 선택해주세요.');
                return;
            }
            
            let generatedCount = 0;
            const sortedIndices = Array.from(state.selectedApplicationRows).sort((a, b) => b - a);
            const generatedRows = [];
            
            sortedIndices.forEach(idx => {
                if (state.applicationData[state.targetYear] && state.applicationData[state.targetYear][idx]) {
                    const referenceDate = state.applicationData[state.targetYear][idx]['신청일'] || state.applicationData[state.targetYear][idx]['검사일'];
                    if (referenceDate) {
                        state.applicationData[state.targetYear][idx]['필증번호'] = generateCertificateNumber(referenceDate, state.targetYear);
                        generatedRows.push(state.applicationData[state.targetYear][idx]);
                        generatedCount++;
                    }
                }
            });
            
            if (generatedCount > 0) {
                if (state.targetYear !== state.inspectionYear) {
                    const nextYear = state.targetYear + 1;
                    
                    if (!state.applicationData[nextYear]) {
                        state.applicationData[nextYear] = [];
                    }
                    
                    state.applicationData[nextYear] = [...state.applicationData[nextYear], ...generatedRows];
                    
                    sortedIndices.forEach(idx => {
                        state.applicationData[state.targetYear].splice(idx, 1);
                    });
                    
                    state.selectedApplicationRows = new Set();
                    state.targetYear = nextYear;
                    
                    alert(`✅ ${generatedCount}개의 필증번호가 생성되어 ${nextYear}년도로 이동되었습니다.`);
                } else {
                    alert(`${generatedCount}개의 필증번호가 생성되었습니다.`);
                }
                
                saveDataToStorage();
            } else {
                alert('신청일 또는 검사일이 입력된 행이 없습니다. 날짜를 먼저 입력해주세요.');
            }
            render();
        }

        function renderDetailModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
                    <div class="bg-white rounded-lg shadow-2xl my-8 w-full max-w-4xl mx-4 max-h-[95vh] overflow-y-auto">
                        
                        <!-- 헤더 -->
                        <div class="bg-pink-600 text-white px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">👁️</span>
                                ${state.detailModalSelectedIdx !== null ? '상세보기' : '새 데이터 추가'}
                            </h3>
                            <button id="detailCloseBtn" class="text-white hover:text-gray-200 text-2xl">✕</button>
                        </div>

                        <!-- 컨텐츠 -->
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${columns.map(col => `
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">${col}</label>
                                        <input type="text" id="detail-${col}" value="${state.detailModalData[col] || ''}" 
                                               class="w-full px-3 py-2 border rounded text-sm" 
                                               ${col.includes('일') ? 'type="date"' : ''} />
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- 버튼 -->
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t sticky bottom-0 z-10">
                            <button id="detailCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                                취소
                            </button>
                            ${state.detailModalSelectedIdx !== null ? `
                                <button id="detailSaveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                                    💾 수정
                                </button>
                            ` : `
                                <button id="detailAddBtn" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-semibold">
                                    ➕ 추가
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

          function renderAppDetailModal() {
    return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
            <div class="bg-white rounded-lg shadow-2xl my-8 w-full max-w-4xl mx-4 max-h-[95vh] overflow-y-auto">
                
                <!-- 헤더 -->
                <div class="bg-pink-600 text-white px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <span class="text-2xl">👁️</span>
                        ${state.appDetailModalSelectedIdx !== null ? '상세보기 (신청접수대장)' : '새 데이터 추가 (신청접수대장)'}
                    </h3>
                    <button id="appDetailCloseBtn" class="text-white hover:text-gray-200 text-2xl">✕</button>
                </div>

                <!-- 컨텐츠 -->
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${applicationColumns.map(col => `
                            <div>
                                <label class="block text-sm font-semibold mb-2">${col}</label>
                                ${col === '검사원' ? `
                                    <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                        <option value="">선택</option>
                                        ${state.inspectors.map(i => `<option value="${i}" ${i === state.appDetailModalData[col] ? 'selected' : ''}>${i}</option>`).join('')}
                                    </select>
                                ` : col === '검사결과' ? `
                                    <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                        <option value="">선택</option>
                                        ${state.inspectionResults.map(r => `<option value="${r}" ${r === state.appDetailModalData[col] ? 'selected' : ''}>${r}</option>`).join('')}
                                    </select>
                                ` : col === '접수처' ? `
                                    <select id="appDetail-${col}" class="w-full px-3 py-2 border rounded text-sm">
                                        <option value="">선택</option>
                                        ${state.receiptLocations.map(l => `<option value="${l}" ${l === state.appDetailModalData[col] ? 'selected' : ''}>${l}</option>`).join('')}
                                    </select>
                                ` : col.includes('일') ? `
                                    <input type="date" id="appDetail-${col}" value="${state.appDetailModalData[col] || ''}" class="w-full px-3 py-2 border rounded text-sm" />
                                ` : `
                                    <input type="text" id="appDetail-${col}" value="${state.appDetailModalData[col] || ''}" class="w-full px-3 py-2 border rounded text-sm" />
                                `}
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 버튼 -->
                <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t sticky bottom-0 z-10">
                    <button id="appDetailCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                        취소
                    </button>
                    ${state.appDetailModalSelectedIdx !== null ? `
                        <button id="appDetailSaveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                            💾 수정
                        </button>
                    ` : `
                        <button id="appDetailAddBtn" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-semibold">
                            ➕ 추가
                        </button>
                    `}
                </div>
            </div>
        </div>
    `;
}

function openAppDetailModal() {
    if (state.selectedApplicationRows.size === 1) {
        const selectedIdx = Array.from(state.selectedApplicationRows)[0];
        const currentAppData = state.applicationData[state.targetYear] || [];
        const selectedData = currentAppData[selectedIdx];
        state.appDetailModalData = { ...selectedData };
        state.appDetailModalSelectedIdx = selectedIdx;
    } else {
        state.appDetailModalData = {};
        state.appDetailModalSelectedIdx = null;
        applicationColumns.forEach(col => {
            state.appDetailModalData[col] = '';
        });
    }
    state.showAppDetailModal = true;
    render();
}

function closeAppDetailModal() {
    state.showAppDetailModal = false;
    render();
}

function saveFromAppDetailModal() {
    applicationColumns.forEach(col => {
        const input = document.getElementById(`appDetail-${col}`);
        if (input) {
            state.appDetailModalData[col] = input.value;
        }
    });
    
    if (state.appDetailModalSelectedIdx !== null && state.appDetailModalSelectedIdx >= 0) {
        state.applicationData[state.targetYear][state.appDetailModalSelectedIdx] = { ...state.appDetailModalData };
    }
    
    state.lastSaved = new Date();
    saveDataToStorage();
    state.showAppDetailModal = false;
    alert('💾 데이터가 저장되었습니다.');
    render();
}

function addFromAppDetailModal() {
    applicationColumns.forEach(col => {
        const input = document.getElementById(`appDetail-${col}`);
        if (input) {
            state.appDetailModalData[col] = input.value;
        }
    });
    
    const newRow = { ...state.appDetailModalData };
    
            // 필증번호 자동 생성 (신청일이 있을 때만)
        if (newRow['신청일'] && newRow['신청일'] !== '') {
            newRow['필증번호'] = generateCertificateNumber(newRow['신청일'], state.targetYear);
        } else {
            newRow['필증번호'] = '';
        }
    
    if (!state.applicationData[state.targetYear]) {
        state.applicationData[state.targetYear] = [];
    }
    state.applicationData[state.targetYear] = [newRow, ...state.applicationData[state.targetYear]];
    
    state.lastSaved = new Date();
    saveDataToStorage();
    state.showAppDetailModal = false;
    alert('데이터가 추가되었습니다.');
    render();
}

         function renderMapModal() {
    return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto p-4">
                <div class="bg-white rounded-lg shadow-2xl my-8" style="width: 95%; max-width: 1000px; height: 700px; display: flex; flex-direction: column; overflow: hidden;">
                
                <!-- 헤더 -->
                <div class="flex items-center justify-between p-6 border-b sticky top-0 bg-white z-10">
                    <h3 class="text-2xl font-bold">🗺️ 시설 위치 지도</h3>
                    <button id="mapCloseBtn" class="text-gray-600 hover:text-gray-900 text-3xl font-bold">✕</button>
                </div>

                <!-- 지도 컨테이너 -->
                <div id="mapContainer" style="width: 100%; height: 400px; background: #f0f0f0; border: 1px solid #ccc;"></div>
                <!-- 로딩 프로그래스 바 -->
                <div id="mapLoadingBar" style="padding: 1.5rem; background: #eff6ff; border-top: 1px solid #bfdbfe; ${state.isLoadingMap ? '' : 'display: none;'}">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-semibold text-blue-700">지도 로딩 중...</span>
                        <span id="mapProgressText" class="text-sm font-bold text-blue-600">${state.mapLoadingProgress}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="mapProgressBar" class="bg-blue-600 h-3 rounded-full transition-all" style="width: ${state.mapLoadingProgress}%;"></div>
                    </div>
                </div>
                <!-- 주소 정보 -->
                <div class="p-6 bg-gray-50 border-t max-h-40 overflow-y-auto flex-1">
                    <h4 class="font-bold mb-4">📍 선택된 시설 주소</h4>
                    <div class="space-y-3">
                        ${state.mapData.map((item, idx) => `
                            <div class="bg-white p-4 rounded border-l-4 border-blue-500">
                                <p class="font-semibold">${item['시설명']}</p>
                                <p class="text-sm text-gray-600">시설번호: ${item['시설번호']}</p>
                                <p class="text-sm text-gray-700">📮 ${item['새주소']}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- 버튼 -->
                <div class="flex gap-3 justify-end p-6 border-t bg-white">
                    <button id="mapPrintBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                        🖨️ 인쇄
                    </button>
                    <button id="mapCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                        닫기
                    </button>
                </div>
            </div>
        </div>
    `;
} 

        function openDetailModal() {
            if (state.selectedRows.size === 1) {
                const selectedIdx = Array.from(state.selectedRows)[0];
                const selectedData = state.filteredData[selectedIdx];
                state.detailModalData = { ...selectedData };
                state.detailModalSelectedIdx = (state.data[state.selectedYear] || []).indexOf(selectedData);
            } else {
                state.detailModalData = {};
                state.detailModalSelectedIdx = null;
                columns.forEach(col => {
                    state.detailModalData[col] = '';
                });
            }
            state.showDetailModal = true;
            render();
        }

        function closeDetailModal() {
            state.showDetailModal = false;
            render();
        }

        function saveFromDetailModal() {
            columns.forEach(col => {
                const input = document.getElementById(`detail-${col}`);
                if (input) {
                    state.detailModalData[col] = input.value;
                }
            });
            
            if (state.detailModalSelectedIdx !== null && state.detailModalSelectedIdx >= 0) {
                state.data[state.selectedYear][state.detailModalSelectedIdx] = { ...state.detailModalData };
            } else {
            if (!state.data[state.selectedYear]) {
                state.data[state.selectedYear] = [];
            }
            state.data[state.selectedYear] = [{ ...state.detailModalData }, ...state.data[state.selectedYear]];
        }
            
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showDetailModal = false;
            alert('💾 데이터가 저장되었습니다.');
            updateFilters();
            render();
        }

        function addFromDetailModal() {
            const newRow = { ...state.detailModalData };
            if (!state.data[state.selectedYear]) {
                state.data[state.selectedYear] = [];
            }
            state.data[state.selectedYear] = [newRow, ...state.data[state.selectedYear]];
            state.lastSaved = new Date();
            saveDataToStorage();
            state.showDetailModal = false;
            alert('데이터가 추가되었습니다.');
            updateFilters();
            render();
        }

        // ======================== 렌더링 함수 ========================
        function render() {
            try {
                updateFilters();
                const app = document.getElementById('app');
                if (!app) {
                    console.error('#app 요소를 찾을 수 없습니다.');
                    return;
                }
                app.innerHTML = renderApp();
                attachEventListeners();
            } catch (error) {
                console.error('렌더링 오류:', error);
                const app = document.getElementById('app');
                if (app) {
                    app.innerHTML = `<div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded">오류가 발생했습니다: ${error.message}</div>`;
                }
            }
        }

        function renderApp() {
            return `
                <div class="min-h-screen bg-gradient-to-b from-sky-400 to-sky-200">
                    ${renderHeader()}
                    ${renderTabs()}
                    <div class="container mx-auto px-4 py-6">
                        ${renderContent()}
                    </div>
                    ${renderFooter()}
                    ${state.isLoading ? renderLoadingModal() : ''}
                    ${state.showDuplicateModal ? renderDuplicateModal() : ''}
                    ${state.showDeleteModal ? renderDeleteModal() : ''}
                    ${state.showAppDeleteModal ? renderAppDeleteModal() : ''}
                    ${state.showDetailModal ? renderDetailModal() : ''}
                    ${state.showAppDetailModal ? renderAppDetailModal() : ''}
                    ${state.showMapModal ? renderMapModal() : ''}
                </div>
            `;
        }

        function renderHeader() {
            const years = Array.from({ length: 10 }, (_, i) => state.currentYear - i);
            return `
                <div class="bg-gradient-to-r from-sky-400 to-sky-500 text-white">
                    <div class="container mx-auto px-4 py-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold">공인검사기관</h1>
                                <p class="text-lg">안전관리시스템 v2.0 💾 (연도별 독립 관리)</p>
                            </div>
                            <div class="text-right">
                                <label class="block text-sm mb-1">당해 연도</label>
                                <select id="yearSelect" class="px-4 py-2 text-gray-900 rounded border-2 border-white">
                                    ${years.map(year => `<option value="${year}" ${year === state.selectedYear ? 'selected' : ''}>${year}년</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTabs() {
            const tabs = ['통합', '신청접수대장', '분기', '경로당', '매출분석', '취소', '자료실', '관리자'];
            return `
                <div class="bg-white border-b shadow-sm">
                    <div class="container mx-auto px-4">
                        <div class="flex gap-1 overflow-x-auto">
                            ${tabs.map(tab => `
                                <button class="tab-btn px-6 py-3 font-semibold whitespace-nowrap ${state.activeTab === tab ? 'bg-blue-600 text-white border-b-4 border-blue-800' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}" data-tab="${tab}">
                                    ${tab}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContent() {
            if (state.showWelcome && Object.keys(state.data).length === 0 && state.activeTab === '통합') {
                return renderWelcome();
            }
            
            if (state.activeTab === '관리자') {
                return renderAdmin();
            }
            
            if (state.activeTab === '신청접수대장') {
                return renderApplicationTab();
            }

            if (state.activeTab === '분기') {
                return renderQuarterTab();
            }

            if (state.activeTab === '매출분석') {
                return renderSalesAnalysisTab();
            }

            if (state.activeTab === '경로당') {
                return renderPathwayTab();
            }

            if (state.activeTab === '자료실') {
                return renderResourceTab();
            }

            if (state.activeTab === '취소') {
                return renderCancellationTab();
            }
            
            return renderMainTab();
        }

        function renderWelcome() {
            return `
                <div class="flex items-center justify-center min-h-96">
                    <div class="bg-white p-12 rounded-2xl shadow-2xl max-w-2xl text-center">
                        <h2 class="text-4xl font-bold mb-6 text-blue-600">👋 환영합니다!</h2>
                        <p class="text-xl mb-8 text-gray-700">공인검사기관 안전관리시스템</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <button id="sampleDataBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-6 rounded-xl hover:from-blue-600 hover:to-blue-700 shadow-lg transform hover:scale-105 transition-all">
                                <div class="text-5xl mb-3">🎯</div>
                                <div class="text-xl font-bold mb-2">샘플 데이터로 시작</div>
                                <div class="text-sm opacity-90">2건의 테스트 데이터 생성</div>
                            </button>

                            <label class="bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-6 rounded-xl hover:from-green-600 hover:to-green-700 shadow-lg transform hover:scale-105 transition-all cursor-pointer">
                                <div class="text-5xl mb-3">📁</div>
                                <div class="text-xl font-bold mb-2">파일 업로드</div>
                                <div class="text-sm opacity-90">Excel/CSV로 시작하기</div>
                                <input type="file" id="welcomeFileInput" accept=".csv,.xlsx,.xls" class="hidden" />
                            </label>
                        </div>

                        <button id="emptyStartBtn" class="mt-6 text-gray-500 hover:text-gray-700 underline">
                            빈 화면으로 시작
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAdmin() {
            if (!state.showAdmin) {
                return `
                    <div class="flex items-center justify-center h-96">
                        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
                            <h2 class="text-xl font-bold mb-4">관리자 로그인</h2>
                            <input type="password" id="adminPassword" placeholder="비밀번호 입력" class="w-full px-4 py-2 border rounded mb-4" />
                            <button id="adminLoginBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                로그인
                            </button>
                        </div>
                    </div>
                `;
            }
            const totalMainData = Object.values(state.data).reduce((sum, yearData) => sum + yearData.length, 0);
            const totalAppData = Object.values(state.applicationData).reduce((sum, yearData) => sum + (yearData ? yearData.length : 0), 0);
            const totalQuarterData = Object.values(state.quarterData).reduce((sum, yearData) => sum + (yearData ? yearData.length : 0), 0);
            const totalCancelData = Object.values(state.cancellationData).reduce((sum, yearData) => sum + (yearData ? yearData.length : 0), 0);
            const totalPathwayData = Object.values(state.pathwayData).reduce((sum, yearData) => {
                let count = 0;
                if (yearData) {
                    Object.values(yearData).forEach(roomData => {
                        if (Array.isArray(roomData)) count += roomData.length;
                    });
                }
                return sum + count;
            }, 0);
            const totalResourceData = Object.values(state.resourceData).reduce((sum, yearData) => {
                if (Array.isArray(yearData)) {
                    return sum + yearData.length;
                }
                return sum;
            }, 0);
            return `
                <div class="p-6 bg-white rounded-lg">
                    <h2 class="text-2xl font-bold mb-6">시스템 관리</h2>
                    <div class="space-y-6">
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold mb-4">시스템 정보</h3>
                            <div class="bg-gray-50 p-4 rounded space-y-2 text-sm">
                                <p><strong>버전:</strong> 2.0.0 (연도별 독립 관리)</p>
                                <p><strong>전체 데이터:</strong> ${totalMainData}건</p>
                                <p><strong>신청접수대장:</strong> ${totalAppData}건</p>
                                <p><strong>분기데이터:</strong> ${totalQuarterData}건</p>
                                <p><strong>취소대장:</strong> ${totalCancelData}건</p>
                                <p><strong>경로당데이터:</strong> ${totalPathwayData}건</p>
                                <p><strong>자료실:</strong> ${totalResourceData}건</p>
                                <p><strong>업로드 파일:</strong> ${state.uploadedFileName || '없음'}</p>
                                <p><strong>마지막 저장:</strong> ${state.lastSaved ? state.lastSaved.toLocaleString() : '저장 기록 없음'}</p>
                                <p><strong>자동저장:</strong> ${state.settings.autoSave ? `활성 (${state.settings.autoSaveInterval}초)` : '비활성'}</p>
                                <p class="pt-2 border-t">
                                    <strong>저장 위치:</strong> 
                                    <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 rounded text-sm">
                                        💾 브라우저 로컬 스토리지
                                    </span>
                                </p>
                                <p>
                                    <strong>저장 공간 사용:</strong>
                                    <span class="${parseFloat(getStorageSize()) > 4 ? 'bg-red-100 text-red-800' : parseFloat(getStorageSize()) > 2 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'} ml-2 px-2 py-1 rounded text-sm font-semibold">
                                        ${getStorageSize()} MB / ~5 MB
                                    </span>
                                </p>
                                ${parseFloat(getStorageSize()) > 3 ? `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded p-2 mt-2">
                                        <p class="text-xs text-yellow-800">
                                            ⚠️ 저장 공간이 부족합니다. 불필요한 데이터를 삭제하거나 파일로 백업하세요.
                                        </p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold mb-4">설정</h3>
                            <div class="space-y-3 text-sm">
                                <label class="flex items-center justify-between">
                                    <span>자동저장</span>
                                    <input type="checkbox" id="autoSaveToggle" ${state.settings.autoSave ? 'checked' : ''} class="w-5 h-5" />
                                </label>
                                <label class="flex items-center justify-between">
                                    <span>자동저장 간격 (초)</span>
                                    <input type="number" id="autoSaveInterval" value="${state.settings.autoSaveInterval}" class="w-24 px-3 py-1 border rounded" min="10" max="300" />
                                </label>
                                <label class="flex items-center justify-between">
                                    <span>최대 파일 크기 (MB)</span>
                                    <input type="number" id="maxFileSize" value="${state.settings.maxFileSize}" class="w-24 px-3 py-1 border rounded" min="10" max="500" />
                                </label>
                            </div>
                        </div>
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold mb-4 text-red-600">위험 구역</h3>
                            <div class="bg-red-50 border border-red-200 rounded p-4">
                                <p class="text-sm text-red-800 mb-3">
                                    ⚠️ 아래 작업은 되돌릴 수 없습니다. 신중하게 진행하세요.
                                </p>
                                <button id="clearAllBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-semibold">
                                    🗑️ 모든 데이터 초기화
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainTab() {
            const uniqueRegions = [...new Set(
                (state.data[state.selectedYear] || []).map(row => (row['행정구역'] || '').replace(/[\\\/]/g, '').trim()).filter(Boolean)
            )].sort();

            const uniqueMonths = [...new Set(
                (state.data[state.selectedYear] || []).map(row => {
                    const dateStr = row['기준일'];
                    if (!dateStr) return null;
                    const match = dateStr.match(/(\d{4})[-./](\d{1,2})[-./](\d{1,2})/);
                    return match ? parseInt(match[2]) : null;
                }).filter(m => m !== null)
            )].sort((a, b) => a - b);

            const totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);
            const paginatedData = state.filteredData.slice(
                (state.currentPage - 1) * state.itemsPerPage,
                state.currentPage * state.itemsPerPage
            );

            return `
                <div>
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <button id="uploadBtn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 cursor-pointer">
                                📤 업로드
                            </button>
                            <div class="relative">
                                <button id="downloadBtn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                    📥 다운로드
                                </button>
                                ${state.showDownloadMenu ? `
                                    <div class="absolute top-full mt-1 right-0 bg-white border rounded shadow-lg z-20 w-48">
                                        <button id="downloadExcelBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left">
                                            📊 Excel 다운로드
                                        </button>
                                        <button id="downloadCSVBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left border-t">
                                            📄 CSV 다운로드
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            <button id="sampleBtn" class="flex items-center gap-2 bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">
                                🎯 샘플 데이터
                            </button>
                            <button id="editToggleBtn" class="flex items-center gap-2 bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                                ✏️ ${state.isEditing ? '완료' : '편집'}
                            </button>
                            <button id="saveBtn" class="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                                💾 저장
                            </button>
                            <button id="copyBtn" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                                📋 신청
                            </button>
                            <button id="deleteBtn" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                                🗑️ 삭제
                            </button>
                            <button id="detailBtn" class="flex items-center gap-2 bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">
                                👁️ 상세보기/추가
                            </button>
                        </div>

                        ${state.uploadedFileName ? `
                            <div class="mb-4 px-3 py-2 bg-blue-50 border border-blue-200 rounded text-sm flex items-center justify-between">
                                <span>📂 <strong>${state.uploadedFileName}</strong> (${(state.data[state.selectedYear] || []).length}건)</span>
                                ${state.lastSaved ? `<span class="text-gray-600 text-xs">마지막 저장: ${state.lastSaved.toLocaleTimeString()}</span>` : ''}
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                            <div class="relative">
                                <label class="block text-xs font-semibold mb-1">행정구역</label>
                                <button id="regionDropdownBtn" class="w-full px-2 py-1 border rounded text-left text-xs bg-white hover:bg-gray-50">
                                    ${state.filters.region.length === 0 ? '선택...' : state.filters.region.join(', ')}
                                </button>
                                ${state.showRegionDropdown ? `
                                    <div class="absolute top-full left-0 right-0 border border-t-0 rounded-b bg-white z-50 max-h-24 overflow-y-auto text-xs">
                                        <div class="space-y-1 p-1">
                                            ${uniqueRegions.length === 0 ? `
                                                <div class="text-gray-400 text-xs py-2 px-1">데이터 없음</div>
                                            ` : `
                                                <label class="flex items-center cursor-pointer hover:bg-blue-50 px-1 py-0.5 rounded">
                                                    <input type="checkbox" id="selectAllRegions" ${state.filters.region.length === uniqueRegions.length && uniqueRegions.length > 0 ? 'checked' : ''} class="mr-1" />
                                                    <span class="text-xs font-semibold text-blue-700">전체</span>
                                                </label>
                                                ${uniqueRegions.map(region => `
                                                    <label class="flex items-center cursor-pointer hover:bg-gray-50 px-1 py-0.5 rounded region-checkbox">
                                                        <input type="checkbox" value="${region}" ${state.filters.region.includes(region) ? 'checked' : ''} class="mr-1" />
                                                        <span class="text-xs">${region}</span>
                                                    </label>
                                                `).join('')}
                                            `}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div class="relative">
                                <label class="block text-xs font-semibold mb-1">기준월</label>
                                <button id="monthDropdownBtn" class="w-full px-2 py-1 border rounded text-left text-xs bg-white hover:bg-gray-50">
                                    ${state.filters.month === '' ? '선택...' : state.filters.month + '월'}
                                </button>
                                ${state.showMonthDropdown ? `
                                    <div class="absolute top-full left-0 right-0 border border-t-0 rounded-b bg-white z-50 max-h-24 overflow-y-auto text-xs">
                                        <div class="space-y-1 p-1">
                                            ${uniqueMonths.length === 0 ? `
                                                <div class="text-gray-400 text-xs py-2 px-1">데이터 없음</div>
                                            ` : `
                                                <label class="flex items-center cursor-pointer hover:bg-blue-50 px-1 py-0.5 rounded">
                                                    <input type="radio" name="month" value="" ${state.filters.month === '' ? 'checked' : ''} class="mr-1" />
                                                    <span class="text-xs font-semibold text-blue-700">전체</span>
                                                </label>
                                                ${uniqueMonths.map(month => `
                                                    <label class="flex items-center cursor-pointer hover:bg-gray-50 px-1 py-0.5 rounded">
                                                        <input type="radio" name="month" value="${month}" ${state.filters.month === String(month) ? 'checked' : ''} class="mr-1" />
                                                        <span class="text-xs">${month}월</span>
                                                    </label>
                                                `).join('')}
                                            `}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div class="relative">
                                <label class="block text-xs font-semibold mb-1">검사이력</label>
                                <button id="inspectionDropdownBtn" class="w-full px-2 py-1 border rounded text-left text-xs bg-white hover:bg-gray-50">
                                    ${state.filters.inspectionHistory === '' ? '선택...' : (state.filters.inspectionHistory === 'Y' ? 'Y (있음)' : '공백 (없음)')}
                                </button>
                                ${state.showInspectionDropdown ? `
                                    <div class="absolute top-full left-0 right-0 border border-t-0 rounded-b bg-white z-50 text-xs">
                                        <div class="space-y-1 p-1">
                                            <label class="flex items-center cursor-pointer hover:bg-blue-50 px-1 py-0.5 rounded">
                                                <input type="radio" name="inspection" value="" ${state.filters.inspectionHistory === '' ? 'checked' : ''} class="mr-1" />
                                                <span class="text-xs font-semibold text-blue-700">전체</span>
                                            </label>
                                            <label class="flex items-center cursor-pointer hover:bg-gray-50 px-1 py-0.5 rounded">
                                                <input type="radio" name="inspection" value="Y" ${state.filters.inspectionHistory === 'Y' ? 'checked' : ''} class="mr-1" />
                                                <span class="text-xs">Y (있음)</span>
                                            </label>
                                            <label class="flex items-center cursor-pointer hover:bg-gray-50 px-1 py-0.5 rounded">
                                                <input type="radio" name="inspection" value="N" ${state.filters.inspectionHistory === 'N' ? 'checked' : ''} class="mr-1" />
                                                <span class="text-xs">공백 (없음)</span>
                                            </label>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div>
                                <label class="block text-xs font-semibold mb-1">검색</label>
                                <div class="flex gap-1">
                                    <div class="relative flex-1">
                                        <input type="text" id="searchInput" value="${state.searchTerm}" placeholder="검색..." class="w-full px-2 py-1 border rounded text-xs" />
                                        <span class="absolute right-2 top-1.5 text-gray-400 text-xs">🔍</span>
                                    </div>
                                    <button id="searchBtn" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold whitespace-nowrap text-xs">
                                        조회
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold mb-1">필터 초기화</label>
                                <button id="mainFilterResetBtn" class="w-full px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 font-semibold text-xs">
                                    🔄 초기화
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse" style="table-layout: fixed; min-width: 4500px;">
                                <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2 sticky left-0 bg-blue-600 z-20" style="width: 50px;">
                                            <input type="checkbox" id="selectAllRows" ${state.selectedRows.size === state.filteredData.length && state.filteredData.length > 0 ? 'checked' : ''} />
                                        </th>
                                        <th class="border px-2 py-2 sticky left-[50px] bg-blue-600 z-20" style="width: 60px;">No</th>
                                        ${columns.map(col => `
                                            <th class="border px-3 py-2 text-sm" style="width: ${columnWidths[col]};">
                                                <div class="truncate" title="${col}">${col}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paginatedData.map((row, idx) => {
                                        const actualIdx = (state.currentPage - 1) * state.itemsPerPage + idx;
                                        return `
                                            <tr class="${state.selectedRows.has(actualIdx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                                <td class="border px-2 py-2 text-center sticky left-0 bg-white z-10" style="width: 50px;">
                                                    <input type="checkbox" class="row-checkbox" data-idx="${actualIdx}" ${state.selectedRows.has(actualIdx) ? 'checked' : ''} />
                                                </td>
                                                <td class="border px-2 py-2 text-center sticky left-[50px] bg-white z-10" style="width: 60px;">${actualIdx + 1}</td>
                                                ${columns.map(col => `
                                                    <td class="border px-3 py-2 text-sm" style="width: ${columnWidths[col]}; max-width: ${columnWidths[col]};">
                                                        ${state.isEditing ? `
                                                            <input type="text" value="${row[col] || ''}" class="table-cell-input cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                        ` : `
                                                            <div class="truncate" title="${row[col] || '-'}">${row[col] || '-'}</div>
                                                        `}
                                                    </td>
                                                `).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${paginatedData.length === 0 ? `
                                        <tr>
                                            <td colspan="${columns.length + 2}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">📋</div>
                                                <div>데이터가 없습니다</div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>

                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                전체 ${state.filteredData.length}건
                                ${state.filteredData.length > 0 ? ` 중 ${((state.currentPage - 1) * state.itemsPerPage) + 1}-${Math.min(state.currentPage * state.itemsPerPage, state.filteredData.length)}건 표시` : ''}
                                ${state.selectedRows.size > 0 ? ` (${state.selectedRows.size}건 선택됨)` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="prevPageBtn" ${state.currentPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">◀</button>
                                <span class="px-4 py-2">${state.currentPage} / ${totalPages || 1}</span>
                                <button id="nextPageBtn" ${state.currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">▶</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderApplicationTab() {
    const mainData = Object.values(state.data).flat(); 
    const currentAppData = (state.applicationData[state.targetYear] || []).filter(row => row !== null && row !== undefined);
    currentAppData.forEach(appRow => {
     if (appRow && (!appRow['기준일'] || appRow['기준일'] === '')) {
    const mainRow = mainData.find(m => m && m['시설번호'] === appRow['시설번호']);
      if (mainRow && mainRow['기준일']) {
        appRow['기준일'] = mainRow['기준일'];
    }
}
});
            
           
    
            const uniqueAppRegions = [...new Set(
               currentAppData.map(row => row['행정구역']).filter(Boolean)
            )].sort();

             

    let filteredApplicationData = [...currentAppData];
            
            if (state.applicationFilters.region.length > 0) {
                filteredApplicationData = filteredApplicationData.filter(row => 
                    state.applicationFilters.region.includes(row['행정구역'])
                );
            }

            if (state.applicationFilters.inspector) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['검사원'] === state.applicationFilters.inspector
                );
            }

           if (state.applicationFilters.inspectionResult) {
                filteredApplicationData = filteredApplicationData.filter(row => {
                    if (state.applicationFilters.inspectionResult === '공란') {
                        return !row['검사결과'] || row['검사결과'].trim() === '';
                    }
                    return row['검사결과'] === state.applicationFilters.inspectionResult;
                });
            }

            if (state.applicationFilters.receiptLocation) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['접수처'] === state.applicationFilters.receiptLocation
                );
            }

            if (state.applicationFilters.applicationDateFrom) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['신청일'] >= state.applicationFilters.applicationDateFrom
                );
            }

            if (state.applicationFilters.applicationDateTo) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['신청일'] <= state.applicationFilters.applicationDateTo
                );
            }

            if (state.applicationFilters.inspectionDateFrom) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['검사일'] >= state.applicationFilters.inspectionDateFrom
                );
            }

            if (state.applicationFilters.inspectionDateTo) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    row['검사일'] <= state.applicationFilters.inspectionDateTo
                );
            }
        
           if (state.applicationFilters.baseMonth) {
    const targetMonth = parseInt(state.applicationFilters.baseMonth);
    filteredApplicationData = filteredApplicationData.filter(row => {
        const dateStr = String(row['기준일'] || '').trim();
        if (!dateStr) return false;

        let match = dateStr.match(/(\d{4})[^\d](\d{1,2})[^\d](\d{1,2})/);
        if (match) {
            const month = parseInt(match[2]);
            return month === targetMonth;
        }

        const onlyNumbers = dateStr.replace(/\D/g, '');
        if (onlyNumbers.length >= 6) {
            const dateMatch = onlyNumbers.match(/(\d{4})(\d{1,2})(\d{1,2})/);
            if (dateMatch) {
                const month = parseInt(dateMatch[2]);
                if (month >= 1 && month <= 12 && month === targetMonth) {
                    return true;
                }
            }
        }

        return false;
    });
}

            if (state.applicationFilters.fee) {
                filteredApplicationData = filteredApplicationData.filter(row =>
                    String(row['수수료']).includes(state.applicationFilters.fee)
                );
            }

            if (state.applicationSearchTerm) {  
    filteredApplicationData = filteredApplicationData.filter(row =>
        Object.values(row).some(val =>
            String(val).toLowerCase().includes(state.applicationSearchTerm.toLowerCase())
        )
    );
}

           if (state.applicationSearchTerm) {  
                filteredApplicationData = filteredApplicationData.filter(row =>
                    Object.values(row).some(val =>
                        String(val).toLowerCase().includes(state.applicationSearchTerm.toLowerCase())
                    )
                );
            }

            const totalAppPages = Math.ceil(filteredApplicationData.length / state.itemsPerPage);
            
            const paginatedAppData = filteredApplicationData.slice(
                (state.currentApplicationPage - 1) * state.itemsPerPage,
                state.currentApplicationPage * state.itemsPerPage
            );

            return `
                <div>
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">해당년도</label>
                                    <select id="targetYearSelect" class="px-3 py-2 border rounded">
                                        ${state.yearRange.map(year => `<option value="${year}" ${year === state.targetYear ? 'selected' : ''}>${year}년</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">검사예정년도</label>
                                    <select id="inspectionYearSelect" class="px-3 py-2 border rounded">
                                        ${state.yearRange.map(year => `<option value="${year}" ${year === state.inspectionYear ? 'selected' : ''}>${year}년</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        ${state.targetYear !== state.inspectionYear ? `
                            <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4">
                                <p class="text-sm text-yellow-800 flex items-center gap-2">
                                    <span class="text-lg">⚠️</span>
                                    <span>
                                        <strong>필증번호 형식:</strong> 해당년도와 검사예정년도가 다릅니다. 
                                        필증번호는 <strong class="text-yellow-900">KGT${String(state.inspectionYear).slice(2)}0101-001</strong> 형식으로 생성됩니다.
                                        <br/>
                                        💡 <strong>팁:</strong> 잘라내기 버튼으로 데이터를 ${state.inspectionYear}년도로 이동시킬 수 있습니다.
                                    </span>
                                </p>
                            </div>
                        ` : ''}
                        
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <button id="appUploadBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">📤 업로드</button>
                            <button id="appAddRowBtn" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">행 추가</button>
                            <button id="appDeleteRowBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">🗑️ 삭제</button>
                            <button id="appEditToggleBtn" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">${state.isEditingApplication ? '편집완료' : '편집'}</button>
                            <button id="appSaveBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">저장</button>
                            <button id="appDownloadBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">다운로드</button>
                            <button id="appCertBtn" class="px-4 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700">✨ 필증번호 재생성</button>
                            <button id="appMapBtn" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">🗺️ MAP</button>
                            <button id="cutBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">📅 내년으로on>
                            <button id="cancelBtn" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">취소</button>
                            <button id="appDetailBtn" class="px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700">👁️ 상세보기/추가</button>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <!-- 행정구역 필터 -->
                            <div>
                                <label class="block text-sm font-semibold mb-2">행정구역</label>
                                <div class="space-y-2 max-h-32 overflow-y-auto border rounded p-2 bg-white">
                                    ${uniqueAppRegions.length === 0 ? `
                                        <div class="text-xs text-gray-400">데이터 없음</div>
                                    ` : `
                                        <label class="flex items-center cursor-pointer text-sm">
                                            <input type="checkbox" id="selectAllAppRegions" ${state.applicationFilters.region.length === uniqueAppRegions.length && uniqueAppRegions.length > 0 ? 'checked' : ''} class="mr-2" />
                                            <span class="font-semibold text-blue-700">전체</span>
                                        </label>
                                        ${uniqueAppRegions.map(region => `
                                            <label class="flex items-center cursor-pointer text-sm app-region-checkbox">
                                                <input type="checkbox" value="${region}" ${state.applicationFilters.region.includes(region) ? 'checked' : ''} class="mr-2" />
                                                <span>${region}</span>
                                            </label>
                                        `).join('')}
                                    `}
                                </div>
                            </div>

                            <!-- 검사원 필터 -->
                            <div>
                                <label class="block text-sm font-semibold mb-2">검사원</label>
                                <select id="appInspectorFilter" class="w-full px-3 py-2 border rounded text-sm">
                                    <option value="">선택</option>
                                    ${state.inspectors.map(i => `<option value="${i}" ${i === state.applicationFilters.inspector ? 'selected' : ''}>${i}</option>`).join('')}
                                </select>
                            </div>

                            <!-- 검사결과 필터 -->
                            <div>
                                <label class="block text-sm font-semibold mb-2">검사결과</label>
                                <select id="appResultFilter" class="w-full px-3 py-2 border rounded text-sm">
                                    <option value="">선택</option>
                                    ${state.inspectionResults.map(r => `<option value="${r}" ${r === state.applicationFilters.inspectionResult ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                            </div>

                            <!-- 접수처 필터 -->
                            <div>
                                <label class="block text-sm font-semibold mb-2">접수처</label>
                                <select id="appReceiptFilter" class="w-full px-3 py-2 border rounded text-sm">
                                    <option value="">선택</option>
                                    ${state.receiptLocations.map(l => `<option value="${l}" ${l === state.applicationFilters.receiptLocation ? 'selected' : ''}>${l}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <!-- 신청일 필터 -->
                            <div>
                                <label class="block text-sm font-semibold mb-2">신청일</label>
                                <div class="flex gap-2">
                                    <input type="date" id="appDateFromFilter" value="${state.applicationFilters.applicationDateFrom}" class="flex-1 px-3 py-2 border rounded text-sm" />
                                    <input type="date" id="appDateToFilter" value="${state.applicationFilters.applicationDateTo}" class="flex-1 px-3 py-2 border rounded text-sm" />
                                </div>
                            </div>

                            <!-- 검사일 필터 -->
                            <div>
                                <label class="block text-sm font-semibold mb-2">검사일</label>
                                <div class="flex gap-2">
                                    <input type="date" id="appInspectionDateFromFilter" value="${state.applicationFilters.inspectionDateFrom}" class="flex-1 px-3 py-2 border rounded text-sm" />
                                    <input type="date" id="appInspectionDateToFilter" value="${state.applicationFilters.inspectionDateTo}" class="flex-1 px-3 py-2 border rounded text-sm" />
                                </div>
                            </div>

                         <!-- 기준월 필터 -->
                           <div>
                              <label class="block text-sm font-semibold mb-2">기준월</label>
                              <select id="appBaseMonthFilter" class="w-full px-3 py-2 border rounded text-sm">
                                  <option value="">선택</option>
                                  ${Array.from({length: 12}, (_, i) => i + 1).map(m => `<option value="${m}" ${String(m) === state.applicationFilters.baseMonth ? 'selected' : ''}>${m}월</option>`).join('')}
                              </select>
                         </div>  

                        <!-- 수수료 필터 -->
                        <div>
                            <label class="block text-sm font-semibold mb-2">수수료</label>
                            <input type="text" id="appFeeFilter" value="${state.applicationFilters.fee}" placeholder="수수료 입력" class="w-full px-3 py-2 border rounded text-sm" />
                        </div>
                        </div>

                        <div class="flex gap-2 items-end">
                            <div class="flex-1">
                                <label class="block text-sm font-semibold mb-2">검색</label>
                                <input type="text" id="appSearchInput" value="${state.applicationSearchTerm}" placeholder="검색어 입력..." class="w-full px-3 py-2 border rounded text-sm" />
                            </div>
                            <button id="appSearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">🔍 검색</button>
                            <button id="appFilterResetBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">🔄 필터 초기화</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse text-sm" style="table-layout: fixed; min-width: 2600px;">
                                <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2" style="width: 50px;">
                                            <input type="checkbox" id="selectAllAppRows"
                                      ${state.selectedApplicationRows.size === filteredApplicationData.length && filteredApplicationData.length > 0 ? 'checked' : ''} />
                                        </th>
                                        <th class="border px-2 py-2" style="width: 60px;">No</th>
                                        ${applicationColumns.map(col => `
                                            <th class="border px-2 py-2" style="width: ${columnWidths[col]};">
                                                <div class="truncate" title="${col}">${col}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paginatedAppData.map((row, idx) => {
                                        const actualIdx = (state.currentApplicationPage - 1) * state.itemsPerPage + idx;
                                        return `
                                            <tr class="${state.selectedApplicationRows.has(actualIdx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                                <td class="border px-2 py-1 text-center" style="width: 50px;">
                                                    <input type="checkbox" class="app-row-checkbox" data-idx="${actualIdx}" ${state.selectedApplicationRows.has(actualIdx) ? 'checked' : ''} />
                                                </td>
                                                <td class="border px-2 py-1 text-center" style="width: 60px;">${actualIdx + 1}</td>
                                                ${applicationColumns.map(col => `
                                                    <td class="border px-2 py-1 text-sm" style="width: ${columnWidths[col]};">
                                                        ${state.isEditingApplication ? `
                                                            ${col.includes('일') && col !== '메모' && col !== '메모2' ? `
                                                                <input type="date" value="${row[col] || ''}" class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                            ` : col === '검사원' ? `
                                                                <select class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${state.inspectors.map(i => `<option value="${i}" ${i === row[col] ? 'selected' : ''}>${i}</option>`).join('')}
                                                                </select>
                                                            ` : col === '검사결과' ? `
                                                                <select class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${state.inspectionResults.map(r => `<option value="${r}" ${r === row[col] ? 'selected' : ''}>${r}</option>`).join('')}
                                                                </select>
                                                            ` : col === '접수처' ? `
                                                                <select class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${state.receiptLocations.map(l => `<option value="${l}" ${l === row[col] ? 'selected' : ''}>${l}</option>`).join('')}
                                                                </select>
                                                            ` : col === '수수료' ? `
                                                                <input type="text" value="${row[col] || ''}" class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}" style="text-align: right;" />
                                                            ` : `
                                                                <input type="text" value="${row[col] || ''}" class="table-cell-input app-cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                            `}
                                                        ` : `
                                                            <div class="truncate ${col === '수수료' ? 'text-right' : ''}" title="${row[col] || '-'}">${col === '수수료' ? (formatCurrency(row[col]) || '-') : (row[col] || '-')}</div>
                                                        `}
                                                    </td>
                                                `).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${paginatedAppData.length === 0 ? `
                                        <tr>
                                            <td colspan="${applicationColumns.length + 2}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">📋</div>
                                                <div>데이터가 없습니다</div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                전체 ${filteredApplicationData.length}건
                                ${filteredApplicationData.length > 0 ? ` 중 ${((state.currentApplicationPage - 1) * state.itemsPerPage) + 1}-${Math.min(state.currentApplicationPage * state.itemsPerPage, filteredApplicationData.length)}건 표시` : ''}
                                ${state.selectedApplicationRows.size > 0 ? ` (${state.selectedApplicationRows.size}건 선택됨)` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="appPrevPageBtn" ${state.currentApplicationPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">◀</button>
                                <span class="px-4 py-2">${state.currentApplicationPage} / ${totalAppPages || 1}</span>
                                <button id="appNextPageBtn" ${state.currentApplicationPage === totalAppPages || totalAppPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">▶</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuarterTab() {
    const quarterColumns = ['시설번호', '시설명', '행정구역', '새주소', '기준일', '검사일', '필증번호'];
    
    // 신청접수대장에서 검사결과="합격"인 데이터만 가져오기
    const applicationData = state.applicationData[state.targetYear] || [];
    const passedData = applicationData.filter(row => row['검사결과'] === '합격');
// 통합 탭에서 기준일 병합
     const mainData = state.data[state.targetYear] || [];
    const passedDataWithBaseDate = passedData.map(appRow => {
        const mainRow = mainData.find(m => m['시설번호'] === appRow['시설번호']);
        return {
            ...appRow,
            '기준일': appRow['기준일'] || (mainRow ? mainRow['기준일'] : '')
        };
    });
    
    // 선택된 분기와 수신처에 따라 필터링
     let filteredData = [...passedDataWithBaseDate];
    
    if (state.quarter.selectedRecipient) {
        const allowedRegions = state.quarter.recipients[state.quarter.selectedRecipient] || [];
        filteredData = filteredData.filter(row => 
            allowedRegions.some(region => row['행정구역']?.includes(region.replace('부산 ', '').replace('울산 ', '').replace('경남 ', '').replace('경북 ', '')))
        );
    }
    // 선택된 분기에 따라 검사일에서 필터링
    if (state.quarter.selectedQuarter) {
        const monthRanges = {
            'Q1': [1, 2, 3],
            'Q2': [4, 5, 6],
            'Q3': [7, 8, 9],
            'Q4': [10, 11, 12]
        };
        const months = monthRanges[state.quarter.selectedQuarter] || [];
        
        filteredData = filteredData.filter(row => {
            const inspectionDate = row['검사일'];
            if (!inspectionDate) return false;
            
            const match = inspectionDate.match(/(\d{4})[-./](\d{1,2})[-./](\d{1,2})/);
            if (match) {
                const month = parseInt(match[2]);
                return months.includes(month);
            }
            return false;
        });
    }
    // 행정구역으로 정렬
    filteredData.sort((a, b) => (a['행정구역'] || '').localeCompare(b['행정구역'] || ''));
    
    return `
        <div>
            <div class="bg-white rounded-lg p-6 mb-4 shadow">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <!-- 분기 선택 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">분기 선택</label>
                        <select id="quarterSelect" class="w-full px-4 py-2 border rounded">
                            <option value="">전체</option>
                            <option value="Q1" ${state.quarter.selectedQuarter === 'Q1' ? 'selected' : ''}>1분기</option>
                            <option value="Q2" ${state.quarter.selectedQuarter === 'Q2' ? 'selected' : ''}>2분기</option>
                            <option value="Q3" ${state.quarter.selectedQuarter === 'Q3' ? 'selected' : ''}>3분기</option>
                            <option value="Q4" ${state.quarter.selectedQuarter === 'Q4' ? 'selected' : ''}>4분기</option>
                        </select>
                    </div>

                    <!-- 수신처 선택 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">수신처 선택</label>
                        <select id="recipientSelect" class="w-full px-4 py-2 border rounded">
                            <option value="">-- 선택 --</option>
                            ${Object.keys(state.quarter.recipients).map(recipient => 
                                `<option value="${recipient}" ${state.quarter.selectedRecipient === recipient ? 'selected' : ''}>${recipient}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <!-- 정보 표시 -->
                    <div class="flex items-end">
                        <div class="text-sm">
                            <p class="text-gray-600">필터된 데이터: <strong>${filteredData.length}건</strong></p>
                            <p class="text-gray-500 text-xs">검사결과 "합격"만 표시</p>
                        </div>
                    </div>
                </div>

                <!-- 버튼 -->
                <div class="flex gap-2 flex-wrap">
                    <button id="quarterExcelBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-2">
                        📊 Excel 내보내기
                    </button>
                    <button id="quarterCSVBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2">
                        📄 CSV 내보내기
                    </button>
                    <button id="quarterLoadBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2">
                     📂 불러오기
                    </button>
                </div>
            </div>

            <!-- 데이터 테이블 -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm" style="table-layout: fixed;">
                        <thead class="bg-blue-600 text-white sticky top-0 z-10">
                            <tr>
                                <th class="border px-3 py-2" style="width: 60px;">No</th>
                                ${quarterColumns.map(col => `
                                    <th class="border px-3 py-2" style="width: 140px;">
                                        <div class="truncate">${col}</div>
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredData.length === 0 ? `
                                <tr>
                                    <td colspan="${quarterColumns.length + 1}" class="text-center py-8 text-gray-500">
                                        <div class="text-4xl mb-2">📋</div>
                                        <div>해당하는 데이터가 없습니다</div>
                                    </td>
                                </tr>
                            ` : filteredData.map((row, idx) => `
                                <tr class="hover:bg-gray-50">
                                    <td class="border px-3 py-2 text-center bg-gray-50">${idx + 1}</td>
                                    ${quarterColumns.map(col => `
                                        <td class="border px-3 py-2">
                                            <div class="truncate" title="${row[col] || '-'}">${row[col] || '-'}</div>
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

        function renderQuarterDataTab() {
            const currentQuarterData = state.quarterData[state.selectedYear] || [];
            const totalQuarterDataPages = Math.ceil(currentQuarterData.length / state.itemsPerPage);
            const paginatedQuarterData = currentQuarterData.slice(
                (state.currentQuarterPage - 1) * state.itemsPerPage,
                state.currentQuarterPage * state.itemsPerPage
            );

            const quarterSummary = {
                Q1: currentQuarterData.filter(row => row['분기'] === 'Q1').length,
                Q2: currentQuarterData.filter(row => row['분기'] === 'Q2').length,
                Q3: currentQuarterData.filter(row => row['분기'] === 'Q3').length,
                Q4: currentQuarterData.filter(row => row['분기'] === 'Q4').length
            };

            return `
                <div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-white p-4 rounded-lg shadow text-center">
                            <div class="text-3xl font-bold text-blue-600">${quarterSummary.Q1}</div>
                            <div class="text-sm text-gray-600 mt-2">1분기 (Q1)</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow text-center">
                            <div class="text-3xl font-bold text-green-600">${quarterSummary.Q2}</div>
                            <div class="text-sm text-gray-600 mt-2">2분기 (Q2)</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow text-center">
                            <div class="text-3xl font-bold text-yellow-600">${quarterSummary.Q3}</div>
                            <div class="text-sm text-gray-600 mt-2">3분기 (Q3)</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow text-center">
                            <div class="text-3xl font-bold text-red-600">${quarterSummary.Q4}</div>
                            <div class="text-sm text-gray-600 mt-2">4분기 (Q4)</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse text-sm" style="table-layout: fixed; min-width: 1200px;">
                                <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2" style="width: 60px;">No</th>
                                        ${quarterColumns.map(col => `
                                            <th class="border px-2 py-2 text-sm" style="width: 140px;">
                                                <div class="truncate" title="${col}">${col}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paginatedQuarterData.map((row, idx) => {
                                        const actualIdx = (state.currentQuarterPage - 1) * state.itemsPerPage + idx;
                                        return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="border px-2 py-1 text-center" style="width: 60px;">${actualIdx + 1}</td>
                                                ${quarterColumns.map(col => `
                                                    <td class="border px-2 py-1 text-sm" style="width: 140px;">
                                                        <div class="truncate" title="${row[col] || '-'}">${row[col] || '-'}</div>
                                                    </td>
                                                `).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${paginatedQuarterData.length === 0 ? `
                                        <tr>
                                            <td colspan="${quarterColumns.length + 1}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">📈</div>
                                                <div>데이터가 없습니다</div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>

                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                전체 ${currentQuarterData.length}건
                                ${currentQuarterData.length > 0 ? ` 중 ${((state.currentQuarterPage - 1) * state.itemsPerPage) + 1}-${Math.min(state.currentQuarterPage * state.itemsPerPage, currentQuarterData.length)}건 표시` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="quarterDataPrevPageBtn" ${state.currentQuarterPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">◀</button>
                                <span class="px-4 py-2">${state.currentQuarterPage} / ${totalQuarterDataPages || 1}</span>
                                <button id="quarterDataNextPageBtn" ${state.currentQuarterPage === totalQuarterDataPages || totalQuarterDataPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">▶</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    
       function renderSalesAnalysisTab() {
            const currentAppData = state.applicationData[state.targetYear] || [];
            
            // 기준일 기반 월별 분석 (월만 추출)
            const baseMonthAnalysis = {};
            currentAppData.forEach(row => {
                const baseDate = row['기준일'];
                const fee = parseInt(String(row['수수료'] || '0').replace(/,/g, '')) || 0;
                const region = row['행정구역'] || '미분류';
                
                if (baseDate) {
                    const match = baseDate.match(/(\d{4})[-./](\d{1,2})[-./](\d{1,2})/);
                    if (match) {
                        const month = parseInt(match[2]);
                        
                        if (!baseMonthAnalysis[month]) {
                            baseMonthAnalysis[month] = {};
                        }
                        if (!baseMonthAnalysis[month][region]) {
                            baseMonthAnalysis[month][region] = { count: 0, total: 0 };
                        }
                        baseMonthAnalysis[month][region].count += 1;
                        baseMonthAnalysis[month][region].total += fee;
                    }
                }
            });

            // 신청일 기반 월별 분석 (월만 추출)
            const appMonthAnalysis = {};
            currentAppData.forEach(row => {
                const appDate = row['신청일'];
                const fee = parseInt(String(row['수수료'] || '0').replace(/,/g, '')) || 0;
                const region = row['행정구역'] || '미분류';
                
                if (appDate) {
                    const match = appDate.match(/(\d{4})[-./](\d{1,2})[-./](\d{1,2})/);
                    if (match) {
                        const month = parseInt(match[2]);
                        
                        if (!appMonthAnalysis[month]) {
                            appMonthAnalysis[month] = {};
                        }
                        if (!appMonthAnalysis[month][region]) {
                            appMonthAnalysis[month][region] = { count: 0, total: 0 };
                        }
                        appMonthAnalysis[month][region].count += 1;
                        appMonthAnalysis[month][region].total += fee;
                    }
                }
            });

            // 모든 지역 추출 및 정렬
            const allRegions = [...new Set(
                currentAppData.map(row => row['행정구역'] || '미분류')
            )].sort();

            // 1월~12월 배열
            const months = Array.from({ length: 12 }, (_, i) => i + 1);

            return `
                <div>
                    <!-- 해당년도 표시 -->
                    <div class="bg-blue-100 border border-blue-300 rounded-lg p-4 mb-4">
                        <p class="text-lg font-bold text-blue-800">📊 해당년도: <span class="text-2xl text-blue-600">${state.targetYear}년</span></p>
                    </div>

                    <!-- 새로고침 버튼 -->
                    <div class="flex gap-2 mb-4">
                        <button id="salesRefreshBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold flex items-center gap-2">
                            🔄 새로고침
                        </button>
                    </div>

                    <!-- 기준일 기반 월별 분석 -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📅 기준일 기반 월별 분석</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse text-sm">
                                <thead class="bg-green-600 text-white">
                                    <tr>
                                        <th class="border px-3 py-2 text-left font-semibold" style="width: 100px;">행정구역</th>
                                        ${months.map(month => `
                                            <th class="border px-2 py-2 text-center font-semibold" colspan="2">${month}월</th>
                                        `).join('')}
                                        <th class="border px-3 py-2 text-center font-semibold bg-green-700">합계<br/>(건)</th>
                                        <th class="border px-3 py-2 text-center font-semibold bg-green-700">합계<br/>(금액)</th>
                                    </tr>
                                    <tr class="bg-green-700 text-white">
                                        <th class="border px-3 py-2 text-left text-xs font-semibold"></th>
                                        ${months.map(month => `
                                            <th class="border px-1 py-1 text-center text-xs font-semibold" style="width: 35px;">건</th>
                                            <th class="border px-1 py-1 text-center text-xs font-semibold" style="width: 50px;">금액</th>
                                        `).join('')}
                                        <th class="border px-1 py-1"></th>
                                        <th class="border px-1 py-1"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allRegions.length === 0 ? `
                                        <tr>
                                            <td colspan="${12 * 2 + 2}" class="text-center py-8 text-gray-500">
                                                데이터가 없습니다
                                            </td>
                                        </tr>
                                    ` : allRegions.map((region, idx) => {
                                        let regionTotalCount = 0;
                                        let regionTotalFee = 0;

                                        months.forEach(month => {
                                            if (baseMonthAnalysis[month] && baseMonthAnalysis[month][region]) {
                                                regionTotalCount += baseMonthAnalysis[month][region].count;
                                                regionTotalFee += baseMonthAnalysis[month][region].total;
                                            }
                                        });

                                        return `
                                            <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-green-50">
                                                <td class="border px-3 py-2 font-semibold text-gray-800">${region}</td>
                                                ${months.map(month => `
                                                    <td class="border px-1 py-2 text-center text-gray-700 text-xs">${baseMonthAnalysis[month]?.[region]?.count || 0}</td>
                                                    <td class="border px-1 py-2 text-right text-gray-700 text-xs">${(baseMonthAnalysis[month]?.[region]?.total || 0).toLocaleString()}</td>
                                                `).join('')}
                                                <td class="border px-3 py-2 text-center font-bold bg-green-100 text-green-800">${regionTotalCount}</td>
                                                <td class="border px-3 py-2 text-right font-bold bg-green-100 text-green-800">${regionTotalFee.toLocaleString()}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr class="bg-green-600 text-white font-bold">
                                        <td class="border px-3 py-2">월별 합계</td>
                                        ${months.map(month => {
                                            let monthTotalCount = 0;
                                            let monthTotalFee = 0;
                                            allRegions.forEach(region => {
                                                if (baseMonthAnalysis[month] && baseMonthAnalysis[month][region]) {
                                                    monthTotalCount += baseMonthAnalysis[month][region].count;
                                                    monthTotalFee += baseMonthAnalysis[month][region].total;
                                                }
                                            });
                                            return `
                                                <td class="border px-1 py-2 text-center text-sm">${monthTotalCount}</td>
                                                <td class="border px-1 py-2 text-right text-sm">${monthTotalFee.toLocaleString()}</td>
                                            `;
                                        }).join('')}
                                        <td class="border px-3 py-2 text-center">${allRegions.reduce((sum, region) => sum + Object.values(baseMonthAnalysis).reduce((s, m) => s + (m[region]?.count || 0), 0), 0)}</td>
                                        <td class="border px-3 py-2 text-right">${Object.values(baseMonthAnalysis).reduce((sum, monthData) => sum + Object.values(monthData).reduce((s, r) => s + (r?.total || 0), 0), 0).toLocaleString()}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 신청일 기반 월별 분석 -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📝 신청일 기반 월별 분석</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse text-sm">
                                <thead class="bg-orange-600 text-white">
                                    <tr>
                                        <th class="border px-3 py-2 text-left font-semibold" style="width: 100px;">행정구역</th>
                                        ${months.map(month => `
                                            <th class="border px-2 py-2 text-center font-semibold" colspan="2">${month}월</th>
                                        `).join('')}
                                        <th class="border px-3 py-2 text-center font-semibold bg-orange-700">합계<br/>(건)</th>
                                        <th class="border px-3 py-2 text-center font-semibold bg-orange-700">합계<br/>(금액)</th>
                                    </tr>
                                    <tr class="bg-orange-700 text-white">
                                        <th class="border px-3 py-2 text-left text-xs font-semibold"></th>
                                        ${months.map(month => `
                                            <th class="border px-1 py-1 text-center text-xs font-semibold" style="width: 35px;">건</th>
                                            <th class="border px-1 py-1 text-center text-xs font-semibold" style="width: 50px;">금액</th>
                                        `).join('')}
                                        <th class="border px-1 py-1"></th>
                                        <th class="border px-1 py-1"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allRegions.length === 0 ? `
                                        <tr>
                                            <td colspan="${12 * 2 + 2}" class="text-center py-8 text-gray-500">
                                                데이터가 없습니다
                                            </td>
                                        </tr>
                                    ` : allRegions.map((region, idx) => {
                                        let regionTotalCount = 0;
                                        let regionTotalFee = 0;

                                        months.forEach(month => {
                                            if (appMonthAnalysis[month] && appMonthAnalysis[month][region]) {
                                                regionTotalCount += appMonthAnalysis[month][region].count;
                                                regionTotalFee += appMonthAnalysis[month][region].total;
                                            }
                                        });

                                        return `
                                            <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-orange-50">
                                                <td class="border px-3 py-2 font-semibold text-gray-800">${region}</td>
                                                ${months.map(month => `
                                                    <td class="border px-1 py-2 text-center text-gray-700 text-xs">${appMonthAnalysis[month]?.[region]?.count || 0}</td>
                                                    <td class="border px-1 py-2 text-right text-gray-700 text-xs">${(appMonthAnalysis[month]?.[region]?.total || 0).toLocaleString()}</td>
                                                `).join('')}
                                                <td class="border px-3 py-2 text-center font-bold bg-orange-100 text-orange-800">${regionTotalCount}</td>
                                                <td class="border px-3 py-2 text-right font-bold bg-orange-100 text-orange-800">${regionTotalFee.toLocaleString()}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr class="bg-orange-600 text-white font-bold">
                                        <td class="border px-3 py-2">월별 합계</td>
                                        ${months.map(month => {
                                            let monthTotalCount = 0;
                                            let monthTotalFee = 0;
                                            allRegions.forEach(region => {
                                                if (appMonthAnalysis[month] && appMonthAnalysis[month][region]) {
                                                    monthTotalCount += appMonthAnalysis[month][region].count;
                                                    monthTotalFee += appMonthAnalysis[month][region].total;
                                                }
                                            });
                                            return `
                                                <td class="border px-1 py-2 text-center text-sm">${monthTotalCount}</td>
                                                <td class="border px-1 py-2 text-right text-sm">${monthTotalFee.toLocaleString()}</td>
                                            `;
                                        }).join('')}
                                        <td class="border px-3 py-2 text-center">${allRegions.reduce((sum, region) => sum + Object.values(appMonthAnalysis).reduce((s, m) => s + (m[region]?.count || 0), 0), 0)}</td>
                                        <td class="border px-3 py-2 text-right">${Object.values(appMonthAnalysis).reduce((sum, monthData) => sum + Object.values(monthData).reduce((s, r) => s + (r?.total || 0), 0), 0).toLocaleString()}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCancellationTab() {
            const currentCancelData = state.cancellationData[state.targetYear] || [];

            return `
                <div>
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <button id="cancelEditToggleBtn" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">${state.isEditingCancellation ? '편집완료' : '편집'}</button>
                            <button id="cancelSaveBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">저장</button>
                            <button id="cancelDeleteRowBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">행 삭제</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse text-sm" style="table-layout: fixed; min-width: 1000px;">
                               <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2" style="width: 50px;">
                                            <input type="checkbox" id="selectAllCancelRows" ${state.selectedCancellationRows.size === currentCancelData.length && currentCancelData.length > 0 ? 'checked' : ''} />
                                        </th>
                                        <th class="border px-2 py-2" style="width: 60px;">No</th>
                                        ${cancellationColumns.map(col => `
                                            <th class="border px-2 py-2 text-sm" style="width: ${columnWidths[col]};">
                                                <div class="truncate" title="${col}">${col}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${currentCancelData.length === 0 ? `
                                        <tr>
                                            <td colspan="${cancellationColumns.length + 1}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">📋</div>
                                                <div>데이터가 없습니다</div>
                                            </td>
                                        </tr>
` : currentCancelData.map((row, idx) => `
                                        <tr class="${state.selectedCancellationRows.has(idx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                            <td class="border px-2 py-1 text-center" style="width: 50px;">
                                                <input type="checkbox" class="cancel-row-checkbox" data-idx="${idx}" ${state.selectedCancellationRows.has(idx) ? 'checked' : ''} />
                                            </td>
                                            <td class="border px-2 py-1 text-center" style="width: 60px;">${idx + 1}</td>
                                            ${cancellationColumns.map(col => `
                                                <td class="border px-2 py-1 text-sm" style="width: ${columnWidths[col]};">
                                                    ${state.isEditingCancellation ? `
                                                        ${col.includes('일') ? `
                                                            <input type="date" value="${row[col] || ''}" class="table-cell-input cancel-cell-edit" data-idx="${idx}" data-col="${col}" />
                                                        ` : col === '취소사유' ? `
                                                            <select class="table-cell-input cancel-cell-edit" data-idx="${idx}" data-col="${col}">
                                                                <option value="">선택</option>
                                                                ${state.cancelReasons.map(reason => `<option value="${reason}" ${reason === row[col] ? 'selected' : ''}>${reason}</option>`).join('')}
                                                            </select>
                                                        ` : `
                                                            <input type="text" value="${row[col] || ''}" class="table-cell-input cancel-cell-edit" data-idx="${idx}" data-col="${col}" />
                                                        `}
                                                    ` : `
                                                        <div class="truncate" title="${row[col] || '-'}">${row[col] || '-'}</div>
                                                    `}
                                                </td>
                                            `).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderResourceTab() {
            const resources = state.resourceData[state.selectedYear] || [];

            return `
                <div>
                    <!-- 해당년도 표시 -->
                    <div class="bg-blue-100 border border-blue-300 rounded-lg p-4 mb-4">
                        <p class="text-lg font-bold text-blue-800">📚 자료실: <span class="text-2xl text-blue-600">${state.selectedYear}년</span></p>
                    </div>

                    <!-- 상단 버튼 -->
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <button id="resourceFileUploadBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold flex items-center gap-2">
                                📁 파일 업로드
                            </button>
                            <button id="resourceFolderUploadBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold flex items-center gap-2">
                                📂 폴더 업로드
                            </button>
                            <button id="resourceCreateFolderBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 font-semibold flex items-center gap-2">
                                ➕ 폴더 생성
                            </button>
                            <button id="resourceDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold flex items-center gap-2">
                                🗑️ 선택 삭제
                            </button>
                        </div>

                        <div class="text-sm text-gray-600">
                            총 <strong>${resources.length}개</strong>의 항목
                        </div>
                    </div>

                    <!-- 자료실 목록 -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse text-sm">
                                <thead class="bg-blue-600 text-white">
                                    <tr>
                                        <th class="border px-3 py-3" style="width: 50px;">
                                            <input type="checkbox" id="selectAllResources" ${state.resourceData['selectedAll_' + state.selectedYear] ? 'checked' : ''} />
                                        </th>
                                        <th class="border px-3 py-3 text-left" style="width: 60px;">No</th>
                                        <th class="border px-3 py-3 text-left">파일명</th>
                                        <th class="border px-3 py-3 text-left" style="width: 120px;">유형</th>
                                        <th class="border px-3 py-3 text-left" style="width: 150px;">크기</th>
                                        <th class="border px-3 py-3 text-left" style="width: 180px;">업로드 날짜</th>
                                        <th class="border px-3 py-3 text-center" style="width: 100px;">다운로드</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${resources.length === 0 ? `
                                        <tr>
                                            <td colspan="7" class="text-center py-12 text-gray-500">
                                                <div class="text-5xl mb-3">📭</div>
                                                <div class="text-lg">자료가 없습니다</div>
                                                <div class="text-sm text-gray-400 mt-2">파일이나 폴더를 업로드해주세요</div>
                                            </td>
                                        </tr>
                                    ` : resources.map((resource, idx) => `
                                        <tr class="${state.resourceData['selected_' + state.selectedYear + '_' + idx] ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                            <td class="border px-3 py-3 text-center">
                                                <input type="checkbox" class="resource-checkbox" data-idx="${idx}" ${state.resourceData['selected_' + state.selectedYear + '_' + idx] ? 'checked' : ''} />
                                            </td>
                                            <td class="border px-3 py-3 text-center text-gray-600">${idx + 1}</td>
                                            <td class="border px-3 py-3">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-lg">
                                                        ${resource.type === 'folder' ? '📂' : resource.type === 'excel' ? '📊' : resource.type === 'csv' ? '📄' : resource.type === 'pdf' ? '📕' : resource.type === 'image' ? '🖼️' : '📎'}
                                                    </span>
                                                    <span class="truncate font-medium">${resource.name}</span>
                                                </div>
                                            </td>
                                            <td class="border px-3 py-3">
                                                <span class="px-2 py-1 bg-gray-100 rounded text-xs font-semibold">
                                                    ${resource.type === 'folder' ? '폴더' : resource.type === 'excel' ? 'Excel' : resource.type === 'csv' ? 'CSV' : resource.type === 'pdf' ? 'PDF' : resource.type === 'image' ? '이미지' : '기타'}
                                                </span>
                                            </td>
                                            <td class="border px-3 py-3 text-gray-700">
                                                ${resource.type === 'folder' ? '-' : resource.sizeKB ? (resource.sizeKB > 1024 ? (resource.sizeKB / 1024).toFixed(2) + ' MB' : resource.sizeKB.toFixed(2) + ' KB') : '-'}
                                            </td>
                                            <td class="border px-3 py-3 text-gray-600 text-xs">
                                                ${resource.uploadDate ? new Date(resource.uploadDate).toLocaleString() : '-'}
                                            </td>
                                            <td class="border px-3 py-3 text-center">
                                                <button class="resource-download-btn px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-semibold" data-idx="${idx}">
                                                    📥
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

       function renderPathwayTab() {
            let currentPathwayData = state.pathwayData[state.targetYear];
            
            // 기존 객체 형식 데이터를 배열로 변환 (호환성 처리)
            if (currentPathwayData && !Array.isArray(currentPathwayData)) {
                currentPathwayData = [];
                state.pathwayData[state.targetYear] = [];
            }
            
            currentPathwayData = currentPathwayData || [];
            
            let filteredPathwayData = [...currentPathwayData];
            
            if (state.pathway.filters.region) {
                filteredPathwayData = filteredPathwayData.filter(row => 
                    row['행정구역'] === state.pathway.filters.region
                );
            }
            
            if (state.pathway.searchTerm) {
                filteredPathwayData = filteredPathwayData.filter(row =>
                    Object.values(row).some(val =>
                        String(val).toLowerCase().includes(state.pathway.searchTerm.toLowerCase())
                    )
                );
            }
            
            const totalPathwayPages = Math.ceil(filteredPathwayData.length / state.itemsPerPage);
            const paginatedPathwayData = filteredPathwayData.slice(
                (state.pathway.currentPage - 1) * state.itemsPerPage,
                state.pathway.currentPage * state.itemsPerPage
            );

            return `
                <div>
                    <div class="bg-blue-100 border border-blue-300 rounded-lg p-4 mb-4">
                        <p class="text-lg font-bold text-blue-800">🏠 경로당 점검: <span class="text-2xl text-blue-600">${state.targetYear}년</span></p>
                    </div>

                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                      <div class="flex gap-2 mb-4 flex-wrap">
                            <button id="pathwayUploadBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold">📤 업로드 (Excel/CSV)</button>
                            <div class="relative">
                                <button id="pathwayDownloadBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold">📥 다운로드</button>
                                ${state.pathway.showDownloadMenu ? `
                                    <div class="absolute top-full mt-1 left-0 bg-white border rounded shadow-lg z-20 w-48">
                                        <button id="pathwayDownloadExcelBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left text-gray-800">
                                            📊 Excel 다운로드
                                        </button>
                                        <button id="pathwayDownloadCSVBtn" class="flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-100 text-left border-t text-gray-800">
                                            📄 CSV 다운로드
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            <button id="pathwayDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold">🗑️ 삭제</button>
                            <button id="pathwaySaveBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 font-semibold">💾 저장</button>
                            <button id="pathwayEditToggleBtn" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 font-semibold">${state.pathway.isEditing ? '편집완료' : '✏️ 편집'}</button>
                            <button id="pathwayAddRowBtn" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 font-semibold">➕ 행 추가</button>
                            <button id="pathwayMapBtn" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 font-semibold">🗺️ MAP</button>
                        </div>
                        

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">행정구역</label>
                                <select id="pathwayRegionFilter" class="w-full px-3 py-2 border rounded text-sm">
                                    <option value="">전체</option>
                                    ${pathwayOptions.regions.map(r => `<option value="${r}" ${state.pathway.filters.region === r ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">검색</label>
                                <input type="text" id="pathwaySearchInput" value="${state.pathway.searchTerm}" placeholder="검색어 입력..." class="w-full px-3 py-2 border rounded text-sm" />
                            </div>
                            <div class="flex items-end">
                                <button id="pathwaySearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold mr-2">🔍 조회</button>
                                <button id="pathwayResetBtn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 font-semibold">🔄 초기화</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse text-sm" style="table-layout: fixed; min-width: 2200px;">
                                <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2" style="width: 50px;">
                                            <input type="checkbox" id="selectAllPathwayRows" ${state.pathway.selectedRows.size === filteredPathwayData.length && filteredPathwayData.length > 0 ? 'checked' : ''} />
                                        </th>
                                        <th class="border px-2 py-2" style="width: 60px;">No</th>
                                        ${pathwayColumns.map(col => `
                                            <th class="border px-2 py-2 text-sm" style="width: ${col === '새주소' ? '200px' : col === '시설명' ? '150px' : col === '시설번호' ? '120px' : '100px'};">
                                                <div class="truncate" title="${col}">${col}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paginatedPathwayData.length === 0 ? `
                                        <tr>
                                            <td colspan="${pathwayColumns.length + 2}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">🏠</div>
                                                <div>데이터가 없습니다</div>
                                            </td>
                                        </tr>
                                    ` : paginatedPathwayData.map((row, idx) => {
                                        const actualIdx = (state.pathway.currentPage - 1) * state.itemsPerPage + idx;
                                        return `
                                            <tr class="${state.pathway.selectedRows.has(actualIdx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                                <td class="border px-2 py-1 text-center" style="width: 50px;">
                                                    <input type="checkbox" class="pathway-row-checkbox" data-idx="${actualIdx}" ${state.pathway.selectedRows.has(actualIdx) ? 'checked' : ''} />
                                                </td>
                                                <td class="border px-2 py-1 text-center" style="width: 60px;">${actualIdx + 1}</td>
                                                ${pathwayColumns.map(col => `
                                                    <td class="border px-2 py-1 text-sm">
                                                        ${state.pathway.isEditing ? `
                                                            ${col === '행정구역' ? `
                                                                <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${pathwayOptions.regions.map(o => `<option value="${o}" ${o === row[col] ? 'selected' : ''}>${o}</option>`).join('')}
                                                                </select>
                                                            ` : col === '사용가스' ? `
                                                                <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${pathwayOptions.gas.map(o => `<option value="${o}" ${o === row[col] ? 'selected' : ''}>${o}</option>`).join('')}
                                                                </select>
                                                            ` : (col === '차단기' || col === '타이머' || col === 'CO경보기') ? `
                                                                <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${pathwayOptions.device.map(o => `<option value="${o}" ${o === row[col] ? 'selected' : ''}>${o}</option>`).join('')}
                                                                </select>
                                                            ` : col === '누설' ? `
                                                                <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${pathwayOptions.leak.map(o => `<option value="${o}" ${o === row[col] ? 'selected' : ''}>${o}</option>`).join('')}
                                                                </select>
                                                            ` : col === '점검자' ? `
                                                                <select class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}">
                                                                    <option value="">선택</option>
                                                                    ${pathwayOptions.inspectors.map(o => `<option value="${o}" ${o === row[col] ? 'selected' : ''}>${o}</option>`).join('')}
                                                                </select>
                                                            ` : col === '점검일' ? `
                                                                <input type="date" value="${row[col] || ''}" class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                            ` : `
                                                                <input type="text" value="${row[col] || ''}" class="table-cell-input pathway-cell-edit" data-idx="${actualIdx}" data-col="${col}" />
                                                            `}
                                                        ` : `
                                                            <div class="truncate" title="${row[col] || '-'}">${row[col] || '-'}</div>
                                                        `}
                                                    </td>
                                                `).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                전체 ${filteredPathwayData.length}건
                                ${filteredPathwayData.length > 0 ? ` 중 ${((state.pathway.currentPage - 1) * state.itemsPerPage) + 1}-${Math.min(state.pathway.currentPage * state.itemsPerPage, filteredPathwayData.length)}건 표시` : ''}
                                ${state.pathway.selectedRows.size > 0 ? ` (${state.pathway.selectedRows.size}건 선택됨)` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="pathwayPrevPageBtn" ${state.pathway.currentPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">◀</button>
                                <span class="px-4 py-2">${state.pathway.currentPage} / ${totalPathwayPages || 1}</span>
                                <button id="pathwayNextPageBtn" ${state.pathway.currentPage === totalPathwayPages || totalPathwayPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">▶</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoadingModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                        <div class="animate-pulse text-4xl mb-4">⏳</div>
                        <p class="text-lg font-semibold mb-2">파일 처리 중...</p>
                        <div class="w-64 bg-gray-200 rounded-full h-4 mb-2">
                            <div class="bg-blue-600 h-4 rounded-full transition-all" style="width: ${state.loadingProgress}%;"></div>
                        </div>
                        <p class="text-sm text-gray-600">${state.loadingProgress}%</p>
                    </div>
                </div>
            `;
        }

        function renderDuplicateModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
                        <div class="bg-orange-500 text-white px-6 py-4">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">⚠️</span>
                                중복된 시설번호 발견
                            </h3>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-96">
                            <p class="text-gray-700 mb-4">
                                신청접수대장에 이미 존재하는 시설번호가 <strong class="text-orange-600">${state.duplicateInfo.duplicates.length}개</strong> 발견되었습니다.
                            </p>
                            
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-orange-800 mb-3">중복된 시설번호 목록:</h4>
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${state.duplicateInfo.duplicates.map((item, idx) => `
                                        <div class="bg-white border border-orange-200 rounded p-3 flex items-start gap-3">
                                            <span class="bg-orange-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">
                                                ${idx + 1}
                                            </span>
                                            <div class="flex-1">
                                                <p class="font-semibold text-gray-800">${item['시설번호']}</p>
                                                <p class="text-sm text-gray-600">${item['시설명']} (${item['행정구역']})</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t">
                            <button id="cancelDupBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                                취소
                            </button>
                            <button id="confirmDupBtn" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold">
                                계속 진행
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDeleteModal() {
            const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
                        <div class="bg-red-500 text-white px-6 py-4">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <span class="text-2xl">🗑️</span>
                                데이터 삭제 확인
                            </h3>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-96">
                            <p class="text-gray-700 mb-4">
                                선택된 <strong class="text-red-600">${selectedData.length}개</strong>의 항목을 삭제하시겠습니까?
                            </p>
                            
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-red-800 mb-3">삭제될 항목:</h4>
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${selectedData.map((item, idx) => `
                                        <div class="bg-white border border-red-200 rounded p-3 flex items-start gap-3">
                                            <span class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">
                                                ${idx + 1}
                                            </span>
                                            <div class="flex-1">
                                                <p class="font-semibold text-gray-800">${item['시설번호']}</p>
                                                <p class="text-sm text-gray-600">${item['시설명']} (${item['행정구역']})</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                                <p class="text-sm text-yellow-800">
                                    <strong>⚠️ 주의:</strong> 이 작업은 되돌릴 수 없습니다.
                                </p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t">
                            <button id="cancelDeleteBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                                취소
                            </button>
                            <button id="confirmDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                                삭제
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAppDeleteModal() {
    const currentAppData = state.applicationData[state.targetYear] || [];
    const selectedData = currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx));
    return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="bg-red-500 text-white px-6 py-4">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <span class="text-2xl">🗑️</span>
                        데이터 삭제 확인
                    </h3>
                </div>
                
                <div class="p-6 overflow-y-auto max-h-96">
                    <p class="text-gray-700 mb-4">
                        선택된 <strong class="text-red-600">${selectedData.length}개</strong>의 항목을 삭제하시겠습니까?
                    </p>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-red-800 mb-3">삭제될 항목:</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${selectedData.map((item, idx) => `
                                <div class="bg-white border border-red-200 rounded p-3 flex items-start gap-3">
                                    <span class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0">
                                        ${idx + 1}
                                    </span>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800">${item['시설번호']}</p>
                                        <p class="text-sm text-gray-600">${item['시설명']} (${item['행정구역']})</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                        <p class="text-sm text-yellow-800">
                            <strong>⚠️ 주의:</strong> 이 작업은 되돌릴 수 없습니다.
                        </p>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end border-t">
                    <button id="cancelAppDeleteBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold">
                        취소
                    </button>
                    <button id="confirmAppDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
                        삭제
                    </button>
                </div>
            </div>
        </div>
    `;
}

        function renderFooter() {
            return `
                <div class="container mx-auto px-4 py-4 text-sm text-gray-600 flex items-center justify-between">
                    <p>검색결과 (Total: ${state.filteredData.length}개)</p>
                    <div class="flex items-center gap-4">
                        ${state.settings.autoSave && state.lastSaved ? `
                            <p class="text-xs text-gray-500 flex items-center gap-2">
                                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                자동저장 활성 | 마지막 저장: ${state.lastSaved.toLocaleTimeString()}
                            </p>
                        ` : ''}
                        <p class="text-xs text-green-600 font-semibold">💾 영구 저장 모드</p>
                    </div>
                </div>
            `;
        }
        // ======================== 지도 초기화 함수 (전역) ========================
       function initMap(locations) {
    const mapContainer = document.getElementById('mapContainer');
    if (!mapContainer) {
        console.error('mapContainer 요소를 찾을 수 없습니다');
        setTimeout(() => initMap(locations), 500);
        return;
    }

    if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
        console.error('카카오맵 SDK가 로드되지 않았습니다');
        setTimeout(() => initMap(locations), 500);
        return;
    }

    kakao.maps.load(function() {
        const mapOption = {
            center: new kakao.maps.LatLng(35.1796, 129.0756),
            level: 7
        };

        const map = new kakao.maps.Map(mapContainer, mapOption);
        const geocoder = new kakao.maps.services.Geocoder();
        const bounds = new kakao.maps.LatLngBounds();
        let processedCount = 0;
        let totalCount = locations.length;

        locations.forEach((location) => {
            const address = location['새주소'];
            if (!address) {
                processedCount++;
                return;
            }

            geocoder.addressSearch(address, function(result, status) {
                  processedCount++;
                    state.mapLoadingProgress = Math.floor((processedCount / totalCount) * 100);
                    const progressBar = document.getElementById('mapProgressBar');
                    const progressText = document.getElementById('mapProgressText');
                    if (progressBar) progressBar.style.width = state.mapLoadingProgress + '%';
                    if (progressText) progressText.textContent = state.mapLoadingProgress + '%';
                
                if (status === kakao.maps.services.Status.OK && result[0]) {
                    const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                    bounds.extend(coords);

                    const marker = new kakao.maps.Marker({
                        position: coords,
                        map: map
                    });

                    const infowindow = new kakao.maps.InfoWindow({
                        content: '<div style="padding:10px;font-size:12px;"><strong>' + location['시설명'] + '</strong><br/>' + location['새주소'] + '<br/>' + (location['전화번호'] || '') + '</div>'
                    });

                    kakao.maps.event.addListener(marker, 'mouseover', function() {
                        infowindow.open(map, marker);
                    });
                    kakao.maps.event.addListener(marker, 'mouseout', function() {
                        infowindow.close();
                    });
                }

                if (processedCount === totalCount) {
    setTimeout(function() {
        if (!bounds.isEmpty()) {
            map.setBounds(bounds);
        }
        state.isLoadingMap = false;
        state.mapLoadingProgress = 100;
        const loadingBar = document.getElementById('mapLoadingBar');
        if (loadingBar) loadingBar.style.display = 'none';
    }, 300);
}
            });
        });
    });
}


        // ======================== 이벤트 리스너 ========================
        function attachEventListeners() {
            try {
                // 탭 버튼
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        state.activeTab = e.target.dataset.tab;
                        render();
                    });
                });

                // 연도 선택
                const yearSelect = document.getElementById('yearSelect');
                if (yearSelect) yearSelect.addEventListener('change', (e) => {
                    state.selectedYear = parseInt(e.target.value);
                    render();
                });

                // 환영 화면
                const sampleDataBtn = document.getElementById('sampleDataBtn');
                if (sampleDataBtn) sampleDataBtn.addEventListener('click', createSampleData);

                const welcomeFileInput = document.getElementById('welcomeFileInput');
                if (welcomeFileInput) {
                    welcomeFileInput.addEventListener('change', (e) => {
                        handleFileUpload(e.target.files[0]);
                    });
                }

                const emptyStartBtn = document.getElementById('emptyStartBtn');
                if (emptyStartBtn) {
                    emptyStartBtn.addEventListener('click', () => {
                        state.showWelcome = false;
                        render();
                    });
                }

                // 관리자
                const adminLoginBtn = document.getElementById('adminLoginBtn');
                if (adminLoginBtn) {
                    adminLoginBtn.addEventListener('click', () => {
                        const pwd = document.getElementById('adminPassword').value;
                        if (pwd === 'kgt7848848!') {
                            state.showAdmin = true;
                            render();
                        } else {
                            alert('비밀번호가 올바르지 않습니다.');
                        }
                    });
                }

                const clearAllBtn = document.getElementById('clearAllBtn');
                if (clearAllBtn) clearAllBtn.addEventListener('click', clearAllData);

                const autoSaveToggle = document.getElementById('autoSaveToggle');
                if (autoSaveToggle) {
                    autoSaveToggle.addEventListener('change', (e) => {
                        state.settings.autoSave = e.target.checked;
                        saveDataToStorage();
                    });
                }

                // 통합 탭
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv,.xlsx,.xls';
                    uploadBtn.addEventListener('click', () => input.click());
                    input.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
                }

                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', () => {
                        state.showDownloadMenu = !state.showDownloadMenu;
                        render();
                    });
                }

                const downloadExcelBtn = document.getElementById('downloadExcelBtn');
                if (downloadExcelBtn) downloadExcelBtn.addEventListener('click', downloadAsExcel);

                const downloadCSVBtn = document.getElementById('downloadCSVBtn');
                if (downloadCSVBtn) downloadCSVBtn.addEventListener('click', downloadAsCSV);

                const sampleBtn = document.getElementById('sampleBtn');
                if (sampleBtn) sampleBtn.addEventListener('click', createSampleData);

                const editToggleBtn = document.getElementById('editToggleBtn');
                if (editToggleBtn) {
                    editToggleBtn.addEventListener('click', () => {
                        state.isEditing = !state.isEditing;
                        render();
                    });
                }

                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        saveDataToStorage();
                        alert('💾 데이터가 저장되었습니다.');
                    });
                }

                const copyBtn = document.getElementById('copyBtn');
                if (copyBtn) copyBtn.addEventListener('click', copyToApplication);

                const deleteBtn = document.getElementById('deleteBtn');
                if (deleteBtn) deleteBtn.addEventListener('click', deleteSelectedRows);

                const detailBtn = document.getElementById('detailBtn');
                if (detailBtn) detailBtn.addEventListener('click', openDetailModal);

                // 행정구역 드롭다운
                const regionDropdownBtn = document.getElementById('regionDropdownBtn');
                if (regionDropdownBtn) {
                    regionDropdownBtn.addEventListener('click', () => {
                        state.showRegionDropdown = !state.showRegionDropdown;
                        state.showMonthDropdown = false;
                        state.showInspectionDropdown = false;
                        render();
                    });
                }

                // 기준월 드롭다운
                const monthDropdownBtn = document.getElementById('monthDropdownBtn');
                if (monthDropdownBtn) {
                    monthDropdownBtn.addEventListener('click', () => {
                        state.showMonthDropdown = !state.showMonthDropdown;
                        state.showRegionDropdown = false;
                        state.showInspectionDropdown = false;
                        render();
                    });
                }

                // 검사이력 드롭다운
                const inspectionDropdownBtn = document.getElementById('inspectionDropdownBtn');
                if (inspectionDropdownBtn) {
                    inspectionDropdownBtn.addEventListener('click', () => {
                        state.showInspectionDropdown = !state.showInspectionDropdown;
                        state.showRegionDropdown = false;
                        state.showMonthDropdown = false;
                        render();
                    });
                }

                // 조회 버튼
                const searchBtn = document.getElementById('searchBtn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => {
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput) {
                            state.searchTerm = searchInput.value;
                        }
                        state.currentPage = 1;
                        render();
                    });
                }

                // 검색 입력 필드 - Enter 키 처리
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            state.searchTerm = e.target.value;
                            state.currentPage = 1;
                            render();
                        }
                    });
                }

                // 필터 초기화 버튼
                const mainFilterResetBtn = document.getElementById('mainFilterResetBtn');
                if (mainFilterResetBtn) {
                    mainFilterResetBtn.addEventListener('click', () => {
                        state.filters = {
                            region: [],
                            month: '',
                            inspectionHistory: ''
                        };
                        state.searchTerm = '';
                        state.currentPage = 1;
                        state.showRegionDropdown = false;
                        state.showMonthDropdown = false;
                        state.showInspectionDropdown = false;
                        render();
                    });
                }

                // 행 선택
                const selectAllRows = document.getElementById('selectAllRows');
                if (selectAllRows) {
                    selectAllRows.addEventListener('change', () => {
                        if (selectAllRows.checked) {
                            state.selectedRows = new Set(state.filteredData.map((_, i) => i));
                        } else {
                            state.selectedRows = new Set();
                        }
                        render();
                    });
                }

                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                       
                 
                        if (e.target.checked) {
                            state.selectedRows.add(idx);
                        } else {
                            state.selectedRows.delete(idx);
                        }
                    });
               });
                

                // 셀 편집
               document.querySelectorAll('.cell-edit').forEach(input => {
                input.addEventListener('change', (e) => {
                   const idx = parseInt(e.target.dataset.idx);
                   const col = e.target.dataset.col;
                   const facilityNumber = state.data[state.selectedYear][idx]['시설번호'];
        
        // 통합 탭 저장
                  state.data[state.selectedYear][idx][col] = e.target.value;
        
        // 신청접수대장에서 같은 시설번호 찾아서 동기화
                   if (facilityNumber && state.applicationData[state.targetYear]) {
                   const appRowIdx = state.applicationData[state.targetYear].findIndex(row => row['시설번호'] === facilityNumber);
                  if (appRowIdx !== -1 && applicationColumns.includes(col)) {
                    state.applicationData[state.targetYear][appRowIdx][col] = e.target.value;
            }
        }
     })
 });
                // 필터
                const selectAllRegions = document.getElementById('selectAllRegions');
                if (selectAllRegions) {
                    selectAllRegions.addEventListener('change', (e) => {
                        const uniqueRegions = [...new Set(
                            (state.data[state.selectedYear] || []).map(row => (row['행정구역'] || '').replace(/[\\\/]/g, '').trim()).filter(Boolean)
                        )];
                        state.filters.region = e.target.checked ? [...uniqueRegions] : [];
                        render();
                    });
                }

                document.querySelectorAll('.region-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const region = e.target.value;
                        if (e.target.checked) {
                            state.filters.region.push(region);
                        } else {
                            state.filters.region = state.filters.region.filter(r => r !== region);
                        }
                    });
                });

                document.querySelectorAll('input[name="month"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        state.filters.month = e.target.value;
                    });
                });

                document.querySelectorAll('input[name="inspection"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        state.filters.inspectionHistory = e.target.value;
                    });
                });

                // 페이지네이션
                const prevPageBtn = document.getElementById('prevPageBtn');
                if (prevPageBtn) {
                    prevPageBtn.addEventListener('click', () => {
                        state.currentPage = Math.max(1, state.currentPage - 1);
                        render();
                    });
                }

                const nextPageBtn = document.getElementById('nextPageBtn');
                if (nextPageBtn) {
                    nextPageBtn.addEventListener('click', () => {
                        const totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);
                        state.currentPage = Math.min(totalPages, state.currentPage + 1);
                        render();
                    });
                }

                // 신청접수대장 탭
                const targetYearSelect = document.getElementById('targetYearSelect');
                if (targetYearSelect) {
                    targetYearSelect.addEventListener('change', (e) => {
                        state.targetYear = parseInt(e.target.value);
                        render();
                    });
                }

                const inspectionYearSelect = document.getElementById('inspectionYearSelect');
                if (inspectionYearSelect) {
                    inspectionYearSelect.addEventListener('change', (e) => {
                        state.inspectionYear = parseInt(e.target.value);
                        render();
                    });
                }

        const appUploadBtn = document.getElementById('appUploadBtn');
if (appUploadBtn && !appUploadBtn.dataset.hasListener) {
    appUploadBtn.dataset.hasListener = 'true';
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv,.xlsx,.xls,.xlsm';  // ← .xlsm 추가됨
    appUploadBtn.addEventListener('click', () => input.click());
    input.addEventListener('change', async (e) => {
        if (!e.target.files[0]) return;
        
        state.isLoading = true;
        state.loadingProgress = 30;
        render();

        try {
            let parsedData;
            const file = e.target.files[0];
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (fileExt === 'xlsx' || fileExt === 'xls' || fileExt === 'xlsm') {  // ← .xlsm 추가됨
                parsedData = await parseExcelFile(file);
            } else if (fileExt === 'csv') {
                parsedData = await parseCSVFile(file);
            } else {
                throw new Error('지원하지 않는 파일 형식입니다. (.xlsx, .xls, .xlsm, .csv만 가능)');
            }

            if (parsedData.length === 0) {
                alert('유효한 데이터가 없습니다.');
                state.isLoading = false;
                render();
                return;
            }

            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }
          const mainData = Object.values(state.data).flat();
          parsedData = parsedData.map(appRow => {
              if (!appRow['기준일'] || appRow['기준일'] === '') {
                  const mainRow = mainData.find(m => m['시설번호'] === appRow['시설번호']);
                   if (mainRow && mainRow['기준일']) {
                         appRow['기준일'] = mainRow['기준일'];
        }
    }
    return appRow;
});
           // 파일의 모든 데이터를 저장 후 정렬 (필증번호 내림차순, 빈 값은 맨 위)
        parsedData.sort((a, b) => {
            const certA = a['필증번호'] || '';
            const certB = b['필증번호'] || '';
            
            // 둘 다 비어있으면 순서 유지
            if (certA === '' && certB === '') return 0;
            // A만 비어있으면 A가 위로
            if (certA === '') return -1;
            // B만 비어있으면 B가 위로
            if (certB === '') return 1;
            // 둘 다 값이 있으면 내림차순
            return certB.localeCompare(certA);
        });

// 필증번호 기준 정렬 (빈 값은 맨 위, 나머지는 내림차순)
parsedData.sort((a, b) => {
    const certA = a['필증번호'] || '';
    const certB = b['필증번호'] || '';
    if (certA === '' && certB === '') return 0;
    if (certA === '') return -1;
    if (certB === '') return 1;
    return certB.localeCompare(certA);
});
state.applicationData[state.targetYear] = parsedData;
            
            state.applicationFilters = {
                region: [],
                inspector: '',
                receiptLocation: '',
                inspectionResult: '',
                applicationDateFrom: '',
                applicationDateTo: '',
                inspectionDateFrom: '',
                inspectionDateTo: '',
                baseMonth: '',
                fee: '',
                facilityCert: '',
                certificateStatus: '',
                insuranceStatus: ''
            };
            state.currentApplicationPage = 1;                     
            state.lastSaved = new Date();
            
            setTimeout(() => {
                state.isLoading = false;
                const storageSize = getStorageSize();
                let message = `✅ ${parsedData.length}개의 데이터가 신청접수대장(${state.targetYear}년)으로 업로드되었습니다.\n파일명: ${file.name}`;
                
                if (parseFloat(storageSize) > 3) {
                    message += `\n\n⚠️ 저장 공간: ${storageSize}MB/5MB`;
                }
                
                alert(message);
                saveDataToStorage();
                render();
                input.value = '';
            }, 300);

        } catch (error) {
            console.error('파일 처리 오류:', error);
            alert('파일 처리 중 오류가 발생했습니다: ' + error.message);
            state.isLoading = false;
            input.value = '';
            render();
        }
    });
}

                const appAddRowBtn = document.getElementById('appAddRowBtn');
                if (appAddRowBtn) appAddRowBtn.addEventListener('click', addApplicationRow);

                const appDeleteRowBtn = document.getElementById('appDeleteRowBtn');
                if (appDeleteRowBtn) appDeleteRowBtn.addEventListener('click', deleteSelectedApplicationRows);

                const appCertBtn = document.getElementById('appCertBtn');
                if (appCertBtn) appCertBtn.addEventListener('click', generateCertificateNumbers);

                const appSaveBtn = document.getElementById('appSaveBtn');
                if (appSaveBtn) {
                    appSaveBtn.addEventListener('click', () => {
                        saveDataToStorage();
                        alert('💾 데이터가 저장되었습니다.');
                    });
                }

                const appEditToggleBtn = document.getElementById('appEditToggleBtn');
                if (appEditToggleBtn) {
                    appEditToggleBtn.addEventListener('click', () => {
                        state.isEditingApplication = !state.isEditingApplication;
                        render();
                    });
                }

              const appDownloadBtn = document.getElementById('appDownloadBtn');
if (appDownloadBtn) {
    appDownloadBtn.addEventListener('click', () => {
        const currentAppData = state.applicationData[state.targetYear] || [];
        
        // 필터링 적용
       let filteredApplicationData = [...currentAppData];

            // 필증번호 기준 정렬 (빈 값은 맨 위, 나머지는 내림차순)
            filteredApplicationData.sort((a, b) => {
                const certA = a['필증번호'] || '';
                const certB = b['필증번호'] || '';
                if (certA === '' && certB === '') return 0;
                if (certA === '') return -1;
                if (certB === '') return 1;
                return certB.localeCompare(certA);
            });
        if (state.applicationFilters.region.length > 0) {
            filteredApplicationData = filteredApplicationData.filter(row => 
                state.applicationFilters.region.includes(row['행정구역'])
            );
        }
        if (state.applicationFilters.inspector) {
            filteredApplicationData = filteredApplicationData.filter(row =>
                row['검사원'] === state.applicationFilters.inspector
            );
        }
        if (state.applicationFilters.inspectionResult) {
            filteredApplicationData = filteredApplicationData.filter(row => {
                if (state.applicationFilters.inspectionResult === '공란') {
                    return !row['검사결과'] || row['검사결과'].trim() === '';
                }
                return row['검사결과'] === state.applicationFilters.inspectionResult;
            });
        }
        if (state.applicationFilters.receiptLocation) {
            filteredApplicationData = filteredApplicationData.filter(row =>
                row['접수처'] === state.applicationFilters.receiptLocation
            );
        }
        if (state.applicationFilters.applicationDateFrom) {
            filteredApplicationData = filteredApplicationData.filter(row =>
                row['신청일'] >= state.applicationFilters.applicationDateFrom
            );
        }
        if (state.applicationFilters.applicationDateTo) {
            filteredApplicationData = filteredApplicationData.filter(row =>
                row['신청일'] <= state.applicationFilters.applicationDateTo
            );
        }
        if (state.applicationFilters.inspectionDateFrom) {
            filteredApplicationData = filteredApplicationData.filter(row =>
                row['검사일'] >= state.applicationFilters.inspectionDateFrom
            );
        }
        if (state.applicationFilters.inspectionDateTo) {
            filteredApplicationData = filteredApplicationData.filter(row =>
                row['검사일'] <= state.applicationFilters.inspectionDateTo
            );
        }
        if (state.applicationFilters.baseMonth) {
            const targetMonth = parseInt(state.applicationFilters.baseMonth);
            filteredApplicationData = filteredApplicationData.filter(row => {
                const dateStr = String(row['기준일'] || '').trim();
                if (!dateStr) return false;
                let match = dateStr.match(/(\d{4})[^\d](\d{1,2})[^\d](\d{1,2})/);
                if (match) {
                    const month = parseInt(match[2]);
                    return month === targetMonth;
                }
                const onlyNumbers = dateStr.replace(/\D/g, '');
                if (onlyNumbers.length >= 6) {
                    const dateMatch = onlyNumbers.match(/(\d{4})(\d{1,2})(\d{1,2})/);
                    if (dateMatch) {
                        const month = parseInt(dateMatch[2]);
                        if (month >= 1 && month <= 12 && month === targetMonth) {
                            return true;
                        }
                    }
                }
                return false;
            });
        }
        if (state.applicationFilters.fee) {
            filteredApplicationData = filteredApplicationData.filter(row =>
                String(row['수수료']).includes(state.applicationFilters.fee)
            );
        }
        if (state.applicationSearchTerm) {
            filteredApplicationData = filteredApplicationData.filter(row =>
                Object.values(row).some(val =>
                    String(val).toLowerCase().includes(state.applicationSearchTerm.toLowerCase())
                )
            );
        }
        
        // 선택된 행이 있으면 선택된 행만, 없으면 필터링된 전체 데이터
        const dataToDownload = state.selectedApplicationRows.size > 0
            ? filteredApplicationData.filter((_, idx) => state.selectedApplicationRows.has(idx))
            : filteredApplicationData;

        if (dataToDownload.length === 0) {
            alert('다운로드할 데이터가 없습니다.');
            return;
        }

        const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: applicationColumns });
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, '신청접수대장');
        
        const fileName = `신청접수대장_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);
    });
}

                // 애플리케이션 행 선택
              const selectAllAppRows = document.getElementById('selectAllAppRows');
if (selectAllAppRows) {
    selectAllAppRows.addEventListener('change', (e) => {
        const currentAppData = state.applicationData[state.targetYear] || [];
        
        if (e.target.checked) {
            state.selectedApplicationRows = new Set(currentAppData.map((_, i) => i));
        } else {
            state.selectedApplicationRows = new Set();
        }
        render();
    });
}
                
             document.querySelectorAll('.app-row-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    if (e.target.checked) {
                        state.selectedApplicationRows.add(idx);
                    } else {
                        state.selectedApplicationRows.delete(idx);
                    }
                });
            });

                // 앱 셀 편집
                
               // 변경할 코드:
               document.querySelectorAll('.app-cell-edit').forEach(input => {
                  input.addEventListener('change', (e) => {
                       const idx = parseInt(e.target.dataset.idx);
                       const col = e.target.dataset.col;
                       const facilityNumber = state.applicationData[state.targetYear][idx]['시설번호'];
        
        // 신청접수대장 저장
                       state.applicationData[state.targetYear][idx][col] = e.target.value;
         
        // 통합 탭에서 같은 시설번호 찾아서 동기화
                       if (facilityNumber && state.data[state.selectedYear]) {
                       const mainRowIdx = state.data[state.selectedYear].findIndex(row => row['시설번호'] === facilityNumber);
                       if (mainRowIdx !== -1 && columns.includes(col)) {
                       state.data[state.selectedYear][mainRowIdx][col] = e.target.value;
            }
        }
        
        if (col === '신청일' && e.target.value && !state.applicationData[state.targetYear][idx]['필증번호']) {
            state.applicationData[state.targetYear][idx]['필증번호'] = generateCertificateNumber(e.target.value, state.targetYear);
        }
        
        saveDataToStorage();
    });
}); 
                // 분기 탭
                const quarterAddRowBtn = document.getElementById('quarterAddRowBtn');
                if (quarterAddRowBtn) quarterAddRowBtn.addEventListener('click', addQuarterRow);

                const quarterDeleteRowBtn = document.getElementById('quarterDeleteRowBtn');
                if (quarterDeleteRowBtn) quarterDeleteRowBtn.addEventListener('click', deleteSelectedQuarterRows);

                const quarterEditToggleBtn = document.getElementById('quarterEditToggleBtn');
                if (quarterEditToggleBtn) {
                    quarterEditToggleBtn.addEventListener('click', () => {
                        state.isEditingQuarter = !state.isEditingQuarter;
                        render();
                    });
                }

                const quarterSaveBtn = document.getElementById('quarterSaveBtn');
                if (quarterSaveBtn) {
                    quarterSaveBtn.addEventListener('click', () => {
                        saveDataToStorage();
                        alert('💾 데이터가 저장되었습니다.');
                    });
                }

                const quarterDownloadBtn = document.getElementById('quarterDownloadBtn');
                if (quarterDownloadBtn) {
                    quarterDownloadBtn.addEventListener('click', () => {
                        const currentQuarterData = state.quarterData[state.selectedYear] || [];
                        const selectedData = state.selectedQuarterRows.size > 0
                            ? currentQuarterData.filter((_, idx) => state.selectedQuarterRows.has(idx))
                            : currentQuarterData;

                        if (selectedData.length === 0) {
                            alert('다운로드할 데이터가 없습니다.');
                            return;
                        }

                        const worksheet = XLSX.utils.json_to_sheet(selectedData, { header: quarterColumns });
                        const workbook = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(workbook, worksheet, '분기');
                        
                        const fileName = `분기_${new Date().toISOString().split('T')[0]}.xlsx`;
                        XLSX.writeFile(workbook, fileName);
                    });
                }

                document.querySelectorAll('.quarter-row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.selectedQuarterRows.add(idx);
                        } else {
                            state.selectedQuarterRows.delete(idx);
                        }
                    });
                });

                document.querySelectorAll('.quarter-cell-edit').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const col = e.target.dataset.col;
                        state.quarterData[state.selectedYear][idx][col] = e.target.value;
                    });
                });

                // 분기 페이지네이션
                const quarterPrevPageBtn = document.getElementById('quarterPrevPageBtn');
                if (quarterPrevPageBtn) {
                    quarterPrevPageBtn.addEventListener('click', () => {
                        state.currentQuarterPage = Math.max(1, state.currentQuarterPage - 1);
                        render();
                    });
                }

                const quarterNextPageBtn = document.getElementById('quarterNextPageBtn');
                if (quarterNextPageBtn) {
                    quarterNextPageBtn.addEventListener('click', () => {
                        const currentQuarterData = state.quarterData[state.selectedYear] || [];
                        const totalPages = Math.ceil(currentQuarterData.length / state.itemsPerPage);
                        state.currentQuarterPage = Math.min(totalPages, state.currentQuarterPage + 1);
                        render();
                    });
                }

                const quarterDataPrevPageBtn = document.getElementById('quarterDataPrevPageBtn');
                if (quarterDataPrevPageBtn) {
                    quarterDataPrevPageBtn.addEventListener('click', () => {
                        state.currentQuarterPage = Math.max(1, state.currentQuarterPage - 1);
                        render();
                    });
                }

                const quarterDataNextPageBtn = document.getElementById('quarterDataNextPageBtn');
                if (quarterDataNextPageBtn) {
                    quarterDataNextPageBtn.addEventListener('click', () => {
                        const currentQuarterData = state.quarterData[state.selectedYear] || [];
                        const totalPages = Math.ceil(currentQuarterData.length / state.itemsPerPage);
                        state.currentQuarterPage = Math.min(totalPages, state.currentQuarterPage + 1);
                        render();
                    });
                }

                const selectAllQuarterRows = document.getElementById('selectAllQuarterRows');
                if (selectAllQuarterRows) {
                    selectAllQuarterRows.addEventListener('change', (e) => {
                        const currentQuarterData = state.quarterData[state.selectedYear] || [];
                        if (e.target.checked) {
                            state.selectedQuarterRows = new Set(currentQuarterData.map((_, i) => i));
                        } else {
                            state.selectedQuarterRows = new Set();
                        }
                        render();
                    });
                }

                // 취소 탭 - 편집 토글
                const cancelEditToggleBtn = document.getElementById('cancelEditToggleBtn');
                if (cancelEditToggleBtn) {
                    cancelEditToggleBtn.addEventListener('click', () => {
                        state.isEditingCancellation = !state.isEditingCancellation;
                        render();
                    });
                }

                // 취소 탭 - 저장
                const cancelSaveBtn = document.getElementById('cancelSaveBtn');
                if (cancelSaveBtn) {
                    cancelSaveBtn.addEventListener('click', () => {
                        saveDataToStorage();
                        alert('💾 데이터가 저장되었습니다.');
                    });
                }

                // 취소 탭 - 셀 편집
                document.querySelectorAll('.cancel-cell-edit').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const col = e.target.dataset.col;
                        state.cancellationData[state.targetYear][idx][col] = e.target.value;
                    });
                });

                // 취소 탭 - 행 삭제
                const cancelDeleteRowBtn = document.getElementById('cancelDeleteRowBtn');
                if (cancelDeleteRowBtn) cancelDeleteRowBtn.addEventListener('click', deleteSelectedCancellationRows);

                document.querySelectorAll('.cancel-row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.selectedCancellationRows.add(idx);
                        } else {
                            state.selectedCancellationRows.delete(idx);
                        }
                    });
                });
             const selectAllCancelRows = document.getElementById('selectAllCancelRows');
                if (selectAllCancelRows) {
                    selectAllCancelRows.addEventListener('change', (e) => {
                        const currentCancelData = state.cancellationData[state.targetYear] || [];
                        if (e.target.checked) {
                            state.selectedCancellationRows = new Set(currentCancelData.map((_, i) => i));
                        } else {
                            state.selectedCancellationRows = new Set();
                        }
                        render();
                    });
                }

                // 신청 탭 - 행정구역 필터
                const selectAllAppRegions = document.getElementById('selectAllAppRegions');
                if (selectAllAppRegions) {
                    selectAllAppRegions.addEventListener('change', (e) => {
                        const currentAppData = state.applicationData[state.targetYear] || [];
                        const uniqueAppRegions = [...new Set(
                            currentAppData.map(row => row['행정구역']).filter(Boolean)
                        )].sort();
                        state.applicationFilters.region = e.target.checked ? [...uniqueAppRegions] : [];
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                document.querySelectorAll('.app-region-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const region = e.target.value;
                        if (e.target.checked) {
                            if (!state.applicationFilters.region.includes(region)) {
                                state.applicationFilters.region.push(region);
                            }
                        } else {
                            state.applicationFilters.region = state.applicationFilters.region.filter(r => r !== region);
                        }
                        state.currentApplicationPage = 1;
                        render();
                    });
                });

                // 신청 탭 - 검사원 필터
                const appInspectorFilter = document.getElementById('appInspectorFilter');
                if (appInspectorFilter) {
                    appInspectorFilter.addEventListener('change', (e) => {
                        state.applicationFilters.inspector = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                // 신청 탭 - 검사결과 필터
                const appResultFilter = document.getElementById('appResultFilter');
                if (appResultFilter) {
                    appResultFilter.addEventListener('change', (e) => {
                        state.applicationFilters.inspectionResult = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                // 신청 탭 - 접수처 필터
                const appReceiptFilter = document.getElementById('appReceiptFilter');
                if (appReceiptFilter) {
                    appReceiptFilter.addEventListener('change', (e) => {
                        state.applicationFilters.receiptLocation = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                // 신청 탭 - 신청일 필터
                const appDateFromFilter = document.getElementById('appDateFromFilter');
                if (appDateFromFilter) {
                    appDateFromFilter.addEventListener('change', (e) => {
                        state.applicationFilters.applicationDateFrom = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                const appDateToFilter = document.getElementById('appDateToFilter');
                if (appDateToFilter) {
                    appDateToFilter.addEventListener('change', (e) => {
                        state.applicationFilters.applicationDateTo = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                // 신청 탭 - 검사일 필터
                const appInspectionDateFromFilter = document.getElementById('appInspectionDateFromFilter');
                if (appInspectionDateFromFilter) {
                    appInspectionDateFromFilter.addEventListener('change', (e) => {
                        state.applicationFilters.inspectionDateFrom = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                const appInspectionDateToFilter = document.getElementById('appInspectionDateToFilter');
                if (appInspectionDateToFilter) {
                    appInspectionDateToFilter.addEventListener('change', (e) => {
                        state.applicationFilters.inspectionDateTo = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                // 신청 탭 - 기준월 필터
                const appBaseMonthFilter = document.getElementById('appBaseMonthFilter');
                if (appBaseMonthFilter) {
                    appBaseMonthFilter.addEventListener('change', (e) => {
                        state.applicationFilters.baseMonth = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                // 신청 탭 - 수수료 필터
                const appFeeFilter = document.getElementById('appFeeFilter');
                if (appFeeFilter) {
                    appFeeFilter.addEventListener('change', (e) => {
                        state.applicationFilters.fee = e.target.value;
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                            // 신청 탭 - 검색
                const appSearchBtn = document.getElementById('appSearchBtn');
                if (appSearchBtn) {
                    appSearchBtn.addEventListener('click', () => {
                        const searchInput = document.getElementById('appSearchInput');
                        if (searchInput) {
                            state.applicationSearchTerm = searchInput.value;
                        }
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                const appSearchInput = document.getElementById('appSearchInput');
                if (appSearchInput) {
                    appSearchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            state.applicationSearchTerm = e.target.value;
                            state.currentApplicationPage = 1;
                            render();
                        }
                    });
                }

                // 신청 탭 - 필터 초기화
                const appFilterResetBtn = document.getElementById('appFilterResetBtn');
                if (appFilterResetBtn) {
                    appFilterResetBtn.addEventListener('click', () => {
                        state.applicationFilters = {
                            region: [],
                            inspector: '',
                            receiptLocation: '',
                            inspectionResult: '',
                            applicationDateFrom: '',
                            applicationDateTo: '',
                            inspectionDateFrom: '',
                            inspectionDateTo: '',
                            baseMonth: '',
                            fee: '',
                            facilityCert: '',
                            certificateStatus: '',
                            insuranceStatus: ''
                        };
                        state.applicationSearchTerm = '';
                        state.currentApplicationPage = 1;
                        render();
                    });
                }

                // 신청 탭 - 잘라내기 버튼
                const cutBtn = document.getElementById('cutBtn');
                if (cutBtn) cutBtn.addEventListener('click', cutToInspectionYear);

                // 신청 탭 - 취소 버튼
                const cancelBtn = document.getElementById('cancelBtn');
                if (cancelBtn) cancelBtn.addEventListener('click', moveToCancel);

                // 중복 모달
                const cancelDupBtn = document.getElementById('cancelDupBtn');
                if (cancelDupBtn) {
                    cancelDupBtn.addEventListener('click', () => {
                        state.showDuplicateModal = false;
                        render();
                    });
                }

                const confirmDupBtn = document.getElementById('confirmDupBtn');
                if (confirmDupBtn) confirmDupBtn.addEventListener('click', confirmDuplicateCopy);

                // 삭제 모달
                const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
                if (cancelDeleteBtn) {
                    cancelDeleteBtn.addEventListener('click', () => {
                        state.showDeleteModal = false;
                        render();
                    });
                }

              const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
                if (confirmDeleteBtn) {
                    confirmDeleteBtn.addEventListener('click', confirmDelete);
                }

                // 신청접수대장 삭제 모달
              const cancelAppDeleteBtn = document.getElementById('cancelAppDeleteBtn');
                if (cancelAppDeleteBtn) {
                    cancelAppDeleteBtn.addEventListener('click', () => {
                        state.showAppDeleteModal = false;
                        render();
                    });
                }

const confirmAppDeleteBtn = document.getElementById('confirmAppDeleteBtn');
if (confirmAppDeleteBtn) {
    confirmAppDeleteBtn.addEventListener('click', confirmAppDelete);
}


                // MAP 버튼
            const appMapBtn = document.getElementById('appMapBtn');
                if (appMapBtn) {
                    appMapBtn.addEventListener('click', () => {
                       const currentAppData = state.applicationData[state.targetYear] || [];
                       const selectedData = currentAppData.filter((_, idx) => state.selectedApplicationRows.has(idx));

                       if (selectedData.length === 0) {
                           alert('지도에 표시할 시설을 선택해주세요.');
                           return;
                       }

                       state.mapData = selectedData;
                       state.showMapModal = true;
                       state.isLoadingMap = true;
                       state.mapLoadingProgress = 0;
                       render();

                       setTimeout(() => {
                           initMap(selectedData);
                       }, 500);
                    });
                }
                // 상세보기/추가 모달
                const detailCancelBtn = document.getElementById('detailCancelBtn');
                if (detailCancelBtn) {
                    detailCancelBtn.addEventListener('click', closeDetailModal);
                }

                const detailCloseBtn = document.getElementById('detailCloseBtn');
                if (detailCloseBtn) {
                    detailCloseBtn.addEventListener('click', closeDetailModal);
                }

                const detailSaveBtn = document.getElementById('detailSaveBtn');
                if (detailSaveBtn) {
                    detailSaveBtn.addEventListener('click', saveFromDetailModal);
                }

               const detailAddBtn = document.getElementById('detailAddBtn');
if (detailAddBtn) {
    detailAddBtn.addEventListener('click', () => {
        columns.forEach(col => {
            const input = document.getElementById(`detail-${col}`);
            if (input) {
                state.detailModalData[col] = input.value;
            }
        });
        addFromDetailModal();
    });
}

// 신청접수대장 상세보기/추가 버튼
const appDetailBtn = document.getElementById('appDetailBtn');
if (appDetailBtn) appDetailBtn.addEventListener('click', openAppDetailModal);

// 신청접수대장 상세보기 모달 이벤트
const appDetailCancelBtn = document.getElementById('appDetailCancelBtn');
if (appDetailCancelBtn) {
    appDetailCancelBtn.addEventListener('click', closeAppDetailModal);
}

const appDetailCloseBtn = document.getElementById('appDetailCloseBtn');
if (appDetailCloseBtn) {
    appDetailCloseBtn.addEventListener('click', closeAppDetailModal);
}

const appDetailSaveBtn = document.getElementById('appDetailSaveBtn');
if (appDetailSaveBtn) {
    appDetailSaveBtn.addEventListener('click', saveFromAppDetailModal);
}

const appDetailAddBtn = document.getElementById('appDetailAddBtn');
if (appDetailAddBtn) {
    appDetailAddBtn.addEventListener('click', addFromAppDetailModal);
}

// 지도 모달 닫기
// 지도 모달 닫기
                const mapCloseBtn = document.getElementById('mapCloseBtn');
                const mapCancelBtn = document.getElementById('mapCancelBtn');
                
               if (mapCloseBtn) {
                    mapCloseBtn.addEventListener('click', () => {
                        state.showMapModal = false;
                        state.mapData = [];
                        state.isLoadingMap = false;
                        render();
                    });
                }

                if (mapCancelBtn) {
                mapCancelBtn.addEventListener('click', () => {
                    state.showMapModal = false;
                    state.mapData = [];
                    state.isLoadingMap = false;
                    render();
    });
}

const mapPrintBtn = document.getElementById('mapPrintBtn');
if (mapPrintBtn) {
    mapPrintBtn.addEventListener('click', () => {
        window.print();
    });
}

               const salesRefreshBtn = document.getElementById('salesRefreshBtn');
                if (salesRefreshBtn) {
                    salesRefreshBtn.addEventListener('click', () => {
                        render();
                        alert('✅ 매출분석 데이터가 새로고침되었습니다.');
                    });
                }

                // 경로당 탭 이벤트 리스너
                const pathwayUploadBtn = document.getElementById('pathwayUploadBtn');
                if (pathwayUploadBtn) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv,.xlsx,.xls.xlsm';
                    pathwayUploadBtn.addEventListener('click', () => input.click());
                    input.addEventListener('change', async (e) => {
                        if (!e.target.files[0]) return;
                        
                        state.isLoading = true;
                        state.loadingProgress = 30;
                        render();

                        try {
                            let parsedData;
                            const file = e.target.files[0];
                            const fileExt = file.name.split('.').pop().toLowerCase();
                            
                            if (fileExt === 'xlsx' || fileExt === 'xls') {
                                parsedData = await parseExcelFile(file);
                            } else if (fileExt === 'csv') {
                                parsedData = await parseCSVFile(file);
                            } else {
                                throw new Error('지원하지 않는 파일 형식입니다.(.xlsx, .xls, .xlsm, .csv만 가능)');
                            }

                            if (!state.pathwayData[state.targetYear]) {
                                state.pathwayData[state.targetYear] = [];
                            }
                            state.pathwayData[state.targetYear] = parsedData;
                            state.lastSaved = new Date();
                            
                            setTimeout(() => {
                                state.isLoading = false;
                                alert(`✅ ${parsedData.length}개의 데이터가 경로당(${state.targetYear}년)으로 업로드되었습니다.`);
                                saveDataToStorage();
                                render();
                                input.value = '';
                            }, 300);
                        } catch (error) {
                            alert('파일 처리 중 오류가 발생했습니다: ' + error.message);
                            state.isLoading = false;
                            input.value = '';
                            render();
                        }
                    });
                }

                 const pathwayDownloadBtn = document.getElementById('pathwayDownloadBtn');
                if (pathwayDownloadBtn) {
                    pathwayDownloadBtn.addEventListener('click', () => {
                        state.pathway.showDownloadMenu = !state.pathway.showDownloadMenu;
                        render();
                    });
                }

                const pathwayDownloadExcelBtn = document.getElementById('pathwayDownloadExcelBtn');
                if (pathwayDownloadExcelBtn) {
                    pathwayDownloadExcelBtn.addEventListener('click', () => {
                        const currentData = state.pathwayData[state.targetYear] || [];
                        const dataToDownload = state.pathway.selectedRows.size > 0
                            ? currentData.filter((_, idx) => state.pathway.selectedRows.has(idx))
                            : currentData;

                        if (dataToDownload.length === 0) {
                            alert('다운로드할 데이터가 없습니다.');
                            return;
                        }

                        const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: pathwayColumns });
                        const workbook = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(workbook, worksheet, '경로당');
                        XLSX.writeFile(workbook, `경로당_${state.targetYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
                        
                        state.pathway.showDownloadMenu = false;
                        render();
                    });
                }

               const pathwayDownloadCSVBtn = document.getElementById('pathwayDownloadCSVBtn');
                if (pathwayDownloadCSVBtn) {
                    pathwayDownloadCSVBtn.addEventListener('click', () => {
                        // ... 생략 ...
                        state.pathway.showDownloadMenu = false;
                        render();
                    });
                }

                const pathwayMapBtn = document.getElementById('pathwayMapBtn');
                if (pathwayMapBtn) {
                    pathwayMapBtn.addEventListener('click', () => {
                        const currentData = state.pathwayData[state.targetYear] || [];
                        const selectedData = currentData.filter((_, idx) => state.pathway.selectedRows.has(idx));

                        if (selectedData.length === 0) {
                            alert('지도에 표시할 시설을 선택해주세요.');
                            return;
                        }

                        state.mapData = selectedData;
                        state.showMapModal = true;
                        state.isLoadingMap = true;
                        state.mapLoadingProgress = 0;
                        render();

                        setTimeout(() => {
                            initMap(selectedData);
                        }, 500);
                    });
                }

                const pathwayDeleteBtn = document.getElementById('pathwayDeleteBtn');
                if (pathwayDeleteBtn) {
                    pathwayDeleteBtn.addEventListener('click', () => {
                        if (state.pathway.selectedRows.size === 0) {
                            alert('삭제할 행을 선택해주세요.');
                            return;
                        }
                        if (confirm(`선택한 ${state.pathway.selectedRows.size}개의 행을 삭제하시겠습니까?`)) {
                            const currentData = state.pathwayData[state.targetYear] || [];
                            state.pathwayData[state.targetYear] = currentData.filter((_, idx) => !state.pathway.selectedRows.has(idx));
                            state.pathway.selectedRows = new Set();
                            saveDataToStorage();
                            alert('삭제되었습니다.');
                            render();
                        }
                    });
                }

                const pathwaySaveBtn = document.getElementById('pathwaySaveBtn');
                if (pathwaySaveBtn) {
                    pathwaySaveBtn.addEventListener('click', () => {
                        saveDataToStorage();
                        alert('💾 데이터가 저장되었습니다.');
                    });
                }

                const pathwayEditToggleBtn = document.getElementById('pathwayEditToggleBtn');
                if (pathwayEditToggleBtn) {
                    pathwayEditToggleBtn.addEventListener('click', () => {
                        state.pathway.isEditing = !state.pathway.isEditing;
                        render();
                    });
                }

               const pathwayAddRowBtn = document.getElementById('pathwayAddRowBtn');
                if (pathwayAddRowBtn) {
                    pathwayAddRowBtn.addEventListener('click', () => {
                        const newRow = {};
                        pathwayColumns.forEach(col => { newRow[col] = ''; });
                        if (!state.pathwayData[state.targetYear]) {
                            state.pathwayData[state.targetYear] = [];
                        }
                        state.pathwayData[state.targetYear] = [newRow, ...state.pathwayData[state.targetYear]];
                        saveDataToStorage();
                        render();
                    });
                }

                const pathwayRegionFilter = document.getElementById('pathwayRegionFilter');
                if (pathwayRegionFilter) {
                    pathwayRegionFilter.addEventListener('change', (e) => {
                        state.pathway.filters.region = e.target.value;
                        state.pathway.currentPage = 1;
                        render();
                    });
                }

                const pathwaySearchBtn = document.getElementById('pathwaySearchBtn');
                if (pathwaySearchBtn) {
                    pathwaySearchBtn.addEventListener('click', () => {
                        const searchInput = document.getElementById('pathwaySearchInput');
                        if (searchInput) {
                            state.pathway.searchTerm = searchInput.value;
                        }
                        state.pathway.currentPage = 1;
                        render();
                    });
                }

                const pathwaySearchInput = document.getElementById('pathwaySearchInput');
                if (pathwaySearchInput) {
                    pathwaySearchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            state.pathway.searchTerm = e.target.value;
                            state.pathway.currentPage = 1;
                            render();
                        }
                    });
                }

                const pathwayResetBtn = document.getElementById('pathwayResetBtn');
                if (pathwayResetBtn) {
                    pathwayResetBtn.addEventListener('click', () => {
                        state.pathway.filters.region = '';
                        state.pathway.searchTerm = '';
                        state.pathway.currentPage = 1;
                        render();
                    });
                }

                const selectAllPathwayRows = document.getElementById('selectAllPathwayRows');
                if (selectAllPathwayRows) {
                    selectAllPathwayRows.addEventListener('change', (e) => {
                        const currentData = state.pathwayData[state.targetYear] || [];
                        if (e.target.checked) {
                            state.pathway.selectedRows = new Set(currentData.map((_, i) => i));
                        } else {
                            state.pathway.selectedRows = new Set();
                        }
                        render();
                    });
                }

                document.querySelectorAll('.pathway-row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.pathway.selectedRows.add(idx);
                        } else {
                            state.pathway.selectedRows.delete(idx);
                        }
                    });
                });

                document.querySelectorAll('.pathway-cell-edit').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const col = e.target.dataset.col;
                        if (state.pathwayData[state.targetYear] && state.pathwayData[state.targetYear][idx]) {
                            state.pathwayData[state.targetYear][idx][col] = e.target.value;
                        }
                    });
                });

                const pathwayPrevPageBtn = document.getElementById('pathwayPrevPageBtn');
                if (pathwayPrevPageBtn) {
                    pathwayPrevPageBtn.addEventListener('click', () => {
                        state.pathway.currentPage = Math.max(1, state.pathway.currentPage - 1);
                        render();
                    });
                }

                const pathwayNextPageBtn = document.getElementById('pathwayNextPageBtn');
                if (pathwayNextPageBtn) {
                    pathwayNextPageBtn.addEventListener('click', () => {
                        const currentData = state.pathwayData[state.targetYear] || [];
                        const totalPages = Math.ceil(currentData.length / state.itemsPerPage);
                        state.pathway.currentPage = Math.min(totalPages, state.pathway.currentPage + 1);
                        render();
                    });
                }

                               // 자료실 탭 - 파일 업로드 버튼
                const resourceFileUploadBtn = document.getElementById('resourceFileUploadBtn');
                if (resourceFileUploadBtn) {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.multiple = true;
                    fileInput.accept = '*/*';
                    
                    resourceFileUploadBtn.addEventListener('click', () => fileInput.click());
                    
                    fileInput.addEventListener('change', (e) => {
                        const files = Array.from(e.target.files);
                        if (files.length === 0) return;
                        
                        if (!state.resourceData[state.selectedYear]) {
                            state.resourceData[state.selectedYear] = [];
                        }
                        
                        files.forEach(file => {
                            let fileType = 'file';
                            const fileExt = file.name.split('.').pop().toLowerCase();
                            
                            if (fileExt === 'xlsx' || fileExt === 'xls') {
                                fileType = 'excel';
                            } else if (fileExt === 'csv') {
                                fileType = 'csv';
                            } else if (fileExt === 'pdf') {
                                fileType = 'pdf';
                            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt)) {
                                fileType = 'image';
                            }
                            
                            const resource = {
                                name: file.name,
                                type: fileType,
                                size: file.size,
                                sizeKB: (file.size / 1024).toFixed(2),
                                uploadDate: new Date().toISOString(),
                                fileData: file
                            };
                            
                            state.resourceData[state.selectedYear].push(resource);
                        });
                        
                        saveDataToStorage();
                        alert(`✅ ${files.length}개의 파일이 업로드되었습니다.`);
                        fileInput.value = '';
                        render();
                    });
                }

               // 자료실 탭 - 폴더 업로드 버튼
                const resourceFolderUploadBtn = document.getElementById('resourceFolderUploadBtn');
                if (resourceFolderUploadBtn) {
                    const folderInput = document.createElement('input');
                    folderInput.type = 'file';
                    folderInput.webkitdirectory = true;
                    folderInput.multiple = true;
                    
                    resourceFolderUploadBtn.addEventListener('click', () => folderInput.click());
                    
                    folderInput.addEventListener('change', (e) => {
                        const files = Array.from(e.target.files);
                        if (files.length === 0) return;
                        
                        if (!state.resourceData[state.selectedYear]) {
                            state.resourceData[state.selectedYear] = [];
                        }
                        
                        const folderName = files[0].webkitRelativePath.split('/')[0];
                        
                        // 폴더 항목 추가
                        const folderResource = {
                            name: folderName,
                            type: 'folder',
                            uploadDate: new Date().toISOString(),
                            fileCount: files.length,
                            files: []
                        };
                        
                        files.forEach(file => {
                            let fileType = 'file';
                            const fileExt = file.name.split('.').pop().toLowerCase();
                            
                            if (fileExt === 'xlsx' || fileExt === 'xls') {
                                fileType = 'excel';
                            } else if (fileExt === 'csv') {
                                fileType = 'csv';
                            } else if (fileExt === 'pdf') {
                                fileType = 'pdf';
                            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt)) {
                                fileType = 'image';
                            }
                            
                            folderResource.files.push({
                                name: file.name,
                                path: file.webkitRelativePath,
                                type: fileType,
                                size: file.size,
                                sizeKB: (file.size / 1024).toFixed(2),
                                fileData: file
                            });
                        });
                        
                        state.resourceData[state.selectedYear].push(folderResource);
                        
                        saveDataToStorage();
                        alert(`✅ "${folderName}" 폴더가 ${files.length}개 파일과 함께 업로드되었습니다.`);
                        folderInput.value = '';
                        render();
                    });
                }

                // 자료실 탭 - 폴더 생성 버튼
                const resourceCreateFolderBtn = document.getElementById('resourceCreateFolderBtn');
                if (resourceCreateFolderBtn) {
                    resourceCreateFolderBtn.addEventListener('click', () => {
                        const folderName = prompt('생성할 폴더명을 입력해주세요:', '새 폴더');
                        
                        if (!folderName || folderName.trim() === '') {
                            alert('폴더명이 입력되지 않았습니다.');
                            return;
                        }
                        
                        // 폴더명 유효성 검사
                        if (/[<>:"|?*]/.test(folderName)) {
                            alert('폴더명에 특수문자(<>:"|?*)를 사용할 수 없습니다.');
                            return;
                        }
                        
                        if (!state.resourceData[state.selectedYear]) {
                            state.resourceData[state.selectedYear] = [];
                        }
                        
                        // 같은 이름의 폴더가 있는지 확인
                        const isDuplicate = state.resourceData[state.selectedYear].some(
                            resource => resource.type === 'folder' && resource.name === folderName.trim()
                        );
                        
                        if (isDuplicate) {
                            alert('같은 이름의 폴더가 이미 존재합니다.');
                            return;
                        }
                        
                        // 새 폴더 생성
                        const newFolder = {
                            name: folderName.trim(),
                            type: 'folder',
                            uploadDate: new Date().toISOString(),
                            fileCount: 0,
                            files: []
                        };
                        
                        state.resourceData[state.selectedYear].push(newFolder);
                        
                        saveDataToStorage();
                        alert(`✅ "${folderName.trim()}" 폴더가 생성되었습니다.`);
                        render();
                    });
                }

                // 자료실 탭 - 선택 삭제 버튼

                // 자료실 탭 - 선택 삭제 버튼
                const resourceDeleteBtn = document.getElementById('resourceDeleteBtn');
                if (resourceDeleteBtn) {
                    resourceDeleteBtn.addEventListener('click', () => {
                        const resources = state.resourceData[state.selectedYear] || [];
                        const selectedIndices = [];
                        
                        document.querySelectorAll('.resource-checkbox').forEach(checkbox => {
                            if (checkbox.checked) {
                                selectedIndices.push(parseInt(checkbox.dataset.idx));
                            }
                        });
                        
                        if (selectedIndices.length === 0) {
                            alert('삭제할 항목을 선택해주세요.');
                            return;
                        }
                        
                        if (confirm(`선택한 ${selectedIndices.length}개의 항목을 삭제하시겠습니까?`)) {
                            const newResources = resources.filter((_, idx) => !selectedIndices.includes(idx));
                            state.resourceData[state.selectedYear] = newResources;
                            
                            saveDataToStorage();
                            alert(`✅ ${selectedIndices.length}개 항목이 삭제되었습니다.`);
                            render();
                        }
                    });
                }

                // 자료실 탭 - 전체 선택 체크박스
                const selectAllResources = document.getElementById('selectAllResources');
                if (selectAllResources) {
                    selectAllResources.addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        document.querySelectorAll('.resource-checkbox').forEach(checkbox => {
                            checkbox.checked = isChecked;
                        });
                        state.resourceData['selectedAll_' + state.selectedYear] = isChecked;
                    });
                }

                // 자료실 탭 - 개별 체크박스
                document.querySelectorAll('.resource-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const allChecked = document.querySelectorAll('.resource-checkbox:checked').length === 
                                          document.querySelectorAll('.resource-checkbox').length;
                        const selectAllCheckbox = document.getElementById('selectAllResources');
                        if (selectAllCheckbox) {
                            selectAllCheckbox.checked = allChecked;
                        }
                    });
                });

                // 자료실 탭 - 다운로드 버튼
                document.querySelectorAll('.resource-download-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        const resources = state.resourceData[state.selectedYear] || [];
                        const resource = resources[idx];
                        
                        if (!resource) {
                            alert('다운로드할 항목을 찾을 수 없습니다.');
                            return;
                        }
                        
                        if (resource.type === 'folder') {
                            // 폴더 다운로드 (압축 파일로)
                            alert(`📂 "${resource.name}" 폴더의 ${resource.fileCount}개 파일을 다운로드합니다.\n\n브라우저의 다운로드 기능을 사용하여 폴더를 받으실 수 있습니다.`);
                            
                            // 폴더의 모든 파일을 개별 다운로드
                            resource.files.forEach((file, fileIdx) => {
                                setTimeout(() => {
                                    const link = document.createElement('a');
                                    link.href = URL.createObjectURL(file.fileData);
                                    link.download = file.name;
                                    link.click();
                                }, fileIdx * 500);
                            });
                        } else {
                            // 단일 파일 다운로드
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(resource.fileData);
                            link.download = resource.name;
                            link.click();
                        }
                    });
                });

                // 분기 탭 이벤트
const quarterSelect = document.getElementById('quarterSelect');
if (quarterSelect) {
    quarterSelect.addEventListener('change', (e) => {
        state.quarter.selectedQuarter = e.target.value;
        render();
    });
}

const recipientSelect = document.getElementById('recipientSelect');
if (recipientSelect) {
    recipientSelect.addEventListener('change', (e) => {
        state.quarter.selectedRecipient = e.target.value;
        render();
    });
}

const quarterExcelBtn = document.getElementById('quarterExcelBtn');
if (quarterExcelBtn) {
    quarterExcelBtn.addEventListener('click', () => {
        const applicationData = state.applicationData[state.targetYear] || [];
        const passedData = applicationData.filter(row => row['검사결과'] === '합격');
        
        let filteredData = [...passedData];
        
        if (state.quarter.selectedRecipient) {
            const allowedRegions = state.quarter.recipients[state.quarter.selectedRecipient] || [];
            filteredData = filteredData.filter(row => 
                allowedRegions.some(region => row['행정구역']?.includes(region.replace('부산 ', '').replace('울산 ', '').replace('경남 ', '').replace('경북 ', '')))
            );
        }
        
        filteredData.sort((a, b) => (a['행정구역'] || '').localeCompare(b['행정구역'] || ''));
        
        const quarterColumns = ['시설번호', '시설명', '행정구역', '새주소', '기준일', '검사일', '필증번호'];
        const worksheet = XLSX.utils.json_to_sheet(filteredData, { header: quarterColumns });
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, '분기');
        
        const fileName = `분기_${state.quarter.selectedQuarter}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(workbook, fileName);
    });
}

const quarterCSVBtn = document.getElementById('quarterCSVBtn');
if (quarterCSVBtn) {
    quarterCSVBtn.addEventListener('click', () => {
        const applicationData = state.applicationData[state.targetYear] || [];
        const passedData = applicationData.filter(row => row['검사결과'] === '합격');
        
        let filteredData = [...passedData];
        
        if (state.quarter.selectedRecipient) {
            const allowedRegions = state.quarter.recipients[state.quarter.selectedRecipient] || [];
            filteredData = filteredData.filter(row => 
                allowedRegions.some(region => row['행정구역']?.includes(region.replace('부산 ', '').replace('울산 ', '').replace('경남 ', '').replace('경북 ', '')))
            );
        }
        
        filteredData.sort((a, b) => (a['행정구역'] || '').localeCompare(b['행정구역'] || ''));
        
        const quarterColumns = ['시설번호', '시설명', '행정구역', '새주소', '기준일', '검사일', '필증번호'];
        const csvContent = [
            quarterColumns.join(','),
            ...filteredData.map(row => 
                quarterColumns.map(col => {
                    const value = row[col] || '';
                    return value.includes(',') || value.includes('"') 
                        ? `"${value.replace(/"/g, '""')}"` 
                        : value;
                }).join(',')
            )
        ].join('\n');

        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `분기_${state.quarter.selectedQuarter}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    });
}

const quarterLoadBtn = document.getElementById('quarterLoadBtn');
if (quarterLoadBtn) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv,.xlsx,.xls';
    quarterLoadBtn.addEventListener('click', () => input.click());
    input.addEventListener('change', async (e) => {
        if (!e.target.files[0]) return;
        
        state.isLoading = true;
        state.loadingProgress = 30;
        render();

        try {
            let parsedData;
            const file = e.target.files[0];
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            if (fileExt === 'xlsx' || fileExt === 'xls') {
                parsedData = await parseExcelFile(file);
            } else if (fileExt === 'csv') {
                parsedData = await parseCSVFile(file);
            } else {
                throw new Error('지원하지 않는 파일 형식입니다. (.xlsx, .xls, .csv만 가능)');
            }

            if (parsedData.length === 0) {
                alert('유효한 데이터가 없습니다.');
                state.isLoading = false;
                render();
                return;
            }

            if (!state.quarterData[state.selectedYear]) {
                state.quarterData[state.selectedYear] = [];
            }
            
            state.quarterData[state.selectedYear] = parsedData;
            state.lastSaved = new Date();
            
            setTimeout(() => {
                state.isLoading = false;
                alert(`✅ ${parsedData.length}개의 데이터가 분기(${state.selectedYear}년)로 불러와졌습니다.\n파일명: ${file.name}`);
                saveDataToStorage();
                render();
                input.value = '';
            }, 300);

        } catch (error) {
            console.error('파일 처리 오류:', error);
            alert('파일 처리 중 오류가 발생했습니다: ' + error.message);
            state.isLoading = false;
            input.value = '';
            render();
        }
    });
}
                // 앱 페이지네이션
                const appPrevPageBtn = document.getElementById('appPrevPageBtn');
                if (appPrevPageBtn) {
                    appPrevPageBtn.addEventListener('click', () => {
                        state.currentApplicationPage = Math.max(1, state.currentApplicationPage - 1);
                        render();
                    });
                }

                const appNextPageBtn = document.getElementById('appNextPageBtn');
                if (appNextPageBtn) {
                    appNextPageBtn.addEventListener('click', () => {
                        const currentAppData = state.applicationData[state.targetYear] || [];
                        let filteredApplicationData = [...currentAppData];
                        
                        if (state.applicationFilters.region.length > 0) {
                            filteredApplicationData = filteredApplicationData.filter(row => 
                                state.applicationFilters.region.includes(row['행정구역'])
                            );
                        }

                        if (state.applicationFilters.inspector) {
                            filteredApplicationData = filteredApplicationData.filter(row =>
                                row['검사원'] === state.applicationFilters.inspector
                            );
                        }

                        if (state.applicationSearchTerm) {
                            filteredApplicationData = filteredApplicationData.filter(row =>
                                Object.values(row).some(val =>
                                    String(val).toLowerCase().includes(state.applicationSearchTerm.toLowerCase())
                                )
                            );
                        }

                        const totalPages = Math.ceil(filteredApplicationData.length / state.itemsPerPage);
                        state.currentApplicationPage = Math.min(totalPages, state.currentApplicationPage + 1);
                        render();
                    });
                }
            } catch (error) {
                console.error('이벤트 리스너 첨부 오류:', error);
            }
        }

     // ======================== 초기화 ========================
    
        window.addEventListener('load', function() {
            try {
                loadFromLocalStorage();
                updateFilters();
                render();
            } catch (error) {
                console.error('초기화 오류:', error);
            }
        });

        // 자동저장
        setInterval(() => {
            if (state.settings.autoSave && (Object.keys(state.data).length > 0 || Object.keys(state.applicationData).length > 0 || Object.keys(state.quarterData).length > 0)) {
                saveDataToStorage();
            }
        }, state.settings.autoSaveInterval * 1000);
        
    // 지도 초기화 함수
</script>
</body>
</html>   
