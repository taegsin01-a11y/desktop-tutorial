<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µì¸ê²€ì‚¬ê¸°ê´€ ì•ˆì „ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script async defer src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c8f5719a2be48f3875087006ce782934&libraries=services"></script>
   
    <style>
        .scroll-x-auto {
            -webkit-overflow-scrolling: touch;
        }
        .table-cell-input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-b from-sky-400 to-sky-200 min-h-screen">
    <div id="app"></div>

    <script>
        // ======================== ì „ì—­ ìƒíƒœ ========================
        const state = {
            currentYear: new Date().getFullYear(),
            activeTab: 'í†µí•©',
            selectedYear: new Date().getFullYear(),
            data: {},
            filteredData: [],
            applicationData: {},
            quarterData: {},
            cancellationData: {},
            pathwayData: {},
            resourceData: {}, 
            currentPage: 1,
            selectedRows: new Set(),
            isLoading: false,
            loadingProgress: 0,
            searchTerm: '',
            isEditing: false,
            showAdmin: false,
            adminPassword: '',
            showWelcome: true,
            lastSaved: null,
            showDownloadMenu: false,
            uploadedFileName: '',
            showDuplicateModal: false,
            duplicateInfo: { duplicates: [], selectedData: [] },
            inspectionYear: new Date().getFullYear(),
            targetYear: new Date().getFullYear(),
            applicationFilters: {
                region: [],
                inspector: '',
                receiptLocation: '',
                inspectionResult: '',
                applicationDateFrom: '',
                applicationDateTo: '',
                inspectionDateFrom: '',
                inspectionDateTo: '',
                baseMonth: '',
                fee: '',
                facilityCert: '',
                certificateStatus: '',
                insuranceStatus: ''
            },
            applicationSearchTerm: '',
            selectedApplicationRows: new Set(),
            isEditingApplication: false,
            currentApplicationPage: 1,
            selectedQuarterRows: new Set(),
            isEditingQuarter: false,
            currentQuarterPage: 1,
            isEditingCancellation: false,
            selectedCancellationRows: new Set(),
            showDeleteModal: false,
            showAppDeleteModal: false,
            showDetailModal: false,
            detailModalData: {},
            detailModalSelectedIdx: null,
            showAppDetailModal: false,
            appDetailModalData: {},
            appDetailModalSelectedIdx: null,
            filters: {
                region: [],
                month: '',
                inspectionHistory: ''
            },
            showRegionDropdown: false,
            showMonthDropdown: false,
            showInspectionDropdown: false,
            settings: {
                companyName: 'ê³µì¸ê²€ì‚¬ê¸°ê´€',
                maxFileSize: 100,
                autoSave: true,
                autoSaveInterval: 30
            },
            itemsPerPage: 50,
            inspectors: ['ìµœì¤‘ìˆ˜', 'ê¹€íƒì‹ ', 'ê¹€ì¶˜ì‹', 'ê¹€ì •ë§Œ'],
            receiptLocations: ['ì§€ë¡œ', 'êµ­ë¯¼', 'ë¶€ì‚°', 'ë†í˜‘', 'ê²½ë‚¨', 'í›„ë‚©', 'ê¸°íƒ€'],
            inspectionResults: ['í•©ê²©', 'ë¶ˆí•©ê²©', 'ì´ì¤‘ë‚©ë¶€','ê³µë€', 'ê¸°íƒ€'],
            yearRange: Array.from({ length: 37 }, (_, i) => 2014 + i),
            cancelReasons: ['ì…ê¸ˆ ë¯¸í™•ì¸', 'ê³ ê° ìš”ì²­', 'ì¤‘ë³µ ì‹ ì²­', 'ê¸°íƒ€'],
            showMapModal: false,
            mapData: [],
            isLoadingMap: false,
            mapLoadingProgress: 0,
            quarter: {
                selectedQuarter: 'Q1',
                selectedRecipient: '',
                quarters: ['1ë¶„ê¸°', '2ë¶„ê¸°', '3ë¶„ê¸°', '4ë¶„ê¸°'],
                recipients: {
                    'ë¶€ì‚°ì‹œì²­': ['ë¶€ì‚° ê°•ì„œêµ¬', 'ë¶€ì‚° ë‚¨êµ¬', 'ë¶€ì‚° ë™êµ¬', 'ë¶€ì‚° ë¶€ì‚°ì§„êµ¬', 'ë¶€ì‚° ì‚¬ìƒêµ¬', 'ë¶€ì‚° ì‚¬í•˜êµ¬', 'ë¶€ì‚° ì„œêµ¬', 'ë¶€ì‚° ìˆ˜ì˜êµ¬', 'ë¶€ì‚° ì˜ë„êµ¬', 'ë¶€ì‚° ì¤‘êµ¬', 'ë¶€ì‚° í•´ìš´ëŒ€êµ¬', 'ë¶€ì‚° ê¸ˆì •êµ¬', 'ë¶€ì‚° ê¸°ì¥êµ°', 'ë¶€ì‚° ë™ë˜êµ¬', 'ë¶€ì‚° ì—°ì œêµ¬', 'ë¶€ì‚° ë¶êµ¬'],
                    'ê°•ì„œêµ¬ì²­ì¥': ['ë¶€ì‚° ê°•ì„œêµ¬'],
                    'ë‚¨êµ¬ì²­ì¥': ['ë¶€ì‚° ë‚¨êµ¬'],
                    'ë™êµ¬ì²­ì¥': ['ë¶€ì‚° ë™êµ¬'],
                    'ë¶€ì‚°ì§„êµ¬ì²­ì¥': ['ë¶€ì‚° ë¶€ì‚°ì§„êµ¬'],
                    'ì‚¬ìƒêµ¬ì²­ì¥': ['ë¶€ì‚° ì‚¬ìƒêµ¬'],
                    'ì‚¬í•˜êµ¬ì²­ì¥': ['ë¶€ì‚° ì‚¬í•˜êµ¬'],
                    'ì„œêµ¬ì²­ì¥': ['ë¶€ì‚° ì„œêµ¬'],
                    'ìˆ˜ì˜êµ¬ì²­ì¥': ['ë¶€ì‚° ìˆ˜ì˜êµ¬'],
                    'ì˜ë„êµ¬ì²­ì¥': ['ë¶€ì‚° ì˜ë„êµ¬'],
                    'ì¤‘êµ¬ì²­ì¥': ['ë¶€ì‚° ì¤‘êµ¬'],
                    'í•´ìš´ëŒ€êµ¬ì²­ì¥': ['ë¶€ì‚° í•´ìš´ëŒ€êµ¬'],
                    'ê¸ˆì •êµ¬ì²­ì¥': ['ë¶€ì‚° ê¸ˆì •êµ¬'],
                    'ê¸°ì¥êµ°ìˆ˜': ['ë¶€ì‚° ê¸°ì¥êµ°'],
                    'ë™ë˜êµ¬ì²­ì¥': ['ë¶€ì‚° ë™ë˜êµ¬'],
                    'ì—°ì œêµ¬ì²­ì¥': ['ë¶€ì‚° ì—°ì œêµ¬'],
                    'ë¶êµ¬ì²­ì¥': ['ë¶€ì‚° ë¶êµ¬'],
                    'ìš¸ì‚°ê´‘ì—­ì‹œ ë¶êµ¬ì²­ì¥': ['ìš¸ì‚° ë¶êµ¬'],
                    'ê¹€í•´ì‹œì²­': ['ê²½ë‚¨ ê¹€í•´ì‹œ'],
                    'ì–‘ì‚°ì‹œì²­': ['ê²½ë‚¨ ì–‘ì‚°ì‹œ'],
                    'ì‚¬ì²œì‹œì²­': ['ê²½ë‚¨ ì‚¬ì²œì‹œ'],
                    'í†µì˜ì‹œì²­': ['ê²½ë‚¨ í†µì˜ì‹œ'],
                    'ê±°ì œì‹œì²­': ['ê²½ë‚¨ ê±°ì œì‹œ'],
                    'í¬í•­ì‹œì²­': ['ê²½ë¶ í¬í•­ì‹œ'],
                    'ê²½ì£¼ì‹œì²­': ['ê²½ë¶ ê²½ì£¼ì‹œ'],
                    'êµ¬ë¯¸ì‹œì²­': ['ê²½ë¶ êµ¬ë¯¸ì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ë¶€ì‚°ì§€ì—­ë³¸ë¶€': ['ë¶€ì‚° ê°•ì„œêµ¬', 'ë¶€ì‚° ë‚¨êµ¬', 'ë¶€ì‚° ë™êµ¬', 'ë¶€ì‚° ë¶€ì‚°ì§„êµ¬', 'ë¶€ì‚° ì‚¬ìƒêµ¬', 'ë¶€ì‚° ì‚¬í•˜êµ¬', 'ë¶€ì‚° ì„œêµ¬', 'ë¶€ì‚° ìˆ˜ì˜êµ¬', 'ë¶€ì‚° ì˜ë„êµ¬', 'ë¶€ì‚° ì¤‘êµ¬'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ë¶ë¶€ì§€ì‚¬': ['ë¶€ì‚° í•´ìš´ëŒ€êµ¬', 'ë¶€ì‚° ê¸ˆì •êµ¬', 'ë¶€ì‚° ê¸°ì¥êµ°', 'ë¶€ì‚° ë™ë˜êµ¬', 'ë¶€ì‚° ì—°ì œêµ¬', 'ë¶€ì‚° ë¶êµ¬'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ìš¸ì‚°ì§€ì‚¬': ['ìš¸ì‚° ë¶êµ¬'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ì°½ì›ì§€ì‚¬': ['ê²½ë‚¨ ê¹€í•´ì‹œ', 'ê²½ë‚¨ ì–‘ì‚°ì‹œ', 'ê²½ë‚¨ í†µì˜ì‹œ', 'ê²½ë‚¨ ê±°ì œì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ì§„ì£¼ì§€ì‚¬': ['ê²½ë‚¨ ì‚¬ì²œì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ê²½ë¶ë™ë¶€ì§€ì‚¬': ['ê²½ë¶ í¬í•­ì‹œ', 'ê²½ë¶ ê²½ì£¼ì‹œ'],
                    'í•œêµ­ê°€ìŠ¤ì•ˆì „ê³µì‚¬ ëŒ€êµ¬ê²½ë¶ì§€ì—­ë³¸ë¶€': ['ê²½ë¶ êµ¬ë¯¸ì‹œ']
                }
            },
            pathway: {
                searchTerm: '',
                selectedRows: new Set(),
                isEditing: false,
                currentPage: 1,
                filters: {
                    region: ''
                },
                showDownloadMenu: false
            }
        };
        
        const columns = [
            'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'êµ¬ì£¼ì†Œ', 'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰', 
            'ì „í™”ë²ˆí˜¸', 'ê¸°ì¤€ì¼', 'ì•ˆì „ê´€ë¦¬ìëª…', 'ìê²©ì¦ë²ˆí˜¸', 'ë³´í—˜ì‚¬', 'ë³´í—˜ë§Œê¸°ì¼', 
            'ë©”ëª¨', 'ê²€ì‚¬ì¼', 'ì‹ ì²­ì¼', 'ê²€ì‚¬ì›', 'ê²€ì‚¬ê²°ê³¼', 'í•„ì¦ë²ˆí˜¸', 'ìˆ˜ìˆ˜ë£Œ', 
            'ì ‘ìˆ˜ì²˜', 'ê³„ì‚°ì„œë°œí–‰ì¼', 'ë¹„ê³ ', 'ê²€ì‚¬í™•ì¸', 'ì‚¬ì—…ìë²ˆí˜¸', 'ëŒ€í‘œìëª…', 
            'ì—…íƒœ', 'ì¢…ëª©', 'ì´ë©”ì¼', 'ë©´ì œëŒ€ìƒ', 'ê²€ì‚¬ì´ë ¥'
        ];

        const applicationColumns = [
            'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'êµ¬ì£¼ì†Œ', 'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰', 
            'ì „í™”ë²ˆí˜¸', 'ê¸°ì¤€ì¼', 'ì•ˆì „ê´€ë¦¬ìëª…', 'ìê²©ì¦ë²ˆí˜¸', 'ë³´í—˜ì‚¬', 'ë³´í—˜ë§Œê¸°ì¼', 
            'ë©”ëª¨', 'ê²€ì‚¬ì¼', 'ì‹ ì²­ì¼', 'ê²€ì‚¬ì›', 'ê²€ì‚¬ê²°ê³¼', 'í•„ì¦ë²ˆí˜¸', 'ìˆ˜ìˆ˜ë£Œ', 
            'ì ‘ìˆ˜ì²˜', 'ê³„ì‚°ì„œë°œí–‰ì¼', 'ë©”ëª¨2', 'ê²€ì‚¬í™•ì¸'
        ];

        const quarterColumns = [
            'ë¶„ê¸°', 'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ì‹ ì²­ì¼', 'ê²€ì‚¬ì¼', 'ê²€ì‚¬ì›', 'ê²€ì‚¬ê²°ê³¼', 'í•„ì¦ë²ˆí˜¸', 'ë©”ëª¨'
        ];

        const cancellationColumns = [
            'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìƒˆì£¼ì†Œ', 'ì‹ ì²­ì¼', 'ì·¨ì†Œì‚¬ìœ ', 'ì·¨ì†Œì¼', 'ìˆ˜ìˆ˜ë£Œ', 'ì ‘ìˆ˜ì²˜','ê³„ì¢Œ', 'ë¹„ê³ '
        ];

        const pathwayColumns = [
            'ì‹œì„¤ë²ˆí˜¸', 'ì‹œì„¤ëª…', 'í–‰ì •êµ¬ì—­', 'ìë©´ë™', 'ìƒˆì£¼ì†Œ', 'ì „í™”ë²ˆí˜¸', 'ì‚¬ìš©ê°€ìŠ¤', 'ì°¨ë‹¨ê¸°', 'íƒ€ì´ë¨¸', 'COê²½ë³´ê¸°', 'ëˆ„ì„¤', 'ì ê²€ì¼', 'ì ê²€ì', 'ë¹„ê³ ', 'ì°¸ì¡°'
        ];

        const pathwayOptions = {
            regions: ['ìš¸ì£¼êµ°', 'ë¶êµ¬', 'ë‚¨êµ¬', 'ì¤‘êµ¬', 'ë™êµ¬'],
            gas: ['LPG', 'ë„ì‹œê°€ìŠ¤', 'LPG+ë„ì‹œê°€ìŠ¤'],
            device: ['ì„¤ì¹˜', 'ë¯¸ì„¤ì¹˜', 'ë¶ˆëŸ‰', 'í•´ë‹¹ì—†ìŠ´'],
            leak: ['ìœ ', 'ë¬´'],
            inspectors: ['ìµœì¤‘ìˆ˜', 'ê¹€íƒì‹ ', 'ê¹€ì¶˜ì‹']
        };

        const columnWidths = {
            'ì‹œì„¤ë²ˆí˜¸': '120px', 'ì‹œì„¤ëª…': '150px', 'í–‰ì •êµ¬ì—­': '100px', 'ìƒˆì£¼ì†Œ': '200px',
            'êµ¬ì£¼ì†Œ': '120px', 'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰': '100px', 'ì „í™”ë²ˆí˜¸': '110px', 'ê¸°ì¤€ì¼': '100px',
            'ì•ˆì „ê´€ë¦¬ìëª…': '90px', 'ìê²©ì¦ë²ˆí˜¸': '120px', 'ë³´í—˜ì‚¬': '70px', 'ë³´í—˜ë§Œê¸°ì¼': '100px',
            'ë©”ëª¨': '150px', 'ê²€ì‚¬ì¼': '100px', 'ì‹ ì²­ì¼': '100px', 'ê²€ì‚¬ì›': '90px',
            'ê²€ì‚¬ê²°ê³¼': '70px', 'í•„ì¦ë²ˆí˜¸': '140px', 'ìˆ˜ìˆ˜ë£Œ': '80px', 'ì ‘ìˆ˜ì²˜': '70px',
            'ê³„ì‚°ì„œë°œí–‰ì¼': '110px', 'ë©”ëª¨2': '150px', 'ê²€ì‚¬í™•ì¸': '70px',
            'ì·¨ì†Œë²ˆí˜¸': '120px', 'ì·¨ì†Œì‚¬ìœ ': '150px', 'ì·¨ì†Œì¼': '100px', 'ì²˜ë¦¬ì': '90px', 'ë¹„ê³ ': '150px'
        };

        // ======================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ========================
        function formatCurrency(value) {
            if (!value || value === '') return '';
            const num = parseInt(String(value).replace(/,/g, ''));
            if (isNaN(num)) return value;
            return num.toLocaleString();
        }

        function saveToLocalStorage(dataToSave) {
            try {
                const jsonString = JSON.stringify(dataToSave);
                const sizeInMB = (new Blob([jsonString]).size / (1024 * 1024)).toFixed(2);
                
                if (parseFloat(sizeInMB) > 15) {
                    console.warn(`âš ï¸ ë°ì´í„° í¬ê¸°ê°€ í½ë‹ˆë‹¤: ${sizeInMB}MB`);
                    return false;
                }
                
                localStorage.setItem('safetySystemData', jsonString);
                console.log(`âœ… ì €ì¥ ì™„ë£Œ (${sizeInMB}MB)`);
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.error('âš ï¸ ì €ì¥ ê³µê°„ ì´ˆê³¼. ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ì„¸ìš”.');
                    state.settings.autoSave = false;
                    return false;
                }
                console.error('ì €ì¥ ì˜¤ë¥˜:', e);
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('safetySystemData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    if (parsed.data) state.data = parsed.data;
                    if (parsed.applicationData) state.applicationData = parsed.applicationData;
                    if (parsed.quarterData) state.quarterData = parsed.quarterData;
                    if (parsed.cancellationData) state.cancellationData = parsed.cancellationData;
                    if (parsed.pathwayData) state.pathwayData = parsed.pathwayData;
                    if (parsed.resourceData) state.resourceData = parsed.resourceData;
                    if (parsed.settings) state.settings = parsed.settings;
                    if (parsed.uploadedFileName) state.uploadedFileName = parsed.uploadedFileName;
                    if (parsed.selectedYear) state.selectedYear = parsed.selectedYear;
                    if (parsed.lastSaved) state.lastSaved = new Date(parsed.lastSaved);
                    
                    const totalData = Object.values(state.data).reduce((sum, yearData) => sum + yearData.length, 0);
                    if (totalData > 0) {
                        state.showWelcome = false;
                        const sizeInMB = (new Blob([savedData]).size / (1024 * 1024)).toFixed(2);
                        console.log(`âœ… ì €ì¥ëœ ë°ì´í„° ë³µì›: ${totalData}ê±´ (${sizeInMB}MB)`);
                    }
                }
            } catch (e) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }

        function getStorageSize() {
            try {
                const savedData = localStorage.getItem('safetySystemData');
                if (savedData) {
                    const sizeInMB = (new Blob([savedData]).size / (1024 * 1024)).toFixed(2);
                    return sizeInMB;
                }
                return '0.00';
            } catch (e) {
                return 'N/A';
            }
        }

        function normalizeDate(dateValue) {
            if (!dateValue || dateValue === '') return '';
            
            if (typeof dateValue === 'number') {
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            const dateStr = String(dateValue).trim();
            
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
            
            if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split('.');
                const year = parts[0];
                const month = String(parts[1]).padStart(2, '0');
                const day = String(parts[2]).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                const year = parts[0];
                const month = String(parts[1]).padStart(2, '0');
                const day = String(parts[2]).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                const year = parts[2];
                const month = String(parts[0]).padStart(2, '0');
                const day = String(parts[1]).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return dateStr;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}.${month}.${day}`;
            } catch (e) {
                return dateString;
            }
        }

        function getQuarterFromDate(dateString) {
            if (!dateString) return '';
            try {
                const match = dateString.match(/(\d{4})[-./](\d{1,2})[-./](\d{1,2})/);
                if (match) {
                    const month = parseInt(match[2]);
                    if (month <= 3) return 'Q1';
                    if (month <= 6) return 'Q2';
                    if (month <= 9) return 'Q3';
                    return 'Q4';
                }
            } catch (e) {}
            return '';
        }

        function generateCertificateNumber(date, year) {
            if (!date || date === '') {
                return '';
            }
            
            const allAppData = Object.values(state.applicationData).flat();
            
            if (state.targetYear !== state.inspectionYear) {
                const yy = String(state.inspectionYear).slice(2);
                const prefix = `KGT${yy}0101`;
                
                const existingNumbers = allAppData
                    .filter(row => row['í•„ì¦ë²ˆí˜¸']?.startsWith(prefix))
                    .map(row => {
                        const match = row['í•„ì¦ë²ˆí˜¸']?.match(/-(\d{3})$/);
                        return match ? parseInt(match[1]) : 0;
                    })
                    .filter(num => num > 0);
                
                const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
                return `${prefix}-${String(nextNumber).padStart(3, '0')}`;
            }
            
            const targetDate = new Date(date);
            const yy = String(targetDate.getFullYear()).slice(2);
            const MM = String(targetDate.getMonth() + 1).padStart(2, '0');
            const dd = String(targetDate.getDate()).padStart(2, '0');
            
            const prefix = `KGT${yy}${MM}${dd}`;
            
            const existingNumbers = allAppData
                .filter(row => row['í•„ì¦ë²ˆí˜¸']?.startsWith(prefix))
                .map(row => {
                    const match = row['í•„ì¦ë²ˆí˜¸']?.match(/-(\d{3})$/);
                    return match ? parseInt(match[1]) : 0;
                })
                .filter(num => num > 0);
            
            const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
            return `${prefix}-${String(nextNumber).padStart(3, '0')}`;
        }

        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                
                reader.onload = (e) => {
                    try {
                        state.loadingProgress = 60;
                        render();
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        state.loadingProgress = 70;
                        render();
                        
                        let targetSheet = null;
                        let maxRows = 0;

                        if (workbook.SheetNames.includes('ì ‘ìˆ˜')) {
                            targetSheet = workbook.Sheets['ì ‘ìˆ˜'];
                        } else {
                            workbook.SheetNames.forEach(sheetName => {
                                const sheet = workbook.Sheets[sheetName];
                                const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                                if (data.length > maxRows) {
                                    maxRows = data.length;
                                    targetSheet = sheet;
                                }
                            });
                        }

                        if (!targetSheet) {
                            targetSheet = workbook.Sheets[workbook.SheetNames[0]];
                        }

                        const jsonData = XLSX.utils.sheet_to_json(targetSheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'));
                            return;
                        }
                        
                        state.loadingProgress = 85;
                        render();
                        
                        const headers = jsonData[0].map(h => String(h || '').trim());
                        const dateColumns = ['ê¸°ì¤€ì¼', 'ê²€ì‚¬ì¼', 'ì‹ ì²­ì¼', 'ë³´í—˜ë§Œê¸°ì¼', 'ê³„ì‚°ì„œë°œí–‰ì¼'];
                        const parsedData = [];
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const hasData = jsonData[i].some(cell => cell !== undefined && cell !== null && String(cell).trim() !== '');
                            if (!hasData) continue;
    
                            const obj = {};
                            headers.forEach((header, idx) => {
                                let value = jsonData[i][idx];
                                if (value === undefined || value === null) {
                                    obj[header] = '';
                                } else {
                                    if (dateColumns.includes(header)) {
                                        obj[header] = normalizeDate(value);
                                    } else {
                                        obj[header] = String(value).trim();
                                    }
                                }
                            });
                            parsedData.push(obj);
                        }
                        
                        state.loadingProgress = 100;
                        render();
                        resolve(parsedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                
                reader.onload = (e) => {
                    try {
                        state.loadingProgress = 60;
                        render();
                        
                        const text = e.target.result;
                        
                        if (!text || text.trim() === '') {
                            reject(new Error('íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'));
                            return;
                        }

                        const lines = text
                            .replace(/\r\n/g, '\n')
                            .split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0);

                        if (lines.length < 2) {
                            reject(new Error('ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'));
                            return;
                        }

                        state.loadingProgress = 80;
                        render();
                        
                        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                        const dateColumns = ['ê¸°ì¤€ì¼', 'ê²€ì‚¬ì¼', 'ì‹ ì²­ì¼', 'ë³´í—˜ë§Œê¸°ì¼', 'ê³„ì‚°ì„œë°œí–‰ì¼'];
                        
                        const parsedData = [];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i];
                            if (!line.trim()) continue;
                            
                            const values = [];
                            let currentValue = '';
                            let insideQuotes = false;
                            
                            for (let j = 0; j < line.length; j++) {
                                const char = line[j];
                                if (char === '"') {
                                    insideQuotes = !insideQuotes;
                                } else if (char === ',' && !insideQuotes) {
                                    values.push(currentValue.trim().replace(/^"|"$/g, ''));
                                    currentValue = '';
                                } else {
                                    currentValue += char;
                                }
                            }
                            values.push(currentValue.trim().replace(/^"|"$/g, ''));
                            
                            while (values.length < headers.length) {
                                values.push('');
                            }

                            const hasData = values.some(v => v && String(v).trim() !== '');
                            if (!hasData) continue;

                            const obj = {};
                            headers.forEach((header, idx) => {
                                let value = (values[idx] || '').replace(/[\\]/g, '').trim();
                                if (dateColumns.includes(header)) {
                                    obj[header] = normalizeDate(value);
                                } else {
                                    obj[header] = value;
                                }
                            });
                            parsedData.push(obj);
                        }

                        state.loadingProgress = 100;
                        render();
                        resolve(parsedData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.readAsText(file, 'EUC-KR');
            });
        }

        async function handleFileUpload(file) {
            if (!file) return;

            const maxSize = state.settings.maxFileSize * 1024 * 1024;
            if (file.size > maxSize) {
                alert(`íŒŒì¼ í¬ê¸°ê°€ ${state.settings.maxFileSize}MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                return;
            }

            state.isLoading = true;
            state.loadingProgress = 30;
            state.uploadedFileName = file.name;
            render();

            try {
                let parsedData;
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                if (fileExt === 'xlsx' || fileExt === 'xls') {
                    parsedData = await parseExcelFile(file);
                } else if (fileExt === 'csv') {
                    parsedData = await parseCSVFile(file);
                } else {
                    throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (.xlsx, .xls, .csvë§Œ ê°€ëŠ¥)');
                }

                if (parsedData.length === 0) {
                    alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    state.isLoading = false;
                    render();
                    return;
                }

                if (!state.data[state.selectedYear]) {
                    state.data[state.selectedYear] = [];
                }
                state.data[state.selectedYear] = parsedData;
                
                state.lastSaved = new Date();
                
                setTimeout(() => {
                    state.isLoading = false;
                    const storageSize = getStorageSize();
                    let message = `âœ… ${parsedData.length}ê°œì˜ ë°ì´í„°ê°€ ${state.selectedYear}ë…„ë„ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\níŒŒì¼ëª…: ${file.name}`;
                    
                    if (parseFloat(storageSize) > 3) {
                        message += `\n\nâš ï¸ ì €ì¥ ê³µê°„: ${storageSize}MB/5MB\nê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ìë™ ì €ì¥ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                    }
                    
                    alert(message);
                    saveDataToStorage();
                    render();
                }, 300);

            } catch (error) {
                console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                state.isLoading = false;
                render();
            }
        }

        function downloadAsExcel() {
            const dataToDownload = state.selectedRows.size > 0
                ? state.filteredData.filter((_, idx) => state.selectedRows.has(idx))
                : state.filteredData;

            if (dataToDownload.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(dataToDownload, { header: columns });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ì•ˆì „ê´€ë¦¬');
            
            const wscols = columns.map(() => ({ wch: 15 }));
            worksheet['!cols'] = wscols;
            
            const fileName = `ì•ˆì „ê´€ë¦¬_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            state.showDownloadMenu = false;
            render();
        }

        function downloadAsCSV() {
            const dataToDownload = state.selectedRows.size > 0
                ? state.filteredData.filter((_, idx) => state.selectedRows.has(idx))
                : state.filteredData;

            if (dataToDownload.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const csvContent = [
                columns.join(','),
                ...dataToDownload.map(row => 
                    columns.map(col => {
                        const value = row[col] || '';
                        return value.includes(',') || value.includes('"') 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ì•ˆì „ê´€ë¦¬_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            state.showDownloadMenu = false;
            render();
        }

        function createSampleData() {
            const sampleData = [
                {
                    'ì‹œì„¤ë²ˆí˜¸': '00458912-0001', 'ì‹œì„¤ëª…': 'ì¥ìˆ˜ë§ˆì„ëª©ìš•íƒ•', 'í–‰ì •êµ¬ì—­': 'ë¶€ì‚°',
                    'ìƒˆì£¼ì†Œ': 'ë¶€ì‚°ê´‘ì—­ì‹œ ê¸°ì¥êµ° ê¸°ì¥ì êµë¦¬ 334-6ë²ˆì§€', 'êµ¬ì£¼ì†Œ': '',
                    'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰': '6,334.00ã¡', 'ì „í™”ë²ˆí˜¸': '051-724-2552', 'ê¸°ì¤€ì¼': '2025-02-03',
                    'ì•ˆì „ê´€ë¦¬ìëª…': '', 'ìê²©ì¦ë²ˆí˜¸': '', 'ë³´í—˜ì‚¬': '', 'ë³´í—˜ë§Œê¸°ì¼': '2028-11-22',
                    'ë©”ëª¨': '', 'ê²€ì‚¬ì¼': '2002-01-30', 'ì‹ ì²­ì¼': '', 'ê²€ì‚¬ì›': 'ë¬¸ì„œì˜',
                    'ê²€ì‚¬ê²°ê³¼': '', 'í•„ì¦ë²ˆí˜¸': '', 'ìˆ˜ìˆ˜ë£Œ': '', 'ì ‘ìˆ˜ì²˜': 'ë¹„ëŒ€ìƒ',
                    'ê³„ì‚°ì„œë°œí–‰ì¼': '', 'ë¹„ê³ ': '', 'ê²€ì‚¬í™•ì¸': '', 'ì‚¬ì—…ìë²ˆí˜¸': '',
                    'ëŒ€í‘œìëª…': '', 'ì—…íƒœ': '', 'ì¢…ëª©': '', 'ì´ë©”ì¼': '', 'ë©´ì œëŒ€ìƒ': '', 'ê²€ì‚¬ì´ë ¥': 'Y'
                },
                {
                    'ì‹œì„¤ë²ˆí˜¸': '01525996-0001', 'ì‹œì„¤ëª…': 'í”¼í”ŒëŸ¬í•œì˜ì›', 'í–‰ì •êµ¬ì—­': 'ë¶€ì‚°',
                    'ìƒˆì£¼ì†Œ': 'ë¶€ì‚°ê´‘ì—­ì‹œ ê¸°ì¥êµ° ì •ê´€ì ìš©ìˆ˜ë¦¬ 12 83-3ë²ˆì§€', 'êµ¬ì£¼ì†Œ': '',
                    'ì›”ì‚¬ìš©ì˜ˆì •ëŸ‰': '1,322.00ã¡', 'ì „í™”ë²ˆí˜¸': '051-728-6999', 'ê¸°ì¤€ì¼': '2025-05-07',
                    'ì•ˆì „ê´€ë¦¬ìëª…': '', 'ìê²©ì¦ë²ˆí˜¸': '', 'ë³´í—˜ì‚¬': '', 'ë³´í—˜ë§Œê¸°ì¼': '',
                    'ë©”ëª¨': '', 'ê²€ì‚¬ì¼': '2011-01-05', 'ì‹ ì²­ì¼': '', 'ê²€ì‚¬ì›': '',
                    'ê²€ì‚¬ê²°ê³¼': '', 'í•„ì¦ë²ˆí˜¸': '', 'ìˆ˜ìˆ˜ë£Œ': '', 'ì ‘ìˆ˜ì²˜': 'ë¹„ëŒ€ìƒ',
                    'ê³„ì‚°ì„œë°œí–‰ì¼': '', 'ë¹„ê³ ': '', 'ê²€ì‚¬í™•ì¸': '', 'ì‚¬ì—…ìë²ˆí˜¸': '',
                    'ëŒ€í‘œìëª…': '', 'ì—…íƒœ': '', 'ì¢…ëª©': '', 'ì´ë©”ì¼': '', 'ë©´ì œëŒ€ìƒ': '', 'ê²€ì‚¬ì´ë ¥': ''
                }
            ];
            if (!state.data[state.selectedYear]) {
                state.data[state.selectedYear] = [];
            }
            state.data[state.selectedYear] = sampleData;
            state.uploadedFileName = 'ìƒ˜í”Œë°ì´í„°.xlsx';
            state.lastSaved = new Date();
            state.showWelcome = false;
            alert('ìƒ˜í”Œ ë°ì´í„° 2ê±´ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            saveDataToStorage();
            updateFilters();
            render();
        }

        function updateFilters() {
            let result = [...(state.data[state.selectedYear] || [])];
            
            if (state.filters.region.length > 0) {
                result = result.filter(row => {
                    const region = (row['í–‰ì •êµ¬ì—­'] || '').replace(/[\\\/]/g, '').trim();
                    return state.filters.region.includes(region);
                });
            }
            
            if (state.filters.inspectionHistory) {
                result = result.filter(row => {
                    const history = row['ê²€ì‚¬ì´ë ¥'];
                    if (state.filters.inspectionHistory === 'Y') return history === 'Y';
                    if (state.filters.inspectionHistory === 'N') return !history || history === '' || history === 'N';
                    return true;
                });
            }
            
            if (state.searchTerm) {
                result = result.filter(row =>
                    Object.values(row).some(val =>
                        String(val).toLowerCase().includes(state.searchTerm.toLowerCase())
                    )
                );
            }
            
            state.filteredData = result;
            state.currentPage = 1;
        }

        function copyToApplication() {
            const selectedData = state.filteredData.filter((_, idx) => state.selectedRows.has(idx));
            
            if (selectedData.length === 0) {
                alert('ë³µì‚¬í•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!state.applicationData[state.targetYear]) {
                state.applicationData[state.targetYear] = [];
            }

            const duplicates = selectedData.filter(item =>
                state.applicationData[state.targetYear].some(app => app['ì‹œì„¤ë²ˆí˜¸'] === item['ì‹œì„¤ë²ˆí˜¸'])
            );

            if (duplicates.length > 0) {
                state.duplicateInfo = { duplicates, selectedData };
                state.showDuplicateModal = true;
                render();
                return;
            }

            selectedData.forEach(row => {
                if (row['ì‹ ì²­ì¼'] && row['ì‹ ì²­ì¼'] !== '') {
                    row['í•„ì¦ë²ˆí˜¸'] = generateCertificateNumber(row['ì‹ ì²­ì¼'], state.targetYear);
                } else {
                    row['í•„ì¦ë²ˆí˜¸'] = '';
                }
            });

            const existingData = state.applicationData[state.targetYear] || [];
            state.applicationData[state.targetYear] = [...selectedData, ...existingData];
                
            state.activeTab = 'ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥';
            state.selectedRows = new Set();
            alert(`${selectedData.length}ê°œ í•­ëª©ì´ ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥ìœ¼ë¡œ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            saveDataToStorage();
            render();
        }

        function saveDataToStorage() {
            const toSave = {
                data: state.data,
                applicationData: state.applicationData,
                quarterData: state.quarterData,
                cancellationData: state.cancellationData,
                pathwayData: state.pathwayData,
                resourceData: state.resourceData,
                settings: state.settings,
                uploadedFileName: state.uploadedFileName,
                selectedYear: state.selectedYear,
                lastSaved: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            const saved = saveToLocalStorage(toSave);
            if (saved) {
                state.lastSaved = new Date();
            } else {
                console.warn('âš ï¸ ì €ì¥ ì‹¤íŒ¨. ë¶ˆí•„ìš”í•œ ë°ì´í„°ë¥¼ ì‚­ì œí•´ì£¼ì„¸ìš”.');
            }
        }

        function clearAllData() {
            if (confirm('âš ï¸ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì €ì¥ëœ ë°ì´í„°ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)')) {
                localStorage.removeItem('safetySystemData');
                state.data = {};
                state.applicationData = {};
                state.quarterData = {};
                state.cancellationData = {};
                state.pathwayData = {};
                state.resourceData = {};
                state.uploadedFileName = '';
                state.lastSaved = null;
                state.showWelcome = true;
                state.showAdmin = false;
                alert('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                render();
            }
        }

        // ======================== ë Œë”ë§ í•¨ìˆ˜ (ê°„ëµí™”) ========================
        function render() {
            try {
                updateFilters();
                const app = document.getElementById('app');
                if (!app) {
                    console.error('#app ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                app.innerHTML = renderApp();
                attachEventListeners();
            } catch (error) {
                console.error('ë Œë”ë§ ì˜¤ë¥˜:', error);
                const app = document.getElementById('app');
                if (app) {
                    app.innerHTML = `<div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
                }
            }
        }

        function renderApp() {
            return `
                <div class="min-h-screen bg-gradient-to-b from-sky-400 to-sky-200">
                    ${renderHeader()}
                    ${renderTabs()}
                    <div class="container mx-auto px-4 py-6">
                        ${renderContent()}
                    </div>
                    ${renderFooter()}
                    ${state.isLoading ? renderLoadingModal() : ''}
                </div>
            `;
        }

        function renderHeader() {
            const years = Array.from({ length: 10 }, (_, i) => state.currentYear - i);
            return `
                <div class="bg-gradient-to-r from-sky-400 to-sky-500 text-white">
                    <div class="container mx-auto px-4 py-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold">ê³µì¸ê²€ì‚¬ê¸°ê´€</h1>
                                <p class="text-lg">ì•ˆì „ê´€ë¦¬ì‹œìŠ¤í…œ v2.0 ğŸ’¾ (GitHub Pages)</p>
                            </div>
                            <div class="text-right">
                                <label class="block text-sm mb-1">ë‹¹í•´ ì—°ë„</label>
                                <select id="yearSelect" class="px-4 py-2 text-gray-900 rounded border-2 border-white">
                                    ${years.map(year => `<option value="${year}" ${year === state.selectedYear ? 'selected' : ''}>${year}ë…„</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTabs() {
            const tabs = ['í†µí•©', 'ì‹ ì²­ì ‘ìˆ˜ëŒ€ì¥', 'ë¶„ê¸°', 'ê²½ë¡œë‹¹', 'ë§¤ì¶œë¶„ì„', 'ì·¨ì†Œ', 'ìë£Œì‹¤', 'ê´€ë¦¬ì'];
            return `
                <div class="bg-white border-b shadow-sm">
                    <div class="container mx-auto px-4">
                        <div class="flex gap-1 overflow-x-auto">
                            ${tabs.map(tab => `
                                <button class="tab-btn px-6 py-3 font-semibold whitespace-nowrap ${state.activeTab === tab ? 'bg-blue-600 text-white border-b-4 border-blue-800' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}" data-tab="${tab}">
                                    ${tab}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContent() {
            if (state.showWelcome && Object.keys(state.data).length === 0 && state.activeTab === 'í†µí•©') {
                return renderWelcome();
            }
            
            if (state.activeTab === 'ê´€ë¦¬ì') {
                return renderAdmin();
            }
            
            return renderMainTab();
        }

        function renderWelcome() {
            return `
                <div class="flex items-center justify-center min-h-96">
                    <div class="bg-white p-12 rounded-2xl shadow-2xl max-w-2xl text-center">
                        <h2 class="text-4xl font-bold mb-6 text-blue-600">ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                        <p class="text-xl mb-8 text-gray-700">ê³µì¸ê²€ì‚¬ê¸°ê´€ ì•ˆì „ê´€ë¦¬ì‹œìŠ¤í…œ</p>
                        <p class="text-sm mb-8 text-green-600">âœ… GitHub Pagesì—ì„œ ì‹¤í–‰ ì¤‘</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <button id="sampleDataBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-8 py-6 rounded-xl hover:from-blue-600 hover:to-blue-700 shadow-lg transform hover:scale-105 transition-all">
                                <div class="text-5xl mb-3">ğŸ¯</div>
                                <div class="text-xl font-bold mb-2">ìƒ˜í”Œ ë°ì´í„°ë¡œ ì‹œì‘</div>
                                <div class="text-sm opacity-90">2ê±´ì˜ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</div>
                            </button>

                            <label class="bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-6 rounded-xl hover:from-green-600 hover:to-green-700 shadow-lg transform hover:scale-105 transition-all cursor-pointer">
                                <div class="text-5xl mb-3">ğŸ“</div>
                                <div class="text-xl font-bold mb-2">íŒŒì¼ ì—…ë¡œë“œ</div>
                                <div class="text-sm opacity-90">Excel/CSVë¡œ ì‹œì‘í•˜ê¸°</div>
                                <input type="file" id="welcomeFileInput" accept=".csv,.xlsx,.xls" class="hidden" />
                            </label>
                        </div>

                        <button id="emptyStartBtn" class="mt-6 text-gray-500 hover:text-gray-700 underline">
                            ë¹ˆ í™”ë©´ìœ¼ë¡œ ì‹œì‘
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAdmin() {
            if (!state.showAdmin) {
                return `
                    <div class="flex items-center justify-center h-96">
                        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
                            <h2 class="text-xl font-bold mb-4">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
                            <input type="password" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" class="w-full px-4 py-2 border rounded mb-4" />
                            <button id="adminLoginBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                ë¡œê·¸ì¸
                            </button>
                        </div>
                    </div>
                `;
            }
            
            const totalMainData = Object.values(state.data).reduce((sum, yearData) => sum + yearData.length, 0);
            
            return `
                <div class="p-6 bg-white rounded-lg">
                    <h2 class="text-2xl font-bold mb-6">ì‹œìŠ¤í…œ ê´€ë¦¬</h2>
                    <div class="space-y-6">
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold mb-4">ì‹œìŠ¤í…œ ì •ë³´</h3>
                            <div class="bg-gray-50 p-4 rounded space-y-2 text-sm">
                                <p><strong>ë²„ì „:</strong> 2.0.0 (GitHub Pages)</p>
                                <p><strong>ì „ì²´ ë°ì´í„°:</strong> ${totalMainData}ê±´</p>
                                <p><strong>ë§ˆì§€ë§‰ ì €ì¥:</strong> ${state.lastSaved ? state.lastSaved.toLocaleString() : 'ì €ì¥ ê¸°ë¡ ì—†ìŒ'}</p>
                                <p><strong>ì €ì¥ ê³µê°„:</strong> ${getStorageSize()} MB / ~5 MB</p>
                            </div>
                        </div>
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-semibold mb-4 text-red-600">ìœ„í—˜ êµ¬ì—­</h3>
                            <button id="clearAllBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-semibold">
                                ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainTab() {
            const totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);
            const paginatedData = state.filteredData.slice(
                (state.currentPage - 1) * state.itemsPerPage,
                state.currentPage * state.itemsPerPage
            );

            return `
                <div>
                    <div class="bg-white rounded-lg p-4 mb-4 shadow">
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <button id="uploadBtn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 cursor-pointer">
                                ğŸ“¤ ì—…ë¡œë“œ
                            </button>
                            <button id="downloadBtn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button id="sampleBtn" class="flex items-center gap-2 bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">
                                ğŸ¯ ìƒ˜í”Œ ë°ì´í„°
                            </button>
                            <button id="saveBtn" class="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                                ğŸ’¾ ì €ì¥
                            </button>
                            <button id="copyBtn" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                                ğŸ“‹ ì‹ ì²­
                            </button>
                        </div>

                        ${state.uploadedFileName ? `
                            <div class="mb-4 px-3 py-2 bg-blue-50 border border-blue-200 rounded text-sm flex items-center justify-between">
                                <span>ğŸ“‚ <strong>${state.uploadedFileName}</strong> (${(state.data[state.selectedYear] || []).length}ê±´)</span>
                                ${state.lastSaved ? `<span class="text-gray-600 text-xs">ë§ˆì§€ë§‰ ì €ì¥: ${state.lastSaved.toLocaleTimeString()}</span>` : ''}
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">ê²€ìƒ‰</label>
                                <div class="flex gap-2">
                                    <input type="text" id="searchInput" value="${state.searchTerm}" placeholder="ê²€ìƒ‰..." class="flex-1 px-3 py-2 border rounded text-sm" />
                                    <button id="searchBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold">
                                        ğŸ”
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto" style="max-height: 600px;">
                            <table class="w-full border-collapse" style="table-layout: fixed; min-width: 4500px;">
                                <thead class="bg-blue-600 text-white sticky top-0 z-10">
                                    <tr>
                                        <th class="border px-2 py-2 sticky left-0 bg-blue-600 z-20" style="width: 50px;">
                                            <input type="checkbox" id="selectAllRows" ${state.selectedRows.size === state.filteredData.length && state.filteredData.length > 0 ? 'checked' : ''} />
                                        </th>
                                        <th class="border px-2 py-2 sticky left-[50px] bg-blue-600 z-20" style="width: 60px;">No</th>
                                        ${columns.map(col => `
                                            <th class="border px-3 py-2 text-sm" style="width: ${columnWidths[col]};">
                                                <div class="truncate" title="${col}">${col}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paginatedData.map((row, idx) => {
                                        const actualIdx = (state.currentPage - 1) * state.itemsPerPage + idx;
                                        return `
                                            <tr class="${state.selectedRows.has(actualIdx) ? 'bg-blue-50' : 'hover:bg-gray-50'}">
                                                <td class="border px-2 py-2 text-center sticky left-0 bg-white z-10" style="width: 50px;">
                                                    <input type="checkbox" class="row-checkbox" data-idx="${actualIdx}" ${state.selectedRows.has(actualIdx) ? 'checked' : ''} />
                                                </td>
                                                <td class="border px-2 py-2 text-center sticky left-[50px] bg-white z-10" style="width: 60px;">${actualIdx + 1}</td>
                                                ${columns.map(col => `
                                                    <td class="border px-3 py-2 text-sm" style="width: ${columnWidths[col]}; max-width: ${columnWidths[col]};">
                                                        <div class="truncate" title="${row[col] || '-'}">${row[col] || '-'}</div>
                                                    </td>
                                                `).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${paginatedData.length === 0 ? `
                                        <tr>
                                            <td colspan="${columns.length + 2}" class="text-center py-8 text-gray-500">
                                                <div class="text-4xl mb-2">ğŸ“‹</div>
                                                <div>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>

                        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
                            <div class="text-sm text-gray-600">
                                ì „ì²´ ${state.filteredData.length}ê±´
                                ${state.selectedRows.size > 0 ? ` (${state.selectedRows.size}ê±´ ì„ íƒë¨)` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="prevPageBtn" ${state.currentPage === 1 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">â—€</button>
                                <span class="px-4 py-2">${state.currentPage} / ${totalPages || 1}</span>
                                <button id="nextPageBtn" ${state.currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} class="p-2 border rounded hover:bg-gray-100 disabled:opacity-50">â–¶</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoadingModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                        <div class="animate-pulse text-4xl mb-4">â³</div>
                        <p class="text-lg font-semibold mb-2">íŒŒì¼ ì²˜ë¦¬ ì¤‘...</p>
                        <div class="w-64 bg-gray-200 rounded-full h-4 mb-2">
                            <div class="bg-blue-600 h-4 rounded-full transition-all" style="width: ${state.loadingProgress}%;"></div>
                        </div>
                        <p class="text-sm text-gray-600">${state.loadingProgress}%</p>
                    </div>
                </div>
            `;
        }

        function renderFooter() {
            return `
                <div class="container mx-auto px-4 py-4 text-sm text-gray-600 flex items-center justify-between">
                    <p>ê²€ìƒ‰ê²°ê³¼ (Total: ${state.filteredData.length}ê°œ)</p>
                    <div class="flex items-center gap-4">
                        ${state.settings.autoSave && state.lastSaved ? `
                            <p class="text-xs text-gray-500 flex items-center gap-2">
                                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                ìë™ì €ì¥ í™œì„± | ë§ˆì§€ë§‰ ì €ì¥: ${state.lastSaved.toLocaleTimeString()}
                            </p>
                        ` : ''}
                        <p class="text-xs text-green-600 font-semibold">ğŸ’¾ GitHub Pages</p>
                    </div>
                </div>
            `;
        }

        // ======================== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ========================
        function attachEventListeners() {
            try {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        state.activeTab = e.target.dataset.tab;
                        render();
                    });
                });

                const yearSelect = document.getElementById('yearSelect');
                if (yearSelect) yearSelect.addEventListener('change', (e) => {
                    state.selectedYear = parseInt(e.target.value);
                    render();
                });

                const sampleDataBtn = document.getElementById('sampleDataBtn');
                if (sampleDataBtn) sampleDataBtn.addEventListener('click', createSampleData);

                const welcomeFileInput = document.getElementById('welcomeFileInput');
                if (welcomeFileInput) {
                    welcomeFileInput.addEventListener('change', (e) => {
                        handleFileUpload(e.target.files[0]);
                    });
                }

                const emptyStartBtn = document.getElementById('emptyStartBtn');
                if (emptyStartBtn) {
                    emptyStartBtn.addEventListener('click', () => {
                        state.showWelcome = false;
                        render();
                    });
                }

                const adminLoginBtn = document.getElementById('adminLoginBtn');
                if (adminLoginBtn) {
                    adminLoginBtn.addEventListener('click', () => {
                        const pwd = document.getElementById('adminPassword').value;
                        if (pwd === 'kgt7848848!') {
                            state.showAdmin = true;
                            render();
                        } else {
                            alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        }
                    });
                }

                const clearAllBtn = document.getElementById('clearAllBtn');
                if (clearAllBtn) clearAllBtn.addEventListener('click', clearAllData);

                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv,.xlsx,.xls';
                    uploadBtn.addEventListener('click', () => input.click());
                    input.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));
                }

                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', downloadAsExcel);
                }

                const sampleBtn = document.getElementById('sampleBtn');
                if (sampleBtn) sampleBtn.addEventListener('click', createSampleData);

                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        saveDataToStorage();
                        alert('ğŸ’¾ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    });
                }

                const copyBtn = document.getElementById('copyBtn');
                if (copyBtn) copyBtn.addEventListener('click', copyToApplication);

                const searchBtn = document.getElementById('searchBtn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => {
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput) {
                            state.searchTerm = searchInput.value;
                        }
                        state.currentPage = 1;
                        render();
                    });
                }

                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            state.searchTerm = e.target.value;
                            state.currentPage = 1;
                            render();
                        }
                    });
                }

                const selectAllRows = document.getElementById('selectAllRows');
                if (selectAllRows) {
                    selectAllRows.addEventListener('change', () => {
                        if (selectAllRows.checked) {
                            state.selectedRows = new Set(state.filteredData.map((_, i) => i));
                        } else {
                            state.selectedRows = new Set();
                        }
                        render();
                    });
                }

                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        if (e.target.checked) {
                            state.selectedRows.add(idx);
                        } else {
                            state.selectedRows.delete(idx);
                        }
                    });
                });

                const prevPageBtn = document.getElementById('prevPageBtn');
                if (prevPageBtn) {
                    prevPageBtn.addEventListener('click', () => {
                        state.currentPage = Math.max(1, state.currentPage - 1);
                        render();
                    });
                }

                const nextPageBtn = document.getElementById('nextPageBtn');
                if (nextPageBtn) {
                    nextPageBtn.addEventListener('click', () => {
                        const totalPages = Math.ceil(state.filteredData.length / state.itemsPerPage);
                        state.currentPage = Math.min(totalPages, state.currentPage + 1);
                        render();
                    });
                }

            } catch (error) {
                console.error('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì²¨ë¶€ ì˜¤ë¥˜:', error);
            }
        }

        // ======================== ì´ˆê¸°í™” ========================
        window.addEventListener('load', function() {
            try {
                loadFromLocalStorage();
                updateFilters();
                render();
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        });

        setInterval(() => {
            if (state.settings.autoSave && (Object.keys(state.data).length > 0 || Object.keys(state.applicationData).length > 0)) {
                saveDataToStorage();
            }
        }, state.settings.autoSaveInterval * 1000);
    </script>
</body>
</html>